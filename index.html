<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestion Intelligente des D√©penses</title>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODULE AUTO-SAVE  ‚Äî  dossier CONFIGURABLE par l'utilisateur
//
//  ‚Ä¢ Dossier libre (choisi par l'utilisateur, modifiable √† tout moment)
//  ‚Ä¢ Handle persist√© en IndexedDB ‚Üí survit √† la fermeture du navigateur
//  ‚Ä¢ queryPermission() silencieux au d√©marrage ‚Üí 0 popup si d√©j√† autoris√©
//  ‚Ä¢ requestPermission() uniquement dans la pile d'un clic utilisateur
//  ‚Ä¢ Nom du dossier affich√© et m√©moris√© dans localStorage
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window._fsAutoSave = (function(){
  const FILE_NAME  = 'Save_data_Depense.json';
  const IDB_NAME   = 'fsAutoSaveDB_v3';
  const IDB_STORE  = 'handles';
  const IDB_KEY    = 'dirHandle';
  const LS_FOLDER  = 'fsAutoSaveFolderName';
  const LS_GRANTED = 'fsAutoSaveGranted';

  let _dir    = null;
  let _timer  = null;
  let _ready  = false;
  let _pendingPermRequest = false;
  const _ok   = ('showDirectoryPicker' in window);

  // IndexedDB
  function _openDB(){
    return new Promise((res,rej)=>{
      const r = indexedDB.open(IDB_NAME, 1);
      r.onupgradeneeded = e => e.target.result.createObjectStore(IDB_STORE);
      r.onsuccess = e => res(e.target.result);
      r.onerror   = () => rej();
    });
  }
  async function _idbSave(h){
    try{
      const db = await _openDB();
      await new Promise((res,rej)=>{
        const tx = db.transaction(IDB_STORE,'readwrite');
        tx.objectStore(IDB_STORE).put(h, IDB_KEY);
        tx.oncomplete = res; tx.onerror = rej;
      });
    }catch(e){}
  }
  async function _idbLoad(){
    try{
      const db = await _openDB();
      return await new Promise(res=>{
        const tx = db.transaction(IDB_STORE,'readonly');
        const r  = tx.objectStore(IDB_STORE).get(IDB_KEY);
        r.onsuccess = e => res(e.target.result || null);
        r.onerror   = () => res(null);
      });
    }catch(e){ return null; }
  }
  async function _idbClear(){
    try{
      const db = await _openDB();
      await new Promise((res,rej)=>{
        const tx = db.transaction(IDB_STORE,'readwrite');
        tx.objectStore(IDB_STORE).delete(IDB_KEY);
        tx.oncomplete = res; tx.onerror = rej;
      });
    }catch(e){}
  }

  // Banniere
  function _banner(icon, txt, bg, col){
    const b = document.getElementById('autoSaveBanner');
    if(!b) return;
    b.innerHTML = '<span style="margin-right:6px">'+icon+'</span><span>'+txt+'</span>';
    b.style.background = bg;
    b.style.color = col || '#065F46';
    b.style.display = 'flex';
  }
  function _bannerOK(){
    const folder = localStorage.getItem(LS_FOLDER) || (_dir ? _dir.name : '?');
    const ts = new Date().toLocaleDateString('fr-FR')+' '+new Date().toLocaleTimeString('fr-FR');
    _banner('\u2705','Sauvegarde auto \u2192 <strong>'+folder+'</strong>&#92;'+FILE_NAME+' \u2014 '+ts,'#D1FAE5');
  }
  function _bannerWaiting(){
    const folder = localStorage.getItem(LS_FOLDER);
    if(!folder) return;
    _banner('\uD83D\uDD12','Permission requise \u2014 Connectez-vous pour r\u00e9activer la sauvegarde vers <strong>'+folder+'</strong>','#FEF3C7','#92400E');
  }

  // UI Parametres
  function _updateSettingsUI(){
    const statusEl = document.getElementById('autoSaveSettingsStatus');
    const folderEl = document.getElementById('autoSaveFolderDisplay');
    const folder   = localStorage.getItem(LS_FOLDER);
    if(statusEl){
      if(_ready){
        statusEl.style.background='#D1FAE5'; statusEl.style.color='#065F46';
        statusEl.innerHTML='\u2705 Sauvegarde automatique <strong>ACTIVE</strong> \u2014 chaque modification est sauvegard\u00e9e automatiquement.';
      } else if(folder){
        statusEl.style.background='#FEF3C7'; statusEl.style.color='#92400E';
        statusEl.innerHTML='\uD83D\uDD12 Dossier m\u00e9moris\u00e9 : <strong>'+folder+'<\/strong><br><span style="font-size:12px">La permission sera demand\u00e9e automatiquement au prochain clic <strong>Se Connecter<\/strong>.<\/span>';
      } else {
        statusEl.style.background='#F1F5F9'; statusEl.style.color='#475569';
        statusEl.innerHTML='\u26A0\uFE0F Sauvegarde automatique <strong>INACTIVE<\/strong> \u2014 S\u00e9lectionnez un dossier pour l\'activer.';
      }
    }
    if(folderEl){
      if(folder){
        folderEl.innerHTML='<span style="font-size:18px">\uD83D\uDCC1<\/span><span><strong>'+folder+'<\/strong>&#92;Save_data_Depense.json<\/span>';
        folderEl.style.display='flex';
      } else {
        folderEl.style.display='none';
      }
    }
  }

  // Ecriture fichier - JAMAIS de popup
  async function _write(){
    if(!_ready || !_dir) return false;
    try{
      const perm = await _dir.queryPermission({mode:'readwrite'});
      if(perm !== 'granted'){ _ready=false; _updateSettingsUI(); _bannerWaiting(); return false; }
      const fh = await _dir.getFileHandle(FILE_NAME, {create:true});
      const payload = {
        app:'Gestion des D\u00e9penses V3', savedAt:new Date().toISOString(), version:'3.0',
        folder: localStorage.getItem(LS_FOLDER) || (_dir ? _dir.name : ''),
        users: JSON.parse(localStorage.getItem('appUsers') || '{}')
      };
      const w = await fh.createWritable();
      await w.write(JSON.stringify(payload, null, 2));
      await w.close();
      _bannerOK();
      return true;
    }catch(e){
      _banner('\u274C','Erreur sauvegarde : '+e.message,'#FEE2E2','#991B1B');
      return false;
    }
  }

  // Lecture fichier
  async function _read(){
    if(!_dir) return null;
    try{
      const perm = await _dir.queryPermission({mode:'readwrite'});
      if(perm !== 'granted') return null;
      const fh = await _dir.getFileHandle(FILE_NAME);
      return JSON.parse(await (await fh.getFile()).text());
    }catch(e){ return null; }
  }

  // RESTAURATION SILENCIEUSE - 0 popup garanti
  async function _tryRestoreSilent(){
    if(!_ok) return false;
    const h = await _idbLoad();
    if(!h) return false;
    try{
      _dir = h;
      const perm = await h.queryPermission({mode:'readwrite'});
      if(perm === 'granted'){
        _ready = true;
        localStorage.setItem(LS_GRANTED, '1');
        _bannerOK();
        _updateSettingsUI();
        return true;
      }
      _bannerWaiting();
      _updateSettingsUI();
      return false;
    }catch(e){ return false; }
  }

  // ACTIVATION AU LOGIN - UNE SEULE popup si necessaire, ZERO si deja granted
  async function activateOnLogin(){
    if(_ready){ _write(); return; }
    if(_dir && !_pendingPermRequest){
      _pendingPermRequest = true;
      try{
        const p = await _dir.requestPermission({mode:'readwrite'});
        _pendingPermRequest = false;
        if(p === 'granted'){
          _ready = true;
          localStorage.setItem(LS_GRANTED, '1');
          await _idbSave(_dir);
          _bannerOK();
          _updateSettingsUI();
          await _write();
          return;
        }
        _banner('\u26A0\uFE0F','Sauvegarde d\u00e9sactiv\u00e9e \u2014 permission refus\u00e9e. Cliquez sur \uD83D\uDCBE dans Param\u00e8tres pour r\u00e9activer.','#FEF3C7','#92400E');
        _updateSettingsUI();
        return;
      }catch(e){ _pendingPermRequest = false; }
    }
    if(!localStorage.getItem(LS_FOLDER)){
      await requestFolder();
    } else if(!_dir){
      const h = await _idbLoad();
      if(h){ _dir = h; await activateOnLogin(); }
    }
  }

  // Selecteur de dossier
  async function requestFolder(){
    if(!_ok){ alert('\u26A0\uFE0F Utilisez Chrome ou Edge pour la sauvegarde automatique.'); return false; }
    try{
      const chosen = await window.showDirectoryPicker({ id:'save_depense_free', mode:'readwrite', startIn:'desktop' });
      _dir   = chosen;
      _ready = true;
      localStorage.setItem(LS_FOLDER, chosen.name);
      localStorage.setItem(LS_GRANTED, '1');
      await _idbSave(chosen);
      _banner('\uD83D\uDCBE','Dossier s\u00e9lectionn\u00e9 : <strong>'+chosen.name+'<\/strong> \u2014 Sauvegarde ACTIVE','#D1FAE5');
      await _write();
      _updateSettingsUI();
      if(typeof showNotification === 'function')
        showNotification('\u2705 Dossier "'+chosen.name+'" s\u00e9lectionn\u00e9 \u2014 Sauvegarde automatique ACTIVE');
      return true;
    }catch(e){
      if(e.name !== 'AbortError') console.warn('AutoSave:',e);
      return false;
    }
  }

  async function changeFolder(){
    _ready = false; _dir = null;
    localStorage.removeItem(LS_FOLDER); localStorage.removeItem(LS_GRANTED);
    await _idbClear(); _updateSettingsUI();
    const ok = await requestFolder();
    if(!ok) _banner('\u26A0\uFE0F','Changement annul\u00e9 \u2014 sauvegarde d\u00e9sactiv\u00e9e','#FEF3C7','#92400E');
    return ok;
  }

  async function importAndApply(onDone){
    const ok = await requestFolder(); if(!ok) return;
    const data = await _read();
    if(!data || !data.users){
      _banner('\uD83D\uDCBE','Dossier pr\u00eat \u2014 aucune sauvegarde trouv\u00e9e ('+FILE_NAME+')','#FEF3C7','#92400E');
      if(onDone) onDone(null); return;
    }
    if(onDone) onDone(data);
  }

  function triggerSave(){ clearTimeout(_timer); _timer = setTimeout(()=>{ if(_ready) _write(); }, 800); }
  function getFolderName(){ return localStorage.getItem(LS_FOLDER) || null; }
  function isReady(){ return _ready; }

  document.addEventListener('DOMContentLoaded', ()=>{ _tryRestoreSilent().then(()=>_updateSettingsUI()); });

  return { requestFolder, changeFolder, activateOnLogin, triggerSave, isReady,
           importAndApply, writeNow:_write, getFolderName, updateUI:_updateSettingsUI };
})();
</script>
<style>
:root {
  --primary: #0F172A;
  --primary-light: #1E293B;
  --accent: #F59E0B;
  --accent-hover: #D97706;
  --success: #10B981;
  --success-dark: #059669;
  --danger: #DC2626;
  --danger-dark: #B91C1C;
  --bg-main: #F8FAFC;
  --bg-card: #FFFFFF;
  --text-primary: #0F172A;
  --text-secondary: #64748B;
  --border: #E2E8F0;
  --shadow-sm: 0 1px 2px rgba(0,0,0,.05);
  --shadow-md: 0 4px 6px -1px rgba(0,0,0,.1);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,.1);
  --shadow-xl: 0 20px 25px -5px rgba(0,0,0,.1);
}
/* ‚ïê‚ïê DARK MODE ‚ïê‚ïê */
body.dark-mode {
  --primary: #F1F5F9;
  --primary-light: #334155;
  --bg-main: #0F172A;
  --bg-card: #1E293B;
  --text-primary: #F1F5F9;
  --text-secondary: #94A3B8;
  --border: #334155;
  --shadow-sm: 0 1px 2px rgba(0,0,0,.3);
  --shadow-md: 0 4px 6px -1px rgba(0,0,0,.4);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,.5);
  --shadow-xl: 0 20px 25px -5px rgba(0,0,0,.6);
}
body.dark-mode input,
body.dark-mode select,
body.dark-mode textarea {
  background: #0F172A;
  color: #F1F5F9;
  border-color: #334155;
}
body.dark-mode input:focus,
body.dark-mode select:focus,
body.dark-mode textarea:focus {
  background: #0F172A;
  border-color: var(--accent);
}
body.dark-mode input[readonly] {
  background: #1E293B;
  color: #64748B;
}
body.dark-mode .auth-wrapper {
  background: linear-gradient(135deg,#020617 0%,#0F172A 50%,#1E293B 100%);
}
body.dark-mode .auth-container {
  background: #1E293B;
}
body.dark-mode tbody tr:hover { background: #0F172A !important; }
body.dark-mode tbody tr.justified-row { background: #064E3B !important; }
body.dark-mode tbody tr.not-justified-row { background: #422006 !important; }
body.dark-mode tbody tr.selected-row { background: #1E3A5F !important; outline-color: #3B82F6; }
body.dark-mode tbody tr.selected-row td { color: #93C5FD !important; }
body.dark-mode table { background: #1E293B; }
body.dark-mode td { border-bottom-color: #334155; }
body.dark-mode .list-item { background: #0F172A; border-color: #334155; }
body.dark-mode .list-item:hover { border-color: var(--accent); }
body.dark-mode .modal-content { background: #1E293B; }
body.dark-mode .error-message { background: #450A0A; color: #FCA5A5; border-color: #7F1D1D; }
body.dark-mode .success-message { background: #052E16; color: #86EFAC; border-color: #166534; }
body.dark-mode #autoSaveBanner { background: #052E16 !important; color: #86EFAC !important; border-top-color: #166534 !important; }
body.dark-mode .stat-box[style*="#DBEAFE"] { background: #1E3A5F !important; }
body.dark-mode .stat-box[style*="#D1FAE5"] { background: #052E16 !important; }
body.dark-mode .stat-box[style*="#FEE2E2"] { background: #450A0A !important; }
body.dark-mode .stat-box[style*="#FEF3C7"] { background: #422006 !important; }
body.dark-mode #viewModeTitle { background: #2D1B69 !important; color: #C4B5FD !important; }
body.dark-mode #personneFilterBanner { background: #422006 !important; border-color: #92400E !important; color: #FCD34D !important; }
/* Transition douce */
body, body * {
  transition: background-color 0.25s ease, color 0.15s ease, border-color 0.2s ease;
}
/* Bouton dark mode */
#darkModeBtn {
  width: auto;
  padding: 5px 10px;
  font-size: 15px;
  border-radius: 6px;
  box-shadow: none;
  white-space: nowrap;
  cursor: pointer;
  font-family: 'Manrope', sans-serif;
  font-weight: 700;
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  background: #1E293B;
  color: #F1F5F9;
  min-width: 34px;
}
body.dark-mode #darkModeBtn {
  background: #F59E0B;
  color: #0F172A;
}
#darkModeBtn:hover { transform: translateY(-1px); filter: brightness(1.1); }
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Manrope',-apple-system,sans-serif;background:var(--bg-main);color:var(--text-primary);min-height:100vh;line-height:1.6;-webkit-font-smoothing:antialiased}
.container{max-width:1400px;margin:0 auto;padding:20px}

/* Auth */
.auth-wrapper{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#0F172A 0%,#1E293B 50%,#334155 100%);padding:20px}
.auth-container{background:var(--bg-card);border-radius:20px;box-shadow:var(--shadow-xl);padding:48px;max-width:480px;width:100%;animation:fadeSlideUp .5s ease-out}
@keyframes fadeSlideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.auth-logo{text-align:center;margin-bottom:32px}
.auth-logo-icon{width:80px;height:80px;background:linear-gradient(135deg,var(--accent) 0%,var(--accent-hover) 100%);border-radius:20px;display:inline-flex;align-items:center;justify-content:center;font-size:40px;margin-bottom:16px;box-shadow:0 8px 16px rgba(245,158,11,.3)}
.auth-title{font-size:28px;font-weight:800;color:var(--text-primary);margin-bottom:8px}
.auth-subtitle{font-size:15px;color:var(--text-secondary)}
.form-group{margin-bottom:24px}
label{display:block;font-weight:600;color:var(--text-primary);margin-bottom:8px;font-size:14px}
input,select,textarea{width:100%;padding:12px 16px;border:2px solid var(--border);border-radius:10px;font-size:15px;font-family:'Manrope',sans-serif;transition:all .2s;background:var(--bg-card)}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(245,158,11,.1)}
input[readonly]{background:var(--bg-main);cursor:not-allowed;color:var(--text-secondary)}
.field-error{border-color:var(--danger)!important;background:#FEE2E2!important}
.field-error:focus{border-color:var(--danger)!important;box-shadow:0 0 0 3px rgba(220,38,38,.1)!important}
button{background:var(--accent);color:white;border:none;padding:14px 24px;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;transition:all .2s;font-family:'Manrope',sans-serif;width:100%;box-shadow:var(--shadow-md)}
button:hover{background:var(--accent-hover);transform:translateY(-1px);box-shadow:var(--shadow-lg)}
button:active{transform:translateY(0)}
button.secondary{background:var(--primary-light)}
button.secondary:hover{background:var(--primary)}
button.danger{background:var(--danger)}
button.danger:hover{background:var(--danger-dark)}
button.success{background:var(--success)}
button.success:hover{background:var(--success-dark)}
.btn-icon{display:inline-flex;align-items:center;gap:8px}
.switch-mode{text-align:center;margin-top:24px;color:var(--text-secondary);font-size:14px}
.switch-mode a{color:var(--accent);cursor:pointer;text-decoration:none;font-weight:600;transition:color .2s}
.switch-mode a:hover{color:var(--accent-hover);text-decoration:underline}
.error-message{background:#FEE2E2;color:#991B1B;border:1px solid #FCA5A5;padding:12px 16px;border-radius:10px;margin-top:16px;display:none;font-size:14px;font-weight:600;animation:fadeSlideUp .3s ease-out}
.success-message{background:#D1FAE5;color:#065F46;border:1px solid #6EE7B7;padding:12px 16px;border-radius:10px;margin-top:16px;display:none;font-size:14px;font-weight:600;animation:fadeSlideUp .3s ease-out}

/* App Header */
.app-header{background:var(--bg-card);border-radius:16px;padding:10px 16px;margin-bottom:16px;box-shadow:var(--shadow-sm);display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);flex-wrap:wrap;gap:8px}
.user-info{display:flex;align-items:center;gap:16px}
.user-avatar{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,var(--accent) 0%,var(--accent-hover) 100%);display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:white}
.user-details h3{font-size:14px;font-weight:700;color:var(--text-primary)}
.user-details p{font-size:11px;color:var(--text-secondary)}
.stat-box{display:flex;align-items:center;justify-content:center;gap:0;padding:12px 16px;border-radius:10px}
.stat-box .stat-icon{display:none}
.stat-box>div{display:flex;flex-direction:column;align-items:center;text-align:center;flex:1;width:100%}
.stat-box .stat-label{font-size:11px;font-weight:700;color:#64748B;text-transform:uppercase;text-align:center;letter-spacing:.04em}
.stat-box .stat-value{font-size:16px;font-weight:800;color:#0F172A;font-family:'JetBrains Mono',monospace;text-align:center;width:100%}
body.dark-mode .stat-box .stat-value{color:#FFFFFF !important}
body.dark-mode .stat-box .stat-label{color:#CBD5E1 !important}

/* Nav */
.nav-tabs{display:flex;gap:8px;background:var(--bg-card);padding:8px;border-radius:12px;margin-bottom:24px;box-shadow:var(--shadow-sm);border:1px solid var(--border);flex-wrap:wrap;align-items:center;row-gap:6px}
.nav-tab{padding:10px 20px;border-radius:8px;font-weight:600;font-size:14px;cursor:pointer;transition:all .2s;color:var(--text-secondary);background:transparent;border:none;box-shadow:none;width:auto}
.nav-tab:hover{background:var(--bg-main);color:var(--text-primary);transform:none}
.nav-tab.active{background:var(--accent);color:white;box-shadow:var(--shadow-sm)}

/* Cards */
.card{background:var(--bg-card);border-radius:16px;padding:24px;box-shadow:var(--shadow-sm);border:1px solid var(--border);margin-bottom:16px}
.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.card-title{font-size:20px;font-weight:700;color:var(--text-primary)}

/* Table */
.table-wrapper{overflow-x:auto;border-radius:12px;border:1px solid var(--border)}
table{width:100%;border-collapse:collapse;background:var(--bg-card)}
thead{background:var(--primary);color:white}
th{padding:6px 8px;text-align:left;font-weight:700;font-size:13px;text-transform:uppercase;letter-spacing:.5px}
td{padding:6px 8px;border-bottom:1px solid var(--border);font-size:14px}
#expensesTable{table-layout:auto}
#expensesTable th,#expensesTable td{padding:4px 5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:180px}
#expensesTable th:nth-child(4),#expensesTable td:nth-child(4){max-width:120px;min-width:0}
#expensesTable th:nth-child(5),#expensesTable td:nth-child(5){white-space:normal;max-width:200px}
#expensesTable th:nth-child(6),#expensesTable td:nth-child(6){min-width:0;width:auto}
tbody tr{transition:background .2s;cursor:pointer}
tbody tr:hover{background:var(--bg-main)}
tbody tr:last-child td{border-bottom:none}
.justified-row{background:#ECFDF5}
.not-justified-row{background:#FEF3C7}
.enplus-solde-row{background:#0A0A0A !important}
.enplus-solde-row td{color:#4ADE80 !important;border-bottom-color:#1a3a1a !important}
.enplus-solde-row td strong{color:#86EFAC !important}
.enplus-nonsolde-row{background:#1A1A1A !important}
.enplus-nonsolde-row td{color:#FCA5A5 !important;border-bottom-color:#3a1a1a !important}
.enplus-nonsolde-row td strong{color:#FCA5A5 !important}
#expensesTable tbody tr.selected-row{background:#DBEAFE!important;outline:2px solid #3B82F6;outline-offset:-2px}
#expensesTable tbody tr.selected-row td{color:#1E40AF}
.alert-badge{display:inline-flex;align-items:center;padding:4px 8px;background:var(--danger);color:white;border-radius:6px;font-size:11px;font-weight:700;margin-top:4px}

/* List Items */
.list-items{display:flex;flex-direction:column;gap:12px}
.list-item{background:var(--bg-main);border:1px solid var(--border);border-radius:12px;padding:16px;display:flex;justify-content:space-between;align-items:center;transition:all .2s}
.list-item:hover{border-color:var(--accent);box-shadow:var(--shadow-sm)}
.list-item-info{flex:1}
.list-item-code{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;color:var(--accent);margin-bottom:4px}
.list-item-name{font-size:16px;font-weight:700;color:var(--text-primary);margin-bottom:2px}
.list-item-desc{font-size:13px;color:var(--text-secondary)}
.list-item button{width:auto;padding:8px 16px;font-size:13px}
input[type="checkbox"]{width:20px;height:20px;cursor:pointer;accent-color:var(--accent)}

/* Pages */
.page{display:none;animation:fadeSlideUp .3s ease-out}
.page.active{display:block}

/* Empty State */
.empty-state{text-align:center;padding:48px 24px;color:var(--text-secondary)}
.empty-state-icon{font-size:64px;margin-bottom:16px;opacity:.5}
.empty-state-text{font-size:16px;font-weight:600}

/* Modal */
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:9999;justify-content:center;align-items:center;animation:fadeIn .2s ease-out}
.modal.active{display:flex}
.modal-content{background:var(--bg-card);border-radius:20px;padding:32px;max-width:450px;width:90%;box-shadow:var(--shadow-xl);animation:slideUp .3s ease-out}
.modal-content.wide{max-width:800px}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.modal-title{font-size:20px;font-weight:700;color:var(--text-primary);margin-bottom:8px;display:flex;align-items:center;gap:10px}
.modal-subtitle{font-size:14px;color:var(--text-secondary);margin-bottom:24px}
.modal-buttons{display:flex;gap:12px;margin-top:20px}
.modal-buttons button{flex:1}

/* Utility */
.flex-between{display:flex;justify-content:space-between;align-items:center;gap:12px}
.text-mono{font-family:'JetBrains Mono',monospace}
.mt-2{margin-top:16px}

/* Form grids */
.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:20px}
.expense-form-grid{display:grid;grid-template-columns:130px 220px 140px minmax(120px,200px) 210px 140px 56px;gap:4px;margin-bottom:0;align-items:flex-end}
.expense-form-grid-row2{display:grid;grid-template-columns:minmax(0,1fr) 60px auto auto;gap:4px;margin-top:4px;align-items:flex-end}
@media(max-width:1200px){.expense-form-grid{grid-template-columns:repeat(3,1fr)}.expense-form-grid-row2{grid-template-columns:repeat(2,1fr)}}
@media(max-width:768px){.expense-form-grid{grid-template-columns:1fr}.app-header{flex-direction:column;gap:16px}.form-grid{grid-template-columns:1fr}th,td{padding:12px 8px;font-size:13px}}
/* Masquer les fl√®ches des champs number */
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
input[type=number]{-moz-appearance:textfield;appearance:textfield}

/* Filtre Personne */
#personneHeaderTh { transition: background .2s, color .2s; }
#personneHeaderTh:hover { background: rgba(245,158,11,.15); }
#personneSearchInput:focus { border-color: #F59E0B !important; box-shadow: 0 0 0 3px rgba(245,158,11,.2) !important; }
#personneFilterBanner { animation: fadeSlideUp .2s ease-out; }

/* D√©pense En Plus ‚Äî SOLD√âE : fond noir + texte vert forc√© */
tr.enplus-solde-row td,
tbody tr.enplus-solde-row td,
#expensesTable tbody tr.enplus-solde-row td {
  color: #4ADE80 !important;
  background: #0A0A0A !important;
  border-bottom-color: #1a3a1a !important;
}
tr.enplus-solde-row td strong,
tbody tr.enplus-solde-row td strong,
#expensesTable tbody tr.enplus-solde-row td strong {
  color: #86EFAC !important;
}
tr.enplus-solde-row:hover td,
tbody tr.enplus-solde-row:hover td,
#expensesTable tbody tr.enplus-solde-row:hover td {
  background: #0f1f0f !important;
  color: #4ADE80 !important;
}

/* D√©pense En Plus ‚Äî NON SOLD√âE : fond noir + texte rouge clair forc√© */
tr.enplus-nonsolde-row td,
tbody tr.enplus-nonsolde-row td,
#expensesTable tbody tr.enplus-nonsolde-row td {
  color: #FCA5A5 !important;
  background: #1A1A1A !important;
  border-bottom-color: #3a1a1a !important;
}
tr.enplus-nonsolde-row td strong,
tbody tr.enplus-nonsolde-row td strong,
#expensesTable tbody tr.enplus-nonsolde-row td strong {
  color: #FCA5A5 !important;
}
tr.enplus-nonsolde-row:hover td,
tbody tr.enplus-nonsolde-row:hover td,
#expensesTable tbody tr.enplus-nonsolde-row:hover td {
  background: #2a1010 !important;
  color: #FCA5A5 !important;
}
</style>
</head>
<body>

<!-- BANNI√àRE AUTO-SAVE (visible dans l'app) -->
<div id="autoSaveBanner" style="display:none;position:fixed;bottom:0;left:0;right:0;padding:8px 20px;font-size:12px;font-weight:700;color:#065F46;z-index:88888;align-items:center;gap:10px;border-top:2px solid #6EE7B7;font-family:'Manrope',sans-serif"></div>

<!-- AUTH SCREEN -->
<div id="authScreen">
  <div class="auth-wrapper">
    <div id="loginForm" class="auth-container">
      <div class="auth-logo">
        <div class="auth-logo-icon">üí∞</div>
        <h1 class="auth-title">Gestion des D√©penses</h1>
        <p class="auth-subtitle">G√©rez vos finances intelligemment</p>
      </div>
      <div class="form-group">
        <label>Nom d'utilisateur</label>
        <input type="text" id="loginUsername" list="loginUsernameList" placeholder="Saisir ou s√©lectionner un compte..." autocomplete="off">
        <datalist id="loginUsernameList"></datalist>
      </div>
      <div class="form-group">
        <label>Mot de passe</label>
        <input type="password" id="loginPassword" placeholder="Votre mot de passe">
      </div>
      <button onclick="login()" class="btn-icon"><span>üîì</span><span>Se Connecter</span></button>
      <div id="loginError" class="error-message"></div>
      <!-- Bouton de r√©cup√©ration locale d'urgence -->
      <div id="localRecoveryBox" style="display:none;margin-top:12px;padding:12px 16px;background:#FEF3C7;border:2px solid #FCD34D;border-radius:10px">
        <div style="font-weight:800;color:#92400E;margin-bottom:6px;font-size:13px">‚ö†Ô∏è Connexion bloqu√©e par Supabase ?</div>
        <div style="font-size:12px;color:#78350F;margin-bottom:10px">Des comptes locaux ont √©t√© d√©tect√©s. Cliquez ci-dessous pour vous connecter en mode hors-ligne uniquement.</div>
        <button onclick="forceLocalLogin()" style="padding:8px 14px;font-size:13px;background:#D97706;width:100%">üîì Connexion Locale Forc√©e (Hors-ligne)</button>
      </div>
      <div id="importSaveInfo" style="display:none;background:#D1FAE5;color:#065F46;border:1px solid #6EE7B7;border-radius:10px;padding:12px 16px;margin-top:12px;font-size:13px;font-weight:600;animation:fadeSlideUp .3s ease-out"></div>
      <div id="loginSaveInfoBox" style="margin-top:16px;padding:12px 16px;background:#EFF6FF;border:1px solid #BFDBFE;border-radius:10px;display:flex;align-items:flex-start;gap:10px">
        <span style="font-size:20px;flex-shrink:0" id="loginSaveIcon">üíæ</span>
        <div>
          <div style="font-size:12px;font-weight:800;color:#1E40AF;margin-bottom:4px" id="loginSaveTitle">Sauvegarde automatique</div>
          <div id="loginSaveFolderInfo" style="font-size:11px;color:#3B82F6;line-height:1.7">
            Chargement...
          </div>
        </div>
      </div>
      <script>
      // Mettre √† jour l'info de sauvegarde sur la page de login
      document.addEventListener('DOMContentLoaded', function(){
        setTimeout(function(){
          const folderName = localStorage.getItem('fsAutoSaveFolderName');
          const infoEl = document.getElementById('loginSaveFolderInfo');
          const iconEl = document.getElementById('loginSaveIcon');
          const titleEl = document.getElementById('loginSaveTitle');
          const boxEl = document.getElementById('loginSaveInfoBox');
          if(!infoEl) return;
          if(folderName){
            iconEl.textContent = 'üîí';
            titleEl.textContent = 'Sauvegarde m√©moris√©e';
            boxEl.style.background = '#FEF3C7';
            boxEl.style.border = '1px solid #FCD34D';
            titleEl.style.color = '#92400E';
            infoEl.style.color = '#92400E';
            infoEl.innerHTML = 'Dossier : <strong>' + folderName + '</strong><br>Cliquez <strong>Se Connecter</strong> pour r√©activer la sauvegarde automatique.<br><span style="font-size:10px;opacity:.8">(Une seule autorisation sera demand√©e)</span>';
          } else {
            iconEl.textContent = 'üíæ';
            titleEl.textContent = 'Sauvegarde automatique';
            boxEl.style.background = '#EFF6FF';
            boxEl.style.border = '1px solid #BFDBFE';
            titleEl.style.color = '#1E40AF';
            infoEl.style.color = '#3B82F6';
            infoEl.innerHTML = '√Ä la connexion, choisissez le dossier de sauvegarde de votre choix.<br>Ce choix est m√©moris√© ‚Äî vous pouvez le changer √† tout moment dans <strong>Param√®tres</strong>.';
          }
        }, 200);
      });
      </script>
      <div class="switch-mode"><p>Pas de compte ? <a onclick="showRegister()">Cr√©er un compte</a></p></div>
    </div>
    <div id="registerForm" class="auth-container" style="display:none">
      <div class="auth-logo">
        <div class="auth-logo-icon" id="registerLogoIcon">üìù</div>
        <h1 class="auth-title" id="registerTitle">Cr√©er un Compte</h1>
        <p class="auth-subtitle" id="registerSubtitle">Commencez √† g√©rer vos d√©penses</p>
      </div>
      <div id="registerTypeBadge" style="display:none;margin-bottom:18px;padding:10px 16px;border-radius:10px;font-size:13px;font-weight:700;text-align:center"></div>
      <div class="form-group"><label>Nom d'utilisateur</label><input type="text" id="registerUsername" placeholder="Choisir un nom d'utilisateur"></div>
      <div class="form-group"><label>Nom complet</label><input type="text" id="registerFullName" placeholder="Votre nom complet"></div>
      <div class="form-group"><label>Email</label><input type="email" id="registerEmail" placeholder="votre.email@gmail.com"></div>
      <div class="form-group"><label>Mot de passe</label><input type="password" id="registerPassword" placeholder="Min. 4 caract√®res"></div>
      <div class="form-group"><label>Confirmer le mot de passe</label><input type="password" id="registerPasswordConfirm" placeholder="Confirmer"></div>
      <button onclick="register()" class="btn-icon"><span>‚úÖ</span><span>Cr√©er mon Compte</span></button>
      <div id="registerError" class="error-message"></div>
      <div id="registerSuccess" class="success-message"></div>
      <div class="switch-mode"><p>D√©j√† un compte ? <a onclick="showLogin()">Se connecter</a></p></div>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="mainApp" style="display:none">
  <div class="container">
    <div class="app-header" style="flex-direction:column;align-items:stretch;gap:10px;padding:12px 16px">

      <!-- ‚îÄ‚îÄ LIGNE 1 : Infos utilisateur + Boutons ‚îÄ‚îÄ -->
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <div class="user-info" style="flex:0 0 auto">
          <div class="user-avatar" id="userAvatar">üë§</div>
          <div class="user-details">
            <h3 id="currentUserDisplay"></h3>
            <p>Compte actif</p>
          </div>
        </div>

        <div style="flex:1"></div>

        <!-- Boutons action -->

        <div style="width:1px;height:28px;background:var(--border);margin:0 4px"></div>

        <!-- Boutons export / save -->
        <button onclick="openExportByDateModal()" style="width:auto;padding:6px 12px;font-size:13px;background:var(--success)" title="Export par date">üìÖ</button>
        <button onclick="openExportByMonthModal()" style="width:auto;padding:6px 12px;font-size:13px;background:var(--success)" title="Export par mois">üìä</button>
        <button onclick="manualSaveToFolder()" style="width:auto;padding:6px 12px;font-size:13px;background:#3B82F6" title="Sauvegarder maintenant">üíæ</button>

        <div style="width:1px;height:28px;background:var(--border);margin:0 4px"></div>

        <button class="secondary" onclick="logout()" style="width:auto;padding:6px 12px;font-size:12px;font-weight:700">D√©connecter</button>
      </div>

      <!-- ‚îÄ‚îÄ LIGNE 2 : Montants / Statistiques ‚îÄ‚îÄ -->
      <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-start">
        <div class="stat-box" style="background:#DBEAFE;flex:1;min-width:160px"><div class="stat-icon">üíº</div><div><div class="stat-label">Solde Pr√©c.</div><div class="stat-value" id="previousBalanceHeader">0,00 DA</div></div></div>
        <div class="stat-box" style="background:#D1FAE5;flex:1;min-width:160px"><div class="stat-icon">üì•</div><div><div class="stat-label">Entr√©es</div><div class="stat-value" id="totalCashInHeader">0,00 DA</div></div></div>
        <div class="stat-box" style="background:#FEE2E2;flex:1;min-width:160px"><div class="stat-icon">üì§</div><div><div class="stat-label">D√©penses</div><div class="stat-value" id="totalExpensesHeader">0,00 DA</div></div></div>
        <div class="stat-box" style="background:#FEF3C7;flex:1;min-width:160px"><div class="stat-icon">‚ö†Ô∏è</div><div><div class="stat-label">Non Just.</div><div class="stat-value" id="totalNotJustifiedHeader">0,00 DA</div></div></div>
        <div class="stat-box" style="background:#DBEAFE;flex:1;min-width:160px"><div class="stat-icon">üí∞</div><div><div class="stat-label">Solde Actuel</div><div class="stat-value" id="currentBalanceHeader">0,00 DA</div></div></div>
      </div>

    </div>

    <div class="nav-tabs">
      <button class="nav-tab active" onclick="showPage('main')">üìä D√©penses</button>
      <button class="nav-tab" onclick="showPage('alimentations')">üí∞ Alimentations</button>
      <button onclick="closeMonth()" style="width:auto;padding:10px 14px;font-size:14px;background:linear-gradient(135deg,#10B981 0%,#059669 100%);color:white;border-radius:8px;box-shadow:var(--shadow-sm);border:none;cursor:pointer;transition:all .2s;font-family:'Manrope',sans-serif;display:flex;align-items:center;gap:6px;font-weight:700" onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 6px 16px rgba(16,185,129,.4)'" onmouseout="this.style.transform='';this.style.boxShadow='var(--shadow-sm)'">üîí <span style="font-size:13px">Cl√¥turer</span></button>
      <!-- ‚îÄ‚îÄ GROUPE DROITE : Personnes / Libell√©s / Projets / Actualiser / Remboursement / Param√®tres ‚îÄ‚îÄ -->
      <div style="display:flex;gap:4px;align-items:center;margin-left:auto;flex-wrap:nowrap">
        <button class="nav-tab" onclick="showPage('persons')" style="margin-left:0">üë• Personnes</button>
        <button class="nav-tab" onclick="showPage('labels')" style="margin-left:0">üè∑Ô∏è Libell√©s</button>
        <button class="nav-tab" onclick="showPage('projets')" style="margin-left:0">üìÅ Projets</button>
        <div style="width:1px;height:24px;background:rgba(255,255,255,.2);margin:0 2px"></div>
        <button onclick="refreshAllData()" title="Actualiser toutes les donn√©es" id="globalRefreshBtn" style="width:auto;padding:10px 14px;font-size:14px;background:linear-gradient(135deg,#0EA5E9 0%,#0284C7 100%);color:white;border-radius:8px;box-shadow:var(--shadow-sm);border:none;cursor:pointer;transition:all .2s;font-family:'Manrope',sans-serif;display:flex;align-items:center;gap:6px;font-weight:700" onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 6px 16px rgba(14,165,233,.4)'" onmouseout="this.style.transform='';this.style.boxShadow='var(--shadow-sm)'">üîÑ <span style="font-size:13px">Actualiser</span></button>
        <button id="remboursementNavTab" onclick="openEtatRembModal()" style="width:auto;padding:10px 12px;font-size:14px;background:linear-gradient(135deg,#10B981 0%,#059669 100%);color:white;border-radius:8px;box-shadow:var(--shadow-sm);border:none;cursor:pointer;transition:all .2s;font-family:'Manrope',sans-serif;display:flex;align-items:center;gap:6px;font-weight:700" onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 6px 16px rgba(16,185,129,.4)'" onmouseout="this.style.transform='';this.style.boxShadow='var(--shadow-sm)'">üí∞ <span style="font-size:13px">Remboursement</span></button>
        <div style="width:1px;height:24px;background:rgba(255,255,255,.2);margin:0 2px"></div>
        <button class="nav-tab" onclick="showPage('settings')" style="margin-left:0">‚öôÔ∏è Param√®tres</button>
      </div>
      <!-- ‚îÄ‚îÄ S√âLECTEUR DE VUE + NAVIGATEUR + ALIM (2e ligne compl√®te) ‚îÄ‚îÄ -->
      <div style="display:flex;gap:6px;align-items:center;width:100%;flex-wrap:nowrap">
        <!-- S√©lecteur Mois/Ann√©e/Global -->
        <div style="display:flex;gap:0;align-items:center;background:#1E293B;border-radius:8px;padding:3px">
          <button id="viewBtn_month"  onclick="setViewMode('month')"  style="width:auto;padding:5px 11px;font-size:11px;font-weight:700;border-radius:5px;background:var(--accent);color:white;box-shadow:none">üìÖ Mois</button>
          <button id="viewBtn_year"   onclick="setViewMode('year')"   style="width:auto;padding:5px 11px;font-size:11px;font-weight:700;border-radius:5px;background:transparent;color:#94A3B8;box-shadow:none">üìÜ Ann√©e</button>
          <button id="viewBtn_global" onclick="setViewMode('global')" style="width:auto;padding:5px 11px;font-size:11px;font-weight:700;border-radius:5px;background:transparent;color:#94A3B8;box-shadow:none">üåê Global</button>
        </div>

        <!-- Navigateur mois -->
        <div id="monthNavWrapper" style="display:flex;gap:0">
          <button class="nav-tab" onclick="goToFirstMonth()" title="Premier mois" style="width:auto;padding:5px 9px;font-size:12px;background:#2563EB;color:white;border-radius:6px 0 0 6px;box-shadow:none;border-right:1px solid rgba(255,255,255,.25)">‚èÆ</button>
          <button class="nav-tab" onclick="previousMonth()" title="Mois pr√©c√©dent" style="width:auto;padding:5px 9px;font-size:12px;background:#3B82F6;color:white;border-radius:0;box-shadow:none">‚óÄ</button>
          <div id="currentMonth" style="padding:5px 12px;font-size:12px;font-weight:700;color:white;background:#3B82F6;display:flex;align-items:center;border-radius:0;min-width:110px;justify-content:center"></div>
          <button class="nav-tab" onclick="nextMonth()" title="Mois suivant" style="width:auto;padding:5px 9px;font-size:12px;background:#3B82F6;color:white;border-radius:0;box-shadow:none">‚ñ∂</button>
          <button class="nav-tab" onclick="goToLastMonth()" title="Dernier mois" style="width:auto;padding:5px 9px;font-size:12px;background:#2563EB;color:white;border-radius:0 6px 6px 0;box-shadow:none;border-left:1px solid rgba(255,255,255,.25)">‚è≠</button>
        </div>
        <!-- Navigateur ann√©e -->
        <div id="yearNavWrapper" style="display:none;gap:0">
          <button class="nav-tab" onclick="previousYear()" style="width:auto;padding:5px 9px;font-size:12px;background:#7C3AED;color:white;border-radius:6px 0 0 6px;box-shadow:none">‚óÄ</button>
          <div id="currentYearDisplay" style="padding:5px 12px;font-size:12px;font-weight:700;color:white;background:#7C3AED;display:flex;align-items:center;border-radius:0;min-width:60px;justify-content:center"></div>
          <button class="nav-tab" onclick="nextYear()" style="width:auto;padding:5px 9px;font-size:12px;background:#7C3AED;color:white;border-radius:0 6px 6px 0;box-shadow:none">‚ñ∂</button>
        </div>
        <!-- Vue globale -->
        <div id="globalNavWrapper" style="display:none;padding:5px 12px;font-size:11px;font-weight:700;color:white;background:#059669;border-radius:6px;align-items:center">üåê Toutes les p√©riodes</div>

        <!-- D√©tail Alim + Etat Alim ‚Äî extr√™me droite de la 2e ligne -->
        <div style="display:flex;gap:4px;align-items:center;margin-left:auto">
          <button id="darkModeBtn" onclick="toggleDarkMode()" title="Mode Nuit / Jour">üåô</button>
          <button onclick="showPage('alimentations')" style="width:auto;padding:5px 10px;font-size:11px;font-weight:700;background:var(--success);color:white;border-radius:6px;box-shadow:none;white-space:nowrap">üí∞ D√©tail Alim</button>
          <button onclick="openCashInStatsModal()" title="Etat des alimentations" style="width:auto;padding:5px 10px;font-size:11px;font-weight:700;background:#3B82F6;color:white;border-radius:6px;box-shadow:none;white-space:nowrap">üìà Etat Alim</button>
        </div>
      </div>
    </div>

    <!-- D√âPENSES PAGE -->
    <div id="mainPage" class="page active">
      <div class="card" style="padding:4px 8px;overflow:visible">
        <!-- LIGNE 1 : Date | Personne | Montant | Projet | Libell√© | Code | Justifi√© -->
        <div style="display:flex;flex-wrap:nowrap;gap:4px;align-items:flex-end;margin-bottom:0;overflow-x:visible;overflow-y:visible">
          <!-- Date -->
          <div class="form-group" style="margin-bottom:0;flex:0 0 130px;min-width:110px">
            <label style="font-size:11px;margin-bottom:1px;display:block">Date</label>
            <input type="date" id="expenseDate" style="padding:3px 6px;font-size:12px;width:100%" onchange="(function(el){const mk=el.value.substring(0,7);if(_dateInClosedMonth(el.value)){_alertMonthLocked(mk);el.value='';}else if(_dateInMonthWithoutCashIn(el.value)){alert('‚ö†Ô∏è Alimentation de caisse du mois de '+_mkToLabel(mk)+' manquante.\nVeuillez d\'abord ajouter une alimentation avant de saisir une d√©pense.');el.value='';}})(this)">
          </div>
          <!-- Personne -->
          <div class="form-group" style="margin-bottom:0;flex:0 0 210px;min-width:140px;position:relative">
            <label style="font-size:11px;margin-bottom:1px;display:block">Personne</label>
            <div style="position:relative">
              <input type="text" id="expensePerson" placeholder="Tapez pour rechercher..." style="padding:3px 24px 3px 6px;font-size:12px;width:100%;cursor:pointer" autocomplete="off" onkeyup="filterPersonsDropdown()" onfocus="openPersonsDropdown()" onblur="setTimeout(closePersonsDropdown,300)">
              <span onmousedown="event.preventDefault();openPersonsDropdown();document.getElementById('expensePerson').focus()" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;color:#64748B;font-size:11px">‚ñº</span>
              <input type="hidden" id="expensePersonId" value="">
              <div id="personsDropdownList" onmousedown="event.preventDefault()" style="display:none;position:absolute;top:100%;left:0;right:0;background:white;border:2px solid var(--accent);border-top:none;border-radius:0 0 10px 10px;max-height:220px;overflow-y:auto;z-index:9999;box-shadow:0 10px 25px rgba(0,0,0,.2)"></div>
            </div>
          </div>
          <!-- Montant -->
          <div class="form-group" style="margin-bottom:0;flex:0 0 130px;min-width:100px">
            <label style="font-size:11px;margin-bottom:1px;display:block">Montant (DA)</label>
            <input type="number" id="expenseAmount" step="0.01" placeholder="0.00" style="padding:3px 6px;font-size:12px;width:100%">
          </div>
          <!-- Projet -->
          <div class="form-group" style="margin-bottom:0;flex:0 0 180px;min-width:120px;position:relative">
            <label style="font-size:11px;margin-bottom:1px;display:block">Projet</label>
            <div id="projetDropdownWrapper" style="position:relative">
              <input type="text" id="expenseProjetSearch" placeholder="Rechercher..." style="padding:3px 20px 3px 5px;font-size:12px;width:100%;cursor:pointer" autocomplete="off" onkeyup="filterProjetsDropdown()" onfocus="openProjetsDropdown()" onblur="setTimeout(closeProjetsDropdown,300)">
              <span onmousedown="event.preventDefault();openProjetsDropdown();document.getElementById('expenseProjetSearch').focus()" style="position:absolute;right:5px;top:50%;transform:translateY(-50%);pointer-events:all;cursor:pointer;color:#64748B;font-size:11px">‚ñº</span>
              <input type="hidden" id="expenseProjet" value="">
              <div id="projetsDropdownList" onmousedown="event.preventDefault()" style="display:none;position:absolute;top:100%;left:0;right:0;background:white;border:2px solid var(--accent);border-top:none;border-radius:0 0 10px 10px;max-height:220px;overflow-y:auto;z-index:9999;box-shadow:0 10px 25px rgba(0,0,0,.2)"></div>
            </div>
          </div>
          <!-- Libell√© -->
          <div class="form-group" style="margin-bottom:0;flex:1 1 180px;min-width:130px">
            <label id="libelleLabelEl" style="font-size:11px;margin-bottom:1px;display:block">Libell√© <span id="libelleRequired" style="color:#DC2626;font-weight:900">*</span></label>
            <select id="expenseLabel" onchange="updateAccountingCode()" style="padding:3px 6px;font-size:12px;width:100%"><option value="">S√©lectionner...</option></select>
          </div>
          <!-- Code -->
          <div class="form-group" style="margin-bottom:0;flex:0 0 110px;min-width:80px">
            <label style="font-size:11px;margin-bottom:1px;display:block">Code</label>
            <input type="text" id="expenseCode" readonly placeholder="Auto" style="padding:3px 6px;font-size:12px;width:100%">
          </div>
          <!-- Justifi√© ‚Äî extr√™me droite, m√™me ligne, jamais wrap -->
          <div style="flex:0 0 auto;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;padding-bottom:1px;gap:1px;margin-left:2px">
            <label for="expenseJustified" style="font-size:10px;font-weight:700;color:var(--text-secondary);white-space:nowrap;cursor:pointer;margin-bottom:0">Justifi√©</label>
            <input type="checkbox" id="expenseJustified" checked style="width:20px;height:20px;cursor:pointer;accent-color:var(--success);display:block" onchange="updateLibelleRequired()">
          </div>
        </div>
        <!-- LIGNE 2 : Description(50%) + Justifi√© | Btn √âtat NJ | Taille police | Ajouter -->
        <div class="expense-form-grid-row2" style="grid-template-columns:minmax(0,1fr) auto auto auto">
          <div class="form-group" style="margin-bottom:0">
            <label style="font-size:11px;margin-bottom:1px;display:block">Description</label>
            <div style="display:flex;align-items:center;gap:8px">
              <input type="text" id="expenseDescription" placeholder="Auto" style="padding:3px 6px;font-size:12px;width:50%;min-width:120px;flex-shrink:0">
              <!-- CASE √Ä COCHER D√âPENSE EN PLUS ‚Äî m√™me style que Justifi√© -->
              <div style="flex:0 0 auto;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;padding-bottom:1px;gap:1px;margin-left:2px">
                <label for="expenseEnPlus" style="font-size:10px;font-weight:700;color:var(--text-secondary);white-space:nowrap;cursor:pointer;margin-bottom:0">D√©p. en +</label>
                <input type="checkbox" id="expenseEnPlus" style="width:20px;height:20px;cursor:pointer;accent-color:#e94560;display:block" onchange="toggleEnPlusStyle(this.checked)">
              </div>
            </div>
          </div>
          <div class="form-group" style="margin-bottom:0">
            <label style="font-size:11px;margin-bottom:1px;visibility:hidden;display:block">_</label>
            <div style="display:flex;align-items:center;gap:5px">
              <!-- ‚îÄ‚îÄ BOUTONS MODE ID ‚îÄ‚îÄ -->
              <div id="idModeGroup" style="display:flex;align-items:center;background:#F1F5F9;border:1.5px solid var(--border);border-radius:8px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.08)">
                <button id="idModeBtn0"
                  onclick="setIdMode('0')"
                  title="ID:0 ‚Äî Num√©rotation s√©quentielle continue (l'ID supprim√© n'est jamais r√©utilis√©)"
                  style="width:auto;padding:5px 9px;font-size:11px;font-weight:800;font-family:'JetBrains Mono',monospace;background:#1D4ED8;color:white;border:none;border-radius:0;box-shadow:none;cursor:pointer;white-space:nowrap;transition:all .15s;letter-spacing:.03em">
                  ID:0
                </button>
                <button id="idModeBtnGt"
                  onclick="setIdMode('>')"
                  title="ID:> ‚Äî R√©utilise le premier ID libre (recycle les num√©ros supprim√©s)"
                  style="width:auto;padding:5px 9px;font-size:11px;font-weight:800;font-family:'JetBrains Mono',monospace;background:transparent;color:#64748B;border:none;border-left:1px solid var(--border);border-radius:0;box-shadow:none;cursor:pointer;white-space:nowrap;transition:all .15s;letter-spacing:.03em">
                  ID:&gt;
                </button>
              </div>
              <div style="width:1px;height:22px;background:var(--border)"></div>
              <button onclick="openEtatNJModal()" style="width:auto;padding:5px 10px;font-size:11px;font-weight:800;background:linear-gradient(135deg,#DC2626,#991B1B);color:white;border-radius:8px;white-space:nowrap;border:none;cursor:pointer;display:flex;align-items:center;gap:5px;box-shadow:0 2px 8px rgba(220,38,38,.4)" onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform=''">üí∞ Solde D√©pense non justifi√©</button>
            </div>
          </div>
          <div class="form-group" style="margin-bottom:0">
            <label style="font-size:11px;margin-bottom:1px;white-space:nowrap;display:block">üî° Taille police</label>
            <div style="display:flex;align-items:center;gap:3px">
              <div style="display:flex;align-items:center;background:#F1F5F9;border:1.5px solid var(--border);border-radius:7px;overflow:hidden">
                <button onclick="changeTableFontSize(-1)" title="R√©duire" style="width:auto;padding:2px 6px;font-size:12px;font-weight:700;background:transparent;color:var(--text-primary);box-shadow:none;border-radius:0;border-right:1px solid var(--border);transform:none" onmouseover="this.style.background='#E2E8F0'" onmouseout="this.style.background='transparent'">A‚àí</button>
                <span id="tableFontSizeDisplay" style="padding:2px 7px;font-size:11px;font-weight:800;color:var(--accent);min-width:32px;text-align:center;font-family:'JetBrains Mono',monospace">14px</span>
                <button onclick="changeTableFontSize(1)" title="Agrandir" style="width:auto;padding:2px 6px;font-size:12px;font-weight:700;background:transparent;color:var(--text-primary);box-shadow:none;border-radius:0;border-left:1px solid var(--border);transform:none" onmouseover="this.style.background='#E2E8F0'" onmouseout="this.style.background='transparent'">A+</button>
              </div>
              <button onclick="resetTableFontSize()" title="R√©initialiser" style="width:auto;padding:2px 5px;font-size:10px;font-weight:600;background:#64748B;box-shadow:none;border-radius:6px;white-space:nowrap">‚Ü∫ R√©init.</button>
            </div>
          </div>
          <div class="form-group" style="margin-bottom:0"><label style="font-size:11px;margin-bottom:1px;visibility:hidden;display:block">Action</label><div style="display:flex;gap:6px;justify-content:flex-end"><button onclick="addExpense()" id="addExpenseBtn" style="width:auto;padding:6px 16px;font-size:12px;white-space:nowrap">Ajouter</button><button id="cancelEditBtn" class="secondary" onclick="cancelEdit()" style="display:none;width:auto;padding:6px 12px;font-size:12px">Annuler</button></div></div>
        </div>
      </div>
      <div class="card" style="padding:12px 16px">
        <!-- Titre dynamique vue ann√©e/global -->
        <div id="viewModeTitle" style="display:none;margin-bottom:10px;padding:8px 14px;border-radius:8px;font-size:13px;font-weight:700;background:#EDE9FE;color:#5B21B6"></div>

        <div id="personneFilterBanner" style="display:none;margin-bottom:8px;padding:8px 14px;background:#FEF3C7;border:2px solid #FCD34D;border-radius:10px;font-size:13px;font-weight:700;color:#92400E;align-items:center;gap:8px">
          üîç Filtre personne : <span id="personneFilterBannerText" style="color:#D97706;font-style:italic"></span>
          &nbsp;‚Äî&nbsp;
          <a onclick="clearPersonneFilter()" style="color:#B45309;cursor:pointer;text-decoration:underline;font-weight:800">‚úï Effacer</a>
        </div>

        <div class="table-wrapper">
          <table id="expensesTable">
            <thead><tr id="transactionsTableHead"><th style="min-width:44px;text-align:center">ID</th><th>Date</th><th id="personneHeaderTh" onclick="togglePersonneDropdown(event)" title="Cliquer pour filtrer par personne" style="cursor:pointer;user-select:none;position:relative;min-width:160px">
              <span style="display:flex;align-items:center;gap:6px;white-space:nowrap;pointer-events:none">Personne <span style="font-size:10px;opacity:.6">‚¨á</span></span>
            </th><th>Montant</th><th>Projet</th><th>Description</th><th>Libell√©</th><th>Code</th><th id="justifiedHeaderTh" onclick="toggleJustifiedSort()" title="Cliquer pour trier" style="cursor:pointer;user-select:none;white-space:nowrap;transition:background .2s" onmouseover="this.style.background='rgba(245,158,11,.15)'" onmouseout="this.style.background=window._justifiedSort?'#D1FAE5':''"><span style="display:flex;align-items:center;justify-content:center;gap:5px">Justifi√© <span id="justifiedSortIcon" style="font-size:11px;opacity:.7">‚áÖ</span></span></th><th>Actions</th></tr></thead>
            <tbody id="transactionsTable"><tr><td colspan="9"><div class="empty-state"><div class="empty-state-icon">üì≠</div><div class="empty-state-text">Aucune d√©pense pour ce mois</div></div></td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- REMBOURSEMENT PAGE -->
    <div id="remboursementPage" class="page">
      <div class="card" style="padding:12px 16px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div>
            <h2 style="font-size:18px;font-weight:800;color:#6d28d9;display:flex;align-items:center;gap:8px;margin:0">üíú Interface de Remboursement</h2>
            <p style="font-size:12px;color:#7c3aed;margin:2px 0 0 0" id="remboursementSubtitle">G√©rez les remboursements li√©s aux d√©penses en plus</p>
          </div>
          <div id="remboursementSoldeGlobal" style="background:linear-gradient(135deg,#6d28d9,#4c1d95);color:white;padding:8px 18px;border-radius:10px;font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:800;display:none"></div>
        </div>
        <!-- Filtre d√©pense en plus -->
        <div style="margin-bottom:10px;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
          <label style="font-size:12px;font-weight:700;color:#6d28d9">D√©pense en plus :</label>
          <select id="remboursementDepenseSelect" onchange="loadRemboursementForDepense(this.value)" style="padding:5px 10px;font-size:12px;border:2px solid #7c3aed;border-radius:8px;min-width:260px;font-weight:700">
            <option value="">‚Äî S√©lectionner une d√©pense en plus ‚Äî</option>
          </select>
          <button onclick="showPage('main')" style="width:auto;padding:5px 12px;font-size:12px;background:#6d28d9;border-radius:7px">‚¨Ö Retour D√©penses</button>
        </div>
        <!-- Table remboursements -->
        <div class="table-wrapper">
          <table id="remboursementTable" style="width:100%;border-collapse:collapse">
            <thead>
              <tr style="background:linear-gradient(135deg,#6d28d9,#4c1d95)">
                <th style="padding:8px 12px;color:white;font-size:12px;text-align:left">Date</th>
                <th style="padding:8px 12px;color:white;font-size:12px;text-align:left">Personne</th>
                <th style="padding:8px 12px;color:white;font-size:12px;text-align:right">Montant (DA)</th>
                <th style="padding:8px 12px;color:white;font-size:12px;text-align:left">Description</th>
                <th style="padding:8px 12px;color:white;font-size:12px;text-align:center">Actions</th>
              </tr>
            </thead>
            <tbody id="remboursementTableBody">
              <tr><td colspan="5"><div class="empty-state"><div class="empty-state-icon">üíú</div><div class="empty-state-text">S√©lectionnez une d√©pense en plus pour voir ses remboursements</div></div></td></tr>
            </tbody>
          </table>
        </div>
        <!-- Formulaire ajout ligne remboursement -->
        <div id="remboursementFormSection" style="display:none;margin-top:12px;padding:12px;background:#f5f3ff;border:2px solid #7c3aed;border-radius:10px">
          <div style="font-size:13px;font-weight:800;color:#6d28d9;margin-bottom:8px">‚ûï Ajouter / Modifier une ligne de remboursement</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end">
            <div class="form-group" style="margin-bottom:0;flex:0 0 130px">
              <label style="font-size:11px;font-weight:700;color:#6d28d9">Date</label>
              <input type="date" id="rembDate" style="padding:4px 8px;font-size:12px;width:100%;border-color:#7c3aed">
            </div>
            <div class="form-group" style="margin-bottom:0;flex:1 1 180px">
              <label style="font-size:11px;font-weight:700;color:#6d28d9">Personne</label>
              <select id="rembPersonne" style="padding:4px 8px;font-size:12px;width:100%;border-color:#7c3aed">
                <option value="">‚Äî S√©lectionner ‚Äî</option>
              </select>
            </div>
            <div class="form-group" style="margin-bottom:0;flex:0 0 130px">
              <label style="font-size:11px;font-weight:700;color:#6d28d9">Montant (-DA)</label>
              <input type="number" id="rembMontant" step="0.01" placeholder="ex: 5000" style="padding:4px 8px;font-size:12px;width:100%;border-color:#7c3aed">
            </div>
            <div class="form-group" style="margin-bottom:0;flex:2 1 200px">
              <label style="font-size:11px;font-weight:700;color:#6d28d9">Description</label>
              <input type="text" id="rembDescription" placeholder="Description du remboursement" style="padding:4px 8px;font-size:12px;width:100%;border-color:#7c3aed">
            </div>
            <div style="display:flex;gap:6px;padding-bottom:1px">
              <button onclick="addRembLigne()" style="width:auto;padding:6px 14px;font-size:12px;background:#6d28d9;white-space:nowrap" id="rembAddBtn">‚úö Ajouter ligne</button>
              <button onclick="cancelRembEdit()" id="rembCancelBtn" class="secondary" style="display:none;width:auto;padding:6px 10px;font-size:12px">Annuler</button>
            </div>
          </div>
          <!-- Solde restant -->
          <div id="rembSoldeBar" style="margin-top:10px;padding:8px 14px;border-radius:8px;font-size:13px;font-weight:700;display:none"></div>
        </div>
      </div>
    </div>

    <!-- ALIMENTATIONS PAGE -->
    <div id="alimentationsPage" class="page">
      <div class="card" style="padding:12px 16px">
        <div class="card-header"><h2 class="card-title" id="cashInFormTitle">‚ûï Ajouter une Alimentation</h2></div>
        <div style="display:grid;grid-template-columns:160px 160px 220px auto;gap:12px;align-items:flex-end">
          <div class="form-group" style="margin-bottom:0"><label style="font-size:11px;margin-bottom:4px">Date</label><input type="date" id="cashInDate" style="padding:8px 12px;font-size:13px" onchange="(function(el){if(_dateInClosedMonth(el.value)){_alertMonthLocked(el.value.substring(0,7));el.value='';}})(this)"></div>
          <div class="form-group" style="margin-bottom:0"><label style="font-size:11px;margin-bottom:4px">Montant (DA)</label><input type="number" id="cashInAmount" step="0.01" placeholder="0.00" style="padding:8px 12px;font-size:13px"></div>
          <div class="form-group" style="margin-bottom:0"><label style="font-size:11px;margin-bottom:4px">Description</label><input type="text" id="cashInDescription" placeholder="Alimentation de caisse" style="padding:8px 12px;font-size:13px;width:100%"></div>
          <div style="display:flex;gap:8px;padding-bottom:1px">
            <button id="addCashInBtn" onclick="addCashInFromForm()" style="width:auto;padding:8px 14px;font-size:13px;white-space:nowrap">‚úö Ajouter</button>
            <!-- Bouton Cl√¥turer masqu√© dans le formulaire Alimentations -->
            <button id="cancelCashInEditBtn" class="secondary" onclick="cancelCashInEdit()" style="display:none;width:auto;padding:8px 14px;font-size:13px">Annuler</button>
          </div>
        </div>
      </div>
      <div class="card" style="padding:12px 16px">
        <div class="card-header"><h2 class="card-title">üí∞ Liste des Alimentations</h2></div>
        <div class="table-wrapper">
          <table>
            <thead><tr><th>Date</th><th>Description</th><th>Montant</th><th style="min-width:200px">Actions</th></tr></thead>
            <tbody id="cashInTable"><tr><td colspan="4"><div class="empty-state"><div class="empty-state-icon">üí∞</div><div class="empty-state-text">Aucune alimentation pour ce mois</div></div></td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- PERSONNES PAGE -->
    <div id="personsPage" class="page">
      <div class="card">
        <div class="card-header"><h2 class="card-title">‚ûï Ajouter une Personne</h2></div>
        <div class="flex-between" style="margin-bottom:16px">
          <input type="text" id="newPersonName" placeholder="Nom de la personne" style="flex:1">
          <button onclick="addPerson()" style="width:auto;min-width:150px">Ajouter</button>
        </div>
        <div style="border-top:1px solid var(--border);padding-top:16px;margin-top:16px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <div>
              <div style="font-weight:700;color:var(--text-primary);margin-bottom:4px">üì§ Importer depuis Excel</div>
              <div style="font-size:13px;color:var(--text-secondary)">Le fichier Excel doit contenir une colonne "Nom"</div>
            </div>
            <button onclick="importPersonsFromExcel()" style="width:auto;min-width:180px;background:var(--success)"><span class="btn-icon">üì• Importer Excel</span></button>
          </div>
          <input type="file" id="personsExcelInput" accept=".xlsx,.xls" style="display:none" onchange="handlePersonsExcelFile(event)">
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üë• Liste des Personnes</h2>
          <button class="danger" onclick="clearPersons()" style="width:auto">üóëÔ∏è Vider</button>
        </div>
        <div class="list-items" id="personsListDiv"><div class="empty-state"><div class="empty-state-icon">üë§</div><div class="empty-state-text">Aucune personne ajout√©e</div></div></div>
      </div>
    </div>

    <!-- LIBELL√âS PAGE -->
    <div id="labelsPage" class="page">
      <div class="card">
        <div class="card-header"><h2 class="card-title" id="labelFormTitle">‚ûï Ajouter un Libell√©</h2></div>
        <div class="form-grid">
          <div class="form-group"><label>Code Comptable</label><input type="text" id="newLabelCode" placeholder="Ex: 6411"></div>
          <div class="form-group"><label>Nom du Libell√©</label><input type="text" id="newLabelName" placeholder="Ex: Transport"></div>
          <div class="form-group"><label>Description</label><input type="text" id="newLabelDesc" placeholder="Ex: Frais de d√©placement"></div>
        </div>
        <div style="display:flex;gap:12px">
          <button id="addLabelBtn" onclick="addLabel()">Ajouter le Libell√©</button>
          <button id="cancelLabelEditBtn" class="secondary" onclick="cancelLabelEdit()" style="display:none">Annuler</button>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üè∑Ô∏è Liste des Libell√©s</h2>
          <button class="danger" onclick="clearLabels()" style="width:auto">üóëÔ∏è Vider</button>
        </div>
        <div class="list-items" id="labelsList"><div class="empty-state"><div class="empty-state-icon">üè∑Ô∏è</div><div class="empty-state-text">Aucun libell√© ajout√©</div></div></div>
      </div>
    </div>

    <!-- PROJETS PAGE -->
    <div id="projetsPage" class="page">
      <div class="card" style="padding:12px 16px">
        <div class="card-header" style="margin-bottom:10px"><h2 class="card-title" id="projetFormTitle" style="font-size:16px">üìÅ Ajouter un Projet</h2></div>
        <div style="background:#EFF6FF;border:1px solid #BFDBFE;border-radius:8px;padding:8px 12px;margin-bottom:12px;font-size:12px;color:#1E40AF">
          <strong>‚ÑπÔ∏è</strong> Les projets cr√©√©s ici appara√Ætront dans la liste d√©roulante <strong>"Projet"</strong> lors de la saisie des d√©penses.
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:10px;align-items:flex-end">
          <div class="form-group" style="margin-bottom:0"><label style="font-size:11px;margin-bottom:4px">Nom du Projet</label><input type="text" id="newProjetName" placeholder="Ex: Construction Bureau" style="padding:8px 12px;font-size:13px"></div>
          <div class="form-group" style="margin-bottom:0"><label style="font-size:11px;margin-bottom:4px">Code Projet</label><input type="text" id="newProjetCode" placeholder="Ex: PRJ-001" style="padding:8px 12px;font-size:13px"></div>
          <div class="form-group" style="margin-bottom:0"><label style="font-size:11px;margin-bottom:4px">Description</label><input type="text" id="newProjetDesc" placeholder="Description optionnelle..." style="padding:8px 12px;font-size:13px"></div>
          <div style="display:flex;gap:8px;padding-bottom:1px">
            <button id="addProjetBtn" onclick="addProjet()" style="width:auto;padding:8px 14px;font-size:13px;background:#7C3AED;white-space:nowrap">üìÅ Ajouter</button>
            <button id="cancelProjetEditBtn" class="secondary" onclick="cancelProjetEdit()" style="display:none;width:auto;padding:8px 12px;font-size:13px">Annuler</button>
          </div>
        </div>
      </div>
      <div class="card" style="padding:12px 16px">
        <div class="card-header" style="margin-bottom:10px">
          <h2 class="card-title" style="font-size:16px">üìã Liste des Projets</h2>
          <button class="danger" onclick="clearProjets()" style="width:auto;padding:6px 12px;font-size:12px">üóëÔ∏è Vider</button>
        </div>
        <div class="list-items" id="projetsList"><div class="empty-state"><div class="empty-state-icon">üìÅ</div><div class="empty-state-text">Aucun projet ajout√©</div></div></div>
      </div>
    </div>

    <!-- PARAM√àTRES PAGE -->
    <div id="settingsPage" class="page">
      <div class="card" style="padding:12px 16px">
        <div class="card-header" style="margin-bottom:10px">
          <h2 class="card-title" style="font-size:16px">üë§ Informations du Compte</h2>
          <div id="currentUserRoleBadge" style="padding:4px 12px;border-radius:20px;font-size:12px;font-weight:700"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr auto auto;gap:10px;align-items:flex-end">
          <div class="form-group" style="margin-bottom:0"><label style="font-size:11px;margin-bottom:4px">Nom d'utilisateur</label><input type="text" id="settingsUsername" placeholder="Nouveau nom d'utilisateur" style="padding:8px 12px;font-size:13px"></div>
          <div class="form-group" style="margin-bottom:0"><label style="font-size:11px;margin-bottom:4px">Nom complet</label><input type="text" id="settingsFullName" placeholder="Votre nom complet" style="padding:8px 12px;font-size:13px"></div>
          <div class="form-group" style="margin-bottom:0"><label style="font-size:11px;margin-bottom:4px">Email</label><input type="email" id="settingsEmail" placeholder="votre.email@gmail.com" style="padding:8px 12px;font-size:13px"></div>
          <div style="padding-bottom:1px"><button class="secondary" onclick="changeUserPassword()" style="width:auto;padding:8px 12px;font-size:12px;white-space:nowrap"><span class="btn-icon">üîê Changer Mot de Passe</span></button></div>
          <div style="padding-bottom:1px"><button class="success" onclick="updateAccountInfo()" style="width:auto;padding:8px 14px;font-size:13px;white-space:nowrap"><span class="btn-icon">üíæ Enregistrer</span></button></div>
        </div>
      </div>

      <!-- ‚ïê‚ïê GESTION DES COMPTES ‚Äî ADMIN UNIQUEMENT ‚ïê‚ïê -->
      <div id="adminUsersCard" class="card" style="display:none;padding:6px 12px;border:2px solid #FCA5A5;background:linear-gradient(135deg,#FEF2F2 0%,#FFF8F8 100%)">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;margin-bottom:4px">
          <div style="display:flex;align-items:center;gap:8px;flex:1;min-width:0">
            <h2 class="card-title" style="font-size:13px;color:#991B1B;white-space:nowrap">üõ°Ô∏è Gestion des Comptes Utilisateurs</h2>
            <span style="font-size:10px;font-weight:700;background:#FEE2E2;color:#991B1B;padding:2px 7px;border-radius:20px;white-space:nowrap">ADMINISTRATEUR</span>
            <span style="font-size:10px;color:#7F1D1D;white-space:nowrap">‚Äî S√©lectionnez les comptes <strong>Standard</strong> √† supprimer. ‚ö†Ô∏è Suppression <strong>d√©finitive</strong>.</span>
          </div>
          <div style="display:flex;gap:5px;flex-shrink:0">
            <button onclick="adminDeleteSelectedUsers()" class="danger" style="padding:4px 10px;font-size:11px;font-weight:700;width:auto;white-space:nowrap">üóëÔ∏è Supprimer</button>
            <button onclick="renderAdminUsersList()" style="padding:4px 8px;font-size:11px;background:#64748B;width:auto;white-space:nowrap">üîÑ Actualiser</button>
          </div>
        </div>
        <div id="adminUsersList" style="display:flex;flex-direction:column;gap:4px;max-height:160px;overflow-y:auto"></div>
      </div>
      <div class="card" style="padding:14px 16px;border:2px solid #BFDBFE">
        <div class="card-header" style="margin-bottom:10px">
          <h2 class="card-title" style="font-size:16px">üíæ Sauvegarde</h2>
        </div>
        <p style="font-size:12px;color:var(--text-secondary);margin-bottom:10px;line-height:1.5">
          Chaque saisie est sauvegard√©e automatiquement dans <strong>Save_data_Depense.json</strong> dans le dossier de votre choix.
        </p>

        <!-- Dossier actuel -->
        <div id="autoSaveFolderDisplay" style="display:none;align-items:center;gap:10px;background:#EFF6FF;border:2px solid #BFDBFE;border-radius:10px;padding:8px 12px;margin-bottom:8px;font-size:12px;font-weight:700;color:#1E40AF"></div>

        <!-- Statut -->
        <div id="autoSaveSettingsStatus" style="margin-bottom:10px;padding:8px 12px;border-radius:8px;font-size:12px;font-weight:600;background:#F1F5F9;color:#475569">
          üíæ Cliquez sur "S√©lectionner le Dossier" pour activer la sauvegarde automatique.
        </div>

        <!-- Ligne 1 : Sauvegarde automatique -->
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
          <button onclick="selectAutoSaveFolder()" style="flex:2;padding:8px 10px;font-size:12px;background:#3B82F6;min-width:160px" class="btn-icon">
            <span>üìÇ</span><span>S√©lectionner le Dossier</span>
          </button>
          <button onclick="changeAutoSaveFolder()" style="flex:2;padding:8px 10px;font-size:12px;background:#7C3AED;min-width:160px" class="btn-icon">
            <span>üîÑ</span><span>Changer de Dossier</span>
          </button>
          <button onclick="manualSaveToFolder()" style="flex:1;padding:8px 10px;font-size:12px;background:#10B981;min-width:120px" class="btn-icon">
            <span>üíæ</span><span>Sauvegarder</span>
          </button>
        </div>

        <!-- S√©parateur -->
        <div style="border-top:1px solid #E2E8F0;margin-bottom:8px"></div>

        <!-- Ligne 2 : Sauvegarde locale JSON -->
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button onclick="exportData()" style="flex:1;padding:7px 10px;font-size:12px">üíæ Exporter JSON</button>
          <button onclick="importData()" style="flex:1;padding:7px 10px;font-size:12px">üì• Importer JSON</button>
          <button onclick="refreshDatabase()" style="flex:1;padding:7px 10px;font-size:12px;background:#3B82F6">üîÑ Rafra√Æchir</button>
        </div>
      </div>

      <!-- ‚ïê‚ïê IMPORTER SAUVEGARDE JSON ‚ïê‚ïê -->
      <div class="card" style="display:none;padding:16px;border:2px solid #C7D2FE;background:linear-gradient(135deg,#EEF2FF 0%,#F8FAFC 100%)">
        <div class="card-header" style="margin-bottom:12px">
          <h2 class="card-title" style="font-size:16px">üìÇ Importer la Sauvegarde JSON</h2>
          <span style="font-size:11px;font-weight:700;background:#E0E7FF;color:#3730A3;padding:3px 10px;border-radius:20px">RESTAURATION</span>
        </div>
        <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px;line-height:1.6">
          Restaurez vos donn√©es depuis un fichier <strong>Save_data_Depense.json</strong>.<br>
          Tous les comptes du fichier seront fusionn√©s avec les donn√©es existantes.
        </p>
        <div id="importSaveJSONStatus" style="display:none;margin-bottom:12px;padding:10px 14px;border-radius:8px;font-size:13px;font-weight:600"></div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button onclick="importSaveJSONFromFolder()" style="flex:2;padding:11px;font-size:13px;background:#4F46E5;min-width:200px" class="btn-icon">
            <span>üíæ</span><span>Importer depuis un Dossier</span>
          </button>
          <button onclick="importSaveJSON()" style="flex:1;padding:11px;font-size:13px;background:#64748B;min-width:150px" class="btn-icon">
            <span>üìÇ</span><span>Choisir un fichier .json</span>
          </button>
        </div>
        <input type="file" id="importSaveJSONInput" accept=".json" style="display:none" onchange="handleImportSaveJSON(event)">
      </div>
      <!-- ‚ïê‚ïê IMPORTATION EXCEL TIERS ‚ïê‚ïê -->
      <div class="card" style="padding:8px 12px;border:2px solid #BBF7D0;background:linear-gradient(135deg,#F0FDF4 0%,#F8FAFC 100%)" id="excelImportCard">
        <div class="card-header" style="margin-bottom:6px">
          <h2 class="card-title" style="font-size:14px">üìä Importation Excel Tiers</h2>
          <span style="font-size:11px;font-weight:700;background:#D1FAE5;color:#065F46;padding:3px 10px;border-radius:20px">IMPORT</span>
        </div>
        <p style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;line-height:1.5">
          Importez un fichier Excel (colonnes : <strong>DATE / PERSONNE / MONTANT / PROJET / DESCRIPTION / LIBELL√â / CODE</strong>).
        </p>

        <!-- ‚îÄ‚îÄ MODE DOUBLONS ‚îÄ‚îÄ -->
        <!-- LIGNE 1 : Mode doublons uniquement -->
        <div style="background:#F8FAFC;border:1px solid #BBF7D0;border-radius:8px;padding:4px 8px;margin-bottom:6px;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
          <span style="font-weight:700;font-size:11px;color:#15803D;white-space:nowrap">üîÅ Mode :</span>
          <label id="modeLabel_sans" onclick="setImportMode('sans')" style="display:flex;align-items:center;gap:6px;cursor:pointer;background:#EFF6FF;border:2px solid #3B82F6;border-radius:6px;padding:3px 8px;transition:all .2s">
            <input type="radio" name="importDoublons" id="importMode_sans" value="sans" checked style="width:12px;height:12px;accent-color:#3B82F6;flex-shrink:0">
            <span style="font-weight:800;font-size:11px;color:#1D4ED8">üö´ SANS DOUBLONS</span>
          </label>
          <label id="modeLabel_avec" onclick="setImportMode('avec')" style="display:flex;align-items:center;gap:6px;cursor:pointer;background:#F8FAFC;border:1.5px solid #CBD5E1;border-radius:6px;padding:3px 8px;transition:all .2s">
            <input type="radio" name="importDoublons" id="importMode_avec" value="avec" style="width:12px;height:12px;accent-color:#F59E0B;flex-shrink:0">
            <span style="font-weight:800;font-size:11px;color:#92400E">‚úÖ AVEC DOUBLONS</span>
          </label>
          <div id="importModeInfo" style="font-size:11px;background:#EFF6FF;color:#1D4ED8;font-weight:600;padding:2px 8px;border-radius:5px;white-space:nowrap">
            ‚ÑπÔ∏è <strong>SANS DOUBLONS</strong> ‚Äî Personnes, Libell√©s et Projets existants ignor√©s.
          </div>
        </div>

        <!-- LIGNE 2 : Que voulez-vous importer ? + case Justifi√©e -->
        <div style="background:white;border:1px solid #BBF7D0;border-radius:8px;padding:8px 10px;margin-bottom:8px">
          <div style="font-weight:700;font-size:12px;color:#15803D;margin-bottom:6px">üéØ Que voulez-vous importer ?</div>
          <div style="display:flex;flex-wrap:wrap;gap:6px;align-items:center">
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;background:#F0FDF4;border:2px solid #86EFAC;border-radius:6px;padding:4px 10px;font-weight:600;font-size:12px">
              <input type="checkbox" id="importChk_depenses" checked style="width:13px;height:13px;accent-color:#10B981"> üìä D√©penses
            </label>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;background:#F0FDF4;border:2px solid #86EFAC;border-radius:6px;padding:4px 10px;font-weight:600;font-size:12px">
              <input type="checkbox" id="importChk_personnes" checked style="width:13px;height:13px;accent-color:#10B981"> üë• Personnes
            </label>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;background:#F0FDF4;border:2px solid #86EFAC;border-radius:6px;padding:4px 10px;font-weight:600;font-size:12px">
              <input type="checkbox" id="importChk_libelles" checked style="width:13px;height:13px;accent-color:#10B981" onchange="document.getElementById('importChk_codes').checked=this.checked"> üè∑Ô∏è Libell√©s
            </label>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;background:#F0FDF4;border:2px solid #86EFAC;border-radius:6px;padding:4px 10px;font-weight:600;font-size:12px">
              <input type="checkbox" id="importChk_codes" checked style="width:13px;height:13px;accent-color:#10B981" onchange="document.getElementById('importChk_libelles').checked=this.checked"> üî¢ Code comptable
            </label>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;background:#F0FDF4;border:2px solid #86EFAC;border-radius:6px;padding:4px 10px;font-weight:600;font-size:12px">
              <input type="checkbox" id="importChk_projets" checked style="width:13px;height:13px;accent-color:#10B981"> üìÅ Projets
            </label>
            <!-- S√©parateur -->
            <div style="width:1px;height:22px;background:#BBF7D0;margin:0 2px;flex-shrink:0"></div>
            <!-- Case √† cocher Justifi√©e -->
            <label id="importJustifiedChkLabel" onclick="toggleImportJustified()" style="display:flex;align-items:center;gap:6px;cursor:pointer;background:#D1FAE5;border:2px solid #10B981;border-radius:6px;padding:4px 10px;font-weight:700;font-size:12px;color:#065F46;transition:all .2s;user-select:none">
              <input type="checkbox" id="importJustifiedChk" checked style="width:13px;height:13px;accent-color:#10B981;flex-shrink:0;pointer-events:none">
              ‚úÖ Justifi√©es
            </label>
          </div>
        </div>
        <!-- Feuilles s√©lectionnables (affich√© apr√®s chargement) -->
        <div id="excelSheetsOptions" style="display:none;background:white;border:1px solid #BBF7D0;border-radius:8px;padding:8px 10px;margin-bottom:8px">
          <div style="font-weight:700;font-size:12px;color:#15803D;margin-bottom:6px">üìã Feuilles d√©tect√©es ‚Äî cochez celles √† importer</div>
          <div id="excelSheetsList" style="display:flex;flex-wrap:wrap;gap:8px"></div>
        </div>
        <!-- R√©sultat / log -->
        <div id="excelImportResult" style="display:none;margin-bottom:8px;padding:8px 12px;border-radius:8px;font-size:12px;font-weight:600;line-height:1.7"></div>
        <!-- Boutons -->
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="excelImportBtn" style="flex:2;padding:8px;font-size:13px;background:linear-gradient(135deg,#10B981 0%,#059669 100%);min-width:200px;font-weight:800" class="btn-icon">
            <span>üìä</span><span>IMPORTATION EXCEL TIERS</span>
          </button>
          <button onclick="resetExcelImport()" style="flex:1;padding:8px;font-size:12px;background:#64748B;min-width:100px">üóëÔ∏è R√©initialiser</button>
        </div>
        <input type="file" id="excelImportFileInput" accept=".xlsx,.xls" style="display:none">
      </div>
      <!-- ‚ïê‚ïê FIN IMPORTATION EXCEL TIERS ‚ïê‚ïê -->

      <div class="card" style="padding:12px 16px">
        <div class="card-header" style="margin-bottom:8px"><h2 class="card-title" style="font-size:16px">üóëÔ∏è Suppression par P√©riode</h2></div>
        <p style="color:var(--text-secondary);margin-bottom:12px;font-size:13px">S√©lectionnez une p√©riode et le type de donn√©es √† supprimer. Cette action est <strong>irr√©versible</strong>.</p>
        <div style="background:#F8FAFC;border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:10px">
          <div style="font-weight:700;color:var(--text-primary);margin-bottom:10px;font-size:13px">üìÖ S√©lection de la P√©riode</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div class="form-group" style="margin-bottom:0"><label style="font-size:11px;margin-bottom:4px">Date de d√©but</label><input type="date" id="resetStartDate" style="padding:7px 10px;font-size:13px"></div>
            <div class="form-group" style="margin-bottom:0"><label style="font-size:11px;margin-bottom:4px">Date de fin</label><input type="date" id="resetEndDate" style="padding:7px 10px;font-size:13px"></div>
          </div>
          <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;align-items:center">
            <button onclick="setResetPeriod('thisMonth')" style="width:auto;padding:5px 10px;font-size:11px;background:#3B82F6">üìÖ Ce mois</button>
            <button onclick="setResetPeriod('lastMonth')" style="width:auto;padding:5px 10px;font-size:11px;background:#6366F1">üìÖ Mois pr√©c√©dent</button>
            <button onclick="setResetPeriod('thisYear')" style="width:auto;padding:5px 10px;font-size:11px;background:#8B5CF6">üìÖ Cette ann√©e</button>
            <button onclick="setResetPeriod('all')" style="width:auto;padding:5px 10px;font-size:11px;background:#64748B">üìÖ Toute la p√©riode</button>
            <div style="display:flex;align-items:center;gap:6px;background:white;border:2px solid var(--border);border-radius:8px;padding:4px 8px">
              <span style="font-size:11px;font-weight:700;color:var(--text-secondary);white-space:nowrap">üìÜ Par mois :</span>
              <select id="resetMonthSelect" style="border:none;padding:2px 4px;font-size:11px;font-weight:600;background:transparent;outline:none;cursor:pointer">
                <option value="0">Janvier</option><option value="1">F√©vrier</option><option value="2">Mars</option><option value="3">Avril</option><option value="4">Mai</option><option value="5">Juin</option><option value="6">Juillet</option><option value="7">Ao√ªt</option><option value="8">Septembre</option><option value="9">Octobre</option><option value="10">Novembre</option><option value="11">D√©cembre</option>
              </select>
              <input type="number" id="resetYearSelect" min="2020" max="2100" style="border:none;padding:2px 4px;font-size:11px;font-weight:600;background:transparent;outline:none;width:58px;cursor:pointer">
              <button onclick="setResetPeriod('byMonth')" style="width:auto;padding:4px 8px;font-size:11px;background:#10B981">‚úî</button>
            </div>
          </div>
        </div>
        <div style="background:#F8FAFC;border:1px solid var(--border);border-radius:10px;padding:6px 10px;margin-bottom:10px">
          <div style="font-weight:700;color:var(--text-primary);margin-bottom:6px;font-size:12px">üéØ Type de Donn√©es √† Supprimer</div>
          <div style="display:flex;flex-wrap:wrap;gap:6px;align-items:center">
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-weight:700;font-size:12px;color:#6D28D9;background:#EDE9FE;border:2px solid #7C3AED;border-radius:6px;padding:5px 10px;white-space:nowrap"><input type="radio" name="resetType" value="comptes" style="width:13px;height:13px;accent-color:#7C3AED"><span>üë§ Utilisateurs</span></label>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-weight:600;font-size:12px;color:var(--text-primary);background:white;border:1.5px solid var(--border);border-radius:6px;padding:5px 10px;white-space:nowrap"><input type="radio" name="resetType" value="depenses" style="width:13px;height:13px;accent-color:var(--accent)"><span>üìä D√©penses</span></label>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-weight:600;font-size:12px;color:var(--text-primary);background:white;border:1.5px solid var(--border);border-radius:6px;padding:5px 10px;white-space:nowrap"><input type="radio" name="resetType" value="alimentations" style="width:13px;height:13px;accent-color:var(--accent)"><span>üí∞ Alimentations</span></label>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-weight:600;font-size:12px;color:var(--text-primary);background:white;border:1.5px solid var(--border);border-radius:6px;padding:5px 10px;white-space:nowrap"><input type="radio" name="resetType" value="solde" style="width:13px;height:13px;accent-color:var(--accent)"><span>üí∞ Solde</span></label>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-weight:600;font-size:12px;color:var(--text-primary);background:white;border:1.5px solid var(--border);border-radius:6px;padding:5px 10px;white-space:nowrap"><input type="radio" name="resetType" value="libelles" style="width:13px;height:13px;accent-color:var(--accent)"><span>üè∑Ô∏è Libell√©s</span></label>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-weight:600;font-size:12px;color:var(--text-primary);background:white;border:1.5px solid var(--border);border-radius:6px;padding:5px 10px;white-space:nowrap"><input type="radio" name="resetType" value="personnes" style="width:13px;height:13px;accent-color:var(--accent)"><span>üë• Personnes</span></label>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-weight:600;font-size:12px;color:var(--text-primary);background:white;border:1.5px solid var(--border);border-radius:6px;padding:5px 10px;white-space:nowrap"><input type="radio" name="resetType" value="projets" style="width:13px;height:13px;accent-color:var(--accent)"><span>üìÅ Projets</span></label>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-weight:700;font-size:12px;color:#991B1B;background:#FEE2E2;border:1.5px solid #DC2626;border-radius:6px;padding:5px 10px;white-space:nowrap"><input type="radio" name="resetType" value="all" style="width:13px;height:13px;accent-color:#DC2626"><span>üî• TOUT SUPPRIMER</span></label>
          </div>
          <div id="resetComptesPanel" style="display:none;margin-top:8px;background:#F5F3FF;border:1.5px solid #C4B5FD;border-radius:8px;padding:8px 12px">
            <div style="font-weight:700;font-size:12px;color:#6D28D9;margin-bottom:6px">S√©lectionnez les comptes √† supprimer <span style="font-weight:500;color:#7C3AED;font-size:11px">(votre compte et les admins sont exclus)</span></div>
            <div id="resetComptesList" style="display:flex;flex-direction:column;gap:5px;max-height:200px;overflow-y:auto;margin-bottom:6px"></div>
            <div style="display:flex;gap:6px">
              <button onclick="selectAllResetComptes(true)" style="width:auto;padding:3px 9px;font-size:11px;background:#7C3AED">Tout s√©lectionner</button>
              <button onclick="selectAllResetComptes(false)" style="width:auto;padding:3px 9px;font-size:11px;background:#64748B">Tout d√©s√©lectionner</button>
            </div>
          </div>
          <div style="margin-top:6px">
            <button class="danger" onclick="resetByPeriod()" style="padding:5px 14px;font-size:12px;font-weight:700;width:auto">üóëÔ∏è Supprimer les Donn√©es S√©lectionn√©es</button>
          </div>
        </div>
      </div>
      <!-- SUPABASE CARD -->
      <div class="card" id="supabaseCard">
        <div class="card-header">
          <h2 class="card-title">
            <svg style="display:inline;vertical-align:middle;margin-right:8px" width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M11.9 1.036c-.015-.986-1.26-1.41-1.874-.637L.764 12.33c-.63.795-.057 1.95.953 1.964l9.299.132.199 8.468c.015.986 1.26 1.41 1.874.637l9.262-11.93c.63-.795.057-1.95-.953-1.964l-9.299-.132-.199-8.468z" fill="#3ECF8E"/></svg>
            Synchronisation Supabase
          </h2>
          <div id="supabaseStatusBadge" style="padding:4px 12px;border-radius:20px;font-size:12px;font-weight:700;background:#FEE2E2;color:#991B1B">‚óè Non configur√©</div>
        </div>

        <!-- ‚ïê‚ïê MODE DE SYNCHRONISATION ‚ïê‚ïê -->
        <div style="background:#F8FAFC;border:1px solid var(--border);border-radius:10px;padding:8px 12px;margin-bottom:10px">
          <div style="font-weight:800;color:var(--text-primary);margin-bottom:2px;font-size:13px;display:flex;align-items:center;gap:8px">
            ‚öôÔ∏è Mode de Synchronisation
          </div>
          <div style="font-size:11px;color:var(--text-secondary);margin-bottom:8px">Choisissez comment vos donn√©es sont sauvegard√©es et synchronis√©es.</div>
          <div style="display:grid;gap:6px">

            <!-- MODE 1 : 100% LOCAL -->
            <label id="syncModeLabel_local" onclick="setSyncMode('local')" style="display:flex;align-items:flex-start;gap:10px;cursor:pointer;background:white;border:2px solid var(--border);border-radius:8px;padding:8px 12px;transition:all .2s">
              <input type="radio" name="syncMode" value="local" style="width:15px;height:15px;accent-color:#64748B;margin-top:2px;flex-shrink:0">
              <div>
                <div style="font-weight:700;font-size:12px;color:#1E293B;display:flex;align-items:center;gap:8px">
                  üíæ 100% Local
                  <span style="font-size:10px;font-weight:600;background:#E2E8F0;color:#64748B;padding:2px 8px;border-radius:20px">HORS LIGNE</span>
                </div>
                <div style="font-size:11px;color:var(--text-secondary);margin-top:2px">Toutes les donn√©es sont stock√©es uniquement sur cet appareil. Aucune connexion cloud requise. Les donn√©es ne sont pas partag√©es entre appareils.</div>
              </div>
            </label>

            <!-- MODE 2 : LOCAL + SUPABASE -->
            <label id="syncModeLabel_both" onclick="setSyncMode('both')" style="display:flex;align-items:flex-start;gap:10px;cursor:pointer;background:white;border:2px solid var(--border);border-radius:8px;padding:8px 12px;transition:all .2s">
              <input type="radio" name="syncMode" value="both" style="width:15px;height:15px;accent-color:#F59E0B;margin-top:2px;flex-shrink:0">
              <div>
                <div style="font-weight:700;font-size:12px;color:#1E293B;display:flex;align-items:center;gap:8px">
                  üîÑ Local + Supabase
                  <span style="font-size:10px;font-weight:600;background:#FEF3C7;color:#92400E;padding:2px 8px;border-radius:20px">RECOMMAND√â</span>
                </div>
                <div style="font-size:11px;color:var(--text-secondary);margin-top:2px">Les donn√©es sont sauvegard√©es localement ET synchronis√©es avec Supabase. Acc√®s hors ligne garanti + partage entre appareils.</div>
              </div>
            </label>

            <!-- MODE 3 : 100% SUPABASE -->
            <label id="syncModeLabel_cloud" onclick="setSyncMode('cloud')" style="display:flex;align-items:flex-start;gap:10px;cursor:pointer;background:white;border:2px solid var(--border);border-radius:8px;padding:8px 12px;transition:all .2s">
              <input type="radio" name="syncMode" value="cloud" style="width:15px;height:15px;accent-color:#3ECF8E;margin-top:2px;flex-shrink:0">
              <div>
                <div style="font-weight:700;font-size:12px;color:#1E293B;display:flex;align-items:center;gap:8px">
                  ‚òÅÔ∏è 100% Supabase
                  <span style="font-size:10px;font-weight:600;background:#D1FAE5;color:#065F46;padding:2px 8px;border-radius:20px">CLOUD</span>
                </div>
                <div style="font-size:11px;color:var(--text-secondary);margin-top:2px">Toutes les donn√©es sont lues et √©crites directement depuis Supabase. Synchronisation en temps r√©el entre tous vos appareils. Connexion internet requise.</div>
              </div>
            </label>

          </div>
          <div id="syncModeStatus" style="margin-top:8px;padding:8px 12px;border-radius:8px;font-size:12px;font-weight:600;display:none"></div>
        </div>
        <!-- ‚ïê‚ïê FIN MODE DE SYNCHRONISATION ‚ïê‚ïê -->

        <div id="supabaseConfigSection">
          <div style="background:#F0FDF4;border:1px solid #BBF7D0;border-radius:10px;padding:16px;margin-bottom:16px">
            <div style="font-weight:700;color:#15803D;margin-bottom:8px;font-size:14px">üîë Configuration Supabase</div>
            <ol style="color:#166534;font-size:13px;line-height:2;padding-left:20px;margin-bottom:12px">
              <li>Ex√©cutez le fichier <strong>supabase_schema.sql</strong> dans votre SQL Editor</li>
              <li>Allez dans <strong>Project Settings ‚Üí API</strong></li>
              <li>Copiez votre <strong>Project URL</strong> et votre <strong>anon public key</strong></li>
              <li>Collez-les ci-dessous et cliquez Connecter</li>
            </ol>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
              <div>
                <label style="font-size:11px;font-weight:700;color:#166534;display:block;margin-bottom:4px">Project URL</label>
                <input type="text" id="supabaseUrlInput" placeholder="https://xxxx.supabase.co" style="font-family:monospace;font-size:13px;border-color:#BBF7D0">
              </div>
              <div>
                <label style="font-size:11px;font-weight:700;color:#166534;display:block;margin-bottom:4px">Anon Public Key</label>
                <input type="password" id="supabaseKeyInput" placeholder="eyJhbGci..." style="font-family:monospace;font-size:13px;border-color:#BBF7D0">
              </div>
            </div>
            <div style="display:flex;gap:8px">
              <button onclick="connectSupabase()" style="width:auto;padding:10px 16px;font-size:13px;background:#3ECF8E;white-space:nowrap">üîå Connecter Supabase</button>
              <div id="supabaseConfigStatus" style="font-size:13px;font-weight:600;display:flex;align-items:center;color:var(--text-secondary)"></div>
            </div>
          </div>
        </div>
        <div id="supabaseSyncSection" style="display:none">
          <div style="display:flex;align-items:center;gap:10px;background:#F0FDF4;border:1px solid #BBF7D0;border-radius:10px;padding:12px 16px;margin-bottom:16px">
            <div style="font-size:24px">üü¢</div>
            <div style="flex:1">
              <div style="font-weight:700;font-size:14px;color:#15803D">Supabase connect√©</div>
              <div id="supabaseProjectInfo" style="font-size:12px;color:#16A34A"></div>
            </div>
            <button onclick="disconnectSupabase()" style="width:auto;padding:6px 12px;font-size:12px;background:#DC2626">D√©connecter</button>
          </div>
          <div id="offlineBanner" style="display:none;background:#FEF3C7;border:1px solid #FCD34D;border-radius:8px;padding:10px 14px;margin-bottom:12px;font-size:13px;font-weight:600;color:#92400E">
            üì∂ Mode hors-ligne ‚Äî Les donn√©es sont sauvegard√©es localement et seront synchronis√©es √† la reconnexion.
          </div>
          <div id="supabaseLastSync" style="font-size:12px;color:var(--text-secondary);margin-bottom:12px"></div>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:10px">
            <button onclick="supabasePush()" style="padding:10px;font-size:13px;background:#3ECF8E"><span class="btn-icon">‚òÅÔ∏è Envoyer (Push)</span></button>
            <button onclick="supabasePull()" style="padding:10px;font-size:13px;background:#7C3AED"><span class="btn-icon">‚¨áÔ∏è R√©cup√©rer (Pull)</span></button>
            <button onclick="supabaseAutoSync()" id="supabaseAutoSyncBtn" style="padding:10px;font-size:13px;background:#059669"><span class="btn-icon">üîÑ Auto-Sync</span></button>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <button onclick="supabaseSyncAll()" style="padding:10px;font-size:13px;background:#0F172A"><span class="btn-icon">üîÅ Sync Complet (Push + Pull)</span></button>
            <button onclick="showSyncStatus()" style="padding:10px;font-size:13px;background:#6366F1"><span class="btn-icon">üìã Journal de Sync</span></button>
          </div>
          <div id="supabaseProgress" style="display:none;margin-top:12px">
            <div style="background:#E2E8F0;border-radius:8px;overflow:hidden;height:8px">
              <div id="supabaseProgressBar" style="height:100%;background:linear-gradient(90deg,#3ECF8E,#7C3AED);width:0%;transition:width .3s;border-radius:8px"></div>
            </div>
            <div id="supabaseProgressText" style="font-size:12px;color:var(--text-secondary);margin-top:6px;text-align:center"></div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><h2 class="card-title">‚ÑπÔ∏è √Ä Propos</h2></div>
        <p style="color:var(--text-secondary);line-height:1.8"><strong>Gestion Intelligente des D√©penses</strong><br>Version 3.0 ‚Äî Supabase Edition<br>Application de gestion financi√®re personnelle<br>localStorage (offline) + Supabase (cloud sync)</p>
      </div>

      <!-- ‚ïê‚ïê DIAGNOSTIC SUPABASE ‚ïê‚ïê -->
      <div class="card" style="border:2px solid #BFDBFE;background:linear-gradient(135deg,#EFF6FF 0%,#F8FAFC 100%)">
        <div class="card-header" style="margin-bottom:12px">
          <h2 class="card-title" style="font-size:16px">üî¨ Diagnostic Supabase</h2>
          <span style="font-size:11px;font-weight:700;background:#DBEAFE;color:#1E40AF;padding:3px 10px;border-radius:20px">D√âBOGAGE</span>
        </div>
        <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">Testez la connectivit√© et chaque table Supabase individuellement pour identifier la cause de l'erreur "Failed to fetch".</p>
        <div id="diagResult" style="display:none;margin-bottom:12px;padding:12px 16px;border-radius:10px;font-size:13px;font-family:'JetBrains Mono',monospace;max-height:280px;overflow-y:auto;white-space:pre-wrap;line-height:1.8;border:1px solid var(--border)"></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button onclick="runSupabaseDiag()" style="flex:2;padding:10px;font-size:13px;background:#1E40AF;min-width:200px" class="btn-icon">
            <span>üî¨</span><span>Lancer le Diagnostic Complet</span>
          </button>
          <button onclick="testSingleTable('users_data')" style="flex:1;padding:10px;font-size:12px;background:#6366F1;min-width:140px">
            üîç Test Connexion
          </button>
          <button onclick="clearDiagResult()" style="flex:1;padding:10px;font-size:12px;background:#64748B;min-width:100px">
            üóëÔ∏è Effacer
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODALS -->
<div id="adminDeleteModal" class="modal">
  <div class="modal-content">
    <h3 class="modal-title">üõ°Ô∏è Confirmation Administrateur</h3>
    <p class="modal-subtitle" id="adminDeleteModalMsg">Entrez le mot de passe administrateur pour supprimer les comptes s√©lectionn√©s.</p>
    <div class="form-group">
      <label>Mot de passe Administrateur</label>
      <input type="password" id="adminDeletePasswordInput" placeholder="Mot de passe admin" onkeypress="if(event.key==='Enter')confirmAdminDelete()">
    </div>
    <div id="adminDeleteError" style="display:none;color:#991B1B;background:#FEE2E2;border-radius:8px;padding:8px 12px;font-size:13px;font-weight:600;margin-bottom:8px"></div>
    <div class="modal-buttons">
      <button class="secondary" onclick="closeModal('adminDeleteModal')">Annuler</button>
      <button class="danger" onclick="confirmAdminDelete()">üóëÔ∏è Supprimer D√©finitivement</button>
    </div>
  </div>
</div>

<div id="passwordModal" class="modal">
  <div class="modal-content">
    <h3 class="modal-title">üîê Confirmation de S√©curit√©</h3>
    <p class="modal-subtitle" id="passwordModalMessage">Entrez votre mot de passe pour continuer</p>
    <div class="form-group"><label>Mot de passe</label><input type="password" id="passwordModalInput" placeholder="Votre mot de passe"></div>
    <div class="modal-buttons">
      <button class="secondary" onclick="closePasswordModal()">Annuler</button>
      <button onclick="confirmPasswordModal()">Confirmer</button>
    </div>
  </div>
</div>

<div id="exportByDateModal" class="modal">
  <div class="modal-content">
    <h3 class="modal-title">üìÖ Exporter vers Excel (Par Date)</h3>
    <p class="modal-subtitle">S√©lectionnez la p√©riode d'export</p>
    <div class="form-group"><label>Date de d√©but</label><input type="date" id="exportStartDate"></div>
    <div class="form-group"><label>Date de fin</label><input type="date" id="exportEndDate"></div>
    <div class="modal-buttons">
      <button class="secondary" onclick="closeModal('exportByDateModal')">Annuler</button>
      <button class="success" onclick="exportToExcelByDate()">üì• Exporter Excel</button>
    </div>
  </div>
</div>

<div id="exportByMonthModal" class="modal">
  <div class="modal-content">
    <h3 class="modal-title">üìä Exporter vers Excel (Par Mois)</h3>
    <p class="modal-subtitle">S√©lectionnez le mois √† exporter</p>
    <div class="form-group"><label>Mois</label>
      <select id="exportMonthSelect" style="width:100%;padding:12px 16px">
        <option value="0">Janvier</option><option value="1">F√©vrier</option><option value="2">Mars</option><option value="3">Avril</option><option value="4">Mai</option><option value="5">Juin</option><option value="6">Juillet</option><option value="7">Ao√ªt</option><option value="8">Septembre</option><option value="9">Octobre</option><option value="10">Novembre</option><option value="11">D√©cembre</option>
      </select>
    </div>
    <div class="form-group"><label>Ann√©e</label><input type="number" id="exportYearInput" min="2020" max="2100" style="width:100%;padding:12px 16px"></div>
    <div class="modal-buttons">
      <button class="secondary" onclick="closeModal('exportByMonthModal')">Annuler</button>
      <button class="success" onclick="exportToExcelByMonth()">üì• Exporter Excel</button>
    </div>
  </div>
</div>

<div id="cashInQuickModal" class="modal">
  <div class="modal-content">
    <h3 class="modal-title">üíµ Alimentation Rapide</h3>
    <p class="modal-subtitle">Ajouter une entr√©e de caisse</p>
    <div class="form-group"><label>Montant (DA)</label><input type="number" id="quickCashInAmount" step="0.01" placeholder="0.00"></div>
    <div class="form-group"><label>Description</label><input type="text" id="quickCashInDesc" placeholder="Alimentation de caisse"></div>
    <div class="modal-buttons">
      <button class="secondary" onclick="closeModal('cashInQuickModal')">Annuler</button>
      <button class="success" onclick="addQuickCashIn()">‚úÖ Ajouter</button>
    </div>
  </div>
</div>

<div id="cashInStatsModal" class="modal">
  <div class="modal-content wide">
    <h3 class="modal-title">üìà Statistiques des Alimentations</h3>
    <p class="modal-subtitle">Vue d'ensemble des alimentations de caisse</p>
    <div id="cashInStatsContent" style="max-height:500px;overflow-y:auto"></div>
    <div class="modal-buttons">
      <button class="secondary" onclick="closeModal('cashInStatsModal')">Fermer</button>
    </div>
  </div>
</div>

<div id="syncLogModal" class="modal">
  <div class="modal-content wide">
    <h3 class="modal-title">üìã Journal de Synchronisation</h3>
    <p class="modal-subtitle">Historique des op√©rations Supabase</p>
    <div id="syncLogContent" style="max-height:450px;overflow-y:auto"></div>
    <div class="modal-buttons">
      <button class="secondary" onclick="closeModal('syncLogModal')">Fermer</button>
    </div>
  </div>
</div>


<!-- MODAL √âTAT D√âPENSES NON JUSTIFI√âES PAR PERSONNE -->
<div id="unjustifiedPersonModal" class="modal" onclick="if(event.target===this)closeModal('unjustifiedPersonModal')">
  <div class="modal-content wide" style="max-height:90vh;display:flex;flex-direction:column;padding:24px">
    <!-- Header avec bouton X -->
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;flex-shrink:0">
      <h3 class="modal-title" style="margin:0">‚ö†Ô∏è D√©penses Non Justifi√©es ‚Äî <span id="unjustifiedPersonName" style="color:var(--danger)"></span></h3>
      <button onclick="closeModal('unjustifiedPersonModal')" title="Fermer" style="width:36px;height:36px;min-width:36px;border-radius:50%;background:#FEE2E2;color:#DC2626;font-size:20px;font-weight:900;border:2px solid #FCA5A5;display:flex;align-items:center;justify-content:center;cursor:pointer;padding:0;box-shadow:none;flex-shrink:0;line-height:1">‚úï</button>
    </div>
    <p class="modal-subtitle" id="unjustifiedPersonSubtitle" style="flex-shrink:0;margin-bottom:16px"></p>
    <!-- Contenu scrollable -->
    <div id="unjustifiedPersonContent" style="overflow-y:auto;flex:1;min-height:0"></div>

  </div>
</div>
<input type="file" id="importFileInput" accept=".json" style="display:none" onchange="handleImportFile(event)">

<!-- LOADING OVERLAY -->
<div id="loadingOverlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(15,23,42,0.85);z-index:99999;justify-content:center;align-items:center;flex-direction:column;gap:20px">
  <div style="background:white;border-radius:20px;padding:40px 48px;text-align:center;box-shadow:0 25px 50px rgba(0,0,0,0.4);max-width:400px;width:90%">
    <div style="font-size:48px;margin-bottom:16px">‚òÅÔ∏è</div>
    <div style="font-size:18px;font-weight:800;color:#0F172A;margin-bottom:8px">Synchronisation en cours...</div>
    <div id="loadingOverlayText" style="font-size:14px;color:#64748B;margin-bottom:20px">R√©cup√©ration de vos donn√©es depuis Supabase</div>
    <div style="background:#E2E8F0;border-radius:8px;overflow:hidden;height:8px">
      <div id="loadingProgressBar" style="height:100%;background:linear-gradient(90deg,#3ECF8E,#7C3AED);width:0%;transition:width 0.4s ease;border-radius:8px"></div>
    </div>
    <div id="loadingProgressText" style="font-size:12px;color:#94A3B8;margin-top:8px">0%</div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- ‚ïê‚ïê‚ïê Fonctions globales d'overlay ‚Äî accessibles depuis TOUS les scripts ‚ïê‚ïê‚ïê -->
<script>
function showStartupOverlay(text, pct){
  let ov = document.getElementById('startupOverlay');
  if(!ov){
    ov = document.createElement('div');
    ov.id = 'startupOverlay';
    ov.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#0F172A 0%,#1E293B 50%,#334155 100%);z-index:99999;display:flex;justify-content:center;align-items:center;flex-direction:column';
    ov.innerHTML = `<div style="text-align:center;color:white;padding:20px">
      <div style="font-size:64px;margin-bottom:16px">üí∞</div>
      <div style="font-size:22px;font-weight:800;margin-bottom:6px;font-family:Manrope,sans-serif">Gestion des D√©penses</div>
      <div id="startupOverlayText" style="font-size:14px;opacity:.7;margin-bottom:28px;font-family:Manrope,sans-serif">Chargement...</div>
      <div style="width:280px;background:rgba(255,255,255,.15);border-radius:8px;overflow:hidden;height:6px;margin:0 auto 10px">
        <div id="startupProgressBar" style="height:100%;background:linear-gradient(90deg,#F59E0B,#10B981);width:0%;transition:width .4s ease;border-radius:8px"></div>
      </div>
      <div id="startupProgressPct" style="font-size:12px;opacity:.5;font-family:Manrope,sans-serif">0%</div>
    </div>`;
    document.body.appendChild(ov);
  }
  const t=document.getElementById('startupOverlayText');
  const b=document.getElementById('startupProgressBar');
  const p=document.getElementById('startupProgressPct');
  if(t)t.textContent=text;
  if(b)b.style.width=pct+'%';
  if(p)p.textContent=pct+'%';
}
function hideStartupOverlay(){
  const ov=document.getElementById('startupOverlay');
  if(ov){ ov.style.transition='opacity .4s'; ov.style.opacity='0'; setTimeout(()=>{ if(ov.parentNode)ov.parentNode.removeChild(ov); },450); }
}
</script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODULE SUPABASE COMPLET
//  - Connexion via URL + Anon Key (stock√©es dans localStorage)
//  - Push / Pull / Auto-Sync / Sync Complet
//  - Persistance de session (reconnexion automatique au d√©marrage)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function(){
  const LS_URL  = 'sbUrl';
  const LS_KEY  = 'sbKey';
  const LS_SYNC = 'sbLastSync';
  const CDN     = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js';

  let _sb       = null;   // client Supabase actif
  let _autoTimer = null;
  let _syncLog   = [];

  // ‚îÄ‚îÄ Charger le SDK Supabase depuis CDN ‚îÄ‚îÄ
  function _loadSDK(){ return new Promise((res,rej)=>{
    if(window.supabase){ res(); return; }
    const s=document.createElement('script');
    s.src=CDN; s.onload=res; s.onerror=()=>rej(new Error('Impossible de charger le SDK Supabase. V√©rifiez votre connexion internet.'));
    document.head.appendChild(s);
  });}

  // ‚îÄ‚îÄ Cr√©er le client ‚îÄ‚îÄ
  function _createClient(url,key){
    try{
      _sb = window.supabase.createClient(url, key, {
        auth:{ persistSession:false },
        global:{ headers:{ 'x-app':'depense-v3' } }
      });
      return true;
    }catch(e){ _sb=null; return false; }
  }

  // ‚îÄ‚îÄ Badge statut ‚îÄ‚îÄ
  function _setBadge(ok, txt){
    const b=document.getElementById('supabaseStatusBadge');
    if(!b)return;
    b.textContent = txt||( ok?'‚óè Connect√©':'‚óè Non configur√©' );
    b.style.background = ok?'#D1FAE5':'#FEE2E2';
    b.style.color      = ok?'#065F46':'#991B1B';
  }

  // ‚îÄ‚îÄ Sections config / sync ‚îÄ‚îÄ
  function _showSyncUI(connected){
    const cfg=document.getElementById('supabaseConfigSection');
    const sync=document.getElementById('supabaseSyncSection');
    if(cfg)  cfg.style.display  = connected?'none':'block';
    if(sync) sync.style.display = connected?'block':'none';
    if(connected){
      const url=localStorage.getItem(LS_URL)||'';
      const infoEl=document.getElementById('supabaseProjectInfo');
      if(infoEl) infoEl.textContent='Projet : '+url.replace('https://','').split('.')[0];
      _refreshLastSyncUI();
    }
  }

  function _refreshLastSyncUI(){
    const el=document.getElementById('supabaseLastSync');
    if(!el)return;
    const ts=localStorage.getItem(LS_SYNC);
    el.textContent = ts?'Derni√®re sync : '+new Date(ts).toLocaleString('fr-FR'):'Aucune synchronisation effectu√©e.';
  }

  function _setProgress(pct, txt){
    const bar=document.getElementById('supabaseProgressBar');
    const lbl=document.getElementById('supabaseProgressText');
    const wrap=document.getElementById('supabaseProgress');
    if(wrap) wrap.style.display= pct<100?'block':'none';
    if(bar)  bar.style.width   = pct+'%';
    if(lbl)  lbl.textContent   = txt||'';
  }

  function _log(msg, type='info'){
    const ts=new Date().toLocaleTimeString('fr-FR');
    _syncLog.unshift({ts, msg, type});
    if(_syncLog.length>100) _syncLog.pop();
  }

  function updateOfflineBanner(){
    const b=document.getElementById('offlineBanner');
    if(!b)return;
    b.style.display = (!navigator.onLine && _sb) ? 'flex':'none';
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONNEXION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  window.connectSupabase = async function(){
    const urlEl=document.getElementById('supabaseUrlInput');
    const keyEl=document.getElementById('supabaseKeyInput');
    const stEl =document.getElementById('supabaseConfigStatus');
    const url=(urlEl?urlEl.value:'').trim();
    const key=(keyEl?keyEl.value:'').trim();
    if(!url||!key){ if(stEl){stEl.style.color='#DC2626';stEl.textContent='‚ö†Ô∏è Veuillez renseigner l\'URL et la cl√©.';} return; }
    if(stEl){stEl.style.color='#64748B';stEl.textContent='‚è≥ Chargement du SDK...';}
    try{
      await _loadSDK();
      if(!_createClient(url,key)) throw new Error('Impossible d\'initialiser le client.');
      if(stEl){stEl.style.color='#64748B';stEl.textContent='‚è≥ Test de connexion...';}
      const {error}=await Promise.race([
        _sb.from('users_data').select('username').limit(1),
        new Promise((_,rej)=>setTimeout(()=>rej(new Error('Timeout ‚Äî v√©rifiez l\'URL et que le projet Supabase est actif.')),12000))
      ]);
      if(error && error.code!=='PGRST116') throw new Error(error.message);
      localStorage.setItem(LS_URL,url); localStorage.setItem(LS_KEY,key);
      _setBadge(true,'‚óè Connect√©');
      _showSyncUI(true);
      _log('Connexion Supabase √©tablie','success');
      if(stEl){stEl.style.color='#16A34A';stEl.textContent='‚úÖ Connect√© avec succ√®s !';}
      if(typeof showNotification==='function') showNotification('‚úÖ Supabase connect√© !');
    }catch(e){
      _sb=null;
      _setBadge(false,'‚óè Erreur');
      if(stEl){stEl.style.color='#DC2626';stEl.textContent='‚ùå '+e.message;}
      _log('√âchec connexion : '+e.message,'error');
    }
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê D√âCONNEXION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  window.disconnectSupabase = function(){
    if(!confirm('D√©connecter Supabase ? Les donn√©es locales sont conserv√©es.')) return;
    _sb=null;
    localStorage.removeItem(LS_URL); localStorage.removeItem(LS_KEY);
    clearInterval(_autoTimer); _autoTimer=null;
    _setBadge(false,'‚óè Non configur√©'); _showSyncUI(false);
    if(typeof showNotification==='function') showNotification('üîå Supabase d√©connect√©.');
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PUSH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  window.supabasePush = async function(silent){
    if(!_sb){if(!silent)showNotification('‚ùå Supabase non connect√©.');return;}
    if(!navigator.onLine){if(!silent)showNotification('üì∂ Hors ligne ‚Äî Push impossible.');return;}
    if(!window.currentUser){if(!silent)showNotification('‚ö†Ô∏è Aucun utilisateur connect√©.');return;}
    if(!silent) _setProgress(5,'Envoi en cours...');
    try{
      await _pushAll(window.currentUser, silent?()=>{}:(p,t)=>_setProgress(p,t));
      localStorage.setItem(LS_SYNC,new Date().toISOString());
      _refreshLastSyncUI();
      if(!silent){ _setProgress(100,''); _log('Push r√©ussi','success'); showNotification('‚òÅÔ∏è Donn√©es envoy√©es vers Supabase !'); }
    }catch(e){
      if(!silent){ _setProgress(100,''); showNotification('‚ùå Push √©chou√© : '+e.message); }
      _log('Push √©chou√© : '+e.message,'error');
      console.warn('[SB] Push:',e.message);
    }
  };

  async function _sbDel(table, u){ const {error}=await _sb.from(table).delete().eq('username',u); if(error) console.warn('[SB] delete',table,error.message); }
  async function _sbIns(table, rows){ if(!rows||rows.length===0) return; const {error}=await _sb.from(table).insert(rows); if(error) throw new Error(table+': '+error.message); }
  async function _sbUps(table, row, col){ const {error}=await _sb.from(table).upsert(row,{onConflict:col}); if(error) throw new Error(table+': '+error.message); }

  async function _pushAll(u, onProgress){
    const usr=window.users[u];
    if(!usr) throw new Error('Utilisateur introuvable');

    onProgress(10,'Utilisateur...');
    await _sbUps('users_data',{username:u,full_name:usr.fullName,email:usr.email||'',password:usr.password,role:usr.role||'standard'},'username');

    onProgress(20,'Personnes...');
    await _sbDel('persons',u);
    await _sbIns('persons',(window.persons||[]).map(p=>({username:u,person_id:p.id,name:p.name})));

    onProgress(35,'Libell√©s...');
    await _sbDel('labels',u);
    await _sbIns('labels',(window.labels||[]).map(l=>({username:u,label_id:l.id,code:l.code,name:l.name,description:l.description||''})));

    onProgress(45,'Projets...');
    await _sbDel('projets',u);
    await _sbIns('projets',(window.projets||[]).map(p=>({username:u,projet_id:p.id,name:p.name,code:p.code||'',description:p.description||''})));

    onProgress(60,'D√©penses...');
    await _sbDel('transactions',u);
    const allTx=[];
    for(const mk in (window.transactions||{}))
      (window.transactions[mk]||[]).forEach(t=>allTx.push({
        username:u, month_key:mk, date:t.date, person_id:t.personId||'',
        label_id:t.labelId||'', code:t.code||'', description:t.description||'',
        projet:t.projet||'', amount:t.amount||0, justified:!!t.justified,
        expense_id:t.expenseId||'', is_transferred:!!t._transferred
      }));
    await _sbIns('transactions',allTx);

    onProgress(78,'Alimentations...');
    await _sbDel('cash_in',u);
    const allCI=[];
    for(const mk in (window.cashIn||{}))
      (window.cashIn[mk]||[]).forEach(c=>allCI.push({
        username:u, month_key:mk, date:c.date||'', amount:c.amount||0,
        description:c.description||'', is_cloture:!!c.isCloture, is_transfer:!!c.isTransfer
      }));
    await _sbIns('cash_in',allCI);

    onProgress(88,'Soldes...');
    await _sbDel('balances',u);
    await _sbIns('balances',Object.entries(window.balances||{}).map(([mk,amt])=>({username:u,month_key:mk,amount:amt||0})));

    onProgress(95,'Mois cl√¥tur√©s...');
    try{ await _sbDel('closed_months',u); }catch(e){}
    const cmRows=Object.entries(window.closedMonths||{}).map(([mk,v])=>({username:u,month_key:mk,label:v.label||mk,closed_at:v.closedAt||new Date().toISOString()}));
    try{ await _sbIns('closed_months',cmRows); }catch(e){ console.warn('[SB] closed_months insert:',e.message); }

    onProgress(100,'');
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PULL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  window.supabasePull = async function(){
    if(!_sb){showNotification('‚ùå Supabase non connect√©.');return;}
    if(!navigator.onLine){showNotification('üì∂ Hors ligne ‚Äî Pull impossible.');return;}
    if(!window.currentUser){showNotification('‚ö†Ô∏è Aucun utilisateur connect√©.');return;}
    if(!confirm('‚¨áÔ∏è R√©cup√©rer les donn√©es depuis Supabase ?\n\nLes donn√©es locales seront remplac√©es.')) return;
    _setProgress(5,'R√©cup√©ration...');
    try{
      await _pullAll(window.currentUser, (p,t)=>_setProgress(p,t));
      localStorage.setItem(LS_SYNC,new Date().toISOString());
      _refreshLastSyncUI(); _setProgress(100,'');
      _log('Pull r√©ussi','success');
      if(typeof showNotification==='function') showNotification('‚¨áÔ∏è Donn√©es r√©cup√©r√©es depuis Supabase !');
      if(typeof renderTransactions==='function') renderTransactions();
      if(typeof renderCashInTable==='function') renderCashInTable();
      if(typeof updateSummary==='function') updateSummary();
    }catch(e){
      _setProgress(100,'');
      _log('Pull √©chou√© : '+e.message,'error');
      if(typeof showNotification==='function') showNotification('‚ùå Pull √©chou√© : '+e.message);
    }
  };

  async function _pullAll(u, onProgress){
    onProgress(10,'Personnes...');
    const [{data:pRows},{data:lRows},{data:prRows},{data:txRows},{data:ciRows},{data:bRows},{data:cmRows}] = await Promise.all([
      _sb.from('persons').select('*').eq('username',u),
      _sb.from('labels').select('*').eq('username',u),
      _sb.from('projets').select('*').eq('username',u),
      _sb.from('transactions').select('*').eq('username',u),
      _sb.from('cash_in').select('*').eq('username',u),
      _sb.from('balances').select('*').eq('username',u),
      _sb.from('closed_months').select('*').eq('username',u)
    ]);
    onProgress(60,'Application des donn√©es...');
    window.persons  = (pRows||[]).map(r=>({id:r.person_id,name:r.name}));
    window.labels   = (lRows||[]).map(r=>({id:r.label_id,code:r.code,name:r.name,description:r.description||''}));
    window.projets  = (prRows||[]).map(r=>({id:r.projet_id||r.id,name:r.name,code:r.code||'',description:r.description||''}));
    window.transactions={};
    (txRows||[]).forEach(r=>{
      if(!window.transactions[r.month_key]) window.transactions[r.month_key]=[];
      window.transactions[r.month_key].push({
        date:r.date, personId:r.person_id, labelId:r.label_id, code:r.code,
        description:r.description||'', projet:r.projet||'', amount:parseFloat(r.amount),
        justified:r.justified, expenseId:r.expense_id||'', _transferred:!!r.is_transferred
      });
    });
    window.cashIn={};
    (ciRows||[]).forEach(r=>{
      if(!window.cashIn[r.month_key]) window.cashIn[r.month_key]=[];
      window.cashIn[r.month_key].push({date:r.date,amount:parseFloat(r.amount),description:r.description||'',isCloture:!!r.is_cloture,isTransfer:!!r.is_transfer});
    });
    window.balances={};
    (bRows||[]).forEach(r=>{ window.balances[r.month_key]=parseFloat(r.amount); });
    window.closedMonths={};
    (cmRows||[]).forEach(r=>{ window.closedMonths[r.month_key]={closedAt:r.closed_at,label:r.label}; });
    // Sauvegarder localement
    if(window.users&&window.users[u]){
      window.users[u].data={persons:window.persons,labels:window.labels,projets:window.projets,transactions:window.transactions,balances:window.balances,cashIn:window.cashIn,closedMonths:window.closedMonths};
      if(typeof saveUserData==='function') saveUserData();
    }
    onProgress(100,'');
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTO-SYNC ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  window.supabaseAutoSync = function(){
    if(_autoTimer){ clearInterval(_autoTimer); _autoTimer=null;
      const btn=document.getElementById('supabaseAutoSyncBtn');
      if(btn){btn.style.background='#059669';btn.querySelector('.btn-icon').textContent='üîÑ Auto-Sync';}
      if(typeof showNotification==='function') showNotification('‚èπÔ∏è Auto-Sync d√©sactiv√©');
      return;
    }
    _autoTimer=setInterval(()=>{ if(_sb&&navigator.onLine&&window.currentUser) _silentPush(); },60000);
    const btn=document.getElementById('supabaseAutoSyncBtn');
    if(btn){btn.style.background='#DC2626';btn.querySelector('.btn-icon').textContent='‚èπÔ∏è Stop Auto-Sync';}
    if(typeof showNotification==='function') showNotification('üîÑ Auto-Sync activ√© (toutes les 60s)');
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SYNC COMPLET ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  window.supabaseSyncAll = async function(){
    if(!_sb){showNotification('‚ùå Supabase non connect√©.');return;}
    if(!navigator.onLine){showNotification('üì∂ Hors ligne.');return;}
    if(!window.currentUser){showNotification('‚ö†Ô∏è Aucun utilisateur connect√©.');return;}
    if(!confirm('üîÅ Sync complet :\n1. Push (local ‚Üí cloud)\n2. Pull (cloud ‚Üí local)\n\nContinuer ?')) return;
    await window.supabasePush();
    await window.supabasePull();
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PUSH SILENCIEUX ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  async function _silentPush(){
    if(!_sb||!navigator.onLine||!window.currentUser) return;
    try{ await _pushAll(window.currentUser,()=>{}); localStorage.setItem(LS_SYNC,new Date().toISOString()); _refreshLastSyncUI(); }
    catch(e){ console.warn('[Supabase] Silent push √©chou√©:',e.message); }
  }
  window._silentPush = _silentPush;

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê JOURNAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  window.showSyncStatus = function(){
    const el=document.getElementById('syncLogContent');
    if(!el)return;
    if(_syncLog.length===0){ el.innerHTML='<p style="color:#64748B;text-align:center;padding:20px">Aucune op√©ration enregistr√©e.</p>'; }
    else el.innerHTML=_syncLog.map(l=>`<div style="padding:6px 10px;border-bottom:1px solid #E2E8F0;font-size:12px;font-family:monospace;color:${l.type==='error'?'#DC2626':l.type==='success'?'#16A34A':'#475569'}"><span style="opacity:.5">${l.ts}</span> ${l.msg}</div>`).join('');
    if(typeof openModal==='function') openModal('syncLogModal');
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CLIENT PUBLIC ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  window._getSupabaseClient = ()=>_sb;
  window._supabaseModule = {
    connect: window.connectSupabase,
    disconnect: window.disconnectSupabase,
    getStatus: ()=>!!_sb,
    push: window.supabasePush,
    pull: window.supabasePull,
    autoSync: window.supabaseAutoSync,
    syncAll: async function(){ await window.supabasePush(); await window.supabasePull(); }
  };

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RESTAURATION AUTO AU D√âMARRAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  async function _tryReconnect(){
    const url=localStorage.getItem(LS_URL);
    const key=localStorage.getItem(LS_KEY);
    if(!url||!key) return;
    try{
      await _loadSDK();
      if(!_createClient(url,key)) return;
      // Test silencieux
      const {error}=await Promise.race([
        _sb.from('users_data').select('username').limit(1),
        new Promise((_,rej)=>setTimeout(()=>rej(new Error('Timeout')),8000))
      ]);
      if(error && error.code!=='PGRST116'){ _sb=null; return; }
      _setBadge(true,'‚óè Connect√©'); _showSyncUI(true);
      _log('Reconnexion automatique r√©ussie','success');
    }catch(e){ _sb=null; console.warn('[Supabase] Reconnexion auto √©chou√©e:',e.message); }
  }

  document.addEventListener('DOMContentLoaded',()=>{
    _tryReconnect();
    window.addEventListener('online',  ()=>{ updateOfflineBanner(); if(_sb&&window.currentUser) _silentPush(); });
    window.addEventListener('offline', ()=>{ updateOfflineBanner(); });
    window._startupDone = true;
    window.dispatchEvent(new Event('supabaseStartupDone'));
  });

})();

function supabasePush(){ if(window._supabaseModule) window._supabaseModule.push(); }
function supabasePull(){ if(window._supabaseModule) window._supabaseModule.pull(); }
function supabaseAutoSync(){ if(window._supabaseModule) window._supabaseModule.autoSync(); }
function supabaseSyncAll(){ if(window._supabaseModule) window._supabaseModule.syncAll && window._supabaseModule.syncAll(); }
function testSupabaseConnection(){ if(typeof testSingleTable==='function') testSingleTable('users_data'); }
</script>
<script>
let users={},currentUser=null,persons=[],labels=[],projets=[],transactions={},balances={},cashIn={},closedMonths={};
let passwordModalCallback=null,editingTransactionIndex=null,editingLabelId=null,editingCashInIndex=null,editingCashInMk=null;
let currentMonthIndex=new Date().getMonth(),currentYear=new Date().getFullYear();
let currentViewMode='month'; // 'month' | 'year' | 'global'

const fmt=n=>Number(n).toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2});
const pad=n=>String(n).padStart(2,'0');
const getMonthKey=()=>`${currentYear}-${pad(currentMonthIndex+1)}`;

// ‚îÄ‚îÄ Vue Mode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setViewMode(mode){
  currentViewMode=mode;
  const mnw=document.getElementById('monthNavWrapper');
  const ynw=document.getElementById('yearNavWrapper');
  const gnw=document.getElementById('globalNavWrapper');
  const formCard=document.querySelector('#mainPage .card');
  ['month','year','global'].forEach(m=>{
    const btn=document.getElementById('viewBtn_'+m);
    if(btn){ btn.style.background=m===mode?'var(--accent)':'transparent'; btn.style.color=m===mode?'white':'#94A3B8'; }
  });
  if(mnw) mnw.style.display=mode==='month'?'flex':'none';
  if(ynw) ynw.style.display=mode==='year'?'flex':'none';
  if(gnw) gnw.style.display=mode==='global'?'flex':'none';
  // Formulaire toujours visible dans tous les modes
  if(formCard){ formCard.style.display=''; }
  if(mode==='year') document.getElementById('currentYearDisplay').textContent=currentYear;
  renderTransactions();
}

function previousYear(){ currentYear--; document.getElementById('currentYearDisplay').textContent=currentYear; renderTransactions(); }
function nextYear(){ currentYear++; document.getElementById('currentYearDisplay').textContent=currentYear; renderTransactions(); }

// ‚îÄ‚îÄ Collecte des transactions selon la vue ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getViewTransactions(){
  if(currentViewMode==='month'){
    const mk=getMonthKey();
    return (transactions[mk]||[]).map((t,i)=>({...t,_mk:mk,_index:i}));
  }
  if(currentViewMode==='year'){
    const list=[];
    Object.keys(transactions).filter(mk=>mk.startsWith(currentYear+'-')).sort().forEach(mk=>{
      (transactions[mk]||[]).forEach((t,i)=>list.push({...t,_mk:mk,_index:i}));
    });
    return list;
  }
  // global
  const list=[];
  Object.keys(transactions).sort().forEach(mk=>{
    (transactions[mk]||[]).forEach((t,i)=>list.push({...t,_mk:mk,_index:i}));
  });
  return list;
}
function openModal(id){document.getElementById(id).classList.add('active')}
function closeModal(id){document.getElementById(id).classList.remove('active')}

function showPasswordModal(msg,cb){
  passwordModalCallback=cb;
  document.getElementById('passwordModalMessage').textContent=msg;
  document.getElementById('passwordModalInput').value='';
  openModal('passwordModal');
  setTimeout(()=>document.getElementById('passwordModalInput').focus(),100);
}
function closePasswordModal(){
  closeModal('passwordModal');
  document.getElementById('passwordModalInput').value='';
  passwordModalCallback=null;
}
function confirmPasswordModal(){
  const pw=document.getElementById('passwordModalInput').value;
  if(!pw){alert('‚ùå Veuillez entrer votre mot de passe');return}
  if(users[currentUser].password!==pw){
    alert('‚ùå Mot de passe incorrect !');
    document.getElementById('passwordModalInput').value='';
    document.getElementById('passwordModalInput').focus();
    return;
  }
  const cb=passwordModalCallback;
  closePasswordModal();
  if(cb)setTimeout(()=>cb(),100);
}
document.addEventListener('keypress',e=>{
  if(e.key==='Enter'){
    if(document.getElementById('passwordModal').classList.contains('active'))confirmPasswordModal();
    const a=document.activeElement;
    if(a.id==='loginPassword')login();
  }
});


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LISTE NOIRE des comptes supprim√©s ‚Äî emp√™che reimport Supabase
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function _getDeletedUsers(){
  try{ return JSON.parse(localStorage.getItem('deletedUsers')||'[]'); }catch(e){ return []; }
}
function _addDeletedUsers(usernames){
  const existing = _getDeletedUsers();
  const merged = [...new Set([...existing,...usernames])];
  localStorage.setItem('deletedUsers', JSON.stringify(merged));
}
function _isDeleted(username){
  return _getDeletedUsers().includes(username);
}

function init(){
  const saved = localStorage.getItem('appUsers');
  if(saved){ try{ users=JSON.parse(saved); }catch(e){ users={}; } }
  try{ document.getElementById('authScreen').style.display='block'; }catch(e){}
  try{ document.getElementById('mainApp').style.display='none'; }catch(e){}
  showLogin();
  populateLoginSelect();
}
function saveUsers(){
  localStorage.setItem('appUsers',JSON.stringify(users));
  // ‚îÄ‚îÄ AUTO-SAVE param√®tres ‚îÄ‚îÄ
  if(window._fsAutoSave && window._fsAutoSave.isReady()){
    window._fsAutoSave.triggerSave();
  }
}
function loadUserData(){
  if(!currentUser||!users[currentUser])return;
  const d=users[currentUser].data;
  persons=d.persons||[];labels=d.labels||[];projets=d.projets||[];transactions=d.transactions||{};
  balances=d.balances||{};cashIn=d.cashIn||{};closedMonths=d.closedMonths||{};
  // Migration : attribuer des IDs au format ancien (entier) si pas encore migr√©
  let migrated=false;
  for(const mk in transactions){
    transactions[mk]=(transactions[mk]||[]).map(t=>{
      const m=(t.personId||'').match(/^(P\d+)/);
      if(m&&m[1]!==t.personId){migrated=true;return{...t,personId:m[1]}}
      return t;
    });
  }
  if(migrated)saveUserData();
  // Migration vers le nouveau syst√®me d'ID (une seule fois)
  migrateExpenseIds();
}
function saveUserData(){
  if(!currentUser||!users[currentUser])return;
  users[currentUser].data={persons,labels,projets,transactions,balances,cashIn,closedMonths,remboursements:(users[currentUser].data&&users[currentUser].data.remboursements)||{}};
  saveUsers();
  // ‚îÄ‚îÄ AUTO-SAVE vers C:\SAVE_DEPENSE\Save_data_Depense.json ‚îÄ‚îÄ
  if(window._fsAutoSave && window._fsAutoSave.isReady()){
    window._fsAutoSave.triggerSave();
  }
}

function showLogin(){
  document.getElementById('loginForm').style.display='block';
  document.getElementById('registerForm').style.display='none';
  clearMessages();populateLoginSelect();
  // Afficher le bouton de r√©cup√©ration si des comptes locaux existent
  _checkShowLocalRecovery();
}

function _checkShowLocalRecovery(){
  try{
    const raw=localStorage.getItem('appUsers');
    if(!raw) return;
    const parsed=JSON.parse(raw);
    const nb=Object.keys(parsed).length;
    const box=document.getElementById('localRecoveryBox');
    if(box && nb>0){
      box.style.display='block';
      box.querySelector('div:nth-child(2)').textContent=
        nb+' compte(s) d√©tect√©(s) localement : '+Object.keys(parsed).join(', ')+
        '. Connexion locale disponible si Supabase ne r√©pond pas.';
    }
  }catch(e){}
}

function forceLocalLogin(){
  const username=document.getElementById('loginUsername').value.trim();
  const password=document.getElementById('loginPassword').value;
  const err=document.getElementById('loginError');
  err.style.display='none';
  if(!username||!password){err.textContent='‚ùå Veuillez remplir les champs nom et mot de passe';err.style.display='block';return}
  // Recharger directement depuis localStorage
  try{
    const raw=localStorage.getItem('appUsers');
    if(raw) Object.assign(users, JSON.parse(raw));
  }catch(e){}
  if(!users[username]){
    err.textContent='‚ùå Compte "'+username+'" introuvable dans la sauvegarde locale.';err.style.display='block';return;
  }
  if(users[username].password!==password){
    err.textContent='‚ùå Mot de passe incorrect';err.style.display='block';return;
  }
  currentUser=username;
  loadUserData();
  showMainApp();
  showNotification('‚úÖ Connect√© en mode local (hors-ligne Supabase)');
}
function showRegister(){
  document.getElementById('loginForm').style.display='none';
  document.getElementById('registerForm').style.display='block';
  clearMessages();
  showRegisterWithRoleBadge();
}
function clearMessages(){
  ['loginError','registerError','registerSuccess'].forEach(id=>document.getElementById(id).style.display='none');
}
function populateLoginSelect(){
  const dl=document.getElementById('loginUsernameList');
  if(!dl)return;
  dl.innerHTML='';
  Object.keys(users).forEach(u=>{
    const o=document.createElement('option');
    o.value=u;
    dl.appendChild(o);
  });
}
// ‚ïê‚ïê GESTION DES ROLES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function isFirstAccount(){ return Object.keys(users).length === 0; }
function getAdminUsername(){
  return Object.keys(users).find(u => users[u].role === 'admin') || null;
}
function isAdmin(u){ return users[u] && users[u].role === 'admin'; }

function showRegisterWithRoleBadge(){
  const badge = document.getElementById('registerTypeBadge');
  const icon  = document.getElementById('registerLogoIcon');
  const title = document.getElementById('registerTitle');
  const sub   = document.getElementById('registerSubtitle');
  if(!badge) return;
  const firstAccount = isFirstAccount();
  badge.style.display = 'block';
  if(firstAccount){
    badge.style.background = '#FEF3C7'; badge.style.border = '2px solid #F59E0B'; badge.style.color = '#92400E';
    badge.innerHTML = 'üõ°Ô∏è Ce compte sera <strong>ADMINISTRATEUR</strong><br><span style="font-size:11px;font-weight:400">Il aura tous les droits de gestion de l&#39;application.</span>';
    if(icon) icon.textContent='üõ°Ô∏è';
    if(title) title.textContent='Cr√©er le Compte Administrateur';
    if(sub) sub.textContent='Premier compte ‚Äî acc√®s complet √† l\'application';
  } else {
    badge.style.background = '#EFF6FF'; badge.style.border = '2px solid #3B82F6'; badge.style.color = '#1E40AF';
    badge.innerHTML = 'üë§ Ce compte sera de type <strong>STANDARD</strong><br><span style="font-size:11px;font-weight:400">Acc√®s normal √† la saisie et consultation des donn√©es.</span>';
    if(icon) icon.textContent='üìù';
    if(title) title.textContent='Cr√©er un Compte Standard';
    if(sub) sub.textContent='Commencez √† g√©rer vos d√©penses';
  }
}

async function register(){
  const username=document.getElementById('registerUsername').value.trim();
  const fullName=document.getElementById('registerFullName').value.trim();
  const email=document.getElementById('registerEmail').value.trim();
  const password=document.getElementById('registerPassword').value;
  const confirmPass=document.getElementById('registerPasswordConfirm').value;
  const err=document.getElementById('registerError');
  const suc=document.getElementById('registerSuccess');
  err.style.display='none';suc.style.display='none';
  if(!username||!fullName||!password||!confirmPass){err.textContent='‚ùå Veuillez remplir tous les champs';err.style.display='block';return}
  if(username.length<3){err.textContent='‚ùå Le nom d\'utilisateur doit contenir au moins 3 caract√®res';err.style.display='block';return}
  if(email&&!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)){err.textContent='‚ùå Format d\'email invalide';err.style.display='block';return}
  if(password.length<4){err.textContent='‚ùå Le mot de passe doit contenir au moins 4 caract√®res';err.style.display='block';return}
  if(password!==confirmPass){err.textContent='‚ùå Les mots de passe ne correspondent pas';err.style.display='block';return}
  if(users[username]){err.textContent='‚ùå Ce nom d\'utilisateur existe d√©j√†';err.style.display='block';return}
  const role = isFirstAccount() ? 'admin' : 'standard';
  users[username]={password,fullName,email:email||'',role,data:{persons:[],labels:[],projets:[],transactions:{},balances:{},cashIn:{},closedMonths:{}}};
  saveUsers();
  try{
    const sb=window._getSupabaseClient&&window._getSupabaseClient();
    if(sb && navigator.onLine){
      await sb.from('users_data').upsert({username,full_name:fullName,email:email||'',password,role},{onConflict:'username'});
    }
  }catch(e){ console.warn('[SB] register:',e.message); }
  const roleLabel = role==='admin' ? 'üõ°Ô∏è Compte Administrateur cr√©√© !' : '‚úÖ Compte Standard cr√©√© !';
  suc.textContent = roleLabel + ' Vous pouvez maintenant vous connecter.';
  suc.style.display='block';
  ['registerUsername','registerFullName','registerEmail','registerPassword','registerPasswordConfirm'].forEach(id=>document.getElementById(id).value='');
  setTimeout(()=>{showLogin();document.getElementById('loginUsername').value=username;},2000);
}


function login(){
  const username=document.getElementById('loginUsername').value.trim();
  const password=document.getElementById('loginPassword').value;
  const err=document.getElementById('loginError');
  err.style.display='none';
  if(!username||!password){err.textContent='‚ùå Veuillez remplir tous les champs';err.style.display='block';return}

  // ‚îÄ‚îÄ S√âCURIT√â : toujours recharger depuis localStorage avant de v√©rifier ‚îÄ‚îÄ
  // (au cas o√π Supabase a √©chou√© au d√©marrage et users={} vide)
  const rawLocal = localStorage.getItem('appUsers');
  if(rawLocal){
    try{ const parsed=JSON.parse(rawLocal); Object.assign(users, parsed); }catch(e){}
  }

  // CAS 1 : compte local trouv√© ‚Üí connexion directe PRIORITAIRE
  if(users[username]){
    if(users[username].password!==password){
      err.textContent='‚ùå Mot de passe incorrect';err.style.display='block';return;
    }
    currentUser=username;
    loadUserData();
    showMainApp();
    return;
  }

  // CAS 2 : compte introuvable localement ‚Üí chercher sur Supabase
  const sb=window._getSupabaseClient&&window._getSupabaseClient();
  if(sb&&navigator.onLine){
    err.innerHTML='üîÑ Compte introuvable localement ‚Äî Recherche sur Supabase...';
    err.style.display='block';
    err.style.color='#1E40AF';err.style.background='#DBEAFE';err.style.borderColor='#93C5FD';
    sb.from('users_data').select('*').eq('username',username).single()
      .then(({data,error})=>{
        err.style.color='';err.style.background='';err.style.borderColor='';
        if(error||!data){
          err.textContent='‚ùå Compte "'+username+'" introuvable (ni en local, ni sur Supabase)';
          err.style.display='block';return;
        }
        if(data.password!==password){err.textContent='‚ùå Mot de passe incorrect';err.style.display='block';return}
        users[username]={password:data.password,fullName:data.full_name,email:data.email||'',
          data:{persons:[],labels:[],projets:[],transactions:{},balances:{},cashIn:{}}};
        saveUsers();populateLoginSelect();
        currentUser=username;loadUserData();showMainApp();
      })
      .catch(()=>{
        err.style.color='';err.style.background='';err.style.borderColor='';
        err.textContent='‚ùå Erreur r√©seau. Si vous avez d√©j√† utilis√© ce compte, rechargez la page et r√©essayez.';
        err.style.display='block';
      });
    return;
  }

  // CAS 3 : pas de Supabase, compte non trouv√© localement
  err.innerHTML='‚ùå Compte "'+username+'" introuvable.<br><span style="font-size:12px;font-weight:400">Si vous avez d√©j√† un compte, rechargez la page ou importez votre sauvegarde JSON dans Param√®tres.</span>';
  err.style.display='block';
}

// Pull Supabase apr√®s connexion ‚Äî met √† jour les donn√©es en arri√®re-plan
async function _pullDataAfterLogin(username){
  try{
    const sb=window._getSupabaseClient&&window._getSupabaseClient();
    if(!sb||!navigator.onLine) return;

    showLoadingOverlay('Synchronisation des donn√©es...', 10);

    const [{data:pRows},{data:lRows},{data:prRows_},{data:tRows},{data:cRows},{data:bRows}]=await Promise.all([
      sb.from('persons').select('*').eq('username',username),
      sb.from('labels').select('*').eq('username',username),
      sb.from('projets').select('*').eq('username',username),
      sb.from('transactions').select('*').eq('username',username),
      sb.from('cash_in').select('*').eq('username',username),
      sb.from('balances').select('*').eq('username',username)
    ]);

    showLoadingOverlay('Application des donn√©es...', 80);
    persons=(pRows||[]).map(r=>({id:r.person_id,name:r.name}));
    labels=(lRows||[]).map(r=>({id:r.label_id,code:r.code,name:r.name,description:r.description||''}));
    projets=(prRows_&&prRows_.length>0)?prRows_.map(r=>({id:r.projet_id||r.id,name:r.name,code:r.code||'',description:r.description||''})):[];
    transactions={};
    (tRows||[]).forEach(r=>{
      if(!transactions[r.month_key])transactions[r.month_key]=[];
      transactions[r.month_key].push({date:r.date,personId:r.person_id,labelId:r.label_id,
        code:r.code,description:r.description||'',projet:r.projet||'',
        amount:parseFloat(r.amount),justified:r.justified});
    });
    cashIn={};
    (cRows||[]).forEach(r=>{
      if(!cashIn[r.month_key])cashIn[r.month_key]=[];
      cashIn[r.month_key].push({date:r.date,amount:parseFloat(r.amount),description:r.description||''});
    });
    balances={};
    (bRows||[]).forEach(r=>{balances[r.month_key]=parseFloat(r.amount);});

    users[username].data={persons,labels,projets,transactions,balances,cashIn};
    saveUsers();
    localStorage.setItem('sbLastSync',new Date().toISOString());

    showLoadingOverlay('‚úÖ Donn√©es synchronis√©es !', 100);
    await new Promise(r=>setTimeout(r,500));
    hideLoadingOverlay();

    updatePersonsList();updateLabelsList();updateProjetsList();
    updatePersonSelects();updateLabelSelects();updateProjetSelects();
    renderTransactions();renderCashInTable();

    const nb=(tRows||[]).length,np=(pRows||[]).length,nl=(lRows||[]).length;
    showNotification(`‚òÅÔ∏è ${np} personne(s) ¬∑ ${nl} libell√©(s) ¬∑ ${nb} d√©pense(s)`);
  }catch(e){
    hideLoadingOverlay();
    console.warn('Pull apr√®s login √©chou√©:',e.message);
  }
}

function logout(){
  if(confirm('Voulez-vous vraiment vous d√©connecter ?')){
    saveUserData();
    currentUser=null;persons=[];labels=[];projets=[];transactions={};balances={};cashIn={};closedMonths={};
    document.getElementById('mainApp').style.display='none';
    document.getElementById('authScreen').style.display='block';
    document.getElementById('loginPassword').value='';
    showLogin();
  }
}

function showMainApp(){
  document.getElementById('authScreen').style.display='none';
  document.getElementById('mainApp').style.display='block';
  document.getElementById('currentUserDisplay').textContent=users[currentUser].fullName;
  const initials=users[currentUser].fullName.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
  document.getElementById('userAvatar').textContent=initials;
  document.getElementById('settingsUsername').value=currentUser;
  document.getElementById('settingsFullName').value=users[currentUser].fullName;
  document.getElementById('settingsEmail').value=users[currentUser].email||'';
  updatePersonsList();updateLabelsList();updateProjetsList();
  updatePersonSelects();updateLabelSelects();updateProjetSelects();
  updateMonthDisplay();setTodayDate();setTodayCashInDate();
  currentViewMode='month';
  setViewMode('month');
  renderTransactions();
  const yi=document.getElementById('resetYearSelect');
  const mi=document.getElementById('resetMonthSelect');
  if(yi)yi.value=new Date().getFullYear();
  if(mi)mi.value=new Date().getMonth();
  // ‚îÄ‚îÄ Badge r√¥le dans les param√®tres
  setTimeout(updateSettingsRoleBadge, 200);
  // ‚îÄ‚îÄ Sauvegarde automatique : activer au login (geste utilisateur = clic Se Connecter)
  if(window._fsAutoSave){
    window._fsAutoSave.activateOnLogin();
    setTimeout(()=>{ if(window._fsAutoSave) window._fsAutoSave.updateUI(); }, 500);
  }
}

function showPage(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  const map={main:['mainPage',0],alimentations:['alimentationsPage',1],persons:['personsPage',2],labels:['labelsPage',3],projets:['projetsPage',4],settings:['settingsPage',5]};
  if(map[name]){
    document.getElementById(map[name][0]).classList.add('active');
    document.querySelectorAll('.nav-tab')[map[name][1]].classList.add('active');
    if(name==='persons')updatePersonsList();
    if(name==='labels')updateLabelsList();
    if(name==='projets')updateProjetsList();
    if(name==='alimentations'){renderCashInTable();setTodayCashInDate()}
    if(name==='settings'){
      document.getElementById('settingsUsername').value=currentUser;
      document.getElementById('settingsFullName').value=users[currentUser].fullName;
      document.getElementById('settingsEmail').value=users[currentUser].email||'';
      updateSyncModeUI();
      updateAutoSaveSettingsStatus();
      updateSettingsRoleBadge();
    }
  }
}

const MONTHS=['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];

function _hasDataForMonth(y, m){
  const mk=`${y}-${pad(m+1)}`;
  return (transactions[mk]||[]).length>0||(cashIn[mk]||[]).length>0;
}
function _hasDataFromMonthOrLater(y,m){
  const refMk=`${y}-${pad(m+1)}`;
  const allKeys=new Set([...Object.keys(transactions||{}),...Object.keys(cashIn||{})]);
  for(const mk of allKeys){ if(mk>=refMk&&((transactions[mk]||[]).length>0||(cashIn[mk]||[]).length>0)) return true; }
  return false;
}
function _hasDataFromMonthOrEarlier(y,m){
  const refMk=`${y}-${pad(m+1)}`;
  const allKeys=new Set([...Object.keys(transactions||{}),...Object.keys(cashIn||{})]);
  for(const mk of allKeys){ if(mk<=refMk&&((transactions[mk]||[]).length>0||(cashIn[mk]||[]).length>0)) return true; }
  return false;
}

function updateMonthDisplay(){
  document.getElementById('currentMonth').textContent=`${MONTHS[currentMonthIndex]} ${currentYear}`;
  const mk=getMonthKey();
  const closed=isMonthClosed(mk);

  // ‚îÄ‚îÄ Banni√®re verrou d√©penses ‚îÄ‚îÄ
  let lb=document.getElementById('monthLockedBanner');
  if(!lb){ lb=document.createElement('div'); lb.id='monthLockedBanner';
    lb.style.cssText='display:none;margin:0 0 10px 0;padding:10px 18px;background:#FEE2E2;border:2px solid #FCA5A5;border-radius:12px;font-size:13px;font-weight:700;color:#991B1B;align-items:center;gap:10px';
    const mp=document.getElementById('mainPage'); if(mp){const fc=mp.querySelector('.card');if(fc)mp.insertBefore(lb,fc);} }
  lb.style.display=closed?'flex':'none';
  if(closed) lb.innerHTML='üîí <span>Le mois de <strong>'+MONTHS[currentMonthIndex]+' '+currentYear+'</strong> est <strong>CL√îTUR√â</strong> ‚Äî Aucune modification autoris√©e.</span>';

  // ‚îÄ‚îÄ Banni√®re verrou alimentations ‚îÄ‚îÄ
  let lbci=document.getElementById('monthLockedBannerCI');
  if(!lbci){ lbci=document.createElement('div'); lbci.id='monthLockedBannerCI';
    lbci.style.cssText='display:none;margin:0 0 10px 0;padding:10px 18px;background:#FEE2E2;border:2px solid #FCA5A5;border-radius:12px;font-size:13px;font-weight:700;color:#991B1B;align-items:center;gap:10px';
    const ap=document.getElementById('alimentationsPage'); if(ap){const fc=ap.querySelector('.card');if(fc)ap.insertBefore(lbci,fc);} }
  lbci.style.display=closed?'flex':'none';
  if(closed) lbci.innerHTML='üîí <span>Mois <strong>'+MONTHS[currentMonthIndex]+' '+currentYear+'</strong> cl√¥tur√© ‚Äî Alimentation et modification interdites.</span>';

  // ‚îÄ‚îÄ D√©sactiver formulaires si cl√¥tur√© ‚îÄ‚îÄ
  ['expenseDate','expensePerson','expenseAmount','expenseProjetSearch','expenseLabel','expenseCode','expenseDescription','expenseJustified','expenseEnPlus']
    .forEach(id=>{const el=document.getElementById(id);if(el){el.disabled=closed;el.style.opacity=closed?'0.45':'1';}});
  const ab=document.getElementById('addExpenseBtn');
  if(ab){ab.disabled=closed;ab.style.opacity=closed?'0.45':'1';}
  ['cashInDate','cashInAmount','cashInDescription']
    .forEach(id=>{const el=document.getElementById(id);if(el){el.disabled=closed;el.style.opacity=closed?'0.45':'1';}});
  const acb=document.getElementById('addCashInBtn');
  if(acb){acb.disabled=closed;acb.style.opacity=closed?'0.45':'1';}
  const cb=document.querySelector('#alimentationsPage button[onclick="closeMonth()"]');
  if(cb) cb.style.display=closed?'none':'';

  // ‚îÄ‚îÄ Bouton Cl√¥turer dans la navbar : gris√© + bloqu√© si mois cl√¥tur√© ‚îÄ‚îÄ
  const navCb=document.querySelector('.nav-tabs button[onclick="closeMonth()"]');
  if(navCb){
    navCb.disabled = closed;
    navCb.style.opacity = closed ? '0.45' : '1';
    navCb.style.cursor = closed ? 'not-allowed' : 'pointer';
    navCb.style.background = closed
      ? 'linear-gradient(135deg,#94A3B8 0%,#64748B 100%)'
      : 'linear-gradient(135deg,#10B981 0%,#059669 100%)';
    navCb.style.boxShadow = closed ? 'none' : 'var(--shadow-sm)';
    navCb.title = closed ? 'Mois d√©j√† cl√¥tur√©' : 'Cl√¥turer ce mois';
    navCb.querySelector('span').textContent = closed ? 'Cl√¥tur√©' : 'Cl√¥turer';
  }

  // ‚îÄ‚îÄ Fl√®ches navigation ‚îÄ‚îÄ
  let pm=currentMonthIndex-1,py=currentYear; if(pm<0){pm=11;py--;}
  let nm=currentMonthIndex+1,ny=currentYear; if(nm>11){nm=0;ny++;}
  const btnPrev=document.querySelector('#monthNavWrapper button:first-child');
  const btnNext=document.querySelector('#monthNavWrapper button:last-child');
  const hasPrev=_hasDataFromMonthOrEarlier(py,pm);
  const hasNext=_hasDataFromMonthOrLater(ny,nm);
  if(btnPrev){btnPrev.disabled=!hasPrev;btnPrev.style.background=hasPrev?'#3B82F6':'#94A3B8';btnPrev.style.cursor=hasPrev?'pointer':'not-allowed';btnPrev.style.opacity=hasPrev?'1':'0.45';}
  if(btnNext){btnNext.disabled=!hasNext;btnNext.style.background=hasNext?'#3B82F6':'#94A3B8';btnNext.style.cursor=hasNext?'pointer':'not-allowed';btnNext.style.opacity=hasNext?'1':'0.45';}
}

function previousMonth(){
  let pm=currentMonthIndex-1,py=currentYear; if(pm<0){pm=11;py--;}
  if(!_hasDataFromMonthOrEarlier(py,pm))return;
  while(!_hasDataForMonth(py,pm)){
    pm--;if(pm<0){pm=11;py--;} if(!_hasDataFromMonthOrEarlier(py,pm))return;
  }
  currentMonthIndex=pm;currentYear=py;
  updateMonthDisplay();renderTransactions();renderCashInTable();
}

function nextMonth(){
  let nm=currentMonthIndex+1,ny=currentYear; if(nm>11){nm=0;ny++;}
  if(!_hasDataFromMonthOrLater(ny,nm))return;
  while(!_hasDataForMonth(ny,nm)){
    nm++;if(nm>11){nm=0;ny++;} if(!_hasDataFromMonthOrLater(ny,nm))return;
  }
  currentMonthIndex=nm;currentYear=ny;
  updateMonthDisplay();renderTransactions();renderCashInTable();
}
function goToFirstMonth(){
  // Trouver le premier mois ayant des donn√©es (transactions ou alimentations)
  const allMks = [
    ...Object.keys(transactions||{}),
    ...Object.keys(cashIn||{})
  ].filter(mk => {
    const hasTx = (transactions[mk]||[]).length > 0;
    const hasCi = (cashIn[mk]||[]).length > 0;
    return hasTx || hasCi;
  });
  if(allMks.length === 0) return;
  const firstMk = allMks.sort()[0];
  const [fy, fm] = firstMk.split('-').map(Number);
  currentYear = fy; currentMonthIndex = fm - 1;
  updateMonthDisplay(); renderTransactions(); renderCashInTable();
}

function goToLastMonth(){
  // Trouver le dernier mois ayant des donn√©es (transactions ou alimentations)
  const allMks = [
    ...Object.keys(transactions||{}),
    ...Object.keys(cashIn||{})
  ].filter(mk => {
    const hasTx = (transactions[mk]||[]).length > 0;
    const hasCi = (cashIn[mk]||[]).length > 0;
    return hasTx || hasCi;
  });
  if(allMks.length === 0) return;
  const lastMk = allMks.sort().pop();
  const [ly, lm] = lastMk.split('-').map(Number);
  currentYear = ly; currentMonthIndex = lm - 1;
  updateMonthDisplay(); renderTransactions(); renderCashInTable();
}

function setTodayDate(){document.getElementById('expenseDate').value=new Date().toISOString().split('T')[0]}
function setTodayCashInDate(){const el=document.getElementById('cashInDate');if(el)el.value=new Date().toISOString().split('T')[0]}

function addPerson(){
  const name=document.getElementById('newPersonName').value.trim();
  if(!name){alert('‚ùå Veuillez entrer un nom');return}
  if(persons.find(p=>p.name===name)){alert('‚ùå Cette personne existe d√©j√†');return}
  persons.push({id:'P'+String(persons.length+1).padStart(3,'0'),name});
  updatePersonsList();updatePersonSelects();
  document.getElementById('newPersonName').value='';
  saveUserData();
}
function removePerson(id){
  const p=persons.find(p=>p.id===id);
  if(confirm(`Supprimer ${p.name} (${p.id}) ?`)){
    persons=persons.filter(p=>p.id!==id);
    updatePersonsList();updatePersonSelects();saveUserData();
  }
}
function editPerson(id){
  const p=persons.find(p=>p.id===id);if(!p)return;
  const n=prompt(`Modifier le nom de "${p.name}" :`,p.name);
  if(n===null)return;
  if(!n.trim()){alert('‚ùå Le nom ne peut pas √™tre vide');return}
  if(persons.find(x=>x.name===n.trim()&&x.id!==id)){alert('‚ùå Ce nom existe d√©j√†');return}
  p.name=n.trim();updatePersonsList();updatePersonSelects();saveUserData();
}
function updatePersonsList(){
  const list=document.getElementById('personsListDiv');if(!list)return;
  if(persons.length===0){list.innerHTML='<div class="empty-state"><div class="empty-state-icon">üë§</div><div class="empty-state-text">Aucune personne ajout√©e</div></div>';return}
  list.innerHTML=persons.map(p=>`<div class="list-item"><div class="list-item-info"><div class="list-item-name"><span class="text-mono" style="font-size:14px;font-weight:700;color:var(--accent)">${p.id}</span> : ${p.name}</div></div><div style="display:flex;gap:8px"><button onclick="editPerson('${p.id}')" title="Modifier" style="background:var(--accent);width:auto;padding:5px 10px;font-size:16px">‚úèÔ∏è</button><button class="danger" onclick="removePerson('${p.id}')" title="Supprimer" style="width:auto;padding:5px 10px;font-size:16px">üóëÔ∏è</button></div></div>`).join('');
}
function updatePersonSelects(){}
function openPersonsDropdown(){
  buildPersonsDropdown(document.getElementById('expensePerson').value);
  document.getElementById('personsDropdownList').style.display='block';
  document.getElementById('expensePerson').style.borderRadius='10px 10px 0 0';
  document.getElementById('expensePerson').style.borderColor='var(--accent)';
}
function closePersonsDropdown(){
  document.getElementById('personsDropdownList').style.display='none';
  document.getElementById('expensePerson').style.borderRadius='10px';
  document.getElementById('expensePerson').style.borderColor='var(--border)';
}
function filterPersonsDropdown(){
  buildPersonsDropdown(document.getElementById('expensePerson').value);
  document.getElementById('personsDropdownList').style.display='block';
  document.getElementById('expensePerson').style.borderRadius='10px 10px 0 0';
}
function buildPersonsDropdown(search){
  const list=document.getElementById('personsDropdownList');if(!list)return;
  const q=(search||'').toLowerCase();
  const filtered=persons.filter(p=>p.name.toLowerCase().includes(q)||p.id.toLowerCase().includes(q));
  let html='';
  if(filtered.length===0){
    html='<div style="padding:8px 12px;font-size:13px;color:#94A3B8;text-align:center">Aucune personne trouv√©e</div>';
  }else{
    html=filtered.map(p=>{
      const nameHl=q?p.name.replace(new RegExp(`(${q})`,'gi'),'<strong style="color:var(--accent)">$1</strong>'):p.name;
      const safeName=p.name.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
      return `<div onmousedown="event.preventDefault();selectPerson('${safeName}','${p.id}')" style="padding:8px 12px;font-size:13px;cursor:pointer;display:flex;align-items:center;border-bottom:1px solid #F1F5F9" onmouseenter="this.style.background='#F8FAFC'" onmouseleave="this.style.background=''">
        <span>${nameHl}</span>
      </div>`;
    }).join('');
  }
  list.innerHTML=html;
}
function selectPerson(name,id){
  document.getElementById('expensePerson').value=name;
  document.getElementById('expensePersonId').value=id;
  document.getElementById('personsDropdownList').style.display='none';
  document.getElementById('expensePerson').style.borderRadius='10px';
  document.getElementById('expensePerson').style.borderColor='var(--border)';
}
function clearPersons(){
  if(!isAdmin(currentUser)){alert('üõ°Ô∏è Action r√©serv√©e √† l\'Administrateur.');return;}
  if(!confirm('‚ö†Ô∏è ATTENTION : Voulez-vous vraiment vider TOUTE la liste des personnes ?\n\nCette action est irr√©versible !'))return;
  showPasswordModal('Entrez votre mot de passe pour vider la liste des personnes',()=>{
    persons=[];updatePersonsList();updatePersonSelects();saveUserData();
    alert('‚úÖ Liste des personnes vid√©e avec succ√®s !');
  });
}
function importPersonsFromExcel(){document.getElementById('personsExcelInput').click()}
function handlePersonsExcelFile(event){
  const file=event.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const data=new Uint8Array(e.target.result);
      const wb=XLSX.read(data,{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const rows=XLSX.utils.sheet_to_json(ws);
      if(rows.length===0){alert('‚ùå Le fichier Excel est vide');return}
      if(!rows[0].hasOwnProperty('Nom')&&!rows[0].hasOwnProperty('nom')&&!rows[0].hasOwnProperty('NOM')){alert('‚ùå Le fichier Excel doit contenir une colonne "Nom"');return}
      let added=0,skipped=0;
      rows.forEach(row=>{
        const name=(row.Nom||row.nom||row.NOM||'').toString().trim();
        if(name&&!persons.find(p=>p.name===name)){persons.push({id:'P'+String(persons.length+1).padStart(3,'0'),name});added++}
        else if(name)skipped++;
      });
      saveUserData();updatePersonsList();updatePersonSelects();
      alert(`‚úÖ Import termin√© !\n\n‚Ä¢ ${added} personne(s) ajout√©e(s)${skipped>0?'\n‚Ä¢ '+skipped+' personne(s) ignor√©e(s) (doublons)':''}`);
    }catch{alert('‚ùå Erreur lors de la lecture du fichier Excel.')}
  };
  reader.readAsArrayBuffer(file);event.target.value='';
}

function addLabel(){
  const code=document.getElementById('newLabelCode').value.trim();
  const name=document.getElementById('newLabelName').value.trim();
  const desc=document.getElementById('newLabelDesc').value.trim();
  if(!code||!name){alert('‚ùå Veuillez remplir le code comptable et le nom');return}
  if(editingLabelId!==null){
    const l=labels.find(l=>l.id===editingLabelId);
    if(l){
      if(labels.find(x=>x.name===name&&x.id!==editingLabelId)){alert('‚ùå Ce nom de libell√© existe d√©j√†');return}
      l.code=code;l.name=name;l.description=desc;
      updateLabelsList();updateLabelSelects();saveUserData();
      editingLabelId=null;
      document.getElementById('labelFormTitle').textContent='‚ûï Ajouter un Libell√©';
      document.getElementById('addLabelBtn').textContent='Ajouter le Libell√©';
      document.getElementById('cancelLabelEditBtn').style.display='none';
      ['newLabelCode','newLabelName','newLabelDesc'].forEach(id=>document.getElementById(id).value='');
    }
  }else{
    if(labels.find(l=>l.name===name)){alert('‚ùå Ce nom de libell√© existe d√©j√†');return}
    labels.push({id:'L'+String(labels.length+1).padStart(3,'0'),code,name,description:desc});
    updateLabelsList();updateLabelSelects();
    ['newLabelCode','newLabelName','newLabelDesc'].forEach(id=>document.getElementById(id).value='');
    saveUserData();
  }
}
function removeLabel(id){
  const l=labels.find(l=>l.id===id);
  if(confirm(`Supprimer le libell√© "${l.name}" ?`)){
    labels=labels.filter(l=>l.id!==id);
    updateLabelsList();updateLabelSelects();saveUserData();
  }
}
function editLabel(id){
  const l=labels.find(l=>l.id===id);if(!l)return;
  document.getElementById('newLabelCode').value=l.code;
  document.getElementById('newLabelName').value=l.name;
  document.getElementById('newLabelDesc').value=l.description||'';
  editingLabelId=id;
  document.getElementById('labelFormTitle').textContent='‚úèÔ∏è Modifier le Libell√©';
  document.getElementById('addLabelBtn').textContent='Enregistrer les Modifications';
  document.getElementById('cancelLabelEditBtn').style.display='block';
  document.getElementById('labelsPage').scrollIntoView({behavior:'smooth',block:'start'});
}
function cancelLabelEdit(){
  editingLabelId=null;
  ['newLabelCode','newLabelName','newLabelDesc'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('labelFormTitle').textContent='‚ûï Ajouter un Libell√©';
  document.getElementById('addLabelBtn').textContent='Ajouter le Libell√©';
  document.getElementById('cancelLabelEditBtn').style.display='none';
}
function updateLabelsList(){
  const list=document.getElementById('labelsList');
  if(labels.length===0){list.innerHTML='<div class="empty-state"><div class="empty-state-icon">üè∑Ô∏è</div><div class="empty-state-text">Aucun libell√© ajout√©</div></div>';return}
  list.innerHTML=labels.map(l=>`<div class="list-item"><div class="list-item-info"><div class="list-item-code">${l.id} | Code: ${l.code}</div><div class="list-item-name">${l.name}</div><div class="list-item-desc">${l.description||''}</div></div><div style="display:flex;gap:8px"><button onclick="editLabel('${l.id}')" title="Modifier" style="background:var(--accent);width:auto;padding:5px 10px;font-size:16px">‚úèÔ∏è</button><button class="danger" onclick="removeLabel('${l.id}')" title="Supprimer" style="width:auto;padding:5px 10px;font-size:16px">üóëÔ∏è</button></div></div>`).join('');
}
function updateLabelSelects(){
  const sel=document.getElementById('expenseLabel');
  const cur=sel.value;
  sel.innerHTML='<option value="">S√©lectionner...</option>'+labels.map(l=>`<option value="${l.id}">${l.name}</option>`).join('');
  sel.value=cur;
}
function clearLabels(){
  if(!isAdmin(currentUser)){alert('üõ°Ô∏è Action r√©serv√©e √† l\'Administrateur.');return;}
  if(!confirm('‚ö†Ô∏è ATTENTION : Voulez-vous vraiment vider TOUTE la liste des libell√©s ?\n\nCette action est irr√©versible !'))return;
  showPasswordModal('Entrez votre mot de passe pour vider la liste des libell√©s',()=>{
    labels=[];updateLabelsList();updateLabelSelects();saveUserData();
    alert('‚úÖ Liste des libell√©s vid√©e avec succ√®s !');
  });
}

let editingProjetId=null;
function addProjet(){
  const name=document.getElementById('newProjetName').value.trim();
  const code=document.getElementById('newProjetCode').value.trim();
  const desc=document.getElementById('newProjetDesc').value.trim();
  if(!name){alert('‚ùå Veuillez entrer un nom de projet');return}
  if(editingProjetId!==null){
    const p=projets.find(p=>p.id===editingProjetId);
    if(p){
      if(projets.find(x=>x.name===name&&x.id!==editingProjetId)){alert('‚ùå Ce nom de projet existe d√©j√†');return}
      p.name=name;p.code=code;p.description=desc;
      updateProjetsList();updateProjetSelects();saveUserData();
      editingProjetId=null;
      document.getElementById('projetFormTitle').textContent='üìÅ Ajouter un Projet';
      document.getElementById('addProjetBtn').textContent='üìÅ Ajouter le Projet';
      document.getElementById('cancelProjetEditBtn').style.display='none';
      ['newProjetName','newProjetCode','newProjetDesc'].forEach(id=>document.getElementById(id).value='');
    }
  }else{
    if(projets.find(p=>p.name===name)){alert('‚ùå Ce nom de projet existe d√©j√†');return}
    projets.push({id:'PJ'+String(projets.length+1).padStart(3,'0'),name,code:code||'',description:desc});
    updateProjetsList();updateProjetSelects();
    ['newProjetName','newProjetCode','newProjetDesc'].forEach(id=>document.getElementById(id).value='');
    saveUserData();
    showNotification('‚úÖ Projet "'+name+'" ajout√© !');
  }
}
function removeProjet(id){
  const p=projets.find(p=>p.id===id);
  if(confirm(`Supprimer le projet "${p.name}" ?`)){
    projets=projets.filter(p=>p.id!==id);
    updateProjetsList();updateProjetSelects();saveUserData();
  }
}
function editProjet(id){
  const p=projets.find(p=>p.id===id);if(!p)return;
  document.getElementById('newProjetName').value=p.name;
  document.getElementById('newProjetCode').value=p.code||'';
  document.getElementById('newProjetDesc').value=p.description||'';
  editingProjetId=id;
  document.getElementById('projetFormTitle').textContent='‚úèÔ∏è Modifier le Projet';
  document.getElementById('addProjetBtn').textContent='üíæ Enregistrer';
  document.getElementById('cancelProjetEditBtn').style.display='block';
  document.getElementById('projetsPage').scrollIntoView({behavior:'smooth',block:'start'});
}
function cancelProjetEdit(){
  editingProjetId=null;
  ['newProjetName','newProjetCode','newProjetDesc'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('projetFormTitle').textContent='üìÅ Ajouter un Projet';
  document.getElementById('addProjetBtn').textContent='üìÅ Ajouter le Projet';
  document.getElementById('cancelProjetEditBtn').style.display='none';
}
function updateProjetsList(){
  const list=document.getElementById('projetsList');if(!list)return;
  if(projets.length===0){
    list.innerHTML='<div class="empty-state"><div class="empty-state-icon">üìÅ</div><div class="empty-state-text">Aucun projet ajout√©</div></div>';return;
  }
  list.innerHTML=projets.map(p=>`
    <div class="list-item" style="padding:10px 14px">
      <div class="list-item-info">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px">
          <span style="font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:700;color:#DC2626">${p.id}</span>
          <span style="font-size:13px;font-weight:700;color:var(--text-secondary)">-</span>
          <span class="list-item-name" style="font-size:14px;margin-bottom:0">${p.name}</span>
          ${p.code?`<span style="font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600;color:#64748B;background:#F1F5F9;padding:2px 8px;border-radius:5px;border:1px solid #E2E8F0">${p.code}</span>`:''}
        </div>
        <div class="list-item-desc" style="font-size:12px">${p.description||''}</div>
      </div>
      <div style="display:flex;gap:8px">
        <button onclick="editProjet('${p.id}')" title="Modifier" style="background:var(--accent);width:auto;padding:5px 10px;font-size:16px">‚úèÔ∏è</button>
        <button class="danger" onclick="removeProjet('${p.id}')" title="Supprimer" style="width:auto;padding:5px 10px;font-size:16px">üóëÔ∏è</button>
      </div>
    </div>`).join('');
}
function updateProjetSelects(){ buildProjetsDropdown(''); }
function openProjetsDropdown(){
  const search=document.getElementById('expenseProjetSearch').value;
  buildProjetsDropdown(search);
  document.getElementById('projetsDropdownList').style.display='block';
  document.getElementById('expenseProjetSearch').style.borderRadius='10px 10px 0 0';
  document.getElementById('expenseProjetSearch').style.borderColor='var(--accent)';
}
function closeProjetsDropdown(){
  document.getElementById('projetsDropdownList').style.display='none';
  document.getElementById('expenseProjetSearch').style.borderRadius='10px';
  document.getElementById('expenseProjetSearch').style.borderColor='var(--border)';
}
function filterProjetsDropdown(){
  const search=document.getElementById('expenseProjetSearch').value;
  buildProjetsDropdown(search);
  document.getElementById('projetsDropdownList').style.display='block';
  document.getElementById('expenseProjetSearch').style.borderRadius='10px 10px 0 0';
}
function buildProjetsDropdown(search){
  const list=document.getElementById('projetsDropdownList');
  const q=(search||'').toLowerCase();
  const filtered=projets.filter(p=>p.name.toLowerCase().includes(q)||p.id.toLowerCase().includes(q)||(p.code&&p.code.toLowerCase().includes(q)));
  let html='<div onmousedown="event.preventDefault();selectProjet(\'\',\'\')" style="padding:8px 12px;font-size:13px;color:#94A3B8;cursor:pointer;border-bottom:1px solid var(--border)" onmouseenter="this.style.background=\'#F8FAFC\'" onmouseleave="this.style.background=\'\'">‚Äî Aucun ‚Äî</div>';
  if(filtered.length===0){
    html+='<div style="padding:8px 12px;font-size:13px;color:#94A3B8;text-align:center">Aucun projet trouv√©</div>';
  }else{
    html+=filtered.map(p=>{
      const nameHl=q?p.name.replace(new RegExp(`(${q})`,'gi'),'<strong style="color:var(--accent)">$1</strong>'):p.name;
      const safeName=p.name.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
      return `<div onmousedown="event.preventDefault();selectProjet('${safeName}','${p.id}')" style="padding:8px 12px;font-size:13px;cursor:pointer;border-bottom:1px solid #F1F5F9" onmouseenter="this.style.background='#F8FAFC'" onmouseleave="this.style.background=''">
        <span>${nameHl}</span>
      </div>`;
    }).join('');
  }
  list.innerHTML=html;
}
function selectProjet(name,id){
  document.getElementById('expenseProjet').value=name;
  document.getElementById('expenseProjetSearch').value=name;
  document.getElementById('projetsDropdownList').style.display='none';
  document.getElementById('expenseProjetSearch').style.borderRadius='10px';
  document.getElementById('expenseProjetSearch').style.borderColor='var(--border)';
}
function resetProjetField(){
  document.getElementById('expenseProjet').value='';
  document.getElementById('expenseProjetSearch').value='';
}
function clearProjets(){
  if(!isAdmin(currentUser)){alert('üõ°Ô∏è Action r√©serv√©e √† l\'Administrateur.');return;}
  if(!confirm('‚ö†Ô∏è ATTENTION : Voulez-vous vraiment vider TOUTE la liste des projets ?\n\nCette action est irr√©versible !'))return;
  showPasswordModal('Entrez votre mot de passe pour vider la liste des projets',()=>{
    projets=[];updateProjetsList();updateProjetSelects();saveUserData();
    alert('‚úÖ Liste des projets vid√©e avec succ√®s !');
  });
}
function updateLibelleRequired(){
  const justified = document.getElementById('expenseJustified').checked;
  const star = document.getElementById('libelleRequired');
  const sel  = document.getElementById('expenseLabel');
  if(star) star.style.display = justified ? 'inline' : 'none';
  // Retirer l'erreur rouge si on d√©coche justifi√©
  if(!justified && sel) sel.classList.remove('field-error');
}

function updateAccountingCode(){
  const id=document.getElementById('expenseLabel').value;
  const codeEl=document.getElementById('expenseCode');
  const descEl=document.getElementById('expenseDescription');
  if(id){const l=labels.find(l=>l.id===id);if(l){codeEl.value=l.code;descEl.value=l.description||''}else{codeEl.value='';descEl.value=''}}
  else{codeEl.value='';descEl.value=''}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  G√âN√âRATEUR D'ID D√âPENSE  ‚Äî Nouveau format v2
//
//  Justifi√©  ‚Üí {2 lettres mois}{chiffre ann√©e}-{num√©ro chrono mois}
//              Compteur IND√âPENDANT par couple (pr√©fixe+ann√©e)
//              Exemples : jv6-01  fv6-02  at6-01  dc5-03
//              Le num√©ro est supprimable (l'ID dispara√Æt avec la ligne)
//
//  Non just. ‚Üí nj{num√©ro global croissant}  ex: nj1 nj2 nj3
//              Non supprimable ‚Üí le compteur ne recule jamais
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MONTH_PREFIXES = ['jv','fv','mr','av','ma','jn','jl','at','sp','oc','nv','dc'];

// Cl√© compteur pour une d√©pense justifi√©e : "jv6", "at6", "dc5" ‚Ä¶
function _monthCounterKey(date){
  const d = date ? new Date(date + 'T12:00:00') : new Date();
  const prefix = MONTH_PREFIXES[d.getMonth()];
  const yearDigit = String(d.getFullYear()).slice(-1); // dernier chiffre de l'ann√©e
  return prefix + yearDigit; // ex: "jv6"
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GESTION DU MODE ID  (ID:0 s√©quentiel / ID:> premier vide)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getIdMode(){ return localStorage.getItem('_expenseIdMode') || '0'; }
function setIdMode(mode){
  localStorage.setItem('_expenseIdMode', mode);
  _applyIdModeButtons(mode);
  showNotification(mode === '>'
    ? '‚ôªÔ∏è Mode ID:> activ√© ‚Äî premier num√©ro libre recycl√©'
    : 'üî¢ Mode ID:0 activ√© ‚Äî num√©rotation s√©quentielle continue');
}
function _applyIdModeButtons(mode){
  const btn0  = document.getElementById('idModeBtn0');
  const btnGt = document.getElementById('idModeBtnGt');
  if(!btn0 || !btnGt) return;
  if(mode === '>'){
    btn0.style.background  = 'transparent';
    btn0.style.color       = '#64748B';
    btnGt.style.background = '#7C3AED';
    btnGt.style.color      = 'white';
    btnGt.style.boxShadow  = '0 2px 6px rgba(124,58,237,.4)';
    btn0.style.boxShadow   = 'none';
  } else {
    btn0.style.background  = '#1D4ED8';
    btn0.style.color       = 'white';
    btn0.style.boxShadow   = '0 2px 6px rgba(29,78,216,.4)';
    btnGt.style.background = 'transparent';
    btnGt.style.color      = '#64748B';
    btnGt.style.boxShadow  = 'none';
  }
}
// Appliquer l'√©tat visuel des boutons au chargement de la page
document.addEventListener('DOMContentLoaded', function(){
  setTimeout(function(){ _applyIdModeButtons(getIdMode()); }, 400);
});

// ‚îÄ‚îÄ Trouve le premier num√©ro libre dans la s√©quence d'une cl√© (mode ID:>) ‚îÄ‚îÄ
function _findFirstGapId(key){
  // Collecter tous les num√©ros utilis√©s pour cette cl√© dans TOUTES les transactions
  const usedNums = new Set();
  for(const mk in transactions){
    (transactions[mk]||[]).forEach(t => {
      if(!t.expenseId) return;
      const m = String(t.expenseId).match(/^([a-z]{2}\d)-(\d+)$/i);
      if(m && m[1].toLowerCase() === key.toLowerCase()){
        usedNums.add(parseInt(m[2], 10));
      }
    });
  }
  // Trouver le premier entier >= 1 absent de usedNums
  let n = 1;
  while(usedNums.has(n)) n++;
  return n;
}

// ‚îÄ‚îÄ Trouve le premier num√©ro NJ libre (mode ID:>) ‚îÄ‚îÄ
function _findFirstGapNj(){
  const usedNums = new Set();
  for(const mk in transactions){
    (transactions[mk]||[]).forEach(t => {
      if(!t.expenseId) return;
      const m = String(t.expenseId).match(/^nj(\d+)$/i);
      if(m) usedNums.add(parseInt(m[1], 10));
    });
  }
  let n = 1;
  while(usedNums.has(n)) n++;
  return n;
}

function generateExpenseId(justified, date){
  const mode     = getIdMode();
  const counters = JSON.parse(localStorage.getItem('_expenseIdCounters') || '{}');

  if(!justified){
    // Non justifi√© : nj1, nj2, ...
    if(mode === '>'){
      // Mode ID:> : premier num√©ro NJ libre
      const n = _findFirstGapNj();
      // Synchroniser le compteur si n√©cessaire
      if(n >= (counters.nj || 1)) { counters.nj = n + 1; localStorage.setItem('_expenseIdCounters', JSON.stringify(counters)); }
      return 'nj' + n;
    } else {
      // Mode ID:0 : s√©quentiel strict
      const next = counters.nj || 1;
      counters.nj = next + 1;
      localStorage.setItem('_expenseIdCounters', JSON.stringify(counters));
      return 'nj' + next;
    }
  } else {
    // Justifi√© : cl√© = "jv6" ‚Üí ID = "jv6-01"
    const key = _monthCounterKey(date);
    if(mode === '>'){
      // Mode ID:> : premier num√©ro libre dans la s√©quence de cette cl√©
      const n = _findFirstGapId(key);
      if(n >= (counters[key] || 1)) { counters[key] = n + 1; localStorage.setItem('_expenseIdCounters', JSON.stringify(counters)); }
      return key + '-' + String(n).padStart(2, '0');
    } else {
      // Mode ID:0 : s√©quentiel strict
      const next = counters[key] || 1;
      counters[key] = next + 1;
      localStorage.setItem('_expenseIdCounters', JSON.stringify(counters));
      return key + '-' + String(next).padStart(2, '0');
    }
  }
}

// Migration : assigne des IDs au nouveau format aux d√©penses sans ID valide
function migrateExpenseIds(){
  let changed = false;
  const counters = JSON.parse(localStorage.getItem('_expenseIdCounters') || '{}');

  // Pr√©-scanner les IDs existants valides pour synchroniser les compteurs
  for(const mk in transactions){
    (transactions[mk]||[]).forEach(t => {
      if(!t.justified){
        // IDs nj d√©j√† pr√©sents
        const m = String(t.expenseId||'').match(/^nj(\d+)$/i);
        if(m){ const n=parseInt(m[1],10); if(n>=(counters.nj||1)) counters.nj = n+1; }
      } else {
        // IDs justifi√©s d√©j√† pr√©sents : format "xx9-01" ou ancien "xx01"
        const m2 = String(t.expenseId||'').match(/^([a-z]{2}\d)-(\d+)$/i);
        if(m2){ const k=m2[1]; const n=parseInt(m2[2],10); if(n>=(counters[k]||1)) counters[k]=n+1; }
      }
    });
  }

  for(const mk in transactions){
    (transactions[mk]||[]).forEach(t => {
      const id = String(t.expenseId||'');
      // Ancien format num√©rique pur ou ancien format sans tiret (ex: "at01", "jv02")
      const needsMigration = (typeof t.expenseId === 'number')
        || /^\d+$/.test(id)
        || (/^[a-z]{2}\d{2}$/i.test(id)); // ancien format ex "at01"

      if(needsMigration){
        if(!t.justified){
          const next = counters.nj || 1;
          counters.nj = next + 1;
          t.expenseId = 'nj' + next;
        } else {
          const key  = _monthCounterKey(t.date);
          const next = counters[key] || 1;
          counters[key] = next + 1;
          t.expenseId = key + '-' + String(next).padStart(2,'0');
        }
        changed = true;
      }
    });
  }

  if(changed){
    localStorage.setItem('_expenseIdCounters', JSON.stringify(counters));
    saveUserData();
  }
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VERROUILLAGE DES MOIS CL√îTUR√âS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function isMonthClosed(mk){ return !!(closedMonths && closedMonths[mk]); }
function _alertMonthLocked(mk){
  const info=closedMonths[mk];
  const lbl=info&&info.label?info.label:mk;
  alert('üîí Le mois de '+lbl+' est cl√¥tur√©.\n\nToute saisie, modification ou suppression est interdite.');
}
function _dateInClosedMonth(dateStr){
  if(!dateStr)return false;
  return isMonthClosed(dateStr.substring(0,7));
}
function _monthHasCashIn(mk){
  const list=cashIn[mk]||[];
  return list.some(c=>c.amount>0&&!c.isCloture);
}
function _mkToLabel(mk){
  if(!mk)return mk;
  const[y,m]=mk.split('-');
  return MONTHS[parseInt(m,10)-1]+' '+y;
}
function _dateInMonthWithoutCashIn(dateStr){
  if(!dateStr)return false;
  const mk=dateStr.substring(0,7);
  if(isMonthClosed(mk))return false;
  return !_monthHasCashIn(mk);
}

function addExpense(){
  const date=document.getElementById('expenseDate').value;
  const personInput=document.getElementById('expensePerson').value.trim();
  const labelId=document.getElementById('expenseLabel').value;
  const code=document.getElementById('expenseCode').value;
  const description=document.getElementById('expenseDescription').value;
  const projet=document.getElementById('expenseProjet').value.trim();
  const amount=parseFloat(document.getElementById('expenseAmount').value);
  const justified=document.getElementById('expenseJustified').checked;
  let personId=document.getElementById('expensePersonId').value||'';
  if(!personId&&personInput){
    const byName=persons.find(p=>p.name.toLowerCase()===personInput.toLowerCase());
    if(byName)personId=byName.id;
    else{const m=personInput.match(/^(P\d+)/);if(m)personId=m[1]}
  }
  ['expenseDate','expensePerson','expenseAmount','expenseLabel'].forEach(id=>document.getElementById(id).classList.remove('field-error'));
  let hasError=false;
  if(!date){document.getElementById('expenseDate').classList.add('field-error');hasError=true}
  if(!personId){document.getElementById('expensePerson').classList.add('field-error');hasError=true}
  if(justified && !labelId){document.getElementById('expenseLabel').classList.add('field-error');hasError=true}
  if(!amount||isNaN(amount)){document.getElementById('expenseAmount').classList.add('field-error');hasError=true}
  if(hasError){alert('‚ùå Veuillez remplir tous les champs obligatoires (en rouge)'+(justified&&!labelId?'\n\n‚ö†Ô∏è Le Libell√© est obligatoire quand la d√©pense est Justifi√©e.':''));return}
  if(date&&_dateInClosedMonth(date)){_alertMonthLocked(date.substring(0,7));return}
  if(date&&_dateInMonthWithoutCashIn(date)){alert('‚ö†Ô∏è Alimentation de caisse du mois de '+_mkToLabel(date.substring(0,7))+' manquante.\n\nVeuillez d\'abord ajouter une alimentation pour ce mois.');return}
  const mk=getMonthKey();
  if(!transactions[mk])transactions[mk]=[];
  const personBalance=getPersonUnjustifiedBalance(personId);
  const alertMsg=personBalance>0?`‚ö†Ô∏è ${fmt(personBalance)} DA non justifi√©`:'';
  if(editingTransactionIndex!==null){
    const editMk = window._editingMk || mk;
    if(!transactions[editMk]) transactions[editMk]=[];
    const existingId = transactions[editMk][editingTransactionIndex].expenseId;
    transactions[editMk][editingTransactionIndex]={date,personId,labelId,code,description,projet,amount,justified,alert:alertMsg,expenseId:existingId};
    editingTransactionIndex=null;
    window._editingMk=null;
    document.getElementById('addExpenseBtn').textContent='Ajouter';
    document.getElementById('cancelEditBtn').style.display='none';
  }else{
    const newId = generateExpenseId(justified, date);
    transactions[mk].push({date,personId,labelId,code,description,projet,amount,justified,alert:alertMsg,expenseId:newId});
  }
  saveUserData();renderTransactions();
  ['expenseLabel','expenseCode','expenseDescription','expenseAmount'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('expensePerson').value='';
  document.getElementById('expensePersonId').value='';
  resetProjetField();
  document.getElementById('expenseJustified').checked=true;setTodayDate();
}
function editTransaction(mk, index){
  const t=transactions[mk]&&transactions[mk][index];if(!t)return;
  if(isMonthClosed(mk)){_alertMonthLocked(mk);return}
  window._editingMk = mk;
  document.getElementById('expenseDate').value=t.date;
  const p=persons.find(p=>p.id===t.personId);
  document.getElementById('expensePerson').value=p?p.name:t.personId;
  document.getElementById('expensePersonId').value=t.personId||'';
  document.getElementById('expenseLabel').value=t.labelId;
  document.getElementById('expenseCode').value=t.code;
  document.getElementById('expenseDescription').value=t.description||'';
  document.getElementById('expenseProjet').value=t.projet||'';
  document.getElementById('expenseProjetSearch').value=t.projet||'';
  document.getElementById('expenseAmount').value=t.amount;
  document.getElementById('expenseJustified').checked=t.justified;
  editingTransactionIndex=index;
  document.getElementById('addExpenseBtn').innerHTML='<span class="btn-icon">üíæ Enregistrer</span>';
  document.getElementById('cancelEditBtn').style.display='block';
  document.getElementById('mainPage').scrollIntoView({behavior:'smooth',block:'start'});
}
function cancelEdit(){
  editingTransactionIndex=null;
  window._editingMk=null;
  ['expenseLabel','expenseCode','expenseDescription','expenseAmount'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('expensePerson').value='';
  document.getElementById('expensePersonId').value='';
  resetProjetField();
  document.getElementById('expenseJustified').checked=true;setTodayDate();
  document.getElementById('addExpenseBtn').textContent='Ajouter';
  document.getElementById('cancelEditBtn').style.display='none';
}
function deleteTransaction(mk, index){
  if(isMonthClosed(mk)){_alertMonthLocked(mk);return}
  const t = (transactions[mk]||[])[index];
  const isEnPlus = t && t.enPlus && t.enPlusUID;
  const confirmMsg = isEnPlus
    ? '‚ùå Supprimer cette d√©pense en plus ?\n\n‚ö†Ô∏è Cela supprimera √©galement :\n‚Ä¢ Toutes les lignes de remboursement associ√©es\n‚Ä¢ Les entr√©es correspondantes dans la table des alimentations'
    : '‚ùå Supprimer cette transaction ?';
  if(confirm(confirmMsg)){
    // ‚îÄ‚îÄ Si c'est une d√©pense en plus ‚Üí nettoyer remboursements + cashIn ‚îÄ‚îÄ
    if(isEnPlus){
      const uid = t.enPlusUID;
      // 1. Supprimer toutes les lignes cashIn li√©es √† ce uid (solde d√©part + remboursements)
      for(const mkey in cashIn){
        cashIn[mkey] = (cashIn[mkey]||[]).filter(c => c.enPlusUID !== uid);
        if(cashIn[mkey].length === 0) delete cashIn[mkey];
      }
      // 2. Supprimer les donn√©es de remboursement
      const rembData = _getRembData();
      if(rembData[uid]){
        delete rembData[uid];
        _saveRembData(rembData);
      }
      updateRemboursementSelect();
      renderCashInTable();
    }
    transactions[mk].splice(index,1);
    saveUserData();
    renderTransactions();
    updateSummary();
  }
}
function getPersonUnjustifiedBalance(personId){
  let total=0;
  for(const mk in transactions)(transactions[mk]||[]).forEach(t=>{if(t.personId===personId&&!t.justified)total+=t.amount});
  return total;
}
function buildJustifiedCheckbox(t){
  const closed = isMonthClosed(t._mk);
  if(closed){
    if(t.justified){
      // Case coch√©e dans mois cl√¥tur√© ‚Üí totalement bloqu√©e
      return '<div title="üîí Mois cl√¥tur√© ‚Äî case justifi√©e non modifiable" style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:5px;background:#78350F;border:2px solid #92400E;cursor:not-allowed;box-shadow:0 1px 4px rgba(120,53,15,.35)"><svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round" style="width:13px;height:13px"><polyline points="20 6 9 17 4 12"/></svg></div>';
    } else if(t._transferred){
      // D√©j√† transf√©r√© ‚Üí bloqu√© avec ic√¥ne transfert
      return '<div title="‚úÖ D√©pense d√©j√† transf√©r√©e ‚Äî op√©ration termin√©e" style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:5px;background:#1D4ED8;border:2px solid #3B82F6;cursor:not-allowed;font-size:11px">üîÄ</div>';
    } else {
      // Case non coch√©e dans mois cl√¥tur√© ‚Üí cliquable pour d√©clencher le transfert
      var onchg2 = "openTransferJustifyModal('"+t._mk+"',"+t._index+",this)";
      return '<input type="checkbox" onchange="'+onchg2+'" style="width:20px;height:20px;cursor:pointer;accent-color:#F59E0B;outline:2px solid #F59E0B;border-radius:3px" title="‚ö° Cliquer pour justifier et transf√©rer vers le mois en cours">';
    }
  }
  var onchg = "toggleJustified('"+t._mk+"',"+t._index+",this.checked,this)";
  var ttl = t.justified ? 'Cliquer pour marquer Non Justifi√©' : 'Cliquer pour marquer Justifi√©';
  return '<input type="checkbox" '+(t.justified?'checked':'')+' onchange="'+onchg+'" style="width:20px;height:20px;cursor:pointer;accent-color:var(--success)" title="'+ttl+'">';
}
function renderTransactions(){
  const list = (window.getViewTransactions || getViewTransactions)();
  const tbody=document.getElementById('transactionsTable');
  const thead=document.getElementById('transactionsTableHead');
  const titleDiv=document.getElementById('viewModeTitle');
  const isExpanded=(currentViewMode!=='month');

  // Titre et en-t√™te selon le mode
  if(titleDiv){
    if(currentViewMode==='year'){
      titleDiv.style.display='block';
      titleDiv.innerHTML=`üìÜ Vue Annuelle ‚Äî <strong>${currentYear}</strong> &nbsp;|&nbsp; ${list.length} d√©pense(s)`;
    } else if(currentViewMode==='global'){
      titleDiv.style.display='block';
      titleDiv.innerHTML=`üåê Vue Globale ‚Äî <strong>Toutes les p√©riodes</strong> &nbsp;|&nbsp; ${list.length} d√©pense(s)`;
    } else {
      titleDiv.style.display='none';
    }
  }
  if(thead){
    const _pf = window._personneFilter||'';
    const _js = window._justifiedSort; // null | 'asc' | 'desc'
    const _jsIcon = _js==='asc' ? '‚ñ≤ Justifi√©' : _js==='desc' ? '‚ñº Non Just.' : 'Justifi√© <span style="font-size:10px;opacity:.6">‚áÖ</span>';
    const _jsBg   = _js ? '#D1FAE5' : 'var(--primary)';
    const _jsFg   = _js ? '#065F46' : 'white';
    const _jsHov  = _js ? '#A7F3D0' : 'rgba(255,255,255,.15)';
    const _justifiedThHTML = `<th id="justifiedHeaderTh" onclick="toggleJustifiedSort()" title="Cliquer pour trier" style="cursor:pointer;user-select:none;white-space:nowrap;background:${_jsBg};color:${_jsFg};transition:background .2s" onmouseover="this.style.background='${_jsHov}'" onmouseleave="this.style.background='${_jsBg}';this.style.color='${_jsFg}'"><span style="display:flex;align-items:center;justify-content:center;gap:5px;pointer-events:none">${_jsIcon}</span></th>`;
    const _personneThHTML = `<th id="personneHeaderTh" style="position:relative;cursor:pointer;user-select:none;min-width:160px;${_pf?'background:#FEF3C7;color:#92400E':''}" onclick="togglePersonneDropdown(event)" title="Cliquer pour filtrer par personne">
      <span style="display:flex;align-items:center;gap:6px;white-space:nowrap;pointer-events:none">
        Personne <span style="font-size:10px;opacity:.7">${_pf?'üîç':'‚¨á'}</span>
        ${_pf?`<span style="background:#F59E0B;color:white;border-radius:10px;font-size:10px;padding:1px 7px;font-weight:800;pointer-events:none">${_pf.charAt(0).toUpperCase()+_pf.slice(1)}</span>`:''}
      </span>
    </th>`;
    const _ds = window._dateSort;
    const _dsIcon = _ds==='desc' ? '‚ñº' : _ds==='asc' ? '‚ñ≤' : '<span style="font-size:10px;opacity:.6">‚áÖ</span>';
    const _dsBg   = _ds ? '#DBEAFE' : 'var(--primary)';
    const _dsFg   = _ds ? '#1E40AF' : 'white';
    const _dsHov  = _ds ? '#BFDBFE' : 'rgba(255,255,255,.15)';
    const _dateTh = `<th id="dateHeaderTh" onclick="toggleDateSort()" title="Cliquer pour trier par date" style="cursor:pointer;user-select:none;white-space:nowrap;background:${_dsBg};color:${_dsFg};transition:background .2s" onmouseover="this.style.background='${_dsHov}'" onmouseleave="this.style.background='${_dsBg}';this.style.color='${_dsFg}'"><span style="display:flex;align-items:center;gap:4px;pointer-events:none">Date ${_dsIcon}</span></th>`;
    if(isExpanded){
      thead.innerHTML=`<tr><th style="min-width:44px;text-align:center">ID</th><th>Mois</th>${_dateTh}${_personneThHTML}<th style="min-width:140px;white-space:nowrap">Montant</th><th>Projet</th><th>Description</th><th>Libell√©</th><th>Code</th>${_justifiedThHTML}<th style="min-width:90px">Actions</th></tr>`;
    } else {
      thead.innerHTML=`<tr id="transactionsTableHead"><th style="min-width:44px;text-align:center">ID</th>${_dateTh}${_personneThHTML}<th style="min-width:140px;white-space:nowrap">Montant</th><th>Projet</th><th>Description</th><th>Libell√©</th><th>Code</th>${_justifiedThHTML}<th style="min-width:90px">Actions</th></tr>`;
    }
  }
  const colspan=isExpanded?10:10;
  if(list.length===0){
    tbody.innerHTML=`<tr><td colspan="${colspan}"><div class="empty-state"><div class="empty-state-icon">üì≠</div><div class="empty-state-text">Aucune d√©pense trouv√©e</div></div></td></tr>`;
  }else{
    // Badge sur le DERNIER ENREGISTREMENT de chaque personne (par date la plus r√©cente dans transactions r√©els)
    // On cherche dans la liste affich√©e la derni√®re occurrence de chaque personne par date r√©elle
    const lastIdxByPerson = {};
    list.forEach((t, i) => {
      if(!lastIdxByPerson.hasOwnProperty(t.personId)){
        lastIdxByPerson[t.personId] = i;
      } else {
        // Garder celui dont la date est la plus r√©cente
        const prev = list[lastIdxByPerson[t.personId]];
        if(t.date >= prev.date) lastIdxByPerson[t.personId] = i;
      }
    });

    tbody.innerHTML=list.map((t,index)=>{
      const p=persons.find(p=>p.id===t.personId);
      const pName=p?p.name:t.personId;
      const l=labels.find(l=>l.id===t.labelId);
      const lName=l?l.name:t.labelId;
      const bal=getPersonUnjustifiedBalance(t.personId);
      const isLastByDate = lastIdxByPerson[t.personId] === index;
      const badge=(bal>0 && isLastByDate)
        ?`<br><span class="alert-badge" onclick="openUnjustifiedPersonModal('${t.personId}')" style="cursor:pointer;padding:1px 4px;font-size:9px;margin-top:1px;border-radius:3px;letter-spacing:.01em;display:inline-block;line-height:1.4" title="Cliquer pour voir le d√©tail">‚ö† ${fmt(bal)} DA NJ</span>`
        :'';
      const mkLabel=isExpanded?(()=>{const[y,m]=t._mk.split('-');return`<td style="font-size:11px;font-weight:700;color:#7C3AED;white-space:nowrap">${MONTHS[parseInt(m,10)-1]}<br><span style="color:#94A3B8;font-weight:400">${y}</span></td>`})():'';
      const isNJ = !t.justified;
      const isTransferred = !!t._transferred;
      // Boutons actions : transfert ‚Üí √©dition bloqu√©e, suppression bloqu√©e
      const actionsTd=`<td><div style="display:flex;gap:4px;flex-wrap:nowrap">
            ${isTransferred
              ? `<button disabled title="üîí D√©pense transf√©r√©e ‚Äî modification non autoris√©e" style="width:auto;padding:5px 10px;font-size:16px;background:#94A3B8;cursor:not-allowed;opacity:0.45;box-shadow:none">‚úèÔ∏è</button>`
              : `<button onclick="editTransaction('${t._mk}',${t._index})" title="Modifier" style="width:auto;padding:5px 10px;font-size:16px;background:var(--accent)">‚úèÔ∏è</button>`
            }
            <button class="danger" onclick="deleteTransaction('${t._mk}',${t._index})" title="Supprimer" style="width:auto;padding:5px 10px;font-size:16px">üóëÔ∏è</button>
          </div></td>`;
      // Classe de ligne : enPlus = vert/rouge selon remboursement, transf√©r√© = bleu p√¢le, justifi√© = vert, NJ = jaune
      // ‚îÄ‚îÄ Calcul √©tat remboursement pour ligne EN+ ‚îÄ‚îÄ
      let _enPlusSolde = false; // sold√© 100%
      let _enPlusSoldeRestant = 0; // montant restant √† rembourser
      if(t.enPlus && t.enPlusUID){
        const _rd = _getRembData();
        const _r  = _rd[t.enPlusUID];
        if(_r){
          const _totalRemb = (_r.lignes||[]).reduce((s,l)=>s+l.montant,0);
          _enPlusSoldeRestant = Math.max(0, _r.soldeDepart - _totalRemb);
          _enPlusSolde = _enPlusSoldeRestant <= 0.01;
        } else {
          _enPlusSoldeRestant = t.amount || 0;
        }
      }
      const _enPlusRowClass = t.enPlus ? (_enPlusSolde ? 'enplus-solde-row' : 'enplus-nonsolde-row') : '';
      const rowClass = isTransferred ? '' : (t.enPlus ? _enPlusRowClass : (t.justified ? 'justified-row' : 'not-justified-row'));
      const _enPlusBorder= _enPlusSolde ? '#22C55E' : '#EF4444';
      const rowStyle = isTransferred
        ? 'background:#EFF6FF;border-left:4px solid #3B82F6;opacity:.85'
        : t.enPlus
          ? `border-left:4px solid ${_enPlusBorder};cursor:pointer;`
          : '';
      // Style cellule ID
      let idCellStyle = t.justified
        ? 'color:#15803D;background:#DCFCE7;border:1.5px solid #86EFAC'
        : 'color:#B91C1C;background:#FEE2E2;border:1.5px solid #FCA5A5';
      if(isTransferred) idCellStyle = 'color:#1E40AF;background:#DBEAFE;border:1.5px solid #93C5FD';
      if(t.enPlus) idCellStyle = _enPlusSolde
        ? 'color:#000000 !important;background:#22C55E !important;border:1.5px solid #4ADE80'
        : 'color:#FFFFFF !important;background:#DC2626 !important;border:1.5px solid #EF4444';
      const idDisplay = isTransferred
        ? `üîÄ ${String(t.expenseId||index+1).toUpperCase()}`
        : String(t.expenseId ? t.expenseId : index+1).toUpperCase();
      const _enPlusBadgeColor = _enPlusSolde ? '#22C55E' : '#DC2626';
      return `<tr class="${rowClass}" style="${rowStyle}" data-enplus-uid="${t.enPlus ? (t.enPlusUID||'') : ''}" ${t.enPlus ? `ondblclick="openRembModalFromRow(this)" title="üñ±Ô∏è Double-cliquer pour ouvrir le remboursement"` : `onclick="selectExpenseRow(this)"`}>
        <td class="text-mono" style="text-align:center;font-size:10px;font-weight:800;min-width:54px;padding:3px 5px;border-radius:6px;letter-spacing:.03em;${idCellStyle}">${idDisplay}</td>
        ${mkLabel}
        <td class="text-mono" style="font-weight:600">${new Date(t.date+'T12:00:00').toLocaleDateString('fr-FR')}</td>
        <td style="font-weight:700"><strong>${pName}</strong>${badge}${t.enPlus ? (_enPlusSolde ? `<br><span class="alert-badge" style="background:#16A34A;color:white;cursor:pointer;padding:1px 4px;font-size:9px;margin-top:1px;border-radius:3px;letter-spacing:.01em;display:inline-block;line-height:1.4" ondblclick="openRembModalFromRow(this.closest('tr'))" title="Sold√© ‚Äî Double-clic pour voir le remboursement">‚úÖ SOLD√â</span>` : `<br><span class="alert-badge" ondblclick="openRembModalFromRow(this.closest('tr'))" style="background:#DC2626;color:white;cursor:pointer;padding:1px 4px;font-size:9px;margin-top:1px;border-radius:3px;letter-spacing:.01em;display:inline-block;line-height:1.4" title="Double-clic pour g√©rer le remboursement">üíú ${fmt(_enPlusSoldeRestant)} DA REMB.</span>`) : ''}</td>
        <td class="text-mono" style="white-space:nowrap"><strong style="${t.enPlus?'font-size:13px;font-weight:900;':''}">${t.enPlus ? '+' : ''}${fmt(t.amount)} DA</strong>${t.enPlus ? `<span style="margin-left:6px;background:${_enPlusBadgeColor};color:white;font-size:9px;font-weight:800;padding:1px 5px;border-radius:4px;border:1px solid ${_enPlusBorder};vertical-align:middle">EN+</span>` : ''}</td>
        <td style="font-size:12px;font-weight:600">${t.projet||'‚Äî'}</td>
        <td style="font-size:12px">${t.description||''}</td>
        <td style="font-weight:600">${lName}</td>
        <td class="text-mono" style="font-weight:700"><strong>${t.code}</strong></td>
        <td style="text-align:center">${buildJustifiedCheckbox(t)}</td>
        ${actionsTd}
      </tr>`;
    }).join('');
  }
  updateSummary();renderCashInTable();
  setTimeout(populatePersonneSelect, 0);
}

function toggleJustified(mk, realIndex, checked, chkEl){
  const arr = transactions[mk];
  if(!arr || !arr[realIndex]) return;
  const t = arr[realIndex];

  // ‚îÄ‚îÄ Si on COCHE "Justifi√©" et qu'il n'y a pas encore de libell√© ‚Üí popup
  if(checked && !t.labelId){
    chkEl.checked = false; // Annuler le cochage visuellement
    openJustifyLabelModal(mk, realIndex, chkEl);
    return;
  }

  _applyToggleJustified(mk, realIndex, checked, chkEl);
}

// ‚îÄ‚îÄ Mini-modale : choisir le libell√© avant de cocher Justifi√© ‚îÄ‚îÄ
function openJustifyLabelModal(mk, realIndex, chkEl){
  // Supprimer une ancienne modale si elle existe
  const old = document.getElementById('justifyLabelModal');
  if(old) old.remove();

  const modal = document.createElement('div');
  modal.id = 'justifyLabelModal';
  modal.style.cssText = `
    position:fixed;inset:0;z-index:99999;
    background:rgba(0,0,0,.5);
    display:flex;align-items:center;justify-content:center;
  `;

  const optionsHTML = labels.map(l =>
    `<div onmouseenter="this.style.background='#EFF6FF'" onmouseleave="this.style.background=''"
      onclick="confirmJustifyLabel('${mk}',${realIndex},'${l.id}')"
      style="padding:10px 16px;cursor:pointer;font-size:13px;font-weight:700;
             color:#0F172A;border-bottom:1px solid #F1F5F9;font-family:'Manrope',sans-serif">
      <span style="font-family:'JetBrains Mono',monospace;font-size:11px;color:#F59E0B;margin-right:8px">${l.code}</span>${l.name}
    </div>`
  ).join('');

  modal.innerHTML = `
    <div style="background:white;border-radius:16px;box-shadow:0 24px 60px rgba(0,0,0,.3);
                width:100%;max-width:280px;overflow:hidden;font-family:'Manrope',sans-serif">
      <div style="background:linear-gradient(135deg,#10B981,#059669);padding:16px 20px;
                  display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-size:15px;font-weight:800;color:white">‚úÖ Justifier la d√©pense</div>
          <div style="font-size:11px;color:rgba(255,255,255,.8);margin-top:2px">S√©lectionnez un libell√© obligatoire</div>
        </div>
        <button onclick="document.getElementById('justifyLabelModal').remove()"
          style="width:30px;height:30px;min-width:30px;border-radius:50%;background:rgba(255,255,255,.2);
                 color:white;font-size:16px;font-weight:900;border:none;cursor:pointer;padding:0;
                 display:flex;align-items:center;justify-content:center">‚úï</button>
      </div>
      <div style="max-height:300px;overflow-y:auto">
        ${optionsHTML.length ? optionsHTML :
          `<div style="padding:20px;text-align:center;color:#94A3B8;font-size:13px">
            Aucun libell√© disponible.<br>
            <a onclick="document.getElementById('justifyLabelModal').remove();showPage('labels')"
               style="color:#F59E0B;cursor:pointer;font-weight:700">‚ûï Cr√©er un libell√©</a>
          </div>`}
      </div>
    </div>`;

  // Fermer au clic sur le fond
  modal.addEventListener('click', e => {
    if(e.target === modal) modal.remove();
  });

  document.body.appendChild(modal);
}

function confirmJustifyLabel(mk, realIndex, labelId){
  document.getElementById('justifyLabelModal').remove();
  const arr = transactions[mk];
  if(!arr || !arr[realIndex]) return;
  const t = arr[realIndex];
  // Appliquer le libell√© + son code
  const lbl = labels.find(l => l.id === labelId);
  t.labelId = labelId;
  t.code    = lbl ? lbl.code : '';
  // Appliquer justifi√©
  const chkEl = null; // re-render complet
  _applyToggleJustified(mk, realIndex, true, chkEl);
  renderTransactions(); // re-render pour afficher libell√© + code
}

function _applyToggleJustified(mk, realIndex, checked, chkEl){
  // Acc√®s direct √† la vraie transaction via _mk et _index r√©el
  const arr = transactions[mk];
  if(!arr || !arr[realIndex]) return;

  const t = arr[realIndex];
  const wasJustified = t.justified;

  // Mise √† jour imm√©diate de la donn√©e
  t.justified = checked;

  // Si le statut change, on g√©n√®re un NOUVEL ID correspondant au nouveau statut
  if(wasJustified !== checked){
    t.expenseId = generateExpenseId(checked, t.date);
    // Mettre √† jour la cellule ID visuellement
    const row = chkEl ? chkEl.closest('tr') : null;
    if(row){
      const idCell = row.querySelector('td:first-child');
      if(idCell){
        idCell.textContent = t.expenseId;
        idCell.style.color      = checked ? '#15803D' : '#B91C1C';
        idCell.style.background = checked ? '#DCFCE7' : '#FEE2E2';
        idCell.style.border     = checked ? '1.5px solid #86EFAC' : '1.5px solid #FCA5A5';
      }
      // Mettre √† jour le bouton supprimer : d√©sactiv√© si NJ
      const actDiv = row.querySelector('td:last-child div');
      if(actDiv){
        const delBtn = actDiv.querySelectorAll('button')[1];
        if(delBtn){
          if(checked){
            delBtn.disabled = false;
            delBtn.className = 'danger';
            delBtn.style.cssText = 'width:auto;padding:5px 10px;font-size:16px;background:#DC2626;cursor:pointer;opacity:1;box-shadow:var(--shadow-md)';
            delBtn.title = 'Supprimer';
            delBtn.setAttribute('onclick', `deleteTransaction('${mk}',${realIndex})`);
          } else {
            delBtn.disabled = false;
            delBtn.className = 'danger';
            delBtn.style.cssText = 'width:auto;padding:5px 10px;font-size:16px;background:#DC2626;cursor:pointer;opacity:1;box-shadow:var(--shadow-md)';
            delBtn.title = 'Supprimer';
            delBtn.setAttribute('onclick', `deleteTransaction('${mk}',${realIndex})`);
          }
        }
      }
    }
  }

  // Feedback visuel instantan√© sur la ligne (sans re-render)
  const row = chkEl ? chkEl.closest('tr') : null;
  if(row){
    row.className = checked ? 'justified-row' : 'not-justified-row';
    chkEl.title = checked ? 'Cliquer pour marquer Non Justifi√©' : 'Cliquer pour marquer Justifi√©';
  }

  // Sauvegarde locale + auto-save fichier
  saveUserData();
  if(window._fsAutoSave && window._fsAutoSave.isReady()) window._fsAutoSave.triggerSave();

  // Mise √† jour du r√©sum√© sans re-render complet du tableau
  updateSummary();

  // Notification
  showNotification(checked ? '‚úÖ D√©pense marqu√©e Justifi√©e ‚Äî sauvegard√©e' : '‚ö†Ô∏è D√©pense marqu√©e Non Justifi√©e ‚Äî sauvegard√©e');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TRANSFERT DE D√âPENSE NON JUSTIFI√âE (mois cl√¥tur√© ‚Üí mois actif)
//
//  Quand on coche "Justifi√©" sur une NJ d'un mois cl√¥tur√© :
//  1. Ligne source : montant ‚Üí 0 DA + description indiquant le transfert
//  2. Nouvelle ligne dans le mois courant avec le montant original
//  3. Ligne de cl√¥ture du mois source corrig√©e (montant r√©duit)
//  4. Alimentation dans le mois courant pour le montant transf√©r√©
//  5. Case coch√©e bloqu√©e (t._transferred = true)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openTransferJustifyModal(sourceMk, realIndex, chkEl){
  // Annuler visuellement le cochage le temps de la confirmation
  if(chkEl) chkEl.checked = false;

  const arr = transactions[sourceMk];
  if(!arr || !arr[realIndex]) return;
  const t = arr[realIndex];

  const [sy, sm] = sourceMk.split('-').map(Number);
  const sourceMonthName = MONTHS[sm - 1] + ' ' + sy;
  // Mois cible = dernier mois ayant une alimentation de caisse ou une cl√¥ture
  function _getLastActiveMk(){
    const allMks = Object.keys(cashIn).filter(mk => (cashIn[mk]||[]).length > 0);
    if(allMks.length === 0){
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    }
    return allMks.sort().pop();
  }
  const targetMk = _getLastActiveMk();
  const [_realTy, _realTm] = targetMk.split('-').map(Number);
  const targetMonthName = MONTHS[_realTm - 1] + ' ' + _realTy;
  const njId = String(t.expenseId || '').toUpperCase();
  const montant = t.amount;

  // Supprimer ancienne modale si existante
  const old = document.getElementById('transferJustifyModal');
  if(old) old.remove();

  const modal = document.createElement('div');
  modal.id = 'transferJustifyModal';
  modal.style.cssText = 'position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,.65);display:flex;align-items:center;justify-content:center;';
  modal.innerHTML = `
    <div style="background:white;border-radius:18px;box-shadow:0 24px 70px rgba(0,0,0,.4);width:100%;max-width:520px;overflow:hidden;font-family:'Manrope',sans-serif">
      <div style="background:linear-gradient(135deg,#F59E0B 0%,#D97706 100%);padding:20px 24px 16px">
        <div style="display:flex;justify-content:space-between;align-items:flex-start">
          <div>
            <div style="font-size:17px;font-weight:800;color:white">‚ö° Transfert de D√©pense Non Justifi√©e</div>
            <div style="font-size:12px;color:rgba(255,255,255,.85);margin-top:4px">Cette op√©ration est irr√©versible</div>
          </div>
          <button onclick="document.getElementById('transferJustifyModal').remove()" style="width:30px;height:30px;min-width:30px;border-radius:50%;background:rgba(255,255,255,.25);color:white;font-size:16px;font-weight:900;border:none;cursor:pointer;padding:0;display:flex;align-items:center;justify-content:center">‚úï</button>
        </div>
      </div>
      <div style="padding:20px 24px">
        <!-- R√©sum√© op√©ration -->
        <div style="background:#FEF3C7;border:2px solid #FCD34D;border-radius:12px;padding:14px 16px;margin-bottom:18px">
          <div style="font-size:13px;font-weight:800;color:#92400E;margin-bottom:10px">üìã R√©sum√© de l'op√©ration :</div>
          <div style="display:grid;gap:6px;font-size:12px;color:#78350F">
            <div>üîñ <strong>D√©pense :</strong> ${njId} ‚Äî ${fmt(montant)} DA</div>
            <div>üìÖ <strong>Mois source (cl√¥tur√©) :</strong> ${sourceMonthName}</div>
            <div>üì• <strong>Mois cible (actif) :</strong> ${targetMonthName}</div>
          </div>
        </div>
        <!-- Ce qui va se passer -->
        <div style="font-size:12px;font-weight:700;color:#475569;margin-bottom:8px">Ce qui sera effectu√© :</div>
        <div style="display:grid;gap:6px;margin-bottom:18px">
          <div style="background:#FEF2F2;border-left:4px solid #DC2626;padding:8px 12px;border-radius:6px;font-size:12px;color:#7F1D1D">
            <strong>1.</strong> Ligne <strong>${njId}</strong> dans ${sourceMonthName} ‚Üí montant mis √† <strong>0,00 DA</strong>
          </div>
          <div style="background:#ECFDF5;border-left:4px solid #10B981;padding:8px 12px;border-radius:6px;font-size:12px;color:#064E3B">
            <strong>2.</strong> Nouvelle d√©pense cr√©√©e dans <strong>${targetMonthName}</strong> : +${fmt(montant)} DA
          </div>
          <div style="background:#EFF6FF;border-left:4px solid #3B82F6;padding:8px 12px;border-radius:6px;font-size:12px;color:#1E3A5F">
            <strong>3.</strong> Ligne de cl√¥ture de <strong>${sourceMonthName}</strong> corrig√©e : +${fmt(montant)} DA (solde ‚Üí ${fmt(montant)} DA suppl√©mentaire report√©)
          </div>
          <div style="background:#EFF6FF;border-left:4px solid #3B82F6;padding:8px 12px;border-radius:6px;font-size:12px;color:#1E3A5F">
            <strong>4.</strong> Report dans le mois suivant la source mis √† jour automatiquement
          </div>
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end">
          <button onclick="document.getElementById('transferJustifyModal').remove()" style="width:auto;padding:9px 18px;font-size:13px;background:#94A3B8;color:white;border:none;border-radius:10px;cursor:pointer;font-weight:700">Annuler</button>
          <button onclick="executeTransferJustify('${sourceMk}',${realIndex})" style="width:auto;padding:9px 20px;font-size:13px;background:linear-gradient(135deg,#F59E0B,#D97706);color:white;border:none;border-radius:10px;cursor:pointer;font-weight:800;box-shadow:0 4px 12px rgba(245,158,11,.4)">‚ö° Confirmer le Transfert</button>
        </div>
      </div>
    </div>`;
  modal.addEventListener('click', e => { if(e.target === modal) modal.remove(); });
  document.body.appendChild(modal);
}

function executeTransferJustify(sourceMk, realIndex){
  document.getElementById('transferJustifyModal')?.remove();

  const arr = transactions[sourceMk];
  if(!arr || !arr[realIndex]) return;
  const t = arr[realIndex];

  const [sy, sm] = sourceMk.split('-').map(Number);
  const sourceMonthName = MONTHS[sm - 1] + ' ' + sy;
  // ‚îÄ‚îÄ Mois cible = dernier mois ayant une alimentation de caisse ou une cl√¥ture ‚îÄ‚îÄ
  const todayDate = new Date();
  const today = todayDate.toISOString().split('T')[0];
  function _getLastActiveMk2(){
    const allMks = Object.keys(cashIn).filter(mk => (cashIn[mk]||[]).length > 0);
    if(allMks.length === 0){
      return `${todayDate.getFullYear()}-${String(todayDate.getMonth()+1).padStart(2,'0')}`;
    }
    return allMks.sort().pop();
  }
  const targetMk = _getLastActiveMk2();
  const [realTy, realTm] = targetMk.split('-').map(Number);
  const targetMonthName = MONTHS[realTm - 1] + ' ' + realTy;
  const njId = String(t.expenseId || '').toUpperCase();
  const originalAmount = t.amount;

  // ‚îÄ‚îÄ 1. Ligne source : montant ‚Üí 0, description mise √† jour, flag transfert ‚îÄ‚îÄ
  const newIdInTarget = generateExpenseId(false, today);
  t.amount = 0;
  t.description = `${njId}: ${fmt(originalAmount)} DA ‚Üí ${String(newIdInTarget).toUpperCase()} ${MONTHS[realTm-1]} ${String(realTy).slice(-2)}`;
  t._transferred = true;
  t.justified = true; // marquer justifi√© pour retirer du solde NJ

  // ‚îÄ‚îÄ 2. Nouvelle d√©pense dans le mois cible (mois calendaire r√©el) ‚îÄ‚îÄ
  if(!transactions[targetMk]) transactions[targetMk] = [];
  transactions[targetMk].push({
    date: today,
    personId: t.personId,
    labelId: t.labelId || '',
    code: t.code || '',
    description: `Transfert de ${njId} ${MONTHS[sm-1]} ${String(sy).slice(-2)}`,
    projet: t.projet || '',
    amount: originalAmount,
    justified: false,
    alert: '',
    expenseId: newIdInTarget
  });

  // ‚îÄ‚îÄ 3b. Nettoyage : retirer toute alimentation isTransfer mal plac√©e (anciens exports) ‚îÄ‚îÄ
  // L'alimentation de transfert N'EST PAS cr√©√©e dans le mois cible ‚Äî c'est la ligne de report
  // (cl√¥ture du mois source augment√©e) qui porte d√©j√† le montant transf√©r√© vers le mois suivant.
  if(cashIn[sourceMk]){
    cashIn[sourceMk] = cashIn[sourceMk].filter(c => !c.isTransfer);
  }
  if(cashIn[targetMk]){
    cashIn[targetMk] = cashIn[targetMk].filter(c => !c.isTransfer);
  }

  // ‚îÄ‚îÄ 4. Recalculer proprement le solde de cl√¥ture du mois source ‚îÄ‚îÄ
  // Solde r√©el = balances[sourceMk] + totalAlim - totalD√©penses (apr√®s mise √† 0 de la NJ)
  const _srcTransList = transactions[sourceMk] || [];
  const _srcCashList  = cashIn[sourceMk] || [];
  const _srcPrevBal   = balances[sourceMk] || 0;
  // Total d√©penses du mois source (NJ transf√©r√©e vaut d√©j√† 0 √† ce stade)
  const _srcTotalExp  = _srcTransList.reduce((s, tx) => s + (tx.amount || 0), 0);
  // Total alimentations du mois source HORS ligne de cl√¥ture n√©gative ET hors entr√©es de transfert
  // (les alimentations isTransfer appartiennent toujours au mois cible, pas au mois source)
  const _srcTotalAlim = _srcCashList.reduce((s, c) => {
    if(c.isCloture) return s;        // exclure la ligne de cl√¥ture n√©gative
    if(c.isTransfer) return s;       // exclure toute alimentation de transfert mal plac√©e
    return s + (c.amount || 0);
  }, 0);
  const _newSolde     = _srcPrevBal + _srcTotalAlim - _srcTotalExp;

  // Mettre √† jour la ligne de cl√¥ture n√©gative dans le mois source
  const sourceCashList = cashIn[sourceMk] || [];
  const clotureEntry = sourceCashList.find(c => c.isCloture === true || (c.amount < 0 && c.description && c.description.startsWith('Cl√¥ture de')));
  if(clotureEntry){
    clotureEntry.amount = -_newSolde;
    // Nettoyer toute mention "corrig√©" pr√©c√©dente, puis r√©√©crire la description propre
    const baseDesc = (clotureEntry.description || '').replace(/\s*\(corrig√©[^)]*\)/g, '').trim();
    clotureEntry.description = baseDesc;
  }

  // Mettre √† jour la ligne de report dans le mois suivant la source
  let nextSm = sm + 1, nextSy = sy;
  if(nextSm > 12){ nextSm = 1; nextSy++; }
  const nextSourceMk = `${nextSy}-${String(nextSm).padStart(2,'0')}`;
  if(!cashIn[nextSourceMk]) cashIn[nextSourceMk] = [];
  const reportEntry = cashIn[nextSourceMk].find(c => c.description && (
    c.description.startsWith('Cl√¥ture du mois de ' + MONTHS[sm-1])
  ));
  if(reportEntry){
    reportEntry.amount = _newSolde;
    // Nettoyer toute mention "corrig√©" pr√©c√©dente ‚Äî PAS de suffixe NJ ici (mois interm√©diaire)
    const baseDesc2 = (reportEntry.description || '').replace(/\s*\(corrig√©[^)]*\)/g, '').trim();
    reportEntry.description = baseDesc2;
  }

  // ‚îÄ‚îÄ PROPAGATION EN CASCADE ‚îÄ‚îÄ
  // Si le mois suivant la source (nextSourceMk) est lui-m√™me cl√¥tur√©,
  // son solde a chang√© (car son alimentation "Cl√¥ture du mois de X" vient d'√™tre mise √† jour).
  // On doit recalculer sa ligne n√©gative "Cl√¥ture de <nextSourceMk>" ET propager
  // cette correction √† son propre mois suivant, et ainsi de suite.
  // √Ä la fin de la cascade, on identifie le dernier mois cl√¥tur√© = mois cible du transfert,
  // et c'est dans SA ligne "Cl√¥ture du mois de <X>" que l'on ajoute le suffixe NJ.
  let _lastCascadeMk = null; // dernier mois mis √† jour dans la cascade = mois cible
  (function cascadeUpdateCloture(startMk) {
    let curMk = startMk;
    for(let i = 0; i < 24; i++) { // max 24 mois de propagation
      if(!isMonthClosed(curMk)) break; // mois non cl√¥tur√© ‚Üí on s'arr√™te
      // Recalculer le solde r√©el de curMk
      const curTransList = transactions[curMk] || [];
      const curCashList  = cashIn[curMk] || [];
      const curPrevBal   = balances[curMk] || 0;
      const curTotalExp  = curTransList.reduce((s, tx) => s + (tx.amount || 0), 0);
      const curTotalAlim = curCashList.reduce((s, c) => {
        if(c.isCloture) return s;
        if(c.isTransfer) return s;
        return s + (c.amount || 0);
      }, 0);
      const curNewSolde = curPrevBal + curTotalAlim - curTotalExp;
      // Mettre √† jour la ligne n√©gative "Cl√¥ture de <Mois> <Ann√©e>" dans curMk
      const curClotureEntry = (cashIn[curMk] || []).find(c =>
        c.isCloture === true || (c.amount < 0 && c.description && c.description.startsWith('Cl√¥ture de'))
      );
      if(curClotureEntry) {
        curClotureEntry.amount = -curNewSolde;
        const bd = (curClotureEntry.description || '').replace(/\s*\(corrig√©[^)]*\)/g, '').trim();
        curClotureEntry.description = bd;
      }
      // Mettre √† jour la ligne positive "Cl√¥ture du mois de <Mois>" dans le mois suivant
      const [cky, ckm] = curMk.split('-').map(Number);
      let nxtm = ckm + 1, nxty = cky;
      if(nxtm > 12) { nxtm = 1; nxty++; }
      const nxtMk = `${nxty}-${String(nxtm).padStart(2,'0')}`;
      if(!cashIn[nxtMk]) cashIn[nxtMk] = [];
      const nxtReport = cashIn[nxtMk].find(c => c.description &&
        c.description.startsWith('Cl√¥ture du mois de ' + MONTHS[ckm - 1])
      );
      if(nxtReport) {
        nxtReport.amount = curNewSolde;
        const bd2 = (nxtReport.description || '').replace(/\s*\(corrig√©[^)]*\)/g, '').trim();
        nxtReport.description = bd2;
        _lastCascadeMk = nxtMk; // m√©moriser le dernier mois mis √† jour
      }
      curMk = nxtMk; // passer au mois suivant pour continuer la cascade
    }
  })(nextSourceMk);

  // ‚îÄ‚îÄ SUFFIXE NJ dans la cl√¥ture du MOIS CIBLE (dernier mois actif) ‚îÄ‚îÄ
  // Si la cascade a parcouru des mois, le dernier mis √† jour = mois cible (targetMk).
  // Si pas de cascade (source = mois juste avant la cible), on cherche directement dans targetMk.
  const njDescMk = _lastCascadeMk || targetMk;
  if(njDescMk && cashIn[njDescMk]){
    // Chercher la ligne "Cl√¥ture du mois de <mois pr√©c√©dent>" dans njDescMk
    const [njy, njm] = njDescMk.split('-').map(Number);
    let prevM = njm - 1, prevY = njy;
    if(prevM < 1){ prevM = 12; prevY--; }
    const targetClotureEntry = cashIn[njDescMk].find(c =>
      c.description && c.description.startsWith('Cl√¥ture du mois de ' + MONTHS[prevM - 1])
    );
    if(targetClotureEntry){
      const njMonthShort = MONTHS[sm - 1].substring(0, 3) + String(sy).slice(-2);
      const njSuffix = ` + ${njId}: ${fmt(originalAmount)} DA ${njMonthShort}`;
      // √âviter de dupliquer le m√™me suffixe si transfert d√©j√† appliqu√©
      if(!targetClotureEntry.description.includes(njSuffix)){
        targetClotureEntry.description = targetClotureEntry.description + njSuffix;
      }
    }
  }

  saveUserData();
  if(window._fsAutoSave && window._fsAutoSave.isReady()) window._fsAutoSave.triggerSave();
  renderTransactions();
  renderCashInTable();
  updateSummary();
  showNotification(`‚úÖ Transfert effectu√© ! ${njId} (${fmt(originalAmount)} DA) ‚Üí ${targetMonthName}`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  D√âPENSE EN PLUS & REMBOURSEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Style visuel quand la case "d√©pense en plus" est coch√©e/d√©coch√©e
function toggleEnPlusStyle(checked){
  const box = document.querySelector('[onclick="document.getElementById(\'expenseEnPlus\').click()"]');
  if(box){
    box.style.background = checked
      ? 'linear-gradient(135deg,#e94560,#b91c1c)'
      : 'linear-gradient(135deg,#1a1a2e,#16213e)';
    box.style.borderColor = checked ? '#e94560' : '#0f3460';
  }
}

// Donn√©es remboursements : { expenseUID: { soldeDepart: N, lignes: [{date,personId,montant,description}], cashInRef: {...} } }
function _getRembData(){
  if(!currentUser || !users[currentUser]) return {};
  return users[currentUser].data.remboursements || {};
}
function _saveRembData(data){
  if(!currentUser || !users[currentUser]) return;
  users[currentUser].data.remboursements = data;
  saveUserData();
}

// G√©n√®re un UID unique pour la d√©pense en plus
function _genUID(){
  return 'enplus_' + Date.now() + '_' + Math.random().toString(36).slice(2,7);
}

// ‚îÄ‚îÄ Modifie addExpense pour g√©rer "d√©pense en plus" ‚îÄ‚îÄ
const _origAddExpense = addExpense;
addExpense = function(){
  const enPlus = document.getElementById('expenseEnPlus') && document.getElementById('expenseEnPlus').checked;
  if(!enPlus){
    // Comportement normal
    _origAddExpense();
    return;
  }
  // ‚îÄ‚îÄ D√âPENSE EN PLUS ‚îÄ‚îÄ
  const date = document.getElementById('expenseDate').value;
  const personInput = document.getElementById('expensePerson').value.trim();
  const labelId = document.getElementById('expenseLabel').value;
  const code = document.getElementById('expenseCode').value;
  const description = document.getElementById('expenseDescription').value;
  const projet = document.getElementById('expenseProjet').value.trim();
  const amount = parseFloat(document.getElementById('expenseAmount').value);
  const justified = document.getElementById('expenseJustified').checked;
  let personId = document.getElementById('expensePersonId').value || '';
  if(!personId && personInput){
    const byName = persons.find(p => p.name.toLowerCase() === personInput.toLowerCase());
    if(byName) personId = byName.id;
    else { const m = personInput.match(/^(P\d+)/); if(m) personId = m[1]; }
  }
  // Validation
  ['expenseDate','expensePerson','expenseAmount','expenseLabel'].forEach(id => document.getElementById(id).classList.remove('field-error'));
  let hasError = false;
  if(!date){ document.getElementById('expenseDate').classList.add('field-error'); hasError = true; }
  if(!personId){ document.getElementById('expensePerson').classList.add('field-error'); hasError = true; }
  if(justified && !labelId){ document.getElementById('expenseLabel').classList.add('field-error'); hasError = true; }
  if(!amount || isNaN(amount)){ document.getElementById('expenseAmount').classList.add('field-error'); hasError = true; }
  if(hasError){ alert('‚ùå Veuillez remplir tous les champs obligatoires'); return; }
  if(date && _dateInClosedMonth(date)){ _alertMonthLocked(date.substring(0,7)); return; }
  if(date && _dateInMonthWithoutCashIn(date)){ alert('‚ö†Ô∏è Alimentation de caisse du mois manquante.'); return; }

  const mk = getMonthKey();
  if(!transactions[mk]) transactions[mk] = [];
  const alertMsg = getPersonUnjustifiedBalance(personId) > 0 ? `‚ö†Ô∏è ${fmt(getPersonUnjustifiedBalance(personId))} DA non justifi√©` : '';
  const newId = generateExpenseId(justified, date);
  const uid = _genUID();

  // Ajouter la ligne en noir (d√©pense normale) avec flag enPlus
  transactions[mk].push({
    date, personId, labelId, code, description, projet, amount, justified,
    alert: alertMsg, expenseId: newId,
    enPlus: true,
    enPlusUID: uid
  });

  // Cr√©er structure remboursement (la cashIn sera inject√©e par _syncRembCashIn)
  if(!cashIn[mk]) cashIn[mk] = [];

  // Cr√©er structure remboursement
  const rembData = _getRembData();
  const p = persons.find(p => p.id === personId);
  rembData[uid] = {
    soldeDepart: amount,
    mk: mk,
    expenseId: newId,
    depenseDesc: description || newId,
    depenseDate: date,
    depensePersonne: p ? p.name : personId,
    lignes: []
  };
  // Injecter le solde de d√©part (+) et les lignes de remboursement d√©taill√©es dans cashIn
  _syncRembCashIn(uid, rembData[uid]);
  _saveRembData(rembData);

  saveUserData();
  renderTransactions();
  updateRemboursementSelect();

  // R√©initialiser formulaire
  ['expenseLabel','expenseCode','expenseDescription','expenseAmount'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('expensePerson').value = '';
  document.getElementById('expensePersonId').value = '';
  resetProjetField();
  document.getElementById('expenseJustified').checked = true;
  document.getElementById('expenseEnPlus').checked = false;
  toggleEnPlusStyle(false);
  setTodayDate();

  showNotification('‚úÖ D√©pense en plus ajout√©e ‚Äî Fen√™tre remboursement ouverte');

  // Ouvrir automatiquement la fen√™tre de remboursement
  setTimeout(() => openRembModal(uid), 400);
};

// ‚îÄ‚îÄ S√©lection simple de ligne (non EN+) ‚îÄ‚îÄ
function selectExpenseRow(row){ /* s√©lection standard, rien √† faire */ }

// ‚îÄ‚îÄ Double-clic natif sur ligne EN+ ‚Üí ouvre modal remboursement ‚îÄ‚îÄ
function openRembModalFromRow(row){
  const uid = row.getAttribute('data-enplus-uid');
  if(!uid) return;
  openRembModal(uid);
}

// ‚îÄ‚îÄ Ouvrir le modal remboursement pour un UID donn√© ‚îÄ‚îÄ
let _currentRembUID = null;
let _rembEditIndex = null;

function openRembModal(uid){
  _currentRembUID = uid;
  _rembEditIndex = null;
  const rembData = _getRembData();
  const r = rembData[uid];
  if(!r){ alert('‚ùå Donn√©es de remboursement introuvables.'); return; }

  // Remplir header
  document.getElementById('rembModalSubtitle').textContent =
    `D√©pense : ${r.expenseId ? r.expenseId.toUpperCase() : ''} ‚Äî ${r.depenseDate} ‚Äî ${fmt(r.soldeDepart)} DA`;
  document.getElementById('rembModalOrigine').innerHTML =
    `üìå D√©pense d'origine : <span style="color:#6d28d9">${r.expenseId ? r.expenseId.toUpperCase() : ''}</span> &nbsp;|&nbsp; Personne : <strong>${r.depensePersonne}</strong> &nbsp;|&nbsp; Montant : <strong style="color:#6d28d9">${fmt(r.soldeDepart)} DA</strong> &nbsp;|&nbsp; Date : <strong>${new Date(r.depenseDate+'T12:00:00').toLocaleDateString('fr-FR')}</strong> &nbsp;|&nbsp; Description : ${r.depenseDesc}`;

  // Remplir select personnes
  const sel = document.getElementById('rembModalPersonne');
  sel.innerHTML = '<option value="">‚Äî S√©lectionner ‚Äî</option>' +
    persons.map(p => `<option value="${p.id}">${p.name}</option>`).join('');

  // Date par d√©faut = aujourd'hui
  document.getElementById('rembModalDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('rembModalMontant').value = '';
  document.getElementById('rembModalDescription').value = '';

  _renderRembModalTable(uid);
  _updateRembModalSolde(uid);
  openModal('remboursementModal');
}

function _renderRembModalTable(uid){
  const rembData = _getRembData();
  const r = rembData[uid];
  if(!r){ return; }
  const tbody = document.getElementById('rembModalTableBody');
  const totalRow = document.getElementById('rembModalTotalRow');
  const totalCell = document.getElementById('rembModalTotalCell');
  if(!r.lignes || r.lignes.length === 0){
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:#9ca3af;font-size:13px">Aucune ligne de remboursement</td></tr>';
    if(totalRow) totalRow.style.display = 'none';
    return;
  }
  let totalRemb = 0;
  tbody.innerHTML = r.lignes.map((l, i) => {
    totalRemb += l.montant;
    const p = persons.find(p => p.id === l.personId);
    const pName = p ? p.name : l.personId;
    const dateStr = l.date ? new Date(l.date+'T12:00:00').toLocaleDateString('fr-FR') : '‚Äî';
    return `<tr style="background:${i%2===0?'#f5f3ff':'white'}" onmouseover="this.style.background='#ede9fe'" onmouseout="this.style.background='${i%2===0?'#f5f3ff':'white'}'">
      <td style="padding:7px 12px;font-size:12px;color:#6d28d9;font-weight:700">${i+1}</td>
      <td style="padding:7px 12px;font-family:'JetBrains Mono',monospace;font-size:12px;color:#475569">${dateStr}</td>
      <td style="padding:7px 12px;font-size:12px;font-weight:700;color:#1e293b">${pName}</td>
      <td style="padding:7px 12px;font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:800;color:#6d28d9;text-align:right;white-space:nowrap">-${fmt(l.montant)} DA</td>
      <td style="padding:7px 12px;font-size:12px;color:#475569">${l.description||'‚Äî'}</td>
      <td style="padding:7px 12px;text-align:center">
        <div style="display:flex;gap:4px;justify-content:center">
          <button onclick="editRembModalLigne(${i})" title="Modifier" style="width:auto;padding:4px 8px;font-size:14px;background:#7c3aed">‚úèÔ∏è</button>
          <button onclick="deleteRembModalLigne(${i})" title="Supprimer" class="danger" style="width:auto;padding:4px 8px;font-size:14px">üóëÔ∏è</button>
        </div>
      </td>
    </tr>`;
  }).join('');
  if(totalRow){
    totalRow.style.display = '';
    totalCell.textContent = `-${fmt(totalRemb)} DA`;
  }
}

function _updateRembModalSolde(uid){
  const rembData = _getRembData();
  const r = rembData[uid];
  if(!r) return;
  const totalRemb = (r.lignes||[]).reduce((s,l) => s + l.montant, 0);
  const restant = r.soldeDepart - totalRemb;
  const bar = document.getElementById('rembModalSoldeBar');
  const barRestant = document.getElementById('rembModalSoldeRestant');

  const soldeHtml = `
    <div style="background:rgba(255,255,255,.2);padding:6px 14px;border-radius:8px;text-align:center">
      <div style="font-size:10px;color:rgba(255,255,255,.7);font-weight:700">SOLDE D√âPART</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:900;color:#A7F3D0">+${fmt(r.soldeDepart)} DA</div>
    </div>
    <div style="background:rgba(255,255,255,.2);padding:6px 14px;border-radius:8px;text-align:center">
      <div style="font-size:10px;color:rgba(255,255,255,.7);font-weight:700">REMBOURS√â</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:900;color:white">-${fmt(totalRemb)} DA</div>
    </div>
    <div style="background:${restant>0?'rgba(251,191,36,.3)':restant===0?'rgba(16,185,129,.3)':'rgba(220,38,38,.3)'};padding:6px 14px;border-radius:8px;text-align:center;border:2px solid ${restant>0?'#fbbf24':restant===0?'#10b981':'#dc2626'}">
      <div style="font-size:10px;color:rgba(255,255,255,.85);font-weight:700">RESTANT</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:900;color:white">${restant>0?'-':restant<0?'+':''}${fmt(Math.abs(restant))} DA</div>
    </div>`;
  if(bar) bar.innerHTML = soldeHtml;

  if(barRestant){
    if(restant > 0){
      barRestant.style.display = '';
      barRestant.style.background = '#fef3c7'; barRestant.style.color = '#92400e';
      barRestant.textContent = `‚ö†Ô∏è Restant √† rembourser : -${fmt(restant)} DA`;
    } else if(restant === 0){
      barRestant.style.display = '';
      barRestant.style.background = '#d1fae5'; barRestant.style.color = '#065f46';
      barRestant.textContent = `‚úÖ Remboursement √©quilibr√© ‚Äî Total = ${fmt(r.soldeDepart)} DA`;
    } else {
      barRestant.style.display = '';
      barRestant.style.background = '#fee2e2'; barRestant.style.color = '#991b1b';
      barRestant.textContent = `‚ùå D√©passement : +${fmt(Math.abs(restant))} DA (total d√©passe le solde de d√©part)`;
    }
  }
}

function addRembModalLigne(){
  if(!_currentRembUID) return;
  const date = document.getElementById('rembModalDate').value;
  const personId = document.getElementById('rembModalPersonne').value;
  const montant = parseFloat(document.getElementById('rembModalMontant').value);
  const description = document.getElementById('rembModalDescription').value.trim();
  if(!date){ alert('‚ùå Veuillez saisir une date'); return; }
  if(!personId){ alert('‚ùå Veuillez s√©lectionner une personne'); return; }
  if(!montant || isNaN(montant) || montant <= 0){ alert('‚ùå Veuillez saisir un montant valide'); return; }

  const rembData = _getRembData();
  const r = rembData[_currentRembUID];
  if(!r) return;

  // V√©rifier que le total ne d√©passe pas le solde de d√©part
  const totalActuel = (r.lignes||[]).reduce((s,l) => s + l.montant, 0);
  const indexEditing = _rembEditIndex;
  let totalSansEdit = totalActuel;
  if(indexEditing !== null && r.lignes[indexEditing]){
    totalSansEdit -= r.lignes[indexEditing].montant;
  }
  if(totalSansEdit + montant > r.soldeDepart + 0.01){
    alert(`‚ùå Total d√©passerait le solde de remboursement de d√©part (+${fmt(r.soldeDepart)} DA).\n\nRestant disponible : ${fmt(r.soldeDepart - totalSansEdit)} DA`);
    return;
  }

  const newLigne = { date, personId, montant, description };

  if(indexEditing !== null){
    r.lignes[indexEditing] = newLigne;
    _rembEditIndex = null;
    document.getElementById('rembModalAddBtn').textContent = '‚úö Ajouter';
    document.getElementById('rembModalCancelBtn').style.display = 'none';
  } else {
    if(!r.lignes) r.lignes = [];
    r.lignes.push(newLigne);
  }

  // Mettre √† jour l'alimentation n√©gative dans cashIn
  _syncRembCashIn(_currentRembUID, r);

  _saveRembData(rembData);
  _renderRembModalTable(_currentRembUID);
  _updateRembModalSolde(_currentRembUID);

  // R√©initialiser champs
  document.getElementById('rembModalDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('rembModalPersonne').value = '';
  document.getElementById('rembModalMontant').value = '';
  document.getElementById('rembModalDescription').value = '';
  renderCashInTable();
  updateSummary();
}

function editRembModalLigne(i){
  if(!_currentRembUID) return;
  const rembData = _getRembData();
  const r = rembData[_currentRembUID];
  if(!r || !r.lignes || !r.lignes[i]) return;
  const l = r.lignes[i];
  document.getElementById('rembModalDate').value = l.date || '';
  document.getElementById('rembModalPersonne').value = l.personId || '';
  document.getElementById('rembModalMontant').value = l.montant || '';
  document.getElementById('rembModalDescription').value = l.description || '';
  _rembEditIndex = i;
  document.getElementById('rembModalAddBtn').textContent = 'üíæ Enregistrer';
  document.getElementById('rembModalCancelBtn').style.display = 'inline-block';
}

function deleteRembModalLigne(i){
  if(!_currentRembUID) return;
  if(!confirm('‚ùå Supprimer cette ligne de remboursement ?')) return;
  const rembData = _getRembData();
  const r = rembData[_currentRembUID];
  if(!r || !r.lignes) return;
  r.lignes.splice(i, 1);
  _syncRembCashIn(_currentRembUID, r);
  _saveRembData(rembData);
  _renderRembModalTable(_currentRembUID);
  _updateRembModalSolde(_currentRembUID);
  renderCashInTable();
  updateSummary();
}

function cancelRembModalEdit(){
  _rembEditIndex = null;
  document.getElementById('rembModalDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('rembModalPersonne').value = '';
  document.getElementById('rembModalMontant').value = '';
  document.getElementById('rembModalDescription').value = '';
  document.getElementById('rembModalAddBtn').textContent = '‚úö Ajouter';
  document.getElementById('rembModalCancelBtn').style.display = 'none';
}

// Synchronise l'alimentation dans cashIn :
// Uniquement la ligne positive du solde de d√©part (entr√©e en caisse)
// Les remboursements par personne ne sont PAS inject√©s dans les alimentations
function _syncRembCashIn(uid, r){
  const mk = r.mk || getMonthKey();
  if(!cashIn[mk]) cashIn[mk] = [];

  // Supprimer toutes les anciennes lignes li√©es √† ce uid
  cashIn[mk] = cashIn[mk].filter(c => !(c.enPlusUID === uid));

  // ‚îÄ‚îÄ Ligne positive uniquement = solde de d√©part (entr√©e en caisse) ‚îÄ‚îÄ
  cashIn[mk].push({
    date: r.depenseDate,
    amount: r.soldeDepart,
    description: `‚ûï D√©pense en plus ${r.expenseId ? r.expenseId.toUpperCase() : uid} ‚Äî ${r.depensePersonne} ‚Äî ${fmt(r.soldeDepart)} DA`,
    isRembSoldeDepart: true,
    enPlusUID: uid
  });
}

function validerRemboursementModal(){
  const rembData = _getRembData();
  const r = rembData[_currentRembUID];
  if(r){
    const totalRemb = (r.lignes||[]).reduce((s,l) => s + l.montant, 0);
    if(Math.abs(totalRemb - r.soldeDepart) > 0.01){
      if(!confirm(`‚ö†Ô∏è Le total rembours√© (-${fmt(totalRemb)} DA) ne correspond pas au solde de d√©part (+${fmt(r.soldeDepart)} DA).\n\nVoulez-vous quand m√™me fermer ?`)) return;
    }
  }
  closeModal('remboursementModal');
  renderTransactions();
  renderCashInTable();
  updateSummary();
  showNotification('‚úÖ Remboursement sauvegard√©');
}

// ‚îÄ‚îÄ Mise √† jour du select dans la page Remboursement ‚îÄ‚îÄ
function updateRemboursementSelect(){
  const sel = document.getElementById('remboursementDepenseSelect');
  if(!sel) return;
  const rembData = _getRembData();
  const keys = Object.keys(rembData);
  sel.innerHTML = '<option value="">‚Äî S√©lectionner une d√©pense en plus ‚Äî</option>' +
    keys.map(uid => {
      const r = rembData[uid];
      return `<option value="${uid}">${r.expenseId ? r.expenseId.toUpperCase() : uid} ‚Äî ${r.depenseDate} ‚Äî ${fmt(r.soldeDepart)} DA ‚Äî ${r.depensePersonne}</option>`;
    }).join('');
}

function loadRemboursementForDepense(uid){
  if(!uid){
    document.getElementById('remboursementTableBody').innerHTML =
      '<tr><td colspan="5"><div class="empty-state"><div class="empty-state-icon">üíú</div><div class="empty-state-text">S√©lectionnez une d√©pense en plus</div></div></td></tr>';
    document.getElementById('remboursementFormSection').style.display = 'none';
    document.getElementById('remboursementSoldeGlobal').style.display = 'none';
    return;
  }
  _currentRembUID = uid;
  const rembData = _getRembData();
  const r = rembData[uid];
  if(!r) return;

  document.getElementById('remboursementFormSection').style.display = 'block';

  // Remplir select personnes
  const sel = document.getElementById('rembPersonne');
  if(sel){
    sel.innerHTML = '<option value="">‚Äî S√©lectionner ‚Äî</option>' +
      persons.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
  }

  // Date par d√©faut
  const dateInp = document.getElementById('rembDate');
  if(dateInp) dateInp.value = new Date().toISOString().split('T')[0];

  // Afficher solde global
  const totalRemb = (r.lignes||[]).reduce((s,l) => s + l.montant, 0);
  const soldeEl = document.getElementById('remboursementSoldeGlobal');
  if(soldeEl){
    soldeEl.style.display = 'block';
    soldeEl.textContent = `Solde d√©part: +${fmt(r.soldeDepart)} DA | Rembours√©: -${fmt(totalRemb)} DA | Restant: -${fmt(Math.max(0,r.soldeDepart - totalRemb))} DA`;
  }

  // Afficher solde barre
  const soldeBar = document.getElementById('rembSoldeBar');
  if(soldeBar){
    const restant = r.soldeDepart - totalRemb;
    soldeBar.style.display = '';
    if(restant > 0){ soldeBar.style.background='#fef3c7'; soldeBar.style.color='#92400e'; soldeBar.textContent = `‚ö†Ô∏è Restant √† rembourser : -${fmt(restant)} DA`; }
    else if(restant === 0){ soldeBar.style.background='#d1fae5'; soldeBar.style.color='#065f46'; soldeBar.textContent = `‚úÖ √âquilibr√© ‚Äî ${fmt(r.soldeDepart)} DA rembours√©`; }
    else { soldeBar.style.background='#fee2e2'; soldeBar.style.color='#991b1b'; soldeBar.textContent = `‚ùå D√©passement : +${fmt(Math.abs(restant))} DA`; }
  }

  // Afficher table
  _renderPageRembTable(uid);
}

function _renderPageRembTable(uid){
  const rembData = _getRembData();
  const r = rembData[uid];
  const tbody = document.getElementById('remboursementTableBody');
  if(!r || !r.lignes || r.lignes.length === 0){
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;color:#9ca3af;font-size:13px">Aucune ligne de remboursement</td></tr>';
    return;
  }
  tbody.innerHTML = r.lignes.map((l,i) => {
    const p = persons.find(p => p.id === l.personId);
    const pName = p ? p.name : l.personId;
    const dateStr = l.date ? new Date(l.date+'T12:00:00').toLocaleDateString('fr-FR') : '‚Äî';
    return `<tr style="background:${i%2===0?'#f5f3ff':'white'}">
      <td style="padding:8px 12px;font-family:'JetBrains Mono',monospace;font-size:12px">${dateStr}</td>
      <td style="padding:8px 12px;font-size:12px;font-weight:700">${pName}</td>
      <td style="padding:8px 12px;font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:800;color:#6d28d9;text-align:right;white-space:nowrap">-${fmt(l.montant)} DA</td>
      <td style="padding:8px 12px;font-size:12px;color:#475569">${l.description||'‚Äî'}</td>
      <td style="padding:8px 12px;text-align:center">
        <button onclick="deletePageRembLigne('${uid}',${i})" class="danger" title="Supprimer" style="width:auto;padding:4px 8px;font-size:14px">üóëÔ∏è</button>
      </td>
    </tr>`;
  }).join('');
}

function addRembLigne(){
  if(!_currentRembUID) return;
  const date = document.getElementById('rembDate').value;
  const personId = document.getElementById('rembPersonne').value;
  const montant = parseFloat(document.getElementById('rembMontant').value);
  const description = document.getElementById('rembDescription').value.trim();
  if(!date || !personId || !montant || isNaN(montant) || montant <= 0){
    alert('‚ùå Veuillez remplir tous les champs'); return;
  }
  const rembData = _getRembData();
  const r = rembData[_currentRembUID];
  if(!r) return;
  const totalActuel = (r.lignes||[]).reduce((s,l) => s + l.montant, 0);
  if(totalActuel + montant > r.soldeDepart + 0.01){
    alert(`‚ùå D√©passement. Restant : ${fmt(r.soldeDepart - totalActuel)} DA`); return;
  }
  if(!r.lignes) r.lignes = [];
  r.lignes.push({ date, personId, montant, description });
  _syncRembCashIn(_currentRembUID, r);
  _saveRembData(rembData);
  loadRemboursementForDepense(_currentRembUID);
  document.getElementById('rembDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('rembPersonne').value = '';
  document.getElementById('rembMontant').value = '';
  document.getElementById('rembDescription').value = '';
  renderCashInTable(); updateSummary();
}

function deletePageRembLigne(uid, i){
  if(!confirm('‚ùå Supprimer cette ligne ?')) return;
  const rembData = _getRembData();
  const r = rembData[uid];
  if(!r || !r.lignes) return;
  r.lignes.splice(i, 1);
  _syncRembCashIn(uid, r);
  _saveRembData(rembData);
  loadRemboursementForDepense(uid);
  renderCashInTable(); updateSummary();
}

function cancelRembEdit(){
  _rembEditIndex = null;
  document.getElementById('rembDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('rembPersonne').value = '';
  document.getElementById('rembMontant').value = '';
  document.getElementById('rembDescription').value = '';
  document.getElementById('rembAddBtn').textContent = '‚úö Ajouter ligne';
  document.getElementById('rembCancelBtn').style.display = 'none';
}

// ‚îÄ‚îÄ Hook showPage pour initialiser la page Remboursement ‚îÄ‚îÄ
const _origShowPage = showPage;
showPage = function(name){
  _origShowPage(name);
  if(name === 'remboursement'){
    document.getElementById('remboursementPage').classList.add('active');
    updateRemboursementSelect();
  }
};

// ‚îÄ‚îÄ Mise √† jour showPage map pour inclure remboursement ‚îÄ‚îÄ
// Override complet pour ajouter 'remboursement'
(function(){
  const _sp = showPage;
  window.showPage = function(name){
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    const map = {
      main:['mainPage',0],
      alimentations:['alimentationsPage',1],
      remboursement:['remboursementPage', null],
      persons:['personsPage',2],
      labels:['labelsPage',3],
      projets:['projetsPage',4],
      settings:['settingsPage',5]
    };
    if(map[name]){
      const pageEl = document.getElementById(map[name][0]);
      if(pageEl) pageEl.classList.add('active');
      if(map[name][1] !== null){
        const tabs = document.querySelectorAll('.nav-tab');
        if(tabs[map[name][1]]) tabs[map[name][1]].classList.add('active');
      } else if(name === 'remboursement'){
        const rTab = document.getElementById('remboursementNavTab');
        if(rTab) rTab.classList.add('active');
      }
      if(name==='persons') updatePersonsList();
      if(name==='labels') updateLabelsList();
      if(name==='projets') updateProjetsList();
      if(name==='alimentations'){ renderCashInTable(); setTodayCashInDate(); }
      if(name==='remboursement'){ updateRemboursementSelect(); }
      if(name==='settings'){
        document.getElementById('settingsUsername').value = currentUser;
        document.getElementById('settingsFullName').value = users[currentUser].fullName;
        document.getElementById('settingsEmail').value = users[currentUser].email||'';
        updateSyncModeUI();
        updateAutoSaveSettingsStatus();
        updateSettingsRoleBadge();
      }
    }
  };
})();


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  √âTAT GLOBAL DES REMBOURSEMENTS ‚Äî Modal (style identique NJ)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let _etatRembPersonneFilter = '';
let _etatRembCurrentTab = 'depenses'; // 'depenses' | 'personnes'

function openEtatRembModal(){
  _etatRembPersonneFilter = '';
  _etatRembCurrentTab = 'depenses';
  generateEtatRembContent();
  openModal('etatRembModal');
}

function etatRembSelectFilter(personId){
  _etatRembPersonneFilter = personId;
  generateEtatRembContent();
}

function etatRembSwitchTab(tab){
  _etatRembCurrentTab = tab;
  _etatRembPersonneFilter = '';
  const sel = document.getElementById('etatRembPersonneSelect');
  if(sel) sel.value = '';
  // Afficher/masquer filtre selon onglet
  const filterBar = document.getElementById('etatRembFilterBar');
  if(filterBar) filterBar.style.display = (tab === 'personnes') ? 'flex' : 'none';
  // Style onglets
  const tD = document.getElementById('etatRembTabDepenses');
  const tP = document.getElementById('etatRembTabPersonnes');
  if(tD){ tD.style.background = tab==='depenses' ? 'white' : 'rgba(255,255,255,.18)'; tD.style.color = tab==='depenses' ? '#059669' : 'white'; }
  if(tP){ tP.style.background = tab==='personnes' ? 'white' : 'rgba(255,255,255,.18)'; tP.style.color = tab==='personnes' ? '#059669' : 'white'; }
  generateEtatRembContent();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VUE D√âPENSES : toutes les d√©penses EN+ avec leurs remboursements
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function generateEtatRembDepensesView(){
  const rembData = _getRembData();
  const allUIDs  = Object.keys(rembData);

  // Totaux globaux
  const totalDuGlobal   = allUIDs.reduce((s,uid)=>s+(rembData[uid]?.soldeDepart||0),0);
  let   totalRembGlobal = 0;
  allUIDs.forEach(uid=>{ totalRembGlobal += (rembData[uid]?.lignes||[]).reduce((s,l)=>s+l.montant,0); });
  const totalRestant = totalDuGlobal - totalRembGlobal;
  const nbDossiers   = allUIDs.length;

  // Sous-titre
  document.getElementById('etatRembSubtitle').textContent =
    `${nbDossiers} dossier(s) ‚Ä¢ Total d√ª : ${fmt(totalDuGlobal)} DA ‚Ä¢ Rembours√© : ${fmt(totalRembGlobal)} DA`;

  // Barre r√©sum√©
  document.getElementById('etatRembSummaryBar').innerHTML = `
    <div style="background:rgba(255,255,255,.18);padding:7px 16px;border-radius:8px;text-align:center;min-width:110px">
      <div style="font-size:10px;color:rgba(255,255,255,.75);font-weight:700;text-transform:uppercase">Dossiers</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:17px;font-weight:900;color:white">${nbDossiers}</div>
    </div>
    <div style="background:rgba(255,255,255,.18);padding:7px 16px;border-radius:8px;text-align:center;min-width:150px">
      <div style="font-size:10px;color:rgba(255,255,255,.75);font-weight:700;text-transform:uppercase">Total D√ª</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:17px;font-weight:900;color:#A7F3D0">+${fmt(totalDuGlobal)} DA</div>
    </div>
    <div style="background:rgba(255,255,255,.18);padding:7px 16px;border-radius:8px;text-align:center;min-width:150px">
      <div style="font-size:10px;color:rgba(255,255,255,.75);font-weight:700;text-transform:uppercase">Rembours√©</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:17px;font-weight:900;color:#A7F3D0">-${fmt(totalRembGlobal)} DA</div>
    </div>
    <div style="background:${totalRestant<=0.01?'rgba(167,243,208,.3)':'rgba(251,191,36,.3)'};border:2px solid ${totalRestant<=0.01?'#6EE7B7':'#FCD34D'};padding:7px 16px;border-radius:8px;text-align:center;min-width:150px">
      <div style="font-size:10px;color:rgba(255,255,255,.85);font-weight:700;text-transform:uppercase">Restant</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:17px;font-weight:900;color:white">-${fmt(Math.max(0,totalRestant))} DA</div>
    </div>`;

  const content = document.getElementById('etatRembContent');
  content.style.background = '#F8FAFC';

  if(allUIDs.length === 0){
    content.innerHTML = `<div style="text-align:center;padding:48px;color:#64748B">
      <div style="font-size:56px;margin-bottom:16px">üìã</div>
      <div style="font-size:16px;font-weight:700">Aucune d√©pense en plus enregistr√©e</div>
      <div style="font-size:13px;margin-top:6px;color:#94A3B8">Cochez "D√©p. en +" lors de la saisie d'une d√©pense</div>
    </div>`;
    return;
  }

  // Trier par date d√©croissante
  const sortedUIDs = allUIDs.sort((a,b)=>{
    const da = rembData[a]?.depenseDate||'';
    const db = rembData[b]?.depenseDate||'';
    return db.localeCompare(da);
  });

  let html = '';
  sortedUIDs.forEach(uid => {
    const r = rembData[uid];
    if(!r) return;
    const lignes     = r.lignes || [];
    const totalRemb  = lignes.reduce((s,l)=>s+l.montant,0);
    const restant    = r.soldeDepart - totalRemb;
    const solde      = Math.abs(restant) <= 0.01;
    const pct        = r.soldeDepart > 0 ? Math.min(100, Math.round(totalRemb/r.soldeDepart*100)) : 0;

    // Grouper remboursements par personne pour le r√©sum√©
    const byPerson = {};
    lignes.forEach(l => {
      if(!byPerson[l.personId]) byPerson[l.personId] = 0;
      byPerson[l.personId] += l.montant;
    });
    const personSummary = Object.keys(byPerson).map(pid => {
      const pp = persons.find(p=>p.id===pid);
      return `<span style="background:${solde?'#D1FAE5':'#FEE2E2'};color:${solde?'#065F46':'#991B1B'};padding:2px 8px;border-radius:12px;font-size:11px;font-weight:700">${pp?pp.name:pid} : -${fmt(byPerson[pid])} DA</span>`;
    }).join(' ');

    const headerBg    = solde ? 'linear-gradient(135deg,#059669,#065F46)' : 'linear-gradient(135deg,#DC2626,#7F1D1D)';
    const borderColor = solde ? '#059669' : '#DC2626';
    const badgeBg     = solde ? '#10B981' : '#F59E0B';
    const badgeLabel  = solde ? '‚úÖ Sold√© 100%' : `‚è≥ En cours ${pct}%`;

    // Table des lignes de remboursement
    const lignesHtml = lignes.length === 0
      ? `<tr><td colspan="4" style="text-align:center;padding:14px;color:#94A3B8;font-size:12px;font-style:italic">Aucune ligne de remboursement saisie</td></tr>`
      : lignes.map((l,li) => {
          const lp     = persons.find(p=>p.id===l.personId);
          const lpName = lp ? lp.name : l.personId;
          const lDate  = l.date ? new Date(l.date+'T12:00:00').toLocaleDateString('fr-FR') : '‚Äî';
          return `<tr style="background:${li%2===0?'white':'#F8FAFC'}" onmouseover="this.style.background='#E0F2FE'" onmouseout="this.style.background='${li%2===0?'white':'#F8FAFC'}'">
            <td style="padding:6px 12px;font-family:'JetBrains Mono',monospace;font-size:11px;color:#475569">${lDate}</td>
            <td style="padding:6px 12px;font-size:12px;font-weight:700;color:#0F172A">${lpName}</td>
            <td style="padding:6px 12px;font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:900;color:#DC2626;text-align:right;white-space:nowrap">-${fmt(l.montant)} DA</td>
            <td style="padding:6px 12px;font-size:11px;color:#64748B">${l.description||'‚Äî'}</td>
          </tr>`;
        }).join('');

    const dDate = r.depenseDate ? new Date(r.depenseDate+'T12:00:00').toLocaleDateString('fr-FR') : '‚Äî';

    html += `
    <div style="margin-bottom:16px;border-radius:12px;overflow:hidden;box-shadow:0 3px 14px rgba(0,0,0,.1);border:1px solid ${borderColor}30">

      <!-- En-t√™te dossier -->
      <div style="background:${headerBg};padding:12px 18px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div style="display:flex;align-items:center;gap:12px">
          <span style="font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:900;background:rgba(255,255,255,.2);color:white;padding:3px 10px;border-radius:6px;border:1.5px solid rgba(255,255,255,.35)">${r.expenseId?r.expenseId.toUpperCase():uid}</span>
          <div>
            <div style="font-size:14px;font-weight:800;color:white;font-family:'Manrope',sans-serif">${r.depensePersonne||'‚Äî'}</div>
            <div style="font-size:11px;color:rgba(255,255,255,.75);margin-top:1px">${dDate} ‚Äî ${r.depenseDesc||'‚Äî'}</div>
          </div>
        </div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <div style="text-align:center">
            <div style="font-size:10px;color:rgba(255,255,255,.7);font-weight:700">SOLDE D√âPART</div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:900;color:#A7F3D0">+${fmt(r.soldeDepart)} DA</div>
          </div>
          <div style="width:1px;height:30px;background:rgba(255,255,255,.25)"></div>
          <div style="text-align:center">
            <div style="font-size:10px;color:rgba(255,255,255,.7);font-weight:700">REMBOURS√â</div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:900;color:white">-${fmt(totalRemb)} DA</div>
          </div>
          <div style="width:1px;height:30px;background:rgba(255,255,255,.25)"></div>
          <div style="text-align:center">
            <div style="font-size:10px;color:rgba(255,255,255,.7);font-weight:700">RESTANT</div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:900;color:${solde?'#A7F3D0':'#FCD34D'}">-${fmt(Math.max(0,restant))} DA</div>
          </div>
          <div style="background:${badgeBg};padding:4px 12px;border-radius:20px;font-size:11px;font-weight:800;color:white;white-space:nowrap">${badgeLabel}</div>
        </div>
      </div>

      <!-- Barre de progression -->
      <div style="background:${solde?'#D1FAE5':'#FEE2E2'};height:6px">
        <div style="background:${solde?'#059669':'#DC2626'};height:100%;width:${pct}%;transition:width .4s"></div>
      </div>

      <!-- Corps : r√©sum√© + table -->
      <div style="background:white">
        ${personSummary ? `<div style="padding:8px 18px;background:#F8FAFC;border-bottom:1px solid #E2E8F0;display:flex;flex-wrap:wrap;gap:6px;align-items:center">
          <span style="font-size:11px;font-weight:700;color:#64748B;margin-right:4px">Rembours√© par :</span>${personSummary}
        </div>` : ''}

        <!-- Table lignes -->
        <table style="width:100%;border-collapse:collapse">
          <thead>
            <tr style="background:#F1F5F9;border-bottom:2px solid #E2E8F0">
              <th style="padding:7px 12px;font-size:10px;color:#475569;text-align:left;font-weight:700;text-transform:uppercase;white-space:nowrap">üìÖ Date</th>
              <th style="padding:7px 12px;font-size:10px;color:#475569;text-align:left;font-weight:700;text-transform:uppercase">üë§ Personne</th>
              <th style="padding:7px 12px;font-size:10px;color:#475569;text-align:right;font-weight:700;text-transform:uppercase">üí∏ Montant</th>
              <th style="padding:7px 12px;font-size:10px;color:#475569;text-align:left;font-weight:700;text-transform:uppercase">üìù Description</th>
            </tr>
          </thead>
          <tbody>${lignesHtml}</tbody>
          ${lignes.length > 0 ? `<tfoot>
            <tr style="background:${solde?'#ECFDF5':'#FFF7ED'};border-top:2px solid ${solde?'#6EE7B7':'#FCD34D'}">
              <td colspan="2" style="padding:7px 12px;font-size:12px;font-weight:800;color:${solde?'#065F46':'#92400E'}">Total rembours√©</td>
              <td style="padding:7px 12px;font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:900;color:${solde?'#059669':'#DC2626'};text-align:right">-${fmt(totalRemb)} DA</td>
              <td></td>
            </tr>
          </tfoot>` : ''}
        </table>
      </div>

      <!-- Bouton ouvrir remboursement -->
      <div style="background:#F8FAFC;padding:8px 18px;display:flex;justify-content:flex-end;border-top:1px solid #E2E8F0">
        <button onclick="closeModal('etatRembModal');setTimeout(()=>openRembModal('${uid}'),200)"
          style="width:auto;padding:6px 16px;font-size:12px;font-weight:700;background:${solde?'#059669':'#7C3AED'};color:white;border:none;border-radius:8px;cursor:pointer">
          ‚úèÔ∏è G√©rer le remboursement
        </button>
      </div>
    </div>`;
  });

  // Total g√©n√©ral
  html += `<div style="background:linear-gradient(135deg,#0F172A,#1E293B);color:white;padding:14px 20px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;margin-top:4px">
    <span style="font-size:14px;font-weight:800;font-family:'Manrope',sans-serif">üí∞ TOTAL G√âN√âRAL ‚Äî ${nbDossiers} dossier(s)</span>
    <div style="display:flex;gap:24px;align-items:center">
      <span style="font-size:11px;color:rgba(255,255,255,.6)">D√ª : <strong style="color:#A7F3D0">+${fmt(totalDuGlobal)} DA</strong></span>
      <span style="font-size:11px;color:rgba(255,255,255,.6)">Rembours√© : <strong style="color:#FCA5A5">-${fmt(totalRembGlobal)} DA</strong></span>
      <span style="font-family:'JetBrains Mono',monospace;font-size:16px;font-weight:900;color:${totalRestant<=0.01?'#A7F3D0':'#FCD34D'}">-${fmt(Math.max(0,totalRestant))} DA</span>
    </div>
  </div>`;

  content.innerHTML = html;
}

function generateEtatRembContent(){
  // Sync √©tat onglets visuellement √† chaque rendu
  const _tD = document.getElementById('etatRembTabDepenses');
  const _tP = document.getElementById('etatRembTabPersonnes');
  const _fB = document.getElementById('etatRembFilterBar');
  if(_tD){ _tD.style.background = _etatRembCurrentTab==='depenses'?'white':'rgba(255,255,255,.18)'; _tD.style.color = _etatRembCurrentTab==='depenses'?'#059669':'white'; }
  if(_tP){ _tP.style.background = _etatRembCurrentTab==='personnes'?'white':'rgba(255,255,255,.18)'; _tP.style.color = _etatRembCurrentTab==='personnes'?'#059669':'white'; }
  if(_fB) _fB.style.display = _etatRembCurrentTab==='personnes' ? 'flex' : 'none';

  if(_etatRembCurrentTab === 'depenses'){
    generateEtatRembDepensesView();
    return;
  }

  const rembData = _getRembData();
  const allUIDs  = Object.keys(rembData);

  // ‚îÄ‚îÄ Construire donn√©es par personne ‚îÄ‚îÄ
  // On parcourt toutes les lignes de remboursement
  // et on regroupe par personId
  const byPerson = {}; // { personId: { totalDu: N, totalRemb: N, details: [{uid, mk, expenseId, soldeDepart, ligne}] } }

  allUIDs.forEach(uid => {
    const r = rembData[uid];
    if(!r) return;
    // Ajouter la d√©pense d'origine (solde d√ª)
    // Pour chaque ligne de remboursement
    (r.lignes || []).forEach(l => {
      if(!byPerson[l.personId]) byPerson[l.personId] = { totalDu: 0, totalRemb: 0, details: [] };
      byPerson[l.personId].totalRemb += l.montant;
      byPerson[l.personId].details.push({
        uid, mk: r.mk, expenseId: r.expenseId, soldeDepart: r.soldeDepart,
        depenseDate: r.depenseDate, depenseDesc: r.depenseDesc,
        depensePersonne: r.depensePersonne,
        ligne: l
      });
    });
    // Solde d√ª = attribu√© √† la personne de la d√©pense d'origine
    // (on reconstruit le total d√ª par personne qui a √©t√© la source)
    // On cherche la transaction en plus correspondante
    let srcPersonId = '';
    for(const mk2 in transactions){
      const found = (transactions[mk2]||[]).find(t => t.enPlusUID === uid);
      if(found){ srcPersonId = found.personId; break; }
    }
    if(srcPersonId){
      if(!byPerson[srcPersonId]) byPerson[srcPersonId] = { totalDu: 0, totalRemb: 0, details: [] };
      byPerson[srcPersonId].totalDu += r.soldeDepart;
    }
  });

  // ‚îÄ‚îÄ Totaux globaux ‚îÄ‚îÄ
  const totalDuGlobal   = allUIDs.reduce((s, uid) => s + (rembData[uid]?.soldeDepart || 0), 0);
  const totalRembGlobal = Object.values(byPerson).reduce((s, p) => s + p.totalRemb, 0);
  const totalRestant    = totalDuGlobal - totalRembGlobal;
  const nbDossiers      = allUIDs.length;

  // Sous-titre
  document.getElementById('etatRembSubtitle').textContent =
    `${nbDossiers} dossier(s) ‚Ä¢ Total d√ª : ${fmt(totalDuGlobal)} DA ‚Ä¢ Rembours√© : ${fmt(totalRembGlobal)} DA`;

  // Barre r√©sum√©
  document.getElementById('etatRembSummaryBar').innerHTML = `
    <div style="background:rgba(255,255,255,.18);padding:7px 16px;border-radius:8px;text-align:center;min-width:130px">
      <div style="font-size:10px;color:rgba(255,255,255,.75);font-weight:700;text-transform:uppercase">Dossiers</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:17px;font-weight:900;color:white">${nbDossiers}</div>
    </div>
    <div style="background:rgba(255,255,255,.18);padding:7px 16px;border-radius:8px;text-align:center;min-width:160px">
      <div style="font-size:10px;color:rgba(255,255,255,.75);font-weight:700;text-transform:uppercase">Total D√ª</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:17px;font-weight:900;color:#A7F3D0">+${fmt(totalDuGlobal)} DA</div>
    </div>
    <div style="background:rgba(255,255,255,.18);padding:7px 16px;border-radius:8px;text-align:center;min-width:160px">
      <div style="font-size:10px;color:rgba(255,255,255,.75);font-weight:700;text-transform:uppercase">Rembours√©</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:17px;font-weight:900;color:#A7F3D0">-${fmt(totalRembGlobal)} DA</div>
    </div>
    <div style="background:${totalRestant<=0.01?'rgba(167,243,208,.3)':'rgba(251,191,36,.3)'};border:2px solid ${totalRestant<=0.01?'#6EE7B7':'#FCD34D'};padding:7px 16px;border-radius:8px;text-align:center;min-width:160px">
      <div style="font-size:10px;color:rgba(255,255,255,.85);font-weight:700;text-transform:uppercase">Restant</div>
      <div style="font-family:'JetBrains Mono',monospace;font-size:17px;font-weight:900;color:white">-${fmt(Math.max(0,totalRestant))} DA</div>
    </div>`;

  // Peupler select personnes
  const sel = document.getElementById('etatRembPersonneSelect');
  const personIds = Object.keys(byPerson);
  sel.innerHTML = '<option value="">‚Äî Toutes les personnes ‚Äî</option>' +
    personIds.map(pid => {
      const p = persons.find(p => p.id === pid);
      return `<option value="${pid}">${p ? p.name : pid}</option>`;
    }).join('');
  sel.value = _etatRembPersonneFilter;

  // Filtrer si besoin
  const filteredPersonIds = _etatRembPersonneFilter
    ? personIds.filter(pid => pid === _etatRembPersonneFilter)
    : personIds;

  const content = document.getElementById('etatRembContent');
  if(allUIDs.length === 0){
    content.innerHTML = `<div style="text-align:center;padding:48px;color:#64748B">
      <div style="font-size:56px;margin-bottom:16px">üí∞</div>
      <div style="font-size:16px;font-weight:700">Aucun remboursement enregistr√©</div>
      <div style="font-size:13px;margin-top:6px;color:#94A3B8">Ajoutez une d√©pense en plus pour cr√©er un dossier de remboursement</div>
    </div>`;
    return;
  }

  // ‚îÄ‚îÄ Bloc par personne ‚îÄ‚îÄ
  let html = '';

  // Trier par total rembours√© d√©croissant
  const sortedPersonIds = filteredPersonIds.sort((a, b) => (byPerson[b]?.totalRemb||0) - (byPerson[a]?.totalRemb||0));

  sortedPersonIds.forEach(pid => {
    const pd = byPerson[pid];
    if(!pd) return;
    const p = persons.find(p => p.id === pid);
    const pName = p ? p.name : pid;
    const totalR = pd.totalRemb;
    const totalD = pd.totalDu;
    const restant = totalD - totalR;
    const pct = totalD > 0 ? Math.min(100, Math.round(totalR / totalD * 100)) : 100;

    // Grouper les d√©tails par mois
    const byMk = {};
    pd.details.forEach(d => {
      const mk = d.mk || '‚Äî';
      if(!byMk[mk]) byMk[mk] = [];
      byMk[mk].push(d);
    });

    html += `
    <div style="margin-bottom:20px;border-radius:12px;overflow:hidden;box-shadow:0 2px 12px rgba(5,150,105,.15)">
      <!-- En-t√™te personne -->
      <div style="background:linear-gradient(135deg,#059669,#065F46);color:white;padding:12px 18px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div style="display:flex;align-items:center;gap:10px">
          <span style="font-size:22px">üë§</span>
          <div>
            <div style="font-size:15px;font-weight:800;font-family:'Manrope',sans-serif">${pName}</div>
            <div style="font-size:11px;color:rgba(255,255,255,.75);margin-top:1px">${pd.details.length} ligne(s) de remboursement</div>
          </div>
        </div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <div style="text-align:right">
            <div style="font-size:10px;color:rgba(255,255,255,.7);font-weight:700">REMBOURS√â</div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:16px;font-weight:900;color:#A7F3D0">-${fmt(totalR)} DA</div>
          </div>
          <div style="width:1px;height:30px;background:rgba(255,255,255,.2)"></div>
          <div style="text-align:right">
            <div style="font-size:10px;color:rgba(255,255,255,.7);font-weight:700">RESTANT</div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:16px;font-weight:900;color:${restant<=0.01?'#A7F3D0':'#FCD34D'}">-${fmt(Math.max(0,restant))} DA</div>
          </div>
          <div style="background:${restant<=0.01?'#10B981':'#F59E0B'};padding:3px 10px;border-radius:20px;font-size:11px;font-weight:800;color:white;white-space:nowrap">
            ${restant<=0.01?'‚úÖ Sold√©':'‚è≥ En cours'} ${pct}%
          </div>
        </div>
      </div>
      <!-- Barre de progression -->
      <div style="background:#D1FAE5;height:5px"><div style="background:#059669;height:100%;width:${pct}%;transition:width .4s"></div></div>
      <!-- D√©tail par mois -->
      ${Object.keys(byMk).sort().map(mk => {
        const mkDetails = byMk[mk];
        const [my, mm] = mk.split('-');
        const mkLabel = mm ? (MONTHS[parseInt(mm)-1] + ' ' + my) : mk;
        const mkTotal = mkDetails.reduce((s, d) => s + d.ligne.montant, 0);

        // Grouper par dossier (uid) dans ce mois
        const byUID = {};
        mkDetails.forEach(d => {
          if(!byUID[d.uid]) byUID[d.uid] = { expenseId: d.expenseId, soldeDepart: d.soldeDepart, depenseDate: d.depenseDate, depenseDesc: d.depenseDesc, lignes: [] };
          byUID[d.uid].lignes.push(d.ligne);
        });

        return `
        <div style="background:white;border-bottom:1px solid #D1FAE5">
          <!-- Sous-header mois -->
          <div style="background:#ECFDF5;padding:7px 18px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #D1FAE5">
            <span style="font-size:12px;font-weight:800;color:#065F46">üìÖ ${mkLabel}</span>
            <span style="font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:800;color:#059669">-${fmt(mkTotal)} DA</span>
          </div>
          <!-- Dossiers dans ce mois -->
          ${Object.keys(byUID).map(uid2 => {
            const dossier = byUID[uid2];
            const dossierTotal = dossier.lignes.reduce((s,l) => s + l.montant, 0);
            const dossierRestant = dossier.soldeDepart - dossierTotal;
            return `
            <div style="padding:8px 18px 4px 28px;border-bottom:1px solid #F0FDF4">
              <!-- Ent√™te dossier -->
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                <div style="display:flex;align-items:center;gap:8px">
                  <span style="font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:800;color:#059669;background:#D1FAE5;padding:2px 8px;border-radius:5px">${dossier.expenseId ? dossier.expenseId.toUpperCase() : uid2}</span>
                  <span style="font-size:12px;color:#475569">${new Date(dossier.depenseDate+'T12:00:00').toLocaleDateString('fr-FR')} ‚Äî ${dossier.depenseDesc||'‚Äî'}</span>
                </div>
                <div style="display:flex;gap:10px;align-items:center">
                  <span style="font-size:11px;color:#064E3B;font-weight:700">Solde d√©part : <strong style="color:#059669">+${fmt(dossier.soldeDepart)} DA</strong></span>
                  <span style="font-size:11px;color:${dossierRestant<=0.01?'#059669':'#D97706'}">Restant : <strong>-${fmt(Math.max(0,dossierRestant))} DA</strong></span>
                </div>
              </div>
              <!-- Lignes de remboursement -->
              <table style="width:100%;border-collapse:collapse;margin-bottom:6px">
                <thead><tr style="background:#F0FDF4">
                  <th style="padding:4px 8px;font-size:10px;color:#065F46;text-align:left;font-weight:700;text-transform:uppercase">Date</th>
                  <th style="padding:4px 8px;font-size:10px;color:#065F46;text-align:left;font-weight:700;text-transform:uppercase">Personne</th>
                  <th style="padding:4px 8px;font-size:10px;color:#065F46;text-align:right;font-weight:700;text-transform:uppercase">Montant</th>
                  <th style="padding:4px 8px;font-size:10px;color:#065F46;text-align:left;font-weight:700;text-transform:uppercase">Description</th>
                </tr></thead>
                <tbody>
                  ${dossier.lignes.map((l, li) => {
                    const lp = persons.find(p2 => p2.id === l.personId);
                    const lpName = lp ? lp.name : l.personId;
                    const lDate = l.date ? new Date(l.date+'T12:00:00').toLocaleDateString('fr-FR') : '‚Äî';
                    return `<tr style="background:${li%2===0?'white':'#F0FDF4'}" onmouseover="this.style.background='#D1FAE5'" onmouseout="this.style.background='${li%2===0?'white':'#F0FDF4'}'">
                      <td style="padding:5px 8px;font-family:'JetBrains Mono',monospace;font-size:11px;color:#475569">${lDate}</td>
                      <td style="padding:5px 8px;font-size:12px;font-weight:700;color:#0F172A">${lpName}</td>
                      <td style="padding:5px 8px;font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:900;color:#059669;text-align:right;white-space:nowrap">-${fmt(l.montant)} DA</td>
                      <td style="padding:5px 8px;font-size:11px;color:#64748B">${l.description||'‚Äî'}</td>
                    </tr>`;
                  }).join('')}
                </tbody>
                <tfoot><tr style="background:#ECFDF5;border-top:1.5px solid #6EE7B7">
                  <td colspan="2" style="padding:5px 8px;font-size:11px;font-weight:800;color:#065F46">Sous-total dossier</td>
                  <td style="padding:5px 8px;font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:900;color:#059669;text-align:right">-${fmt(dossierTotal)} DA</td>
                  <td></td>
                </tr></tfoot>
              </table>
            </div>`;
          }).join('')}
          <!-- Total mois -->
          <div style="background:#D1FAE5;padding:6px 18px;display:flex;justify-content:space-between;align-items:center">
            <span style="font-size:11px;font-weight:700;color:#065F46">Total ${mkLabel}</span>
            <span style="font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:900;color:#059669">-${fmt(mkTotal)} DA</span>
          </div>
        </div>`;
      }).join('')}
      <!-- Total personne -->
      <div style="background:#059669;color:white;padding:10px 18px;display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:13px;font-weight:800;font-family:'Manrope',sans-serif">üí∞ TOTAL ${pName.toUpperCase()}</span>
        <span style="font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:900">-${fmt(totalR)} DA</span>
      </div>
    </div>`;
  });

  // Total g√©n√©ral
  html += `<div style="background:linear-gradient(135deg,#065F46,#022c22);color:white;padding:14px 20px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;margin-top:8px">
    <span style="font-size:15px;font-weight:800;font-family:'Manrope',sans-serif">üí∞ TOTAL G√âN√âRAL REMBOURSEMENTS</span>
    <span style="font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:900">-${fmt(totalRembGlobal)} DA</span>
  </div>`;

  content.innerHTML = html;
}

// ‚ïê‚ïê FIN √âTAT REMBOURSEMENTS ‚ïê‚ïê

// ‚ïê‚ïê FIN D√âPENSE EN PLUS & REMBOURSEMENT ‚ïê‚ïê

function addCashInFromForm(){
  const date=document.getElementById('cashInDate').value;
  const amount=parseFloat(document.getElementById('cashInAmount').value);
  const description=document.getElementById('cashInDescription').value.trim()||'Alimentation de caisse';
  if(!date){alert('‚ùå Veuillez s√©lectionner une date');return}
  if(!amount||isNaN(amount)||amount<=0){alert('‚ùå Veuillez entrer un montant valide');return}
  if(_dateInClosedMonth(date)){_alertMonthLocked(date.substring(0,7));return}

  // Cl√© du mois correspondant √† la DATE saisie (pas le mois affich√©)
  const dateMk = date.substring(0,7); // "YYYY-MM"

  if(!cashIn[dateMk])cashIn[dateMk]=[];

  if(editingCashInIndex!==null && editingCashInMk!==null){
    // Supprimer l'ancienne entr√©e de son ancien mois
    cashIn[editingCashInMk].splice(editingCashInIndex,1);
    // Ajouter dans le nouveau mois (selon la nouvelle date)
    cashIn[dateMk].push({date,amount,description});
    editingCashInIndex=null;
    editingCashInMk=null;
    document.getElementById('cashInFormTitle').textContent='‚ûï Ajouter une Alimentation';
    document.getElementById('addCashInBtn').textContent='‚úö Ajouter';
    document.getElementById('cancelCashInEditBtn').style.display='none';
  }else{
    cashIn[dateMk].push({date,amount,description});
  }
  saveUserData();renderCashInTable();renderTransactions();updateSummary();
  document.getElementById('cashInAmount').value='';
  document.getElementById('cashInDescription').value='';
  setTodayCashInDate();
  showNotification('‚úÖ Alimentation enregistr√©e dans ' + dateMk);

  // ‚îÄ‚îÄ Actualisation compl√®te de la base de donn√©es apr√®s alimentation ‚îÄ‚îÄ
  try{
    updatePersonsList();
    updateLabelsList();
    updateProjetsList();
    updatePersonSelects();
    updateLabelSelects();
    updateProjetSelects();
    updateMonthDisplay();
    if(window._fsAutoSave && window._fsAutoSave.isReady()) window._fsAutoSave.triggerSave();
    const sb = window._getSupabaseClient && window._getSupabaseClient();
    if(sb && navigator.onLine && window.currentUser){
      if(typeof _silentPush === 'function') _silentPush();
    }
  }catch(e){}
}
function editCashIn(index){
  const mk=getMonthKey();const item=cashIn[mk][index];if(!item)return;
  if(isMonthClosed(mk)){_alertMonthLocked(mk);return}
  document.getElementById('cashInDate').value=item.date;
  document.getElementById('cashInAmount').value=item.amount;
  document.getElementById('cashInDescription').value=item.description||'';
  editingCashInIndex=index;
  editingCashInMk=mk; // m√©moriser le mois source
  document.getElementById('cashInFormTitle').textContent='‚úèÔ∏è Modifier l\'Alimentation';
  document.getElementById('addCashInBtn').textContent='Enregistrer';
  document.getElementById('cancelCashInEditBtn').style.display='block';
  document.getElementById('alimentationsPage').scrollIntoView({behavior:'smooth',block:'start'});
}
function cancelCashInEdit(){
  editingCashInIndex=null;
  editingCashInMk=null;
  document.getElementById('cashInAmount').value='';
  document.getElementById('cashInDescription').value='';
  setTodayCashInDate();
  document.getElementById('cashInFormTitle').textContent='‚ûï Ajouter une Alimentation';
  document.getElementById('addCashInBtn').textContent='‚úö Ajouter';
  document.getElementById('cancelCashInEditBtn').style.display='none';
}
function deleteCashIn(index){
  const mk=getMonthKey();
  const item=cashIn[mk][index];
  if(!item)return;
  const isCloture=item.isCloture===true||item.amount<0;
  // ‚îÄ‚îÄ R√àGLE : si le mois est cl√¥tur√©, la ligne de cl√¥ture est INTOUCHABLE ‚îÄ‚îÄ
  if(isCloture&&isMonthClosed(mk)){
    alert('üîí Suppression non autoris√©e.\n\nLe mois est cl√¥tur√© ‚Äî la ligne de cl√¥ture ne peut pas √™tre supprim√©e tant que le mois reste verrouill√©.');
    return;
  }
  if(!isCloture&&isMonthClosed(mk)){_alertMonthLocked(mk);return}
  if(isCloture){
    const[year,month]=mk.split('-').map(Number);
    let nm=month+1,ny=year; if(nm>12){nm=1;ny++;}
    const nextMk=`${ny}-${String(nm).padStart(2,'0')}`;
    const linkedList=cashIn[nextMk]||[];
    const linkedItem=linkedList.find(c=>c.description&&(c.description.startsWith('Cl√¥ture du mois de')||c.description.startsWith('Cl√¥ture de'))&&c.amount>0);
    const msgLinked=linkedItem?`

‚ö†Ô∏è L'alimentation li√©e "${linkedItem.description}" (+${fmt(linkedItem.amount)} DA) dans le mois suivant sera aussi supprim√©e.`:'';
    if(!confirm(`üîí Supprimer la cl√¥ture "${item.description}" ?${msgLinked}`))return;
    cashIn[mk].splice(index,1);
    if(linkedItem&&cashIn[nextMk]) cashIn[nextMk]=cashIn[nextMk].filter(c=>c!==linkedItem);
    // D√©verrouiller le mois
    if(closedMonths&&closedMonths[mk]) delete closedMonths[mk];
    saveUserData();renderCashInTable();renderTransactions();updateSummary();
  } else {
    if(confirm('‚ùå Supprimer cette alimentation ?')){
      cashIn[mk].splice(index,1);saveUserData();renderCashInTable();renderTransactions();updateSummary();
    }
  }
}
function renderCashInTable(){
  const mk=getMonthKey();const list=cashIn[mk]||[];
  const tbody=document.getElementById('cashInTable');
  if(!tbody)return;
  if(list.length===0){tbody.innerHTML='<tr><td colspan="4"><div class="empty-state"><div class="empty-state-icon">üí∞</div><div class="empty-state-text">Aucune alimentation pour ce mois</div></div></td></tr>';return}
  const closed=isMonthClosed(mk);
  tbody.innerHTML=list.map((c,i)=>{
    const isCloture=c.isCloture===true||c.amount<0;
    // ‚îÄ‚îÄ Ligne solde de d√©part d√©pense en plus ‚Äî affichage VERT (entr√©e +) ‚îÄ‚îÄ
    if(c.isRembSoldeDepart){
      return `<tr style="background:#D1FAE5;border-left:4px solid #059669">
        <td class="text-mono" style="color:#065F46;font-weight:700">${new Date(c.date+'T12:00:00').toLocaleDateString('fr-FR')}</td>
        <td style="color:#065F46;font-weight:800">${c.description}</td>
        <td class="text-mono" style="white-space:nowrap;color:#059669;font-weight:900"><strong>+${fmt(c.amount)} DA</strong></td>
        <td><span style="font-size:11px;color:#059669;font-weight:700;background:#A7F3D0;padding:2px 8px;border-radius:5px">D√©pense en plus</span></td>
      </tr>`;
    }
    // ‚îÄ‚îÄ Ligne de remboursement (sortie par personne) ‚Äî affichage violet ‚îÄ‚îÄ
    if(c.isRemboursement){
      return `<tr style="background:#f5f3ff;border-left:4px solid #7c3aed">
        <td class="text-mono" style="color:#6d28d9;font-weight:700">${new Date(c.date+'T12:00:00').toLocaleDateString('fr-FR')}</td>
        <td style="color:#4c1d95;font-weight:800">üíú ${c.description}</td>
        <td class="text-mono" style="white-space:nowrap;color:#dc2626;font-weight:900"><strong>${fmt(c.amount)} DA</strong></td>
        <td><span style="font-size:11px;color:#7c3aed;font-weight:700;background:#ede9fe;padding:2px 8px;border-radius:5px">Remboursement</span></td>
      </tr>`;
    }
    if(isCloture){
      // Si le mois est cl√¥tur√© ‚Üí bouton suppression d√©sactiv√© avec cadenas
      const delBtn = closed
        ? `<button disabled title="Suppression non autoris√©e ‚Äî mois cl√¥tur√©" style="width:auto;padding:5px 10px;font-size:18px;background:#94A3B8;color:white;border:none;border-radius:8px;cursor:not-allowed;opacity:0.5;box-shadow:none">üîí</button>`
        : `<button class="danger" onclick="deleteCashIn(${i})" title="Supprimer la cl√¥ture" style="width:auto;padding:5px 10px;font-size:18px">üóëÔ∏è</button>`;
      return `<tr style="background:#FEE2E2;border-top:2px solid #FCA5A5;border-bottom:2px solid #FCA5A5">
        <td class="text-mono" style="color:#991B1B;font-weight:700">${new Date(c.date+'T12:00:00').toLocaleDateString('fr-FR')}</td>
        <td style="color:#991B1B;font-weight:700">üîí ${c.description}</td>
        <td class="text-mono" style="white-space:nowrap;color:#DC2626;font-weight:900"><strong>${fmt(c.amount)} DA</strong></td>
        <td>${delBtn}</td>
      </tr>`;
    }
    if(closed){
      return `<tr style="background:#D1FAE5;opacity:.85">
        <td class="text-mono">${new Date(c.date+'T12:00:00').toLocaleDateString('fr-FR')}</td>
        <td>${c.description}</td>
        <td class="text-mono" style="white-space:nowrap"><strong>${fmt(c.amount)} DA</strong></td>
        <td><span style="font-size:12px;color:#991B1B;font-weight:700">üîí Mois cl√¥tur√©</span></td>
      </tr>`;
    }
    return `<tr style="background:#D1FAE5">
      <td class="text-mono">${new Date(c.date+'T12:00:00').toLocaleDateString('fr-FR')}</td>
      <td>${c.description}</td>
      <td class="text-mono" style="white-space:nowrap"><strong>${fmt(c.amount)} DA</strong></td>
      <td><div style="display:flex;gap:8px;flex-wrap:wrap">
        <button onclick="editCashIn(${i})" title="Modifier" style="width:auto;padding:5px 10px;font-size:18px;background:var(--accent)">‚úèÔ∏è</button>
        <button class="danger" onclick="deleteCashIn(${i})" title="Supprimer" style="width:auto;padding:5px 10px;font-size:18px">üóëÔ∏è</button>
      </div></td>
    </tr>`;
  }).join('');
}
function openCashInQuickModal(){
  document.getElementById('quickCashInAmount').value='';
  document.getElementById('quickCashInDesc').value='';
  openModal('cashInQuickModal');
  setTimeout(()=>document.getElementById('quickCashInAmount').focus(),100);
}
function addQuickCashIn(){
  const amount=parseFloat(document.getElementById('quickCashInAmount').value);
  const description=document.getElementById('quickCashInDesc').value.trim()||'Alimentation de caisse';
  if(!amount||isNaN(amount)||amount<=0){alert('‚ùå Veuillez entrer un montant valide');return}
  const mk=getMonthKey();
  if(!cashIn[mk])cashIn[mk]=[];
  cashIn[mk].push({date:new Date().toISOString().split('T')[0],amount,description});
  saveUserData();renderTransactions();renderCashInTable();
  closeModal('cashInQuickModal');
  showNotification(`‚úÖ Alimentation de ${fmt(amount)} DA enregistr√©e !`);
}

function updateSummary(){
  const list = getViewTransactions();
  // Pour cashIn et balances, on adapte aussi selon le mode
  let cashList=[];
  let prevBal=0;
  if(currentViewMode==='month'){
    const mk=getMonthKey();
    cashList=cashIn[mk]||[];
    prevBal=balances[mk]||0;
  } else if(currentViewMode==='year'){
    Object.keys(cashIn).filter(mk=>mk.startsWith(currentYear+'-')).forEach(mk=>{cashList=cashList.concat(cashIn[mk]||[])});
    // solde de d√©but d'ann√©e = balance de Jan
    const janKey=`${currentYear}-01`;
    prevBal=balances[janKey]||0;
  } else {
    Object.values(cashIn).forEach(arr=>{cashList=cashList.concat(arr||[])});
    prevBal=0;
  }
  const totalExp=list.reduce((s,t)=>s+t.amount,0);
  const totalNotJust=list.filter(t=>!t.justified).reduce((s,t)=>s+t.amount,0);
  const totalCI=cashList.reduce((s,c)=>s+c.amount,0);
  const curBal=prevBal+totalCI-totalExp;
  document.getElementById('previousBalanceHeader').textContent=fmt(prevBal)+' DA';
  document.getElementById('totalCashInHeader').textContent=fmt(totalCI)+' DA';
  document.getElementById('totalExpensesHeader').textContent=fmt(totalExp)+' DA';
  document.getElementById('totalNotJustifiedHeader').textContent=fmt(totalNotJust)+' DA';
  document.getElementById('currentBalanceHeader').textContent=fmt(curBal)+' DA';
}
function closeMonth(){
  if(!confirm('‚úÖ Cl√¥turer ce mois et reporter le solde au mois suivant ?'))return;
  const mk=getMonthKey();
  const list=transactions[mk]||[];
  const cashList=cashIn[mk]||[];
  const totalExp=list.reduce((s,t)=>s+t.amount,0);
  const totalCI=cashList.reduce((s,c)=>s+c.amount,0);
  const prevBal=balances[mk]||0;
  const curBal=prevBal+totalCI-totalExp;
  let nm=currentMonthIndex+1,ny=currentYear;
  if(nm>11){nm=0;ny++;}
  const nextMk=`${ny}-${pad(nm+1)}`;

  // ‚îÄ‚îÄ Cr√©er automatiquement une Alimentation dans le mois suivant ‚îÄ‚îÄ
  const today=new Date();
  const clotureDate=today.toISOString().split('T')[0];
  const clotureDesc=`Cl√¥ture du mois de ${MONTHS[currentMonthIndex]} ${currentYear}`;
  if(!cashIn[nextMk])cashIn[nextMk]=[];
  cashIn[nextMk]=cashIn[nextMk].filter(c=>!c.description.startsWith('Cl√¥ture du mois de '+MONTHS[currentMonthIndex]));
  cashIn[nextMk].unshift({date:clotureDate, amount:curBal, description:clotureDesc});

  // ‚îÄ‚îÄ Ligne n√©gative dans le mois courant ‚îÄ‚îÄ
  if(!cashIn[mk])cashIn[mk]=[];
  const clotureDescMois=`Cl√¥ture de ${MONTHS[currentMonthIndex]} ${currentYear}`;
  cashIn[mk]=cashIn[mk].filter(c=>!c.description.startsWith('Cl√¥ture de '+MONTHS[currentMonthIndex]));
  cashIn[mk].push({date:clotureDate,amount:-curBal,description:clotureDescMois,isCloture:true});

  // ‚îÄ‚îÄ Marquer le mois comme cl√¥tur√© ‚îÄ‚îÄ
  if(!closedMonths)closedMonths={};
  closedMonths[mk]={closedAt:new Date().toISOString(),label:`${MONTHS[currentMonthIndex]} ${currentYear}`};

  balances[nextMk]=0;
  saveUserData();

  alert(`‚úÖ Cl√¥ture effectu√©e !

üìä D√©tail :
‚Ä¢ Alimentations : +${fmt(totalCI)} DA
‚Ä¢ D√©penses : -${fmt(totalExp)} DA
üí∞ Solde cl√¥tur√© : ${fmt(curBal)} DA

üîí Mois ${MONTHS[currentMonthIndex]} ${currentYear} verrouill√©.
üì• Report cr√©√© pour ${MONTHS[nm]} ${ny} : ${fmt(curBal)} DA`);

  currentMonthIndex=nm; currentYear=ny;
  updateMonthDisplay();
  renderTransactions();
  renderCashInTable();
  showPage('alimentations');

  // ‚îÄ‚îÄ Actualisation compl√®te de la base de donn√©es apr√®s cl√¥ture ‚îÄ‚îÄ
  try{
    updatePersonsList();
    updateLabelsList();
    updateProjetsList();
    updatePersonSelects();
    updateLabelSelects();
    updateProjetSelects();
    if(window._fsAutoSave && window._fsAutoSave.isReady()) window._fsAutoSave.triggerSave();
    const sb = window._getSupabaseClient && window._getSupabaseClient();
    if(sb && navigator.onLine && window.currentUser){
      if(typeof _silentPush === 'function') _silentPush();
    }
    showNotification('‚úÖ Base de donn√©es actualis√©e apr√®s cl√¥ture !');
  }catch(e){}
}

function openCashInStatsModal(){generateCashInStats();openModal('cashInStatsModal')}
function generateCashInStats(){
  const stats={};let totalG=0,countG=0;
  for(const mk in cashIn){
    const [year,month]=mk.split('-');
    const mi=parseInt(month)-1;
    const list=cashIn[mk];
    if(list.length>0){
      if(!stats[year])stats[year]={};
      const total=list.reduce((s,c)=>s+c.amount,0);
      const count=list.length;
      stats[year][mi]={monthName:MONTHS[mi],total,count,avg:total/count,details:list};
      totalG+=total;countG+=count;
    }
  }
  let html=`<div style="background:linear-gradient(135deg,var(--accent) 0%,var(--accent-hover) 100%);color:white;padding:20px;border-radius:12px;margin-bottom:20px">
    <h3 style="margin:0 0 10px 0;font-size:18px">üìä R√©sum√© Global</h3>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px">
      <div><div style="font-size:12px;opacity:.9">Total des alimentations</div><div style="font-size:24px;font-weight:800;font-family:'JetBrains Mono',monospace">${fmt(totalG)} DA</div></div>
      <div><div style="font-size:12px;opacity:.9">Nombre d'op√©rations</div><div style="font-size:24px;font-weight:800;font-family:'JetBrains Mono',monospace">${countG}</div></div>
      <div><div style="font-size:12px;opacity:.9">Moyenne par op√©ration</div><div style="font-size:24px;font-weight:800;font-family:'JetBrains Mono',monospace">${countG>0?fmt(totalG/countG):'0,00'} DA</div></div>
    </div></div>`;
  const years=Object.keys(stats).sort((a,b)=>b-a);
  if(years.length===0){
    html+='<div style="text-align:center;padding:40px;color:var(--text-secondary)"><div style="font-size:48px;margin-bottom:16px">üí∞</div><div style="font-size:16px;font-weight:600">Aucune alimentation enregistr√©e</div></div>';
  }else{
    years.forEach(year=>{
      const ys=stats[year];
      const yt=Object.values(ys).reduce((s,m)=>s+m.total,0);
      const yc=Object.values(ys).reduce((s,m)=>s+m.count,0);
      html+=`<div style="margin-bottom:24px"><h4 style="background:var(--primary);color:white;padding:12px 16px;border-radius:8px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center"><span>üìÖ Ann√©e ${year}</span><span style="font-family:'JetBrains Mono',monospace">${fmt(yt)} DA (${yc} op√©rations)</span></h4><div style="display:grid;gap:8px">`;
      Object.keys(ys).map(m=>parseInt(m)).sort((a,b)=>b-a).forEach(mi=>{
        const ms=ys[mi];
        html+=`<div style="background:#ECFDF5;border:1px solid #6EE7B7;border-radius:8px;padding:12px;margin-bottom:8px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid #10B981">
            <div><div style="font-weight:700;font-size:16px;color:var(--text-primary)">${ms.monthName} ${year}</div><div style="font-size:13px;color:var(--text-secondary)">${ms.count} alimentation(s) ‚Ä¢ Moyenne: ${fmt(ms.avg)} DA</div></div>
            <div style="font-size:20px;font-weight:800;color:var(--success);font-family:'JetBrains Mono',monospace">${fmt(ms.total)} DA</div>
          </div><div style="display:grid;gap:6px;margin-top:12px">`;
        ms.details.forEach(item=>{
          const d=new Date(item.date+'T12:00:00').toLocaleDateString('fr-FR');
          html+=`<div style="background:white;border-left:4px solid var(--success);padding:8px 12px;border-radius:6px;display:flex;justify-content:space-between;align-items:center">
            <div style="flex:1"><div style="display:flex;gap:12px;align-items:center"><span style="font-size:11px;font-weight:600;color:var(--text-secondary);font-family:'JetBrains Mono',monospace">üìÖ ${d}</span><span style="font-size:13px;color:var(--text-primary)">${item.description}</span></div></div>
            <div style="font-size:16px;font-weight:700;color:var(--success);font-family:'JetBrains Mono',monospace">+${fmt(item.amount)} DA</div></div>`;
        });
        html+='</div></div>';
      });
      html+='</div></div>';
    });
  }
  document.getElementById('cashInStatsContent').innerHTML=html;
}

function setResetPeriod(preset){
  const now=new Date();
  let sy,sm,sd,ey,em,ed;
  if(preset==='thisMonth'){sy=now.getFullYear();sm=now.getMonth();sd=1;ey=sy;em=sm;ed=new Date(sy,sm+1,0).getDate()}
  else if(preset==='lastMonth'){const d=new Date(now.getFullYear(),now.getMonth()-1,1);sy=d.getFullYear();sm=d.getMonth();sd=1;ey=sy;em=sm;ed=new Date(sy,sm+1,0).getDate()}
  else if(preset==='thisYear'){sy=now.getFullYear();sm=0;sd=1;ey=sy;em=11;ed=31}
  else if(preset==='byMonth'){
    const month=parseInt(document.getElementById('resetMonthSelect').value);
    const year=parseInt(document.getElementById('resetYearSelect').value);
    if(!year||isNaN(year)){alert('‚ùå Veuillez saisir une ann√©e valide.');return}
    sy=year;sm=month;sd=1;ey=year;em=month;ed=new Date(year,month+1,0).getDate();
  }else{
    const allDates=[];
    for(const mk in transactions)(transactions[mk]||[]).forEach(t=>allDates.push(t.date));
    for(const mk in cashIn)(cashIn[mk]||[]).forEach(c=>allDates.push(c.date));
    if(allDates.length===0){alert('‚ùå Aucune donn√©e trouv√©e.');return}
    allDates.sort();
    document.getElementById('resetStartDate').value=allDates[0];
    document.getElementById('resetEndDate').value=allDates[allDates.length-1];
    return;
  }
  document.getElementById('resetStartDate').value=`${sy}-${pad(sm+1)}-${pad(sd)}`;
  document.getElementById('resetEndDate').value=`${ey}-${pad(em+1)}-${pad(ed)}`;
}
function resetByPeriod(){
  if(!isAdmin(currentUser)){alert('\u26a1 La suppression par p\u00e9riode est r\u00e9serv\u00e9e \u00e0 l\'Administrateur.');return;}
  const start=document.getElementById('resetStartDate').value;
  const end=document.getElementById('resetEndDate').value;
  const typeEl=document.querySelector('input[name="resetType"]:checked');
  if(!typeEl){alert('\u274c Veuillez s\u00e9lectionner le type de donn\u00e9es \u00e0 supprimer.');return}
  const type=typeEl.value;

  if(type==='comptes'){
    const checks=document.querySelectorAll('.resetCompteChk:checked');
    if(checks.length===0){alert('\u274c Veuillez s\u00e9lectionner au moins un compte \u00e0 supprimer.');return;}
    const targets=Array.from(checks).map(c=>c.dataset.user);
    showPasswordModal('Confirmez la suppression de '+targets.length+' compte(s) : '+targets.join(', '),()=>{
      const deleted=[];
      targets.forEach(u=>{
        if(users[u]&&u!==currentUser&&users[u].role!=='admin'){
          delete users[u];
          deleted.push(u);
        }
      });
      // Ajouter √† la liste noire AVANT sauvegarde
      if(deleted.length>0) _addDeletedUsers(deleted);
      saveUsers();
      if(window._fsAutoSave&&window._fsAutoSave.isReady())window._fsAutoSave.triggerSave();
      // Supprimer depuis Supabase de fa√ßon fiable (await)
      (async function(){
        try{
          const sb=window._getSupabaseClient&&window._getSupabaseClient();
          if(sb&&navigator.onLine){
            for(const u of deleted){
              await Promise.all([
                sb.from('users_data').delete().eq('username',u),
                sb.from('persons').delete().eq('username',u),
                sb.from('labels').delete().eq('username',u),
                sb.from('projets').delete().eq('username',u),
                sb.from('transactions').delete().eq('username',u),
                sb.from('cash_in').delete().eq('username',u),
                sb.from('balances').delete().eq('username',u),
              ]);
            }
            showNotification('‚òÅÔ∏è Comptes supprim√©s de Supabase : '+deleted.join(', '));
          }
        }catch(e){ console.warn('Supabase delete error:',e); }
      })();
      (async function(){
        try{ if(typeof pushSB==='function'){ showNotification('\ud83d\udd04 Sync Supabase...'); await pushSB(); showNotification('\u2601\ufe0f Supabase synchronis\u00e9'); } }
        catch(e){ console.warn('Sync SB:',e); }
      })();
      const panel=document.getElementById('resetComptesPanel');
      if(panel) panel.style.display='none';
      populateResetComptesList();
      const chk=document.querySelector('input[name="resetType"]:checked');
      if(chk)chk.checked=false;
      showNotification('\ud83d\uddd1\ufe0f '+deleted.length+' compte(s) supprim\u00e9(s) : '+deleted.join(', '));
      alert('\u2705 Suppression r\u00e9ussie !\n\n'+deleted.length+' compte(s):\n'+deleted.map(u=>' \u2022 '+u).join('\n')+'\n\nToutes leurs donn\u00e9es ont \u00e9t\u00e9 effac\u00e9es.\n\u2601\ufe0f Sync Supabase lanc\u00e9e.');
    });
    return;
  }

  if(!start||!end){alert('\u274c Veuillez s\u00e9lectionner une p\u00e9riode.');return}
  if(start>end){alert('\u274c La date de d\u00e9but doit \u00eatre ant\u00e9rieure ou \u00e9gale \u00e0 la date de fin.');return}
  const labels2={depenses:'üìä D√©penses',alimentations:'üí∞ Alimentations',solde:'üí∞ Solde',libelles:'üè∑Ô∏è Libell√©s',personnes:'üë• Personnes',projets:'üìÅ Projets',all:'üî• Tout'};
  showPasswordModal(`üîê Entrez votre mot de passe\n\nP√©riode : ${start} ‚Üí ${end}\nType    : ${labels2[type]}`,()=>{
    let dt=0,dc=0,dl=0,dp=0,dpr=0,ds=0;
    if(type==='all'){
      // √âTAT USINE COMPLET
      const dtTotal=Object.values(transactions).reduce(function(s,a){return s+(a||[]).length},0);
      transactions={};
      const dcTotal=Object.values(cashIn).reduce(function(s,a){return s+(a||[]).length},0);
      cashIn={};
      const dsTotal=Object.keys(balances).length;
      balances={};
      const dclTotal=Object.keys(closedMonths||{}).length;
      closedMonths={};
      const dlTotal=labels.length; labels=[];
      const dpTotal=persons.length; persons=[];
      const dprTotal=projets.length; projets=[];
      // ‚îÄ‚îÄ Supprimer tous les remboursements ‚îÄ‚îÄ
      const drTotal=Object.keys((users[currentUser]&&users[currentUser].data&&users[currentUser].data.remboursements)||{}).length;
      if(users[currentUser]&&users[currentUser].data) users[currentUser].data.remboursements={};
      localStorage.removeItem('_expenseIdCounters');
      updateLabelsList();updateLabelSelects();
      updatePersonsList();updatePersonSelects();
      updateProjetsList();updateProjetSelects();
      updateRemboursementSelect();
      saveUserData();renderTransactions();renderCashInTable();updateSummary();updateMonthDisplay();
      document.getElementById('resetStartDate').value='';
      document.getElementById('resetEndDate').value='';
      var chkAll=document.querySelector('input[name="resetType"]:checked');
      if(chkAll)chkAll.checked=false;
      showNotification('üî• √âtat usine complet ‚Äî tout r√©initialis√© !');
      alert('‚úÖ √âTAT USINE COMPLET !\n\nüóëÔ∏è '+dtTotal+' d√©pense(s)\nüí∞ '+dcTotal+' alimentation(s)\nüîí '+dclTotal+' cl√¥ture(s)\nüíæ '+dsTotal+' solde(s)\nüè∑Ô∏è '+dlTotal+' libell√©(s)\nüë• '+dpTotal+' personne(s)\nüìÅ '+dprTotal+' projet(s)\nüíú '+drTotal+' remboursement(s)\nüî¢ IDs remis √† z√©ro');
      return;
    }
    if(type==='depenses'){
      const rembData = _getRembData();
      let drCount = 0;
      for(const mk in transactions){
        const before = (transactions[mk]||[]).length;
        // Identifier les d√©penses en plus supprim√©es dans cette p√©riode
        (transactions[mk]||[]).forEach(t => {
          if(t.enPlus && t.enPlusUID && t.date >= start && t.date <= end){
            const uid = t.enPlusUID;
            // Supprimer les cashIn li√©s
            for(const mkey in cashIn){
              cashIn[mkey] = (cashIn[mkey]||[]).filter(c => c.enPlusUID !== uid);
              if(cashIn[mkey].length === 0) delete cashIn[mkey];
            }
            // Supprimer le dossier remboursement
            if(rembData[uid]){ delete rembData[uid]; drCount++; }
          }
        });
        transactions[mk]=(transactions[mk]||[]).filter(t=>t.date<start||t.date>end);
        dt+=before-transactions[mk].length;
      }
      if(drCount > 0){ _saveRembData(rembData); updateRemboursementSelect(); }
    }
    if(type==='alimentations'){
      for(const mk in cashIn){const b=(cashIn[mk]||[]).length;cashIn[mk]=(cashIn[mk]||[]).filter(c=>c.date<start||c.date>end);dc+=b-cashIn[mk].length}
    }
    if(type==='solde'){
      for(const mk in balances){
        const[y,m]=mk.split('-').map(Number);
        const first=`${y}-${pad(m)}-01`;const last=`${y}-${pad(m)}-${new Date(y,m,0).getDate()}`;
        if(first<=end&&last>=start){delete balances[mk];ds++;}
      }
    }
    if(type==='libelles'){dl=labels.length;labels=[];updateLabelsList();updateLabelSelects()}
    if(type==='personnes'){dp=persons.length;persons=[];updatePersonsList();updatePersonSelects()}
    if(type==='projets'){dpr=projets.length;projets=[];updateProjetsList();updateProjetSelects()}
    saveUserData();renderTransactions();renderCashInTable();updateSummary();
    const lines=['‚úÖ Suppression effectu√©e !'];
    if(type!=='libelles'&&type!=='personnes'&&type!=='projets')lines.push(`P√©riode : ${start} ‚Üí ${end}`);
    if(type==='depenses')lines.push(`${dt} d√©pense(s)`);
    if(type==='alimentations')lines.push(`${dc} alimentation(s)`);
    if(type==='solde')lines.push(`${ds} solde(s) supprim√©(s)`);
    if(type==='libelles')lines.push(`${dl} libell√©(s)`);
    if(type==='personnes')lines.push(`${dp} personne(s)`);
    if(type==='projets')lines.push(`${dpr} projet(s)`);
    showNotification(lines.join(' ‚Ä¢ '));
    document.getElementById('resetStartDate').value='';
    document.getElementById('resetEndDate').value='';
    const checked=document.querySelector('input[name="resetType"]:checked');
    if(checked)checked.checked=false;
  });
}

document.addEventListener('DOMContentLoaded',function(){
  document.querySelectorAll('input[name="resetType"]').forEach(function(r){
    r.addEventListener('change',function(){
      var p=document.getElementById('resetComptesPanel');
      if(!p)return;
      if(this.value==='comptes'){p.style.display='block';populateResetComptesList();}
      else{p.style.display='none';}
    });
  });
});

function populateResetComptesList(){
  var c=document.getElementById('resetComptesList');
  if(!c)return;
  var others=Object.keys(users).filter(function(u){return u!==currentUser&&(!users[u].role||users[u].role==='standard');});
  if(others.length===0){c.innerHTML='<div style="text-align:center;padding:10px;color:#8B5CF6;font-size:12px">Aucun compte Standard trouv\u00e9</div>';return;}
  c.innerHTML=others.map(function(u){
    var info=users[u];
    return '<div style="display:flex;align-items:center;gap:8px;background:white;border:1.5px solid #C4B5FD;border-radius:6px;padding:5px 10px">'
      +'<input type="checkbox" class="resetCompteChk" data-user="'+u+'" style="width:13px;height:13px;accent-color:#7C3AED;flex-shrink:0;cursor:pointer">'
      +'<div style="flex:1"><div style="font-weight:700;font-size:12px;color:#0F172A">'+u+'</div>'
      +'<div style="font-size:11px;color:#64748B">'+(info.fullName||'')+(info.email?' \u00b7 '+info.email:'')+'</div></div>'
      +'<span style="font-size:10px;font-weight:700;background:#EFF6FF;color:#1E40AF;padding:2px 7px;border-radius:20px">STANDARD</span></div>';
  }).join('');
}

function selectAllResetComptes(select){
  document.querySelectorAll('.resetCompteChk').forEach(function(c){c.checked=select;});
}

function updateAccountInfo(){
  const newUsername=document.getElementById('settingsUsername').value.trim();
  const fullName=document.getElementById('settingsFullName').value.trim();
  const email=document.getElementById('settingsEmail').value.trim();
  if(!newUsername){alert('‚ùå Le nom d\'utilisateur ne peut pas √™tre vide.');return}
  if(newUsername.length<3){alert('‚ùå Le nom d\'utilisateur doit contenir au moins 3 caract√®res.');return}
  if(!fullName){alert('‚ùå Le nom complet ne peut pas √™tre vide.');return}
  if(email&&!email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)){alert('‚ùå Format d\'email invalide.');return}
  if(newUsername!==currentUser){
    if(users[newUsername]){alert('‚ùå Ce nom d\'utilisateur est d√©j√† utilis√©.');document.getElementById('settingsUsername').value=currentUser;return}
    showPasswordModal('üîê Entrez votre mot de passe pour confirmer',()=>{
      users[newUsername]={password:users[currentUser].password,fullName,email,data:users[currentUser].data};
      delete users[currentUser];currentUser=newUsername;saveUsers();
      document.getElementById('currentUserDisplay').textContent=fullName;
      document.getElementById('settingsUsername').value=newUsername;
      const initials=fullName.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
      document.getElementById('userAvatar').textContent=initials;
      showNotification('‚úÖ Nom d\'utilisateur modifi√© : '+newUsername);
    });
  }else{
    users[currentUser].fullName=fullName;users[currentUser].email=email;saveUsers();
    document.getElementById('currentUserDisplay').textContent=fullName;
    const initials=fullName.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
    document.getElementById('userAvatar').textContent=initials;
    showNotification('‚úÖ Informations du compte mises √† jour !');
  }
}
function changeUserPassword(){
  showPasswordModal('Entrez votre mot de passe actuel',()=>{
    const np=prompt('üîë Entrez votre nouveau mot de passe (min. 4 caract√®res) :');
    if(!np)return;
    if(np.length<4){alert('‚ùå Le mot de passe doit contenir au moins 4 caract√®res');return}
    const cp=prompt('üîë Confirmez votre nouveau mot de passe :');
    if(np!==cp){alert('‚ùå Les mots de passe ne correspondent pas');return}
    users[currentUser].password=np;saveUsers();
    alert('‚úÖ Mot de passe modifi√© avec succ√®s !');
  });
}
function deleteAccount(){
  if(!confirm('‚ö†Ô∏è SUPPRESSION DE COMPTE\n\nCela supprimera d√©finitivement votre compte et toutes vos donn√©es.\n\n‚ùå IRR√âVERSIBLE.\n\nContinuer ?'))return;
  showPasswordModal('üîê Entrez votre mot de passe pour confirmer',()=>{
    delete users[currentUser];saveUsers();
    currentUser=null;persons=[];labels=[];transactions={};balances={};cashIn={};
    document.getElementById('mainApp').style.display='none';
    document.getElementById('authScreen').style.display='block';
    showLogin();
  });
}
function refreshDatabase(){
  loadUserData();updatePersonsList();updateLabelsList();updatePersonSelects();updateLabelSelects();
  renderTransactions();renderCashInTable();updateMonthDisplay();
  document.getElementById('settingsUsername').value=currentUser;
  document.getElementById('settingsFullName').value=users[currentUser].fullName;
  document.getElementById('settingsEmail').value=users[currentUser].email||'';
  showNotification('üîÑ Base de donn√©es rafra√Æchie avec succ√®s !');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BOUTON ACTUALISER GLOBAL (nav-tabs)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function refreshAllData(){
  const btn = document.getElementById('globalRefreshBtn');

  // Animation rotation de l'ic√¥ne
  if(btn){
    btn.style.opacity = '.6';
    btn.style.pointerEvents = 'none';
    const icon = btn.querySelector('span:first-child') || btn;
    btn.innerHTML = '<span style="display:inline-block;animation:spin360 .7s linear infinite;font-size:16px">üîÑ</span> <span style="font-size:13px">Actualisation...</span>';
  }

  // Ajouter l'animation CSS si pas encore pr√©sente
  if(!document.getElementById('spin360Style')){
    const s = document.createElement('style');
    s.id = 'spin360Style';
    s.textContent = '@keyframes spin360{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}';
    document.head.appendChild(s);
  }

  setTimeout(function(){
    try{
      // Recharger toutes les donn√©es depuis le localStorage
      loadUserData();

      // Rafra√Æchir toutes les listes
      updatePersonsList();
      updateLabelsList();
      updateProjetsList();
      updatePersonSelects();
      updateLabelSelects();
      updateProjetSelects();

      // Rafra√Æchir les tableaux
      renderTransactions();
      renderCashInTable();
      updateMonthDisplay();

      // Rafra√Æchir les champs param√®tres si ouverts
      try{
        document.getElementById('settingsUsername').value = currentUser;
        document.getElementById('settingsFullName').value = users[currentUser].fullName;
        document.getElementById('settingsEmail').value    = users[currentUser].email||'';
      }catch(e){}

      // Tenter un pull Supabase si connect√© et en ligne
      const sb = window._getSupabaseClient && window._getSupabaseClient();
      if(sb && navigator.onLine && window.currentUser){
        if(typeof _silentPush === 'function') _silentPush();
      }

      // Tenter un auto-save fichier
      if(window._fsAutoSave && window._fsAutoSave.isReady()) window._fsAutoSave.triggerSave();

      showNotification('‚úÖ Toutes les donn√©es actualis√©es avec succ√®s !');
    }catch(e){
      showNotification('‚ö†Ô∏è Actualisation partielle : ' + e.message);
    }finally{
      // Restaurer le bouton
      const b = document.getElementById('globalRefreshBtn');
      if(b){
        b.innerHTML = 'üîÑ <span style="font-size:13px">Actualiser</span>';
        b.style.opacity = '1';
        b.style.pointerEvents = '';
      }
    }
  }, 600);
}

function exportData(){
  const data={username:currentUser,fullName:users[currentUser].fullName,email:users[currentUser].email,exportDate:new Date().toISOString(),data:{persons,labels,transactions,balances,cashIn}};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const link=document.createElement('a');
  link.href=url;link.download=`gestion-depenses-${currentUser}-${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(link);link.click();document.body.removeChild(link);URL.revokeObjectURL(url);
  alert('‚úÖ Donn√©es export√©es avec succ√®s !\n\nüí° Conseil : Envoyez ce fichier √† votre email pour le r√©cup√©rer sur un autre appareil.');
}
function importData(){
  if(!confirm('‚ö†Ô∏è ATTENTION : L\'importation remplacera toutes vos donn√©es actuelles.\n\nVoulez-vous continuer ?'))return;
  document.getElementById('importFileInput').click();
}
function handleImportFile(event){
  const file=event.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const imported=JSON.parse(e.target.result);
      if(!imported.data||!imported.username){alert('‚ùå Fichier invalide.');return}
      showPasswordModal('Entrez votre mot de passe pour confirmer l\'importation',()=>{
        persons=imported.data.persons||[];
        labels=imported.data.labels||[];
        transactions=imported.data.transactions||{};
        balances=imported.data.balances||{};
        cashIn=imported.data.cashIn||{};
        saveUserData();updatePersonsList();updateLabelsList();updatePersonSelects();updateLabelSelects();renderTransactions();
        alert(`‚úÖ Donn√©es import√©es !\n\nSource : ${imported.username}\nDate d'export : ${new Date(imported.exportDate).toLocaleString('fr-FR')}`);
      });
    }catch{alert('‚ùå Erreur lors de la lecture du fichier.')}
  };
  reader.readAsText(file);event.target.value='';
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  IMPORT SAUVEGARDE JSON
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function importSaveJSON(){
  document.getElementById('importSaveJSONInput').click();
}
function _showImportSaveStatus(msg, bg, col){
  const el = document.getElementById('importSaveJSONStatus');
  if(!el) return;
  el.textContent = msg; el.style.background = bg; el.style.color = col;
  el.style.display = msg ? 'block' : 'none';
}
function _applyImportedSaveData(parsed){
  let importedUsers = {};
  if(parsed.users && typeof parsed.users === 'object'){
    importedUsers = parsed.users;
  } else if(parsed.username && parsed.data){
    importedUsers[parsed.username] = {
      password: parsed.password || (users[parsed.username] ? users[parsed.username].password : ''),
      fullName: parsed.fullName || parsed.username, email: parsed.email || '', data: parsed.data
    };
  } else { _showImportSaveStatus('‚ùå Format non reconnu.', '#FEE2E2', '#991B1B'); return; }
  const nb = Object.keys(importedUsers).length;
  if(!nb){ _showImportSaveStatus('‚ö†Ô∏è Aucun compte trouv√©.', '#FEF3C7', '#92400E'); return; }
  Object.keys(importedUsers).forEach(u=>{
    if(!users[u]){ users[u]=importedUsers[u]; }
    else{
      users[u].fullName=importedUsers[u].fullName||users[u].fullName;
      users[u].email=importedUsers[u].email||users[u].email;
      if(importedUsers[u].password) users[u].password=importedUsers[u].password;
      users[u].data=importedUsers[u].data||users[u].data;
    }
  });
  localStorage.setItem('appUsers', JSON.stringify(users));
  populateLoginSelect();
  if(currentUser && importedUsers[currentUser]){
    loadUserData();
    updatePersonsList();updateLabelsList();updateProjetsList();
    updatePersonSelects();updateLabelSelects();updateProjetSelects();
    renderTransactions();renderCashInTable();
  }
  const savedAt = parsed.savedAt ? new Date(parsed.savedAt).toLocaleString('fr-FR') : 'inconnue';
  const folder  = parsed.folder  ? ' ¬∑ Dossier : ' + parsed.folder : '';
  _showImportSaveStatus('‚úÖ '+nb+' compte(s) restaur√©(s). Sauvegarde du : '+savedAt+folder, '#D1FAE5', '#065F46');
  showNotification('‚úÖ '+nb+' compte(s) import√©(s) depuis la sauvegarde JSON');
}
function handleImportSaveJSON(event){
  const file=event.target.files[0]; if(!file) return;
  _showImportSaveStatus('üîÑ Lecture...', '#DBEAFE', '#1E40AF');
  const r=new FileReader();
  r.onload=e=>{ try{ _applyImportedSaveData(JSON.parse(e.target.result)); }catch(err){ _showImportSaveStatus('‚ùå Fichier JSON invalide.', '#FEE2E2', '#991B1B'); } };
  r.readAsText(file); event.target.value='';
}
async function importSaveJSONFromFolder(){
  if(!('showDirectoryPicker' in window)){ alert('‚ö†Ô∏è Utilisez Chrome ou Edge.'); return; }
  _showImportSaveStatus('üîÑ S√©lection du dossier...', '#DBEAFE', '#1E40AF');
  try{
    const dir=await window.showDirectoryPicker({id:'import_save_dir', mode:'readwrite', startIn:'desktop'});
    const perm=await dir.requestPermission({mode:'readwrite'});
    if(perm!=='granted'){ _showImportSaveStatus('‚ùå Permission refus√©e.', '#FEE2E2', '#991B1B'); return; }
    let fh; try{ fh=await dir.getFileHandle('Save_data_Depense.json'); }
    catch(e){ _showImportSaveStatus('‚ùå Save_data_Depense.json introuvable dans ce dossier.', '#FEE2E2', '#991B1B'); return; }
    _showImportSaveStatus('üîÑ Lecture de Save_data_Depense.json...', '#DBEAFE', '#1E40AF');
    _applyImportedSaveData(JSON.parse(await (await fh.getFile()).text()));
  }catch(e){
    if(e.name!=='AbortError') _showImportSaveStatus('‚ùå Erreur : '+e.message, '#FEE2E2', '#991B1B');
    else _showImportSaveStatus('', '#fff', '#000');
  }
}

function openExportByDateModal(){
  const now=new Date();
  document.getElementById('exportStartDate').value=new Date(now.getFullYear(),now.getMonth(),1).toISOString().split('T')[0];
  document.getElementById('exportEndDate').value=new Date(now.getFullYear(),now.getMonth()+1,0).toISOString().split('T')[0];
  openModal('exportByDateModal');
}
function openExportByMonthModal(){
  document.getElementById('exportMonthSelect').value=currentMonthIndex;
  document.getElementById('exportYearInput').value=currentYear;
  openModal('exportByMonthModal');
}
function exportToExcelByDate(){
  const start=document.getElementById('exportStartDate').value;
  const end=document.getElementById('exportEndDate').value;
  if(!start||!end){alert('‚ùå Veuillez s√©lectionner les deux dates');return}
  if(new Date(start)>new Date(end)){alert('‚ùå La date de d√©but doit √™tre ant√©rieure √† la date de fin');return}
  let filtered=[];
  for(const mk in transactions){
    (transactions[mk]||[]).forEach(t=>{
      if(t.date>=start&&t.date<=end){
        const p=persons.find(p=>p.id===t.personId);
        const l=labels.find(l=>l.id===t.labelId);
        filtered.push({Date:t.date,Personne:p?p.name:t.personId,Montant:t.amount,Projet:t.projet||'',Description:t.description||'',Libell√©:l?l.name:t.labelId,Code:t.code,Justifi√©:t.justified?'Oui':'Non'});
      }
    });
  }
  filtered.sort((a,b)=>new Date(a.Date)-new Date(b.Date));
  if(filtered.length===0){alert('‚ùå Aucune d√©pense trouv√©e dans cette p√©riode');return}
  generateExcelFile(filtered,`D√©penses_${start}_au_${end}`);
  closeModal('exportByDateModal');
}
function exportToExcelByMonth(){
  const month=parseInt(document.getElementById('exportMonthSelect').value);
  const year=parseInt(document.getElementById('exportYearInput').value);
  const mk=`${year}-${pad(month+1)}`;
  const mt=transactions[mk]||[];
  if(mt.length===0){alert('‚ùå Aucune d√©pense trouv√©e pour ce mois');return}
  const data=mt.map(t=>{
    const p=persons.find(p=>p.id===t.personId);
    const l=labels.find(l=>l.id===t.labelId);
    return{Date:t.date,Personne:p?p.name:t.personId,Montant:t.amount,Projet:t.projet||'',Description:t.description||'',Libell√©:l?l.name:t.labelId,Code:t.code,Justifi√©:t.justified?'Oui':'Non'};
  });
  generateExcelFile(data,`D√©penses_${MONTHS[month]}_${year}`);
  closeModal('exportByMonthModal');
}
function generateExcelFile(data,filename){
  const totalAmount=data.reduce((s,r)=>s+parseFloat(r.Montant||0),0);
  const justifiedAmount=data.filter(r=>r.Justifi√©==='Oui').reduce((s,r)=>s+parseFloat(r.Montant||0),0);
  const notJustifiedAmount=data.filter(r=>r.Justifi√©==='Non').reduce((s,r)=>s+parseFloat(r.Montant||0),0);
  const jc=data.filter(r=>r.Justifi√©==='Oui').length;
  const njc=data.filter(r=>r.Justifi√©==='Non').length;
  let html=`<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="utf-8"><style>table{border-collapse:collapse;width:100%}th{background-color:#0F172A;color:white;font-weight:bold;padding:10px;border:1px solid #ddd;text-align:left}td{padding:8px;border:1px solid #ddd}.justified{background-color:#ECFDF5}.not-justified{background-color:#FEF3C7}.summary{background-color:#E0E7FF;font-weight:bold}.summary-header{background-color:#4F46E5;color:white}</style></head><body>
  <h2>Rapport des D√©penses - ${filename}</h2><p>Date d'export : ${new Date().toLocaleString('fr-FR')}</p><p>Utilisateur : ${users[currentUser].fullName}</p><br>
  <table><thead><tr><th>Date</th><th>Personne</th><th>Montant (DA)</th><th>Projet</th><th>Description</th><th>Libell√©</th><th>Code</th><th>Justifi√©</th></tr></thead><tbody>`;
  data.forEach(row=>{
    const cls=row.Justifi√©==='Oui'?'justified':'not-justified';
    html+=`<tr class="${cls}"><td>${row.Date}</td><td>${row.Personne}</td><td style="text-align:right">${fmt(parseFloat(row.Montant))}</td><td>${row.Projet||''}</td><td>${row.Description||''}</td><td>${row.Libell√©}</td><td>${row.Code}</td><td style="text-align:center">${row.Justifi√©}</td></tr>`;
  });
  html+=`</tbody></table><br><br><table><thead><tr><th colspan="2" class="summary-header">R√âSUM√â</th></tr></thead><tbody>
  <tr class="summary"><td><strong>Total des d√©penses</strong></td><td style="text-align:right">${data.length}</td></tr>
  <tr class="summary"><td><strong>Montant total</strong></td><td style="text-align:right">${fmt(totalAmount)} DA</td></tr>
  <tr style="background-color:#ECFDF5"><td><strong>D√©penses justifi√©es</strong></td><td style="text-align:right">${jc} (${fmt(justifiedAmount)} DA)</td></tr>
  <tr style="background-color:#FEF3C7"><td><strong>D√©penses non justifi√©es</strong></td><td style="text-align:right">${njc} (${fmt(notJustifiedAmount)} DA)</td></tr>
  </tbody></table></body></html>`;
  const blob=new Blob(['\ufeff'+html],{type:'application/vnd.ms-excel;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const link=document.createElement('a');
  link.href=url;link.download=filename+'.xls';
  document.body.appendChild(link);link.click();document.body.removeChild(link);URL.revokeObjectURL(url);
  alert(`‚úÖ Export Excel r√©ussi !\n\n${data.length} d√©pense(s)\nMontant total : ${fmt(totalAmount)} DA\nJustifi√©es : ${jc} (${fmt(justifiedAmount)} DA)\nNon justifi√©es : ${njc} (${fmt(notJustifiedAmount)} DA)`);
}

function showNotification(message){
  let n=document.getElementById('appNotification');
  if(!n){
    n=document.createElement('div');n.id='appNotification';
    n.style.cssText='position:fixed;top:80px;left:50%;transform:translateX(-50%);background:#10B981;color:white;padding:16px 28px;border-radius:12px;font-weight:700;font-size:14px;box-shadow:0 8px 32px rgba(16,185,129,.4);z-index:9999;text-align:center;max-width:600px;transition:opacity .5s ease';
    document.body.appendChild(n);
  }
  n.textContent=message;n.style.opacity='1';n.style.display='block';
  clearTimeout(n._t);
  n._t=setTimeout(()=>{n.style.opacity='0';setTimeout(()=>{n.style.display='none'},500)},4000);
}

document.addEventListener('DOMContentLoaded',()=>{
  ['expenseDate','expensePerson','expenseAmount'].forEach(id=>{
    const el=document.getElementById(id);
    if(el){
      el.addEventListener('input',function(){this.classList.remove('field-error')});
      el.addEventListener('change',function(){this.classList.remove('field-error')});
    }
  });
  const yi=document.getElementById('resetYearSelect');
  const mi=document.getElementById('resetMonthSelect');
  if(yi)yi.value=new Date().getFullYear();
  if(mi)mi.value=new Date().getMonth();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODES DE SYNCHRONISATION : local | both | cloud
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getSyncMode(){ return localStorage.getItem('syncMode')||'both'; }

function setSyncMode(mode){
  const prev = getSyncMode();
  if(mode === prev){ updateSyncModeUI(); return; }

  const labels = { local:'üíæ 100% Local', both:'üîÑ Local + Supabase', cloud:'‚òÅÔ∏è 100% Supabase' };
  const descs  = {
    local : '‚ö†Ô∏è Mode LOCAL activ√©. Les donn√©es ne seront plus envoy√©es ni lues depuis Supabase.',
    both  : '‚úÖ Mode LOCAL + SUPABASE activ√©. Vos donn√©es sont sauvegard√©es partout.',
    cloud : '‚òÅÔ∏è Mode 100% SUPABASE activ√©. Une connexion internet est requise pour acc√©der √† vos donn√©es.'
  };

  if(!confirm(`Changer le mode de synchronisation ?\n\nNouveau mode : ${labels[mode]}\n\n${descs[mode]}`)){
    // Annuler ‚Äî remettre l'ancien mode coch√©
    updateSyncModeUI(); return;
  }

  localStorage.setItem('syncMode', mode);
  updateSyncModeUI();

  // Actions selon le mode choisi
  if(mode === 'local'){
    // D√©sactiver l'auto-sync Supabase si actif
    if(window._supabaseModule && typeof window._supabaseModule.autoSync === 'function'){
      // stopper l'interval si en cours (g√©r√© dans le module)
    }
    showNotification('üíæ Mode 100% Local activ√© ‚Äî Supabase d√©sactiv√©');
  } else if(mode === 'both'){
    showNotification('üîÑ Mode Local + Supabase activ√©');
    // Push imm√©diat pour synchroniser
    const sb = window._getSupabaseClient && window._getSupabaseClient();
    if(sb && navigator.onLine && window.currentUser){
      setTimeout(()=>{ if(window.supabasePush) window.supabasePush(); }, 500);
    }
  } else if(mode === 'cloud'){
    showNotification('‚òÅÔ∏è Mode 100% Supabase activ√© ‚Äî Pull depuis le cloud...');
    const sb = window._getSupabaseClient && window._getSupabaseClient();
    if(sb && navigator.onLine && window.currentUser){
      setTimeout(()=>{ if(window.supabasePull) window.supabasePull(); }, 500);
    } else if(!navigator.onLine){
      showNotification('üì∂ Hors-ligne ! Mode cloud impossible sans connexion internet.');
    }
  }
}

function updateSyncModeUI(){
  const mode = getSyncMode();
  // Cocher le bon radio
  const radio = document.querySelector(`input[name="syncMode"][value="${mode}"]`);
  if(radio) radio.checked = true;

  // Styles des 3 cartes
  const styles = {
    local : { border:'2px solid #94A3B8', bg:'#F8FAFC' },
    both  : { border:'2px solid #F59E0B', bg:'#FFFBEB' },
    cloud : { border:'2px solid #3ECF8E', bg:'#F0FDF4' }
  };
  ['local','both','cloud'].forEach(m => {
    const lbl = document.getElementById(`syncModeLabel_${m}`);
    if(!lbl) return;
    const s = styles[m];
    if(m === mode){
      lbl.style.border = s.border;
      lbl.style.background = s.bg;
      lbl.style.boxShadow = '0 2px 8px rgba(0,0,0,.08)';
    } else {
      lbl.style.border = '2px solid var(--border)';
      lbl.style.background = 'white';
      lbl.style.boxShadow = 'none';
    }
  });

  // Afficher le statut
  const statusEl = document.getElementById('syncModeStatus');
  if(!statusEl) return;
  const info = {
    local : { bg:'#F1F5F9', color:'#475569', icon:'üíæ', txt:'Mode actuel : 100% Local ‚Äî Donn√©es stock√©es uniquement sur cet appareil.' },
    both  : { bg:'#FFFBEB', color:'#92400E', icon:'üîÑ', txt:'Mode actuel : Local + Supabase ‚Äî Sauvegarde locale ET cloud activ√©e.' },
    cloud : { bg:'#F0FDF4', color:'#065F46', icon:'‚òÅÔ∏è', txt:'Mode actuel : 100% Supabase ‚Äî Lecture/√©criture directement depuis le cloud.' }
  };
  const i = info[mode];
  statusEl.style.display  = 'block';
  statusEl.style.background = i.bg;
  statusEl.style.color    = i.color;
  statusEl.innerHTML      = `${i.icon} ${i.txt}`;
}

// Intercepter saveUserData selon le mode
const _origSaveUserData = saveUserData;
window.saveUserData = function(){
  const mode = getSyncMode();
  // Toujours sauvegarder localement (sauf cloud pur ‚Äî mais on garde quand m√™me pour offline)
  _origSaveUserData();
  // En mode "both" : push auto vers Supabase apr√®s chaque sauvegarde
  if(mode === 'both'){
    const sb = window._getSupabaseClient && window._getSupabaseClient();
    if(sb && navigator.onLine && window.currentUser){
      // Push silencieux sans alert (on utilise pushSB en version silencieuse)
      _silentPush();
    }
  }
  // En mode "cloud" : idem push
  if(mode === 'cloud'){
    const sb = window._getSupabaseClient && window._getSupabaseClient();
    if(sb && navigator.onLine && window.currentUser){
      _silentPush();
    }
  }
};

// Initialiser l'UI du mode au chargement de la page settings
document.addEventListener('DOMContentLoaded',()=>{
  setTimeout(updateSyncModeUI, 300);
});

function selectAutoSaveFolder(){
  if(!('showDirectoryPicker' in window)){
    alert('‚ö†Ô∏è Cette fonctionnalit√© n√©cessite Chrome ou Edge.');
    return;
  }
  window._fsAutoSave.requestFolder().then(ok=>{
    window._fsAutoSave.updateUI();
  });
}

function changeAutoSaveFolder(){
  if(!('showDirectoryPicker' in window)){
    alert('‚ö†Ô∏è Cette fonctionnalit√© n√©cessite Chrome ou Edge.');
    return;
  }
  if(!confirm('Voulez-vous changer le dossier de sauvegarde ?\n\nLes donn√©es existantes dans l\'ancien dossier ne seront pas d√©plac√©es.')) return;
  window._fsAutoSave.changeFolder().then(ok=>{
    window._fsAutoSave.updateUI();
  });
}

function updateAutoSaveSettingsStatus(){
  if(window._fsAutoSave) window._fsAutoSave.updateUI();
}

function manualSaveToFolder(){
  if(!window._fsAutoSave){showNotification('‚ùå Module auto-save non disponible');return;}
  if(!window._fsAutoSave.isReady()){
    window._fsAutoSave.requestFolder().then(ok=>{
      if(ok){ window._fsAutoSave.writeNow().then(()=>{ showNotification('‚úÖ Sauvegarde effectu√©e !'); window._fsAutoSave.updateUI(); }); }
    });
    return;
  }
  window._fsAutoSave.writeNow().then(ok=>{
    const folder = window._fsAutoSave.getFolderName() || '?';
    if(ok) showNotification('‚úÖ Sauvegard√© dans "' + folder + '"');
    else showNotification('‚ùå Erreur ‚Äî v√©rifiez les permissions du dossier');
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  IMPORT AUTOMATIQUE DEPUIS LE DOSSIER DE SAUVEGARDE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startImportFromFolder(){
  if(!('showDirectoryPicker' in window)){
    alert('‚ö†Ô∏è Cette fonctionnalit√© n√©cessite Chrome ou Edge.\n\nVotre navigateur actuel ne supporte pas l\'API File System Access.');
    return;
  }
  const infoEl = document.getElementById('importSaveInfo');
  if(infoEl){ infoEl.style.display='block'; infoEl.textContent='üîÑ S√©lection du dossier en cours...'; infoEl.style.background='#DBEAFE'; infoEl.style.color='#1E40AF'; infoEl.style.borderColor='#93C5FD'; }

  window._fsAutoSave.importAndApply(function(data){
    if(!data){
      if(infoEl){ infoEl.textContent='üìÇ Dossier s√©lectionn√© ‚Äî Aucune sauvegarde trouv√©e. La sauvegarde automatique est ACTIVE pour les nouvelles saisies.'; infoEl.style.background='#FEF3C7'; infoEl.style.color='#92400E'; infoEl.style.borderColor='#FCD34D'; }
      return;
    }
    // Charger les donn√©es import√©es
    const importedUsers = data.users || {};
    const nbUsers = Object.keys(importedUsers).length;
    if(nbUsers === 0){
      if(infoEl){ infoEl.textContent='‚ö†Ô∏è Fichier trouv√© mais aucun utilisateur dedans.'; infoEl.style.background='#FEE2E2'; infoEl.style.color='#991B1B'; infoEl.style.borderColor='#FCA5A5'; }
      return;
    }
    // Fusionner avec les users locaux (les donn√©es import√©es ont priorit√©)
    Object.assign(users, importedUsers);
    localStorage.setItem('appUsers', JSON.stringify(users));
    populateLoginSelect();
    const savedAt = data.savedAt ? new Date(data.savedAt).toLocaleString('fr-FR') : 'inconnue';
    if(infoEl){
      infoEl.textContent = `‚úÖ Sauvegarde charg√©e ! ${nbUsers} compte(s) restaur√©(s). Date : ${savedAt}. La sauvegarde automatique est ACTIVE.`;
      infoEl.style.background = '#D1FAE5'; infoEl.style.color = '#065F46'; infoEl.style.borderColor = '#6EE7B7';
    }
    // Remplir automatiquement le champ username si un seul compte
    if(nbUsers === 1){
      const uname = Object.keys(importedUsers)[0];
      const el = document.getElementById('loginUsername');
      if(el) el.value = uname;
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DIAGNOSTIC SUPABASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function _diagLog(msg, el){
  el.textContent += msg + '\n';
  el.scrollTop = el.scrollHeight;
}
function clearDiagResult(){
  const el=document.getElementById('diagResult');
  if(el){el.style.display='none';el.textContent='';}
}
async function testSingleTable(table){
  const el=document.getElementById('diagResult');
  if(!el)return;
  el.style.display='block';el.style.background='#EFF6FF';el.style.color='#1E40AF';
  el.textContent='';
  _diagLog('üîå Test connexion Supabase...', el);
  const sb=window._getSupabaseClient&&window._getSupabaseClient();
  if(!sb){_diagLog('‚ùå Supabase non connect√©. Configurez d\'abord vos identifiants.', el);return;}
  if(!navigator.onLine){_diagLog('‚ùå Pas de connexion internet d√©tect√©e.', el);return;}
  try{
    const start=Date.now();
    const { data, error } = await Promise.race([
      sb.from(table).select('*').limit(1),
      new Promise((_,rej)=>setTimeout(()=>rej(new Error('Timeout 10s')),10000))
    ]);
    const ms=Date.now()-start;
    if(error && error.code!=='PGRST116') throw new Error(error.message);
    _diagLog(`‚úÖ Connexion OK ‚Äî Table "${table}" accessible (${ms}ms)`, el);
    el.style.background='#ECFDF5';el.style.color='#065F46';
  }catch(e){
    el.style.background='#FEE2E2';el.style.color='#991B1B';
    _diagLog(`‚ùå Erreur : ${e.message}`, el);
    if(e.message.includes('fetch')){
      _diagLog('\n‚ö†Ô∏è "Failed to fetch" ‚Äî Causes possibles :', el);
      _diagLog('  1. URL Supabase incorrecte ou projet en pause', el);
      _diagLog('  2. R√©seau/pare-feu bloquant cdn.jsdelivr.net ou supabase.co', el);
      _diagLog('  3. Extension navigateur (ad-blocker) bloquant les requ√™tes', el);
      _diagLog('  4. Projet Supabase sur plan gratuit ‚Üí peut s\'endormir apr√®s inactivit√©', el);
      _diagLog('\nüí° Solutions :', el);
      _diagLog('  ‚Ä¢ V√©rifiez l\'URL sur : app.supabase.com ‚Üí Project Settings ‚Üí API', el);
      _diagLog('  ‚Ä¢ D√©sactivez temporairement les extensions navigateur', el);
      _diagLog('  ‚Ä¢ Ouvrez l\'URL du projet dans un onglet pour le "r√©veiller"', el);
    }
  }
}
async function runSupabaseDiag(){
  const el=document.getElementById('diagResult');
  if(!el)return;
  el.style.display='block';el.style.background='#1E293B';el.style.color='#94A3B8';
  el.textContent='';
  _diagLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', el);
  _diagLog('  üî¨ DIAGNOSTIC SUPABASE COMPLET', el);
  _diagLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', el);
  _diagLog(`üìÖ ${new Date().toLocaleString('fr-FR')}`, el);
  _diagLog('', el);

  // 1. R√©seau
  _diagLog('1Ô∏è‚É£  R√âSEAU :', el);
  _diagLog(`   navigator.onLine = ${navigator.onLine}`, el);

  // 2. Config
  const url=localStorage.getItem('sbUrl');
  const key=localStorage.getItem('sbKey');
  _diagLog('', el);
  _diagLog('2Ô∏è‚É£  CONFIGURATION :', el);
  _diagLog(`   URL : ${url ? url.substring(0,40)+'...' : '‚ùå Non configur√©e'}`, el);
  _diagLog(`   Cl√© : ${key ? key.substring(0,20)+'... ('+key.length+' chars)' : '‚ùå Non configur√©e'}`, el);

  const sb=window._getSupabaseClient&&window._getSupabaseClient();
  _diagLog(`   Client Supabase : ${sb ? '‚úÖ Initialis√©' : '‚ùå Non initialis√©'}`, el);

  if(!sb || !url){
    _diagLog('\n‚ùå Impossible de continuer ‚Äî Supabase non configur√©.', el);
    el.style.color='#FCA5A5';return;
  }
  if(!navigator.onLine){
    _diagLog('\n‚ùå Impossible de continuer ‚Äî Pas de connexion internet.', el);
    el.style.color='#FCA5A5';return;
  }

  // 3. Test tables
  _diagLog('', el);
  _diagLog('3Ô∏è‚É£  TEST DES TABLES :', el);
  const tables=['users_data','persons','labels','projets','transactions','cash_in','balances','sync_log'];
  let allOk=true;
  for(const t of tables){
    try{
      const start=Date.now();
      const {error} = await Promise.race([
        sb.from(t).select('*').limit(1),
        new Promise((_,rej)=>setTimeout(()=>rej(new Error('Timeout')),8000))
      ]);
      const ms=Date.now()-start;
      if(error && error.code==='42P01') _diagLog(`   ‚ö†Ô∏è  ${t.padEnd(14)} ‚Üí Table INEXISTANTE (ex√©cutez supabase_schema.sql)`, el);
      else if(error && error.code!=='PGRST116') { _diagLog(`   ‚ùå ${t.padEnd(14)} ‚Üí ${error.message}`, el); allOk=false; }
      else _diagLog(`   ‚úÖ ${t.padEnd(14)} ‚Üí OK (${ms}ms)`, el);
    }catch(e){
      allOk=false;
      _diagLog(`   ‚ùå ${t.padEnd(14)} ‚Üí ${e.message}`, el);
    }
  }

  // 4. R√©sultat
  _diagLog('', el);
  _diagLog('4Ô∏è‚É£  R√âSULTAT :', el);
  if(allOk){
    _diagLog('   ‚úÖ Toutes les tables sont accessibles !', el);
    _diagLog('   üí° Si Pull √©choue quand m√™me, r√©essayez (r√©seau instable)', el);
    el.style.color='#86EFAC';
  } else {
    _diagLog('   ‚ùå Des erreurs ont √©t√© d√©tect√©es.', el);
    _diagLog('   ‚Üí V√©rifiez votre URL Supabase et votre cl√© API.', el);
    _diagLog('   ‚Üí Si "Failed to fetch" : le projet Supabase est peut-√™tre en pause.', el);
    _diagLog('   ‚Üí Ouvrez https://app.supabase.com pour v√©rifier le statut.', el);
    el.style.color='#FCA5A5';
  }
  _diagLog('', el);
  _diagLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', el);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  IMPORTATION EXCEL TIERS ‚Äî Version robuste
//  Colonnes support√©es : DATE / PERSONNE(S) / MONTANT / PROJET(S) / DESCRIPTION / LIBELL√â(S) / CODE
//  Tiers : sans doublons | D√©penses : avec doublons, regroup√©es par onglet (mois)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function(){
  'use strict';

  // Mapping mois fran√ßais ‚Üí num√©ro
  const MOIS_MAP = {
    JANVIER:1, FEVRIER:2, F√âVRIER:2, MARS:3, AVRIL:4, MAI:5, JUIN:6,
    JUILLET:7, AOUT:8, AO√õT:8, SEPTEMBRE:9, OCTOBRE:10, NOVEMBRE:11,
    DECEMBRE:12, D√âCEMBRE:12
  };

  let _wb = null;          // Workbook XLSX charg√©
  let _phase = 'idle';    // 'idle' | 'loaded' | 'done'

  // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function _showResult(html, bg, col){
    const el = document.getElementById('excelImportResult');
    if(!el) return;
    el.innerHTML = html;
    el.style.cssText = `display:block;margin-bottom:12px;padding:14px 16px;border-radius:10px;font-size:13px;font-weight:600;line-height:1.9;background:${bg};color:${col};border:1.5px solid ${col}55`;
  }

  function _normalizeHeader(raw){
    if(raw == null) return '';
    return String(raw).replace(/\t/g,'').trim().toUpperCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,''); // enl√®ve accents
  }

  // Convertit une valeur de cellule XLSX en date JS
  function _toDate(v){
    if(!v) return null;
    if(v instanceof Date) return isNaN(v) ? null : v;
    if(typeof v === 'number'){
      // S√©riel Excel (base 1900, avec bug leap-year)
      const d = new Date(Math.round((v - 25569) * 86400 * 1000));
      return isNaN(d) ? null : d;
    }
    if(typeof v === 'string'){
      const d = new Date(v);
      return isNaN(d) ? null : d;
    }
    return null;
  }

  // Formate une date JS en YYYY-MM-DD
  function _fmtDate(d){
    return d.getFullYear() + '-' +
      String(d.getMonth()+1).padStart(2,'0') + '-' +
      String(d.getDate()).padStart(2,'0');
  }

  // Extrait {month, year} depuis un nom d'onglet (ex: "DECEMBRE 2025")
  function _sheetMonthYear(name){
    const parts = name.trim().toUpperCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'').split(/\s+/);
    let month = null, year = null;
    for(const p of parts){
      if(MOIS_MAP[p]) month = MOIS_MAP[p];
      const n = parseInt(p,10);
      if(!isNaN(n) && n > 2000 && n < 2100) year = n;
    }
    return (month && year) ? {month, year} : null;
  }

  // D√©tecte les index de colonnes depuis la ligne d'en-t√™te
  function _detectCols(ws){
    const ref = ws['!ref'];
    if(!ref) return {};
    const range = XLSX.utils.decode_range(ref);
    const cols = {};
    for(let c = range.s.c; c <= range.e.c; c++){
      const addr = XLSX.utils.encode_cell({r: range.s.r, c});
      const cell = ws[addr];
      if(!cell) continue;
      const h = _normalizeHeader(cell.v);
      if(h === 'DATE')                                    cols.date    = c;
      else if(h === 'PERSONNE' || h === 'PERSONNES')     cols.person  = c;
      else if(h === 'MONTANT')                            cols.amount  = c;
      else if(h === 'PROJET'   || h === 'PROJETS')       cols.projet  = c;
      else if(h === 'DESCRIPTION')                        cols.desc    = c;
      else if(h === 'LIBELLE'  || h === 'LIBELLES'  ||
              h === 'LIBELLE'  || h === 'LIBELLES')      cols.libelle = c;
      else if(h === 'CODE')                               cols.code    = c;
    }
    return cols;
  }

  // V√©rifie qu'une feuille contient au moins une colonne DATE + des donn√©es
  function _isTransactionSheet(ws){
    const ref = ws['!ref'];
    if(!ref) return false;
    const range = XLSX.utils.decode_range(ref);
    if(range.e.r < 1) return false; // besoin d'au moins 1 ligne de donn√©es
    for(let c = range.s.c; c <= Math.min(range.e.c, 15); c++){
      const addr = XLSX.utils.encode_cell({r: range.s.r, c});
      const cell = ws[addr];
      if(cell && _normalizeHeader(cell.v) === 'DATE') return true;
    }
    return false;
  }

  // Valeur brute d'une cellule
  function _cellVal(ws, r, c){
    if(c === undefined || c === null) return null;
    const addr = XLSX.utils.encode_cell({r, c});
    const cell = ws[addr];
    return cell ? cell.v : null;
  }

  // ‚îÄ‚îÄ Phase 1 : chargement du fichier ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function _loadFile(file){
    _showResult('üîÑ Lecture du fichier Excel en cours...', '#DBEAFE', '#1E40AF');
    const reader = new FileReader();
    reader.onerror = () => _showResult('‚ùå Impossible de lire le fichier.', '#FEE2E2', '#991B1B');
    reader.onload  = function(ev){
      try{
        const data = new Uint8Array(ev.target.result);
        // NE PAS utiliser cellDates:true ‚Üí les dates arrivent comme s√©riels num√©riques
        // _toDate() g√®re les s√©riels ET les Date objects ‚Üí plus fiable
        _wb = XLSX.read(data, {type:'array'});

        const txSheets = [], skipped = [];
        for(const sname of _wb.SheetNames){
          const ws = _wb.Sheets[sname];
          if(_isTransactionSheet(ws)){
            const my = _sheetMonthYear(sname);
            txSheets.push({name: sname, my});
          } else {
            skipped.push(sname);
          }
        }

        if(txSheets.length === 0){
          _showResult('‚ùå Aucune feuille de transactions d√©tect√©e (colonne DATE introuvable).\nFeuilles trouv√©es : ' + _wb.SheetNames.join(', '), '#FEE2E2', '#991B1B');
          return;
        }

        // Construire la liste de feuilles √† cocher
        const listEl = document.getElementById('excelSheetsList');
        listEl.innerHTML = '';
        txSheets.forEach(sh => {
          const lbl = document.createElement('label');
          const tag = sh.my ? `‚Üí ${String(sh.my.month).padStart(2,'0')}/${sh.my.year}` : '‚Üí dates depuis donn√©es';
          lbl.style.cssText = 'display:flex;align-items:center;gap:8px;cursor:pointer;background:#F0FDF4;border:2px solid #86EFAC;border-radius:8px;padding:8px 14px;font-weight:600;font-size:13px;white-space:nowrap';
          const chk = document.createElement('input');
          chk.type = 'checkbox';
          chk.className = 'xl-sheet-chk';
          chk.dataset.sheet = sh.name;
          chk.checked = true;
          chk.style.cssText = 'width:16px;height:16px;accent-color:#10B981;flex-shrink:0';
          lbl.appendChild(chk);
          lbl.insertAdjacentHTML('beforeend', `<span>üìÑ ${sh.name}</span><span style="font-size:11px;color:#64748B;font-weight:400">${tag}</span>`);
          listEl.appendChild(lbl);
        });
        if(skipped.length){
          const info = document.createElement('div');
          info.style.cssText = 'font-size:11px;color:#64748B;margin-top:8px;padding:6px 10px;background:#F8FAFC;border-radius:6px;width:100%';
          info.textContent = 'Ignor√©es (sans colonne DATE) : ' + skipped.join(', ');
          listEl.appendChild(info);
        }

        document.getElementById('excelSheetsOptions').style.display = 'block';
        _phase = 'loaded';

        // Changer le bouton en mode "LANCER" en mettant √† jour son innerHTML et son handler
        const btn = document.getElementById('excelImportBtn');
        btn.innerHTML = '<span>üöÄ</span><span>LANCER L\'IMPORTATION</span>';
        btn.style.background = 'linear-gradient(135deg,#F59E0B 0%,#D97706 100%)';
        // Remplacer le handler en clonant le bouton (supprime tous les anciens listeners)
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        newBtn.addEventListener('click', _runImport);

        _showResult(
          `‚úÖ <strong>Fichier charg√©</strong> ‚Äî ${_wb.SheetNames.length} onglet(s) dont <strong>${txSheets.length}</strong> feuille(s) de transactions d√©tect√©e(s).<br>` +
          `S√©lectionnez les feuilles √† importer puis cliquez <strong>"LANCER L'IMPORTATION"</strong>.`,
          '#D1FAE5', '#065F46'
        );
      } catch(err){
        _showResult('‚ùå Erreur lecture Excel : ' + err.message, '#FEE2E2', '#991B1B');
        console.error('Excel import error:', err);
      }
    };
    reader.readAsArrayBuffer(file);
  }

  // ‚îÄ‚îÄ Phase 2 : traitement et import ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function _runImport(){
    if(!_wb){
      _showResult('‚ùå Aucun fichier charg√©. Cliquez d\'abord sur "IMPORTATION EXCEL TIERS".', '#FEE2E2', '#991B1B');
      return;
    }
    if(typeof currentUser === 'undefined' || !currentUser){
      _showResult('‚ùå Vous devez √™tre connect√© pour importer des donn√©es.', '#FEE2E2', '#991B1B');
      return;
    }

    const doDepenses  = document.getElementById('importChk_depenses').checked;
    const doPersonnes = document.getElementById('importChk_personnes').checked;
    const doLibelles  = document.getElementById('importChk_libelles').checked;
    const doProjets   = document.getElementById('importChk_projets').checked;
    const doCodes     = document.getElementById('importChk_codes').checked;
    const avecDoublons = document.getElementById('importMode_avec').checked; // true=avec, false=sans

    const selectedSheets = [];
    document.querySelectorAll('.xl-sheet-chk:checked').forEach(chk => {
      selectedSheets.push(chk.dataset.sheet);
    });
    if(!selectedSheets.length){
      _showResult('‚ùå Aucune feuille s√©lectionn√©e.', '#FEE2E2', '#991B1B');
      return;
    }

    _showResult('‚è≥ Import en cours...', '#FEF3C7', '#92400E');

    // L√©g√®re pause pour que l'UI se mette √† jour avant le traitement synchrone
    setTimeout(function(){
      const stats = {pAdd:0, pSkip:0, lAdd:0, lSkip:0, prAdd:0, prSkip:0, txAdd:0, months: new Set()};

      for(const sheetName of selectedSheets){
        const ws  = _wb.Sheets[sheetName];
        if(!ws) continue;
        const cols = _detectCols(ws);

        // V√©rifier colonnes minimales
        if(cols.date === undefined){
          console.warn('Feuille "' + sheetName + '" : colonne DATE introuvable, ignor√©e.');
          continue;
        }
        if(cols.amount === undefined){
          console.warn('Feuille "' + sheetName + '" : colonne MONTANT introuvable, ignor√©e.');
          continue;
        }

        const my  = _sheetMonthYear(sheetName);
        const ref = ws['!ref'];
        if(!ref) continue;
        const range = XLSX.utils.decode_range(ref);
        const startRow = range.s.r + 1; // sauter la ligne d'en-t√™te

        for(let r = startRow; r <= range.e.r; r++){
          const rawDate   = _cellVal(ws, r, cols.date);
          const rawAmount = _cellVal(ws, r, cols.amount);
          const rawPerson = _cellVal(ws, r, cols.person);

          // Ignorer lignes vides
          if(rawDate == null && rawAmount == null && rawPerson == null) continue;

          const dateObj = _toDate(rawDate);
          if(!dateObj) continue;

          // D√©terminer le month_key
          let mkYear  = dateObj.getFullYear();
          let mkMonth = dateObj.getMonth() + 1;
          if(my){ mkYear = my.year; mkMonth = my.month; }
          const monthKey = mkYear + '-' + String(mkMonth).padStart(2,'0');
          const dateStr  = _fmtDate(dateObj);

          // Valeurs texte
          const personStr  = rawPerson != null ? String(rawPerson).trim() : '';
          const projetStr  = cols.projet  !== undefined ? ((_cellVal(ws,r,cols.projet)  != null) ? String(_cellVal(ws,r,cols.projet)).trim()  : '') : '';
          const libelleStr = cols.libelle !== undefined ? ((_cellVal(ws,r,cols.libelle) != null) ? String(_cellVal(ws,r,cols.libelle)).trim() : '') : '';
          const descStr    = cols.desc    !== undefined ? ((_cellVal(ws,r,cols.desc)    != null) ? String(_cellVal(ws,r,cols.desc)).trim()    : '') : '';
          const rawCode    = cols.code    !== undefined ? _cellVal(ws,r,cols.code) : null;
          const codeStr    = rawCode != null ? String(typeof rawCode === 'number' ? Math.round(rawCode) : rawCode).trim() : '';

          // Montant
          let amount = 0;
          if(typeof rawAmount === 'number') amount = rawAmount;
          else if(rawAmount != null){
            amount = parseFloat(String(rawAmount).replace(/\s/g,'').replace(',','.'));
          }
          if(isNaN(amount) || amount <= 0) continue;

          // ‚îÄ‚îÄ Personnes ‚îÄ‚îÄ
          if(doPersonnes && personStr){
            const existsP = avecDoublons ? false : persons.find(p => p.name.toLowerCase() === personStr.toLowerCase());
            if(!existsP){
              persons.push({id:'P'+String(persons.length+1).padStart(3,'0'), name: personStr});
              stats.pAdd++;
            } else { stats.pSkip++; }
          }

          // ‚îÄ‚îÄ Libell√©s ‚îÄ‚îÄ
          if(libelleStr && doLibelles){
            const existsL = avecDoublons ? false :
              labels.find(l => l.name.toLowerCase() === libelleStr.toLowerCase() && l.code === codeStr);
            if(!existsL){
              labels.push({id:'L'+String(labels.length+1).padStart(3,'0'), code: codeStr, name: libelleStr, description: libelleStr});
              stats.lAdd++;
            } else { stats.lSkip++; }
          }

          // ‚îÄ‚îÄ Projets ‚îÄ‚îÄ
          if(doProjets && projetStr){
            const existsPr = avecDoublons ? false : projets.find(p => p.name.toLowerCase() === projetStr.toLowerCase());
            if(!existsPr){
              projets.push({id:'PJ'+String(projets.length+1).padStart(3,'0'), name: projetStr, code:'', description:''});
              stats.prAdd++;
            } else { stats.prSkip++; }
          }

          // ‚îÄ‚îÄ D√©penses ‚Äî toujours avec doublons ‚îÄ‚îÄ
          if(doDepenses){
            if(!transactions[monthKey]) transactions[monthKey] = [];
            const pObj = persons.find(p => p.name.toLowerCase() === personStr.toLowerCase());
            const lObj = labels.find(l => l.name.toLowerCase() === libelleStr.toLowerCase() && l.code === codeStr) ||
                         labels.find(l => l.name.toLowerCase() === libelleStr.toLowerCase());
            const importJustifiedSel = document.getElementById('importJustifiedChk');
            const importJustifiedValue = importJustifiedSel ? importJustifiedSel.checked : true;
            const importedId = generateExpenseId(importJustifiedValue, dateStr);
            transactions[monthKey].push({
              date:        dateStr,
              personId:    pObj ? pObj.id : '',
              labelId:     lObj ? lObj.id : '',
              code:        lObj ? lObj.code : codeStr,
              description: descStr || libelleStr,
              projet:      projetStr,
              amount:      amount,
              justified:   importJustifiedValue,
              expenseId:   importedId
            });
            stats.txAdd++;
            stats.months.add(monthKey);
          }
        }
      }

      // Sauvegarder
      saveUserData();
      updatePersonsList();  updatePersonSelects();
      updateLabelsList();   updateLabelSelects();
      updateProjetsList();  updateProjetSelects();
      renderTransactions();

      // Rapport final
      const MONTHS_APP = ['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
      const moisList = Array.from(stats.months).sort().map(mk => {
        const [y,m] = mk.split('-');
        return MONTHS_APP[parseInt(m,10)-1] + ' ' + y;
      });

      let rapport = '‚úÖ <strong>Importation termin√©e avec succ√®s !</strong><br><br>';
      if(doPersonnes) rapport += `üë• Personnes : <strong>+${stats.pAdd}</strong> ajout√©e(s)${stats.pSkip>0?' ‚Äî '+stats.pSkip+' doublon(s) ignor√©(s)':''}<br>`;
      if(doLibelles)  rapport += `üè∑Ô∏è Libell√©s  : <strong>+${stats.lAdd}</strong> ajout√©(s)${stats.lSkip>0?' ‚Äî '+stats.lSkip+' doublon(s) ignor√©(s)':''}<br>`;
      if(doProjets)   rapport += `üìÅ Projets   : <strong>+${stats.prAdd}</strong> ajout√©(s)${stats.prSkip>0?' ‚Äî '+stats.prSkip+' doublon(s) ignor√©(s)':''}<br>`;
      if(doDepenses)  rapport += `üìä D√©penses  : <strong>+${stats.txAdd}</strong> transaction(s) import√©e(s)<br>`;
      if(moisList.length) rapport += `<br>üìÖ Mois renseign√©s : <strong>${moisList.join(' ¬∑ ')}</strong>`;

      _showResult(rapport, '#D1FAE5', '#065F46');
      if(typeof showNotification === 'function')
        showNotification(`‚úÖ Import Excel : ${stats.txAdd} d√©penses ¬∑ ${stats.pAdd} personnes ¬∑ ${stats.lAdd} libell√©s ¬∑ ${stats.prAdd} projets`);
      if(window._fsAutoSave && window._fsAutoSave.isReady()) window._fsAutoSave.triggerSave();

      _phase = 'done';
    }, 50);
  }

  // ‚îÄ‚îÄ R√©initialisation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  window.resetExcelImport = function(){
    _wb = null;
    _phase = 'idle';
    document.getElementById('excelSheetsOptions').style.display = 'none';
    document.getElementById('excelImportResult').style.display = 'none';
    document.getElementById('excelImportFileInput').value = '';
    // Recr√©er le bouton principal proprement
    const oldBtn = document.getElementById('excelImportBtn');
    if(oldBtn){
      const newBtn = oldBtn.cloneNode(false);
      newBtn.id = 'excelImportBtn';
      newBtn.innerHTML = '<span>üìä</span><span>IMPORTATION EXCEL TIERS</span>';
      newBtn.style.cssText = 'flex:2;padding:13px;font-size:14px;background:linear-gradient(135deg,#10B981 0%,#059669 100%);min-width:200px;font-weight:800;display:inline-flex;align-items:center;gap:8px';
      newBtn.className = 'btn-icon';
      newBtn.addEventListener('click', function(){
        document.getElementById('excelImportFileInput').click();
      });
      oldBtn.parentNode.replaceChild(newBtn, oldBtn);
    }
  };

  // ‚îÄ‚îÄ Initialisation (apr√®s DOMContentLoaded) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  // ‚îÄ‚îÄ Changement statut justification √† l'import ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  window.toggleImportJustified = function(){
    const chk   = document.getElementById('importJustifiedChk');
    const lbl   = document.getElementById('importJustifiedChkLabel');
    if(!chk || !lbl) return;
    const isChecked = chk.checked;  // valeur AVANT toggle (onclick d√©clenche avant)
    const newVal    = !isChecked;
    chk.checked     = newVal;
    if(newVal){
      lbl.style.background  = '#D1FAE5';
      lbl.style.border      = '2px solid #10B981';
      lbl.style.color       = '#065F46';
      lbl.innerHTML         = '<input type="checkbox" id="importJustifiedChk" checked style="width:13px;height:13px;accent-color:#10B981;flex-shrink:0;pointer-events:none"> ‚úÖ Justifi√©es';
    } else {
      lbl.style.background  = '#FEF3C7';
      lbl.style.border      = '2px solid #F59E0B';
      lbl.style.color       = '#92400E';
      lbl.innerHTML         = '<input type="checkbox" id="importJustifiedChk" style="width:13px;height:13px;accent-color:#F59E0B;flex-shrink:0;pointer-events:none"> ‚ùå Non Justifi√©es';
    }
  };
  window.setImportJustifiedFromSelect = function(val){ /* legacy no-op */ };
  window.setImportJustified = function(isJustified){
    const chk = document.getElementById('importJustifiedChk');
    const lbl = document.getElementById('importJustifiedChkLabel');
    if(!chk || !lbl) return;
    chk.checked = isJustified;
    if(isJustified){
      lbl.style.background = '#D1FAE5'; lbl.style.border = '2px solid #10B981'; lbl.style.color = '#065F46';
      lbl.innerHTML = '<input type="checkbox" id="importJustifiedChk" checked style="width:13px;height:13px;accent-color:#10B981;flex-shrink:0;pointer-events:none"> ‚úÖ Justifi√©es';
    } else {
      lbl.style.background = '#FEF3C7'; lbl.style.border = '2px solid #F59E0B'; lbl.style.color = '#92400E';
      lbl.innerHTML = '<input type="checkbox" id="importJustifiedChk" style="width:13px;height:13px;accent-color:#F59E0B;flex-shrink:0;pointer-events:none"> ‚ùå Non Justifi√©es';
    }
  };

  // ‚îÄ‚îÄ Changement de mode doublons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  window.setImportMode = function(mode){
    const isSans = (mode === 'sans');
    // Styles carte SANS
    const lblSans = document.getElementById('modeLabel_sans');
    const lblAvec = document.getElementById('modeLabel_avec');
    if(lblSans){
      lblSans.style.background   = isSans ? '#EFF6FF' : '#F8FAFC';
      lblSans.style.border       = isSans ? '2px solid #3B82F6' : '1.5px solid #CBD5E1';
    }
    if(lblAvec){
      lblAvec.style.background   = !isSans ? '#FFFBEB' : '#F8FAFC';
      lblAvec.style.border       = !isSans ? '2px solid #F59E0B' : '1.5px solid #CBD5E1';
    }
    // Mettre √† jour l'info
    const info = document.getElementById('importModeInfo');
    if(info){
      if(isSans){
        info.style.background = '#EFF6FF';
        info.style.color      = '#1D4ED8';
        info.innerHTML = '‚ÑπÔ∏è <strong>SANS DOUBLONS</strong> ‚Äî Personnes, Libell√©s et Projets existants ignor√©s.';
      } else {
        info.style.background = '#FFFBEB';
        info.style.color      = '#92400E';
        info.innerHTML = '‚ö†Ô∏è <strong>AVEC DOUBLONS</strong> ‚Äî toutes les entr√©es import√©es telles quelles.';
      }
    }
    // Cocher le bon radio
    const radioSans = document.getElementById('importMode_sans');
    const radioAvec = document.getElementById('importMode_avec');
    if(radioSans) radioSans.checked = isSans;
    if(radioAvec) radioAvec.checked = !isSans;
  };

  function _init(){
    const fileInput = document.getElementById('excelImportFileInput');
    const btn       = document.getElementById('excelImportBtn');
    if(!fileInput || !btn) return;

    // Le bouton ouvre le s√©lecteur de fichier
    btn.addEventListener('click', function(){
      if(_phase === 'idle'){
        fileInput.click();
      } else if(_phase === 'loaded'){
        _runImport();
      }
    });

    // Quand un fichier est s√©lectionn√©
    fileInput.addEventListener('change', function(ev){
      const file = ev.target.files[0];
      if(!file) return;
      _phase = 'idle';
      // Reconfigurer le bouton pour la phase de lancement
      btn.innerHTML = '<span>üöÄ</span><span>LANCER L\'IMPORTATION</span>';
      btn.style.background = 'linear-gradient(135deg,#F59E0B 0%,#D97706 100%)';
      _loadFile(file);
      // Ne PAS reset fileInput.value ici ‚Äî le faire apr√®s chargement
    });
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', _init);
  } else {
    _init();
  }

})();
// ‚îÄ‚îÄ Fin module Importation Excel Tiers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FONCTIONS ADMIN ‚Äî R√îLES, GESTION COMPTES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function updateSettingsRoleBadge(){
  const badge = document.getElementById('currentUserRoleBadge');
  const adminCard = document.getElementById('adminUsersCard');
  if(!badge || !currentUser) return;
  const role = (users[currentUser] && users[currentUser].role) || 'standard';
  if(role === 'admin'){
    badge.style.background = '#FEF3C7';
    badge.style.color      = '#92400E';
    badge.style.border     = '1px solid #F59E0B';
    badge.textContent      = 'üõ°Ô∏è ADMINISTRATEUR';
    if(adminCard){ adminCard.style.display='block'; renderAdminUsersList(); }
  } else {
    badge.style.background = '#EFF6FF';
    badge.style.color      = '#1E40AF';
    badge.style.border     = '1px solid #BFDBFE';
    badge.textContent      = 'üë§ STANDARD';
    if(adminCard) adminCard.style.display='none';
  }
}

function renderAdminUsersList(){
  const container = document.getElementById('adminUsersList');
  if(!container) return;
  const standardUsers = Object.keys(users).filter(u => u !== currentUser && (!users[u].role || users[u].role === 'standard'));
  if(standardUsers.length === 0){
    container.innerHTML = '<div style="color:#94A3B8;font-size:11px;padding:4px 2px;font-style:italic">üë§ Aucun compte Standard trouv√©</div>';
    return;
  }
  container.innerHTML = standardUsers.map(u => {
    const info = users[u];
    return `<div style="display:flex;align-items:center;gap:8px;background:white;border:1.5px solid #FCA5A5;border-radius:5px;padding:4px 8px">
      <input type="checkbox" class="adminUserChk" data-user="${u}" style="width:12px;height:12px;accent-color:#DC2626;flex-shrink:0;cursor:pointer">
      <div style="flex:1;min-width:0">
        <span style="font-weight:700;font-size:12px;color:#0F172A">${u}</span>
        <span style="font-size:11px;color:#64748B;margin-left:6px">${info.fullName || ''}${info.email ? ' ¬∑ '+info.email : ''}</span>
      </div>
      <span style="font-size:10px;font-weight:700;background:#EFF6FF;color:#1E40AF;padding:1px 7px;border-radius:20px;white-space:nowrap">STANDARD</span>
    </div>`;
  }).join('');
}

let _adminDeleteTargets = [];

function adminDeleteSelectedUsers(){
  const checks = document.querySelectorAll('.adminUserChk:checked');
  if(checks.length === 0){ alert('‚ùå Veuillez s√©lectionner au moins un compte √† supprimer.'); return; }
  _adminDeleteTargets = Array.from(checks).map(c => c.dataset.user);
  const names = _adminDeleteTargets.join(', ');
  document.getElementById('adminDeleteModalMsg').innerHTML =
    `‚ö†Ô∏è Vous allez supprimer d√©finitivement <strong>${_adminDeleteTargets.length}</strong> compte(s) :<br>
     <strong style="color:#DC2626">${names}</strong><br><br>
     Toutes leurs donn√©es seront effac√©es. Entrez le mot de passe <strong>Administrateur</strong> pour confirmer.`;
  document.getElementById('adminDeletePasswordInput').value = '';
  document.getElementById('adminDeleteError').style.display = 'none';
  openModal('adminDeleteModal');
  setTimeout(()=>document.getElementById('adminDeletePasswordInput').focus(), 150);
}

function confirmAdminDelete(){
  const pw  = document.getElementById('adminDeletePasswordInput').value;
  const err = document.getElementById('adminDeleteError');
  err.style.display = 'none';
  if(!pw){ err.textContent='‚ùå Veuillez entrer le mot de passe administrateur'; err.style.display='block'; return; }
  if(!users[currentUser] || users[currentUser].password !== pw){
    err.textContent = '‚ùå Mot de passe administrateur incorrect';
    err.style.display = 'block';
    document.getElementById('adminDeletePasswordInput').value = '';
    document.getElementById('adminDeletePasswordInput').focus();
    return;
  }
  // Suppression effective
  const deleted = [];
  _adminDeleteTargets.forEach(u => {
    if(users[u] && users[u].role !== 'admin'){
      delete users[u];
      deleted.push(u);
    }
  });
  // Ajouter √† la liste noire AVANT de sauvegarder
  if(deleted.length > 0) _addDeletedUsers(deleted);
  saveUsers();
  // Supprimer depuis Supabase de fa√ßon fiable (await)
  (async function(){
    try{
      const sb = window._getSupabaseClient && window._getSupabaseClient();
      if(sb && navigator.onLine){
        for(const u of deleted){
          await Promise.all([
            sb.from('users_data').delete().eq('username', u),
            sb.from('persons').delete().eq('username', u),
            sb.from('labels').delete().eq('username', u),
            sb.from('projets').delete().eq('username', u),
            sb.from('transactions').delete().eq('username', u),
            sb.from('cash_in').delete().eq('username', u),
            sb.from('balances').delete().eq('username', u),
          ]);
        }
        showNotification('‚òÅÔ∏è Comptes supprim√©s de Supabase : '+deleted.join(', '));
      }
    }catch(e){ console.warn('Supabase delete error:', e); }
  })();
  closeModal('adminDeleteModal');
  _adminDeleteTargets = [];
  renderAdminUsersList();
  if(window._fsAutoSave && window._fsAutoSave.isReady()) window._fsAutoSave.triggerSave();
  (async function(){
    try{ if(typeof pushSB==='function'){ showNotification('üîÑ Sync Supabase...'); await pushSB(); showNotification('‚òÅÔ∏è Supabase synchronis√© ‚Äî comptes supprim√©s'); } }
    catch(e){ console.warn('Sync SB:',e); }
  })();
  showNotification(`üóëÔ∏è ${deleted.length} compte(s) supprim√©(s) : ${deleted.join(', ')}`);
  alert(`‚úÖ Suppression r√©ussie !\n\nüóëÔ∏è Comptes supprim√©s (${deleted.length}) :\n${deleted.map(u=>' ‚Ä¢ '+u).join('\n')}\n\nToutes leurs donn√©es ont √©t√© effac√©es.\n‚òÅÔ∏è Sync Supabase lanc√©e.`);
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONTR√îLE TAILLE POLICE TABLE D√âPENSES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TABLE_FONT_MIN = 9;
const TABLE_FONT_MAX = 22;
const TABLE_FONT_DEFAULT = 14;
let _tableFontSize = parseInt(localStorage.getItem('tableFontSize') || TABLE_FONT_DEFAULT);

function _applyTableFontSize(){
  const table = document.getElementById('expensesTable');
  if(!table) return;
  table.style.fontSize = _tableFontSize + 'px';
  // Aussi ajuster le padding des cellules proportionnellement
  const padV = Math.max(4, Math.round(_tableFontSize * 0.6));
  const padH = Math.max(6, Math.round(_tableFontSize * 0.9));
  table.querySelectorAll('th, td').forEach(cell => {
    cell.style.padding = padV + 'px ' + padH + 'px';
  });
  const disp = document.getElementById('tableFontSizeDisplay');
  if(disp) disp.textContent = _tableFontSize + 'px';
}

function changeTableFontSize(delta){
  _tableFontSize = Math.min(TABLE_FONT_MAX, Math.max(TABLE_FONT_MIN, _tableFontSize + delta));
  localStorage.setItem('tableFontSize', _tableFontSize);
  _applyTableFontSize();
}

function resetTableFontSize(){
  _tableFontSize = TABLE_FONT_DEFAULT;
  localStorage.setItem('tableFontSize', _tableFontSize);
  _applyTableFontSize();
}

// Appliquer apr√®s chaque rendu de la table
const _origRenderTransactions = typeof renderTransactions === 'function' ? renderTransactions : null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TRI JUSTIFI√â ‚Äî Clic sur l'en-t√™te "JUSTIFI√â"
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window._justifiedSort = null; // null | 'asc' | 'desc'

function toggleJustifiedSort(){
  // Cycle : null ‚Üí asc (justifi√©es en premier) ‚Üí desc (non justifi√©es en premier) ‚Üí null
  if(!window._justifiedSort)           window._justifiedSort = 'asc';
  else if(window._justifiedSort==='asc')  window._justifiedSort = 'desc';
  else                                 window._justifiedSort = null;
  renderTransactions();
  // Notification courte
  const labels = { asc:'‚ñ≤ Justifi√©es en premier', desc:'‚ñº Non justifi√©es en premier', null:'Tri annul√©' };
  showNotification('üîÉ ' + (labels[window._justifiedSort] || 'Tri annul√©'));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TRI PAR DATE ‚Äî Clic sur l'en-t√™te "DATE"
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window._dateSort = null; // null | 'asc' | 'desc'

function toggleDateSort(){
  if(!window._dateSort)              window._dateSort = 'desc'; // Plus r√©cent en premier
  else if(window._dateSort==='desc') window._dateSort = 'asc';  // Plus ancien en premier
  else                               window._dateSort = null;   // Tri annul√©
  renderTransactions();
  const labels = { desc:'‚ñº Plus r√©cent en premier', asc:'‚ñ≤ Plus ancien en premier' };
  showNotification('üìÖ ' + (labels[window._dateSort] || 'Tri date annul√©'));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FILTRE PERSONNE ‚Äî Dropdown inject√© dans <body> (hors tableau)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window._personneFilter = '';
window._personneDropdownOpen = false;

function togglePersonneDropdown(event){
  event.stopPropagation();
  if(window._personneDropdownOpen){
    closePersonneDropdown();
  } else {
    openPersonneDropdown(event);
  }
}

function openPersonneDropdown(event){
  // Supprimer un menu existant
  const old = document.getElementById('personneDropdownMenu');
  if(old) old.remove();

  // Calculer position du th
  const th = document.getElementById('personneHeaderTh');
  if(!th) return;
  const rect = th.getBoundingClientRect();

  // Collecter toutes les personnes pr√©sentes dans la vue (sans filtre actif)
  const savedFilter = window._personneFilter;
  window._personneFilter = '';
  let rawList = [];
  try { rawList = (window.getViewTransactions || getViewTransactions)(); } catch(e){}
  window._personneFilter = savedFilter;

  const seen = new Map();
  rawList.forEach(t => {
    if(!seen.has(t.personId)){
      const p = (persons||[]).find(p => p.id === t.personId);
      seen.set(t.personId, p ? p.name : t.personId);
    }
  });
  const entries = [...seen.entries()].sort((a,b) => a[1].localeCompare(b[1]));

  // Cr√©er le menu
  const menu = document.createElement('div');
  menu.id = 'personneDropdownMenu';
  menu.style.cssText = `
    position:fixed;
    top:${rect.bottom}px;
    left:${rect.left}px;
    min-width:${Math.max(rect.width, 220)}px;
    background:white;
    border:2px solid #F59E0B;
    border-radius:0 0 12px 12px;
    z-index:99999;
    box-shadow:0 12px 30px rgba(0,0,0,.25);
    max-height:280px;
    overflow-y:auto;
    font-family:'Manrope',sans-serif;
  `;

  let html = `<div onmousedown="event.preventDefault();filterByPersonne('')" style="padding:9px 14px;font-size:12px;color:#64748B;cursor:pointer;border-bottom:2px solid #E2E8F0;font-weight:700;background:#F8FAFC" onmouseenter="this.style.background='#E2E8F0'" onmouseleave="this.style.background='#F8FAFC'">üë• Toutes les personnes</div>`;

  if(entries.length === 0){
    html += `<div style="padding:12px 14px;font-size:12px;color:#94A3B8;text-align:center">Aucune personne dans cette vue</div>`;
  } else {
    entries.forEach(([id, name]) => {
      const isSelected = savedFilter && name.toLowerCase() === savedFilter;
      const safeName = name.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
      html += `<div onmousedown="event.preventDefault();filterByPersonne('${safeName}')" style="padding:9px 14px;font-size:13px;cursor:pointer;font-weight:700;color:${isSelected?'#92400E':'#0F172A'};background:${isSelected?'#FEF3C7':''};border-bottom:1px solid #F1F5F9" onmouseenter="this.style.background='${isSelected?'#FDE68A':'#EFF6FF'}'" onmouseleave="this.style.background='${isSelected?'#FEF3C7':''}'" >üë§ ${name}</div>`;
    });
  }

  menu.innerHTML = html;
  document.body.appendChild(menu);
  window._personneDropdownOpen = true;

  // Fermer au clic ext√©rieur
  document.removeEventListener('click', _closePersonneOnOutside);
  setTimeout(()=>{ document.addEventListener('click', _closePersonneOnOutside); }, 10);
}

function _closePersonneOnOutside(e){
  const menu = document.getElementById('personneDropdownMenu');
  const th   = document.getElementById('personneHeaderTh');
  if(menu && menu.contains(e.target)) return;
  if(th   && th.contains(e.target))   return;
  closePersonneDropdown();
}

function closePersonneDropdown(){
  const menu = document.getElementById('personneDropdownMenu');
  if(menu) menu.remove();
  window._personneDropdownOpen = false;
  document.removeEventListener('click', _closePersonneOnOutside);
}

function filterByPersonne(val){
  window._personneFilter = (val||'').toLowerCase().trim();
  closePersonneDropdown();
  const banner     = document.getElementById('personneFilterBanner');
  const bannerText = document.getElementById('personneFilterBannerText');
  if(banner){
    if(window._personneFilter){
      banner.style.display = 'flex';
      const p = (persons||[]).find(p=>p.name.toLowerCase()===window._personneFilter);
      if(bannerText) bannerText.textContent = '"' + (p ? p.name : val) + '"';
    } else {
      banner.style.display = 'none';
    }
  }
  renderTransactions();
}

function clearPersonneFilter(){ filterByPersonne(''); }

function populatePersonneSelect(){ /* obsol√®te */ }

// Patch de getViewTransactions pour appliquer le filtre personne ET le tri justifi√©
const _origGetViewTransactions = typeof getViewTransactions === 'function' ? getViewTransactions : null;
(function(){
  const _orig = window.getViewTransactions || (typeof getViewTransactions !== 'undefined' ? getViewTransactions : null);
  if(!_orig) return;
  window.getViewTransactions = function(){
    let list = _orig.apply(this, arguments);
    // Filtre personne
    const f = window._personneFilter;
    if(f){
      list = list.filter(t => {
        const p = persons.find(p => p.id === t.personId);
        const name = p ? p.name.toLowerCase() : (t.personId||'').toLowerCase();
        return name.includes(f);
      });
    }
    // Tri justifi√©
    const js = window._justifiedSort;
    if(js === 'asc'){
      // justifi√©es (true=1) en premier, non justifi√©es (false=0) en dernier
      list = list.slice().sort((a,b) => (b.justified?1:0) - (a.justified?1:0));
    } else if(js === 'desc'){
      // non justifi√©es en premier
      list = list.slice().sort((a,b) => (a.justified?1:0) - (b.justified?1:0));
    }
    // Tri par date
    const ds = window._dateSort;
    if(ds === 'desc'){
      list = list.slice().sort((a,b) => (b.date||'').localeCompare(a.date||''));
    } else if(ds === 'asc'){
      list = list.slice().sort((a,b) => (a.date||'').localeCompare(b.date||''));
    }
    return list;
  };
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODE NUIT / JOUR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleDarkMode(){
  const isDark = document.body.classList.toggle('dark-mode');
  localStorage.setItem('darkMode', isDark ? '1' : '0');
  const btn = document.getElementById('darkModeBtn');
  if(btn) btn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
  showNotification(isDark ? 'üåô Mode Nuit activ√©' : '‚òÄÔ∏è Mode Jour activ√©');
}
function applyDarkModeOnLoad(){
  const saved = localStorage.getItem('darkMode');
  if(saved === '1'){
    document.body.classList.add('dark-mode');
    const btn = document.getElementById('darkModeBtn');
    if(btn) btn.textContent = '‚òÄÔ∏è';
  }
}
document.addEventListener('DOMContentLoaded', applyDarkModeOnLoad);

init();

// Appliquer la taille apr√®s init et apr√®s chaque renderTransactions
document.addEventListener('DOMContentLoaded', function(){
  setTimeout(_applyTableFontSize, 300);
  // Initialiser l'affichage
  const disp = document.getElementById('tableFontSizeDisplay');
  if(disp) disp.textContent = _tableFontSize + 'px';
});

// Patch renderTransactions pour appliquer la taille apr√®s chaque rendu
(function(){
  const _orig = window.renderTransactions;
  if(typeof _orig === 'function'){
    window.renderTransactions = function(){
      _orig.apply(this, arguments);
      setTimeout(_applyTableFontSize, 50);
    };
  }
})();


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODAL √âTAT D√âPENSES NON JUSTIFI√âES PAR PERSONNE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openUnjustifiedPersonModal(personId){
  const p = persons.find(p => p.id === personId);
  const pName = p ? p.name : personId;

  // Collecter toutes les d√©penses non justifi√©es de cette personne
  let rows = [];
  for(const mk in transactions){
    (transactions[mk]||[]).forEach((t,i) => {
      if(t.personId === personId && !t.justified){
        rows.push({ ...t, _mk: mk });
      }
    });
  }
  rows.sort((a,b) => new Date(a.date) - new Date(b.date));

  const total = rows.reduce((s,t) => s+t.amount, 0);
  const nbMois = new Set(rows.map(t=>t._mk)).size;

  document.getElementById('unjustifiedPersonName').textContent = pName;
  document.getElementById('unjustifiedPersonSubtitle').innerHTML =
    `<span style="color:var(--danger);font-weight:800">${rows.length} d√©pense(s) non justifi√©e(s)</span> &nbsp;|&nbsp;
     <span style="color:var(--danger);font-weight:800">${fmt(total)} DA</span> au total &nbsp;|&nbsp;
     ${nbMois} mois concern√©(s)`;

  if(rows.length === 0){
    document.getElementById('unjustifiedPersonContent').innerHTML =
      '<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><div class="empty-state-text">Aucune d√©pense non justifi√©e</div></div>';
    openModal('unjustifiedPersonModal'); return;
  }

  // Grouper par mois
  const byMonth = {};
  rows.forEach(t => {
    if(!byMonth[t._mk]) byMonth[t._mk] = [];
    byMonth[t._mk].push(t);
  });

  let html = '';
  Object.keys(byMonth).sort().reverse().forEach(mk => {
    const [y,m] = mk.split('-');
    const monthName = ['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'][parseInt(m,10)-1];
    const monthTotal = byMonth[mk].reduce((s,t)=>s+t.amount,0);

    html += `<div style="margin-bottom:16px">
      <div style="background:var(--danger);color:white;padding:8px 14px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <span style="font-weight:800;font-size:14px">üìÖ ${monthName} ${y}</span>
        <span style="font-family:'JetBrains Mono',monospace;font-weight:800">${fmt(monthTotal)} DA</span>
      </div>
      <div style="border:1.5px solid #FCA5A5;border-radius:8px;overflow:hidden">
        <table style="width:100%;border-collapse:collapse;font-size:13px">
          <thead><tr style="background:#FEE2E2">
            <th style="padding:7px 10px;text-align:left;font-size:11px;color:#991B1B;font-weight:700">DATE</th>
            <th style="padding:7px 10px;text-align:left;font-size:11px;color:#991B1B;font-weight:700">PROJET</th>
            <th style="padding:7px 10px;text-align:left;font-size:11px;color:#991B1B;font-weight:700">DESCRIPTION</th>
            <th style="padding:7px 10px;text-align:left;font-size:11px;color:#991B1B;font-weight:700">LIBELL√â</th>
            <th style="padding:7px 10px;text-align:left;font-size:11px;color:#991B1B;font-weight:700">CODE</th>
            <th style="padding:7px 10px;text-align:right;font-size:11px;color:#991B1B;font-weight:700">MONTANT</th>
          </tr></thead>
          <tbody>`;

    byMonth[mk].forEach((t,i) => {
      const l = labels.find(l=>l.id===t.labelId);
      const lName = l ? l.name : (t.labelId||'‚Äî');
      const dateStr = new Date(t.date+'T12:00:00').toLocaleDateString('fr-FR');
      const bg = i%2===0 ? '#FFF5F5' : 'white';
      html += `<tr style="background:${bg};border-top:1px solid #FEE2E2">
        <td style="padding:7px 10px;font-family:'JetBrains Mono',monospace;font-size:12px">${dateStr}</td>
        <td style="padding:7px 10px;font-size:12px;color:var(--text-primary);font-weight:600">${t.projet||'‚Äî'}</td>
        <td style="padding:7px 10px;font-size:12px;color:var(--text-secondary)">${t.description||'‚Äî'}</td>
        <td style="padding:7px 10px;font-size:12px;font-weight:600">${lName}</td>
        <td style="padding:7px 10px;font-family:'JetBrains Mono',monospace;font-size:12px">${t.code||'‚Äî'}</td>
        <td style="padding:7px 10px;font-family:'JetBrains Mono',monospace;font-weight:800;color:var(--danger);text-align:right">${fmt(t.amount)} DA</td>
      </tr>`;
    });

    html += `</tbody>
          <tfoot><tr style="background:#FEE2E2;border-top:2px solid #FCA5A5">
            <td colspan="5" style="padding:7px 10px;font-size:12px;font-weight:700;color:#991B1B">Sous-total ${monthName} ${y}</td>
            <td style="padding:7px 10px;font-family:'JetBrains Mono',monospace;font-weight:800;color:var(--danger);text-align:right">${fmt(monthTotal)} DA</td>
          </tr></tfoot>
        </table>
      </div>
    </div>`;
  });

  // Ligne total g√©n√©ral
  html += `<div style="background:#0F172A;color:white;padding:12px 16px;border-radius:10px;display:flex;justify-content:space-between;align-items:center">
    <span style="font-weight:800;font-size:15px">‚ö†Ô∏è TOTAL NON JUSTIFI√â ‚Äî ${pName}</span>
    <span style="font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:800;color:#FCA5A5">${fmt(total)} DA</span>
  </div>`;

  document.getElementById('unjustifiedPersonContent').innerHTML = html;
  openModal('unjustifiedPersonModal');
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  S√âLECTION DE LIGNE D√âPENSE EN BLEU
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selectExpenseRow(row){
  const table = document.getElementById('expensesTable');
  if(!table) return;
  const already = row.classList.contains('selected-row');
  // D√©s√©lectionner toutes les lignes
  table.querySelectorAll('tbody tr.selected-row').forEach(r => r.classList.remove('selected-row'));
  // Si la ligne n'√©tait pas d√©j√† s√©lectionn√©e, la s√©lectionner
  if(!already) row.classList.add('selected-row');
}

window.saveUserData        = saveUserData;
window.updatePersonsList   = updatePersonsList;
window.updateLabelsList    = updateLabelsList;
window.updateProjetsList   = updateProjetsList;
window.updatePersonSelects = updatePersonSelects;
window.updateLabelSelects  = updateLabelSelects;
window.updateProjetSelects = updateProjetSelects;
window.renderTransactions  = renderTransactions;
window.renderCashInTable   = renderCashInTable;
window.showNotification    = showNotification;
window.openModal           = openModal;
window.closeModal          = closeModal;

Object.defineProperty(window,'persons',      {get:()=>persons,      set:v=>{persons=v},      configurable:true});
Object.defineProperty(window,'labels',       {get:()=>labels,       set:v=>{labels=v},       configurable:true});
Object.defineProperty(window,'projets',      {get:()=>projets,      set:v=>{projets=v},      configurable:true});
Object.defineProperty(window,'transactions', {get:()=>transactions, set:v=>{transactions=v}, configurable:true});
Object.defineProperty(window,'cashIn',       {get:()=>cashIn,       set:v=>{cashIn=v},       configurable:true});
Object.defineProperty(window,'balances',     {get:()=>balances,     set:v=>{balances=v},     configurable:true});
Object.defineProperty(window,'users',        {get:()=>users,        set:v=>{users=v},        configurable:true});
Object.defineProperty(window,'currentUser',  {get:()=>currentUser,  set:v=>{currentUser=v},  configurable:true});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODAL √âTAT GLOBAL NON JUSTIFI√â
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window._etatNJFilter = '';

function openEtatNJModal(){
  window._etatNJFilter    = '';
  window._etatNJColFilters= {};
  window._etatNJColSort   = null;

  // Peupler la liste d√©roulante avec les personnes ayant des NJ
  const sel    = document.getElementById('etatNJPersonneSelect');
  const banner = document.getElementById('etatNJFilterBanner');
  if(sel){
    const njPersonIds = new Set();
    Object.values(transactions||{}).forEach(arr=>{
      (arr||[]).forEach(t=>{ if(!t.justified) njPersonIds.add(t.personId); });
    });
    const njPersons = (persons||[])
      .filter(p => njPersonIds.has(p.id))
      .sort((a,b) => a.name.localeCompare(b.name, 'fr'));
    sel.innerHTML = '<option value="">‚Äî Toutes les personnes ‚Äî</option>';
    njPersons.forEach(p=>{
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = p.name;
      sel.appendChild(opt);
    });
    sel.value = '';
  }
  if(banner) banner.style.display = 'none';

  renderEtatNJTable();
  openModal('etatNJModal');
}

// etatNJSelectFilter : appel√© quand l'utilisateur choisit une personne dans la liste d√©roulante
function etatNJSelectFilter(personId){
  window._etatNJFilter = personId; // on stocke l'id (ou '' pour tout)
  const banner     = document.getElementById('etatNJFilterBanner');
  const filterText = document.getElementById('etatNJFilterText');
  if(personId){
    const p = (persons||[]).find(p => p.id === personId);
    const name = p ? p.name : personId;
    if(banner){ banner.style.display = 'flex'; }
    if(filterText){ filterText.textContent = name; }
  } else {
    if(banner) banner.style.display = 'none';
  }
  renderEtatNJTable();
}

function etatNJClearFilter(){
  window._etatNJFilter = '';
  const sel    = document.getElementById('etatNJPersonneSelect');
  const banner = document.getElementById('etatNJFilterBanner');
  if(sel)    sel.value             = '';
  if(banner) banner.style.display = 'none';
  renderEtatNJTable();
}

// Stub pour r√©trocompatibilit√© (l'ancien onclick est supprim√©, mais on garde la fonction)
function etatNJToggleSearch(e){ if(e) e.stopPropagation(); }

function renderEtatNJTable(){
  // Lire la valeur depuis le select (filtrage par personId)
  const sel = document.getElementById('etatNJPersonneSelect');
  const selectedId = sel ? sel.value : '';
  window._etatNJFilter = selectedId;

  // Banner filtre personne
  const banner     = document.getElementById('etatNJFilterBanner');
  const filterText = document.getElementById('etatNJFilterText');
  if(banner){
    banner.style.display = selectedId ? 'flex' : 'none';
    if(filterText && selectedId){
      const p = (persons||[]).find(p => p.id === selectedId);
      filterText.textContent = p ? p.name : selectedId;
    }
  }

  // Collecter TOUTES les d√©penses non justifi√©es de TOUS les mois
  const allNJ = [];
  Object.keys(transactions).forEach(mk => {
    (transactions[mk]||[]).forEach((t, idx) => {
      if(!t.justified) allNJ.push({ ...t, _mk: mk, _realIdx: idx });
    });
  });

  // Filtrer par personne (par id exact depuis le select)
  let filtered = selectedId
    ? allNJ.filter(t => t.personId === selectedId)
    : allNJ;

  // Filtres colonnes actifs
  const cf = window._etatNJColFilters || {};
  const colKeys = ['date','projet','description','libelle','montant'];
  colKeys.forEach(col => {
    const v = (cf[col]||'').toLowerCase().trim();
    if(!v) return;
    filtered = filtered.filter(t => {
      if(col==='date')        return new Date(t.date+'T12:00:00').toLocaleDateString('fr-FR').includes(v);
      if(col==='projet')      return (t.projet||'').toLowerCase().includes(v);
      if(col==='description') return (t.description||'').toLowerCase().includes(v);
      if(col==='libelle')     return ((labels.find(l=>l.id===t.labelId)||{}).name||t.labelId||'').toLowerCase().includes(v);
      if(col==='montant')     return String(t.amount||'').includes(v);
      return true;
    });
  });

  // Tri colonne actif
  const cs = window._etatNJColSort; // { col, dir }
  if(cs && cs.col){
    filtered = filtered.slice().sort((a,b) => {
      let va='',vb='';
      if(cs.col==='date')        { va=a.date;   vb=b.date; }
      else if(cs.col==='projet') { va=(a.projet||'').toLowerCase(); vb=(b.projet||'').toLowerCase(); }
      else if(cs.col==='description'){ va=(a.description||'').toLowerCase(); vb=(b.description||'').toLowerCase(); }
      else if(cs.col==='libelle'){
        va=((labels.find(l=>l.id===a.labelId)||{}).name||'').toLowerCase();
        vb=((labels.find(l=>l.id===b.labelId)||{}).name||'').toLowerCase();
      }
      else if(cs.col==='montant'){ va=a.amount||0; vb=b.amount||0; }
      if(va<vb) return cs.dir==='asc'?-1:1;
      if(va>vb) return cs.dir==='asc'?1:-1;
      return 0;
    });
  } else {
    // tri par date d√©croissante par d√©faut
    filtered.sort((a,b) => b.date.localeCompare(a.date));
  }

  // R√©sum√©
  const totalNJ  = filtered.reduce((s,t) => s+(t.amount||0), 0);
  const nbPersons= new Set(filtered.map(t=>t.personId)).size;
  const subtitle = document.getElementById('etatNJSubtitle');
  if(subtitle) subtitle.textContent =
    `${filtered.length} d√©pense(s) ‚Äî ${nbPersons} personne(s) ‚Äî Total : ${fmt(totalNJ)} DA`;
  const summaryBar = document.getElementById('etatNJSummaryBar');
  if(summaryBar){
    summaryBar.innerHTML = [
      ['‚ö†Ô∏è D√©penses NJ', filtered.length,        '#FEF3C7','#92400E'],
      ['üë• Personnes',   nbPersons,               '#DBEAFE','#1E40AF'],
      ['üí∞ Total',       fmt(totalNJ)+' DA',       '#FCE7F3','#9D174D'],
    ].map(([label,val,bg,fg])=>
      `<div style="background:${bg};color:${fg};padding:4px 12px;border-radius:20px;font-size:12px;font-weight:800;font-family:'Manrope',sans-serif">${label} : ${val}</div>`
    ).join('');
  }

  const content = document.getElementById('etatNJContent');
  if(!content) return;

  if(filtered.length === 0){
    content.innerHTML = `<div style="text-align:center;padding:48px 24px;color:#94A3B8">
      <div style="font-size:48px;margin-bottom:12px">üîç</div>
      <div style="font-size:16px;font-weight:700">Aucune d√©pense trouv√©e pour ce filtre</div>
    </div>`;
    return;
  }

  // Helper ent√™te colonne triable (avec fl√®che tri seulement, pas de filtre texte ici)
  function colTh(col, label, align='left'){
    const sort    = window._etatNJColSort;
    const isSort  = sort && sort.col === col;
    const sortIcon= isSort ? (sort.dir==='asc' ? '‚ñ≤' : '‚ñº') : '‚áÖ';
    const bg = isSort ? '#FCA5A5' : '#FEE2E2';
    const fw = isSort ? '900' : '700';
    return `<th onclick="etatNJToggleColSort('${col}')" style="padding:6px 10px;text-align:${align};background:${bg};cursor:pointer;user-select:none;font-size:11px;font-weight:${fw};color:#991B1B;text-transform:uppercase;letter-spacing:.04em;white-space:nowrap;transition:background .15s" title="Cliquer pour trier" onmouseover="this.style.background='#FCA5A5'" onmouseleave="this.style.background='${bg}'">
      <span style="display:inline-flex;align-items:center;gap:4px;pointer-events:none">${label} <span style="font-size:9px;opacity:.7">${sortIcon}</span></span>
    </th>`;
  }

  const isSortActive = !!(window._etatNJColSort && window._etatNJColSort.col);

  if(isSortActive){
    // ‚îÄ‚îÄ VUE PLATE tri√©e : tout dans un seul tableau ‚îÄ‚îÄ
    const cs = window._etatNJColSort;
    const sortLabel = {date:'Date',projet:'Projet',description:'Description',libelle:'Libell√©',montant:'Montant'}[cs.col]||cs.col;
    const flatRows = filtered.map(t => {
      const p       = persons.find(p => p.id === t.personId);
      const pName   = p ? p.name : t.personId;
      const proj    = t.projet || '‚Äî';
      const lbl     = (labels.find(l=>l.id===t.labelId)||{}).name || t.labelId || '‚Äî';
      const dateStr = new Date(t.date+'T12:00:00').toLocaleDateString('fr-FR');
      return `<tr onmouseover="this.style.background='#FFF1F1'" onmouseout="this.style.background=''">
        <td style="padding:7px 10px;font-family:'JetBrains Mono',monospace;font-size:12px;white-space:nowrap;color:#475569">${dateStr}</td>
        <td style="padding:7px 10px;font-size:12px;font-weight:700;color:#DC2626">${pName}</td>
        <td style="padding:7px 10px;font-size:12px;font-weight:600;color:var(--text-primary)">${proj}</td>
        <td style="padding:7px 10px;font-size:12px;color:#475569">${t.description||'‚Äî'}</td>
        <td style="padding:7px 10px;font-size:12px;color:#475569">${lbl}</td>
        <td style="padding:7px 10px;font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:800;color:#DC2626;text-align:right;white-space:nowrap">${fmt(t.amount)} DA</td>
      </tr>`;
    }).join('');

    content.innerHTML =
      `<div style="margin-bottom:10px;padding:6px 14px;background:#FEF3C7;border:1.5px solid #FCD34D;border-radius:8px;font-size:12px;font-weight:700;color:#92400E;display:flex;align-items:center;gap:8px">
        ${cs.dir==='asc'?'‚ñ≤':'‚ñº'} Tri par <strong>${sortLabel}</strong> ${cs.dir==='asc'?'croissant':'d√©croissant'}
        &nbsp;‚Äî&nbsp;<a onclick="window._etatNJColSort=null;renderEtatNJTable()" style="cursor:pointer;text-decoration:underline;color:#B45309">‚úï Annuler</a>
      </div>
      <div style="border-radius:12px;overflow:hidden;box-shadow:0 2px 10px rgba(220,38,38,.12)">
        <table style="width:100%;border-collapse:collapse;background:white">
          <thead><tr>
            ${colTh('date','Date')}
            <th style="padding:6px 10px;background:#FEE2E2;font-size:11px;font-weight:700;color:#991B1B;text-transform:uppercase;letter-spacing:.04em">Personne</th>
            ${colTh('projet','Projet')}
            ${colTh('description','Description')}
            ${colTh('libelle','Libell√©')}
            ${colTh('montant','Montant','right')}
          </tr></thead>
          <tbody>${flatRows}</tbody>
          <tfoot><tr style="background:#FEF2F2;border-top:2px solid #FCA5A5">
            <td colspan="5" style="padding:8px 10px;font-size:12px;font-weight:700;color:#991B1B">TOTAL G√âN√âRAL</td>
            <td style="padding:8px 10px;font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:800;color:#DC2626;text-align:right">${fmt(totalNJ)} DA</td>
          </tr></tfoot>
        </table>
      </div>`;
    return;
  }

  // ‚îÄ‚îÄ VUE GROUP√âE PAR PERSONNE (d√©faut, sans tri colonne) ‚îÄ‚îÄ
  const byPerson = {};
  filtered.forEach(t => {
    if(!byPerson[t.personId]) byPerson[t.personId] = [];
    byPerson[t.personId].push(t);
  });
  const sortedPersonIds = Object.keys(byPerson).sort((a,b) => {
    const sumA = byPerson[a].reduce((s,t)=>s+(t.amount||0),0);
    const sumB = byPerson[b].reduce((s,t)=>s+(t.amount||0),0);
    return sumB - sumA;
  });

  content.innerHTML = sortedPersonIds.map(pid => {
    const p    = persons.find(p => p.id === pid);
    const name = p ? p.name : pid;
    const rows = byPerson[pid];
    const tot  = rows.reduce((s,t) => s+(t.amount||0), 0);

    const rowsHTML = rows.map(t => {
      const proj    = t.projet || '‚Äî';
      const lbl     = (labels.find(l=>l.id===t.labelId)||{}).name || t.labelId || '‚Äî';
      const dateStr = new Date(t.date+'T12:00:00').toLocaleDateString('fr-FR');
      return `<tr onmouseover="this.style.background='#FFF1F1'" onmouseout="this.style.background=''">
        <td style="padding:7px 10px;font-family:'JetBrains Mono',monospace;font-size:12px;white-space:nowrap;color:#475569">${dateStr}</td>
        <td style="padding:7px 10px;font-size:12px;font-weight:600;color:var(--text-primary)">${proj}</td>
        <td style="padding:7px 10px;font-size:12px;color:#475569">${t.description||'‚Äî'}</td>
        <td style="padding:7px 10px;font-size:12px;color:#475569">${lbl}</td>
        <td style="padding:7px 10px;font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:800;color:#DC2626;text-align:right;white-space:nowrap">${fmt(t.amount)} DA</td>
      </tr>`;
    }).join('');

    return `<div style="margin-bottom:18px;border-radius:12px;overflow:hidden;box-shadow:0 2px 10px rgba(220,38,38,.12)">
      <div style="background:#DC2626;color:white;padding:10px 14px;display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:14px;font-weight:800;font-family:'Manrope',sans-serif">üë§ ${name}</span>
        <span style="font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:800">${fmt(tot)} DA</span>
      </div>
      <table style="width:100%;border-collapse:collapse;background:white">
        <thead><tr>
          ${colTh('date','Date')}
          ${colTh('projet','Projet')}
          ${colTh('description','Description')}
          ${colTh('libelle','Libell√©')}
          ${colTh('montant','Montant','right')}
        </tr></thead>
        <tbody>${rowsHTML}</tbody>
        <tfoot><tr style="background:#FEF2F2;border-top:2px solid #FCA5A5">
          <td colspan="4" style="padding:8px 10px;font-size:12px;font-weight:700;color:#991B1B">Sous-total ${name}</td>
          <td style="padding:8px 10px;font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:800;color:#DC2626;text-align:right">${fmt(tot)} DA</td>
        </tr></tfoot>
      </table>
    </div>`;
  }).join('') +
  `<div style="background:#7F1D1D;color:white;padding:12px 18px;border-radius:10px;display:flex;justify-content:space-between;align-items:center;margin-top:8px">
    <span style="font-size:14px;font-weight:800;font-family:'Manrope',sans-serif">üí∞ TOTAL G√âN√âRAL NON JUSTIFI√â</span>
    <span style="font-family:'JetBrains Mono',monospace;font-size:16px;font-weight:800">${fmt(totalNJ)} DA</span>
  </div>`;
}

function etatNJToggleColSort(col){
  const cs = window._etatNJColSort;
  if(cs && cs.col === col){
    if(cs.dir === 'asc') window._etatNJColSort = { col, dir:'desc' };
    else                 window._etatNJColSort = null;
  } else {
    window._etatNJColSort = { col, dir:'asc' };
  }
  renderEtatNJTable();
  // restore focus
  setTimeout(()=>{
    const inp = document.querySelector(`[data-njcol=${col}]`);
    // don't re-focus ‚Äî user clicked the header
  }, 20);
}
</script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- MODAL : REMBOURSEMENT (ouvert par double-clic ou apr√®s saisie) -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="remboursementModal" class="modal" onclick="if(event.target===this)closeModal('remboursementModal')">
  <div class="modal-content wide" style="max-width:900px;max-height:93vh;display:flex;flex-direction:column;padding:0;border-radius:20px;overflow:hidden;box-shadow:0 24px 80px rgba(109,40,217,.4)">
    <!-- HEADER -->
    <div style="background:linear-gradient(135deg,#6d28d9 0%,#4c1d95 100%);padding:18px 24px 14px;flex-shrink:0">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
        <div>
          <div style="font-size:18px;font-weight:800;color:white;font-family:'Manrope',sans-serif">üíú Fen√™tre de Remboursement</div>
          <div id="rembModalSubtitle" style="font-size:12px;color:rgba(255,255,255,.75);margin-top:3px"></div>
        </div>
        <button onclick="closeModal('remboursementModal')" style="width:34px;height:34px;min-width:34px;border-radius:50%;background:rgba(255,255,255,.2);color:white;font-size:18px;font-weight:900;border:2px solid rgba(255,255,255,.35);cursor:pointer;padding:0;box-shadow:none;display:flex;align-items:center;justify-content:center;flex-shrink:0">‚úï</button>
      </div>
      <!-- R√©sum√© solde -->
      <div id="rembModalSoldeBar" style="display:flex;gap:8px;flex-wrap:wrap"></div>
    </div>
    <!-- CONTENU -->
    <div style="overflow-y:auto;flex:1;min-height:0;padding:16px 20px;background:#f5f3ff">
      <!-- D√©pense d'origine -->
      <div id="rembModalOrigine" style="margin-bottom:14px;padding:10px 16px;background:white;border:2px solid #7c3aed;border-radius:10px;font-size:13px;font-weight:700;color:#4c1d95"></div>
      <!-- Formulaire ajout ligne -->
      <div style="margin-bottom:14px;padding:12px;background:white;border:1.5px solid #c4b5fd;border-radius:10px">
        <div style="font-size:12px;font-weight:800;color:#6d28d9;margin-bottom:8px">‚ûï Ajouter une ligne de remboursement</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end">
          <div class="form-group" style="margin-bottom:0;flex:0 0 130px">
            <label style="font-size:11px;font-weight:700;color:#6d28d9">Date</label>
            <input type="date" id="rembModalDate" style="padding:4px 8px;font-size:12px;width:100%;border-color:#7c3aed">
          </div>
          <div class="form-group" style="margin-bottom:0;flex:1 1 160px">
            <label style="font-size:11px;font-weight:700;color:#6d28d9">Personne</label>
            <select id="rembModalPersonne" style="padding:4px 8px;font-size:12px;width:100%;border-color:#7c3aed">
              <option value="">‚Äî S√©lectionner ‚Äî</option>
            </select>
          </div>
          <div class="form-group" style="margin-bottom:0;flex:0 0 130px">
            <label style="font-size:11px;font-weight:700;color:#6d28d9">Montant (-DA)</label>
            <input type="number" id="rembModalMontant" step="0.01" placeholder="ex: 5000" style="padding:4px 8px;font-size:12px;width:100%;border-color:#7c3aed">
          </div>
          <div class="form-group" style="margin-bottom:0;flex:2 1 180px">
            <label style="font-size:11px;font-weight:700;color:#6d28d9">Description</label>
            <input type="text" id="rembModalDescription" placeholder="Description" style="padding:4px 8px;font-size:12px;width:100%;border-color:#7c3aed">
          </div>
          <div style="display:flex;gap:6px;padding-bottom:1px">
            <button onclick="addRembModalLigne()" style="width:auto;padding:6px 14px;font-size:12px;background:#6d28d9;white-space:nowrap" id="rembModalAddBtn">‚úö Ajouter</button>
            <button onclick="cancelRembModalEdit()" id="rembModalCancelBtn" class="secondary" style="display:none;width:auto;padding:6px 10px;font-size:12px">Annuler</button>
          </div>
        </div>
        <div id="rembModalSoldeRestant" style="margin-top:8px;padding:6px 12px;border-radius:7px;font-size:12px;font-weight:700;display:none"></div>
      </div>
      <!-- Table lignes remboursement -->
      <div style="border-radius:10px;overflow:hidden;box-shadow:0 2px 10px rgba(109,40,217,.15)">
        <table style="width:100%;border-collapse:collapse;background:white">
          <thead>
            <tr style="background:linear-gradient(135deg,#6d28d9,#4c1d95)">
              <th style="padding:8px 12px;color:white;font-size:12px;text-align:left">#</th>
              <th style="padding:8px 12px;color:white;font-size:12px;text-align:left">Date</th>
              <th style="padding:8px 12px;color:white;font-size:12px;text-align:left">Personne</th>
              <th style="padding:8px 12px;color:white;font-size:12px;text-align:right">Montant</th>
              <th style="padding:8px 12px;color:white;font-size:12px;text-align:left">Description</th>
              <th style="padding:8px 12px;color:white;font-size:12px;text-align:center">Actions</th>
            </tr>
          </thead>
          <tbody id="rembModalTableBody">
            <tr><td colspan="6" style="text-align:center;padding:20px;color:#9ca3af;font-size:13px">Aucune ligne de remboursement</td></tr>
          </tbody>
          <tfoot>
            <tr id="rembModalTotalRow" style="background:#ede9fe;border-top:2px solid #7c3aed;display:none">
              <td colspan="3" style="padding:8px 12px;font-size:13px;font-weight:800;color:#4c1d95">TOTAL REMBOURS√â</td>
              <td id="rembModalTotalCell" style="padding:8px 12px;font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:900;color:#6d28d9;text-align:right"></td>
              <td colspan="2"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
    <!-- FOOTER boutons -->
    <div style="padding:12px 20px;background:white;border-top:2px solid #e9d5ff;display:flex;gap:10px;justify-content:flex-end;flex-shrink:0">
      <button onclick="validerRemboursementModal()" id="rembModalValiderBtn" style="width:auto;padding:8px 20px;font-size:13px;background:linear-gradient(135deg,#6d28d9,#4c1d95);white-space:nowrap">‚úÖ Valider & Fermer</button>
      <button onclick="closeModal('remboursementModal')" class="secondary" style="width:auto;padding:8px 16px;font-size:13px">Fermer</button>
    </div>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- MODAL : √âTAT GLOBAL DES REMBOURSEMENTS                        -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="etatRembModal" class="modal" onclick="if(event.target===this)closeModal('etatRembModal')">
  <div class="modal-content wide" style="max-width:1080px;max-height:93vh;display:flex;flex-direction:column;padding:0;border-radius:20px;overflow:hidden;box-shadow:0 24px 80px rgba(16,185,129,.35)">

    <!-- HEADER -->
    <div style="background:linear-gradient(135deg,#059669 0%,#065F46 100%);padding:20px 24px 0;flex-shrink:0">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px">
        <div>
          <div style="font-size:19px;font-weight:800;color:white;font-family:'Manrope',sans-serif">üí∞ √âtat Global des Remboursements</div>
          <div id="etatRembSubtitle" style="font-size:12px;color:rgba(255,255,255,.75);margin-top:3px;font-family:'Manrope',sans-serif"></div>
        </div>
        <button onclick="closeModal('etatRembModal')" style="width:34px;height:34px;min-width:34px;border-radius:50%;background:rgba(255,255,255,.2);color:white;font-size:18px;font-weight:900;border:2px solid rgba(255,255,255,.35);cursor:pointer;padding:0;box-shadow:none;display:flex;align-items:center;justify-content:center;flex-shrink:0">‚úï</button>
      </div>
      <!-- Chiffres cl√©s -->
      <div id="etatRembSummaryBar" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px"></div>

      <!-- ONGLETS + FILTRE sur m√™me ligne -->
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;padding-bottom:0">
        <!-- Onglets Vue -->
        <div style="display:flex;gap:0;border-radius:10px 10px 0 0;overflow:hidden">
          <button id="etatRembTabDepenses" onclick="etatRembSwitchTab('depenses')"
            style="padding:9px 20px;font-size:13px;font-weight:800;font-family:'Manrope',sans-serif;border:none;cursor:pointer;display:flex;align-items:center;gap:6px;background:white;color:#059669;border-radius:10px 0 0 0;transition:all .15s">
            üìã Vue D√©penses
          </button>
          <button id="etatRembTabPersonnes" onclick="etatRembSwitchTab('personnes')"
            style="padding:9px 20px;font-size:13px;font-weight:800;font-family:'Manrope',sans-serif;border:none;cursor:pointer;display:flex;align-items:center;gap:6px;background:rgba(255,255,255,.25);color:white;border-radius:0 10px 0 0;transition:all .15s">
            üë• Vue Personnes
          </button>
        </div>
        <!-- Filtre personne (visible selon onglet) -->
        <div id="etatRembFilterBar" style="display:flex;align-items:center;gap:8px;padding-bottom:6px">
          <span style="font-size:11px;font-weight:700;color:rgba(255,255,255,.7);white-space:nowrap">Filtrer :</span>
          <div style="position:relative;display:flex;align-items:center;min-width:220px">
            <span style="position:absolute;left:10px;z-index:2;font-size:15px;pointer-events:none">üë§</span>
            <select id="etatRembPersonneSelect" onchange="etatRembSelectFilter(this.value)"
              style="width:100%;padding:7px 36px 7px 34px;border:2px solid rgba(255,255,255,.5);border-radius:8px;font-size:13px;font-family:'Manrope',sans-serif;font-weight:700;color:#1E293B;background:white;outline:none;cursor:pointer;appearance:none;-webkit-appearance:none">
              <option value="">‚Äî Toutes les personnes ‚Äî</option>
            </select>
            <span style="position:absolute;right:10px;font-size:12px;pointer-events:none;color:#64748B">‚ñº</span>
          </div>
        </div>
      </div>
    </div>

    <!-- CONTENU scrollable -->
    <div id="etatRembContent" style="overflow-y:auto;flex:1;min-height:0;padding:16px 20px;background:#F0FDF4"></div>
  </div>
</div>


<div id="etatNJModal" class="modal" onclick="if(event.target===this)closeModal('etatNJModal')">
  <div class="modal-content wide" style="max-width:980px;max-height:93vh;display:flex;flex-direction:column;padding:0;border-radius:20px;overflow:hidden;box-shadow:0 24px 80px rgba(0,0,0,.35)">

    <!-- HEADER -->
    <div style="background:linear-gradient(135deg,#DC2626 0%,#7F1D1D 100%);padding:20px 24px 16px;flex-shrink:0">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px">
        <div>
          <div style="font-size:19px;font-weight:800;color:white;font-family:'Manrope',sans-serif">‚ö†Ô∏è √âtat des D√©penses Non Justifi√©es</div>
          <div id="etatNJSubtitle" style="font-size:12px;color:rgba(255,255,255,.75);margin-top:3px;font-family:'Manrope',sans-serif"></div>
        </div>
        <button onclick="closeModal('etatNJModal')" style="width:34px;height:34px;min-width:34px;border-radius:50%;background:rgba(255,255,255,.2);color:white;font-size:18px;font-weight:900;border:2px solid rgba(255,255,255,.35);cursor:pointer;padding:0;box-shadow:none;display:flex;align-items:center;justify-content:center;flex-shrink:0">‚úï</button>
      </div>
      <!-- Chiffres cl√©s -->
      <div id="etatNJSummaryBar" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px"></div>
      <!-- Filtre personne ‚Äî liste d√©roulante -->
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <span style="font-size:11px;font-weight:700;color:rgba(255,255,255,.7);white-space:nowrap">Filtrer :</span>
        <div style="position:relative;display:flex;align-items:center;gap:0;min-width:240px">
          <span style="position:absolute;left:10px;z-index:2;font-size:15px;pointer-events:none">üë§</span>
          <select id="etatNJPersonneSelect"
            onchange="etatNJSelectFilter(this.value)"
            style="width:100%;padding:7px 36px 7px 34px;border:2px solid rgba(255,255,255,.5);border-radius:8px;font-size:13px;font-family:'Manrope',sans-serif;font-weight:700;color:#1E293B;background:white;outline:none;cursor:pointer;appearance:none;-webkit-appearance:none">
            <option value="">‚Äî Toutes les personnes ‚Äî</option>
          </select>
          <span id="etatNJSelectArrow" style="position:absolute;right:10px;font-size:12px;pointer-events:none;color:#64748B">‚ñº</span>
        </div>
        <div id="etatNJFilterBanner" style="display:none;background:rgba(255,255,255,.22);color:white;padding:4px 10px;border-radius:20px;font-size:12px;font-weight:700;align-items:center;gap:5px">
          üë§ <span id="etatNJFilterText" style="font-style:italic"></span>
          <span onclick="etatNJClearFilter()" style="cursor:pointer;font-size:13px;margin-left:4px;opacity:.8">‚úï</span>
        </div>
      </div>
    </div>

    <!-- CONTENU scrollable -->
    <div id="etatNJContent" style="overflow-y:auto;flex:1;min-height:0;padding:16px 20px;background:#FFF5F5"></div>
  </div>
</div>

</body>
</html>
